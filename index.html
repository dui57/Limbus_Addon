<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Î¶ºÎ≤ÑÏä§ Ïª¥ÌçºÎãà Ïï†ÎìúÏò®</title>
  <style>
    :root{
      --bg:#050608;
      --bg2:#0b0d10;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);

      --gold:#caa66a;
      --gold2:#f3d39a;

      --text:#eef1ff;
      --muted:rgba(238,241,255,.70);

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;

      --barOrange:#d95a2b;
      --barOrange2:#f07a33;

      --toneRed:#ff4b4b;
      --toneRed2:#ff6868;

      --toneGrayText: rgba(235,240,255,.40);
      --toneGrayBorder: rgba(235,240,255,.28);

      --toneNormalText: rgba(255,255,255,.92);
      --toneNormalBorder: rgba(255,255,255,.14);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(202,166,106,.14), transparent 58%),
        radial-gradient(900px 600px at 85% 25%, rgba(243,211,154,.08), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      display:grid;
      place-items:start center;
      padding: 22px;
    }

    /* ‚úÖ Ï†ÑÏ≤¥ Ïï± ÏµúÎåÄ Ìè≠ ÌôïÏû• (Ìå®ÏãúÎ∏åÍ∞Ä Ï¢ÅÏïÑ Î≥¥Ïù¥Îçò ÏõêÏù∏ Ìï¥Í≤∞) */
    .app{ width: min(1920px, 100%); }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 16px 18px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{ margin:0; font-size: 20px; letter-spacing:-0.02em; }
    .brand .sub{ margin:0; font-size: 13px; color: var(--muted); }
    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 7px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.22);
    }

    .screen{ margin-top: 14px; }
    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    button{
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 14px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space: nowrap;
    }
    button:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(180deg, rgba(202,166,106,.24), rgba(202,166,106,.10));
      border-color: rgba(202,166,106,.40);
    }
    .primary:hover{
      background: linear-gradient(180deg, rgba(202,166,106,.32), rgba(202,166,106,.14));
      border-color: rgba(202,166,106,.55);
    }
    .ghost{ background: transparent; }

    .home{ padding: 22px; }
    .home h2{ margin:0 0 6px; font-size: 18px; }
    .home p{ margin:0 0 18px; color: var(--muted); line-height: 1.6; font-size: 14px; }
    .actions{ display:flex; gap:12px; flex-wrap:wrap; }

    .toast{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      display:none;
      white-space: pre-wrap;
    }

    /* ===== AI ÏÉÅÎåÄ Ïù¥Î¶Ñ(ÎáåÌö°) Ï†ÑÏö© ÌÖåÎßà ===== */
    .aiNameWrap{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.2;
    }
    .aiNameMain{
      font-weight:1000;
      font-size:22px;
      letter-spacing:.06em;
      color:#f4d7a1;
      text-shadow:
        0 0 10px rgba(255,205,120,.22),
        0 2px 8px rgba(0,0,0,.55);
    }
    .aiNameSub{
      font-size:11px;
      font-weight:700;
      letter-spacing:.14em;
      color:rgba(255,224,170,.82);
      text-transform:uppercase;
      opacity:.95;
    }

    /* ÎáåÌö° ÏÑ†ÌÉù ÏãúÏóêÎßå ÏÇ¥Ïßù Îçî Í∞ïÌïú ÌÜ§ */
    .aiNameWrap.leiheng .aiNameMain{
      color:#f6cc7a;
      text-shadow:
        0 0 14px rgba(255,196,88,.28),
        0 2px 10px rgba(0,0,0,.65);
    }
    .aiNameWrap.leiheng .aiNameSub{
      color:rgba(255,214,138,.90);
    }

    .hidden{ display:none; }

    /* ‚úÖ ÌÇ§ÏõåÎìú Î™®Îã¨: Ï§ëÏïôÏ†ïÎ†¨ ÎêòÍ≤å display:flex Í≥†Ï†ï */
    #kwModal{ display:flex; }
    #kwModal.hidden{ display:none !important; }

    /* ===== EDITOR layout ===== */
    .editor{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height: 640px;
    }
    .sidebar{
      padding: 16px;
      border-right: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .sidebar h3{
      margin: 2px 0 10px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .02em;
    }
    .nav{ display:flex; flex-direction:column; gap: 10px; }
    .nav button{
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .nav button.active{
      border-color: rgba(202,166,106,.65);
      background: linear-gradient(180deg, rgba(202,166,106,.18), rgba(202,166,106,.07));
      box-shadow: 0 8px 25px rgba(202,166,106,.12);
    }
    .sidebar .bottom{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
      display:flex;
      gap: 10px;
    }
    .sidebar .bottom button{ flex: 1; text-align:center; }

    /* ‚úÖ content Í∞ÄÏö¥Îç∞ Í≥†Ï†ï Ìï¥Ï†ú (Ìå®ÏãúÎ∏å Ìè≠ ÌôïÏû•) */
    .content{
      padding: 18px;
      background: rgba(255,255,255,.03);
      display:flex;
      justify-content: stretch;
    }

    .centerBoard{
      width: min(1040px, 100%);
      margin: 0 auto;
    }

    /* ‚úÖ Ïó¨Í∏∞! content ÏïàÏùò Í∞Å Ìå®ÎÑêÏùÄ Í∞ÄÎ°ú 100% ÏÇ¨Ïö© */
    .content > section{ width: 100%; }

    .core-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items:start;
    }

    .frame{
      border: 1px solid rgba(202,166,106,.35);
      background: linear-gradient(180deg, rgba(12,13,16,.92), rgba(7,8,10,.92));
      border-radius: 16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      overflow:hidden;
    }
    .frame .hdr{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(202,166,106,.28);
      background: linear-gradient(180deg, rgba(202,166,106,.22), rgba(143,107,50,.10));
      color: var(--gold2);
      font-weight: 700;
      letter-spacing: .02em;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .frame .hdr .slash{
      margin-left:auto;
      width: 120px;
      height: 2px;
      background: linear-gradient(90deg, rgba(202,166,106,.0), rgba(202,166,106,.65), rgba(202,166,106,.0));
      opacity: .9;
    }
    .frame .body{ padding: 12px; }

    .name-row input, .kwInput, .numInput, .textInput, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
      min-width: 0;
      font-family: inherit;
    }
    .name-row input:focus, .kwInput:focus, .numInput:focus, .textInput:focus, textarea:focus{
      border-color: rgba(202,166,106,.70);
      box-shadow: 0 0 0 3px rgba(202,166,106,.14);
    }

    .portrait{
      height: 360px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background:
        radial-gradient(700px 320px at 30% 10%, rgba(202,166,106,.08), transparent 60%),
        rgba(0,0,0,.24);
      display:grid;
      place-items:center;
      overflow:hidden;
      position: relative;
    }
    .portrait img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:none;
    }
    .portrait .ph{
      color: rgba(238,241,255,.55);
      font-size: 13px;
      line-height: 1.6;
      text-align:center;
      padding: 0 20px;
    }
    .upload-row{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .file{
      position: relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      min-width: 160px;
    }
    .file input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .statList{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    .rowItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      min-width: 0;
      transition: border-color .15s ease;
    }
    .iconBox{
      width: 30px;
      height: 30px;
      display:grid;
      place-items:center;
      border-radius: 10px;
      border: 1px solid rgba(202,166,106,.35);
      background: rgba(0,0,0,.20);
      flex: 0 0 auto;
      overflow:hidden;
      transition: border-color .15s ease;
    }
    .iconBox img{
      width: 20px;
      height: 20px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .label{
      color: rgba(243,211,154,.95);
      font-weight: 800;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .grow{ flex: 1 1 auto; min-width: 0; }
    .inline{ display:flex; gap: 8px; align-items:center; min-width:0; }
    .inline .sep{ opacity:.6; font-size:12px; padding:0 4px; flex:0 0 auto; }

    .select{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: var(--toneNormalText);
      outline:none;
      appearance: none;
      min-width: 0;
      text-align:center;
      transition: border-color .15s ease, color .15s ease;
    }
    .coef{
      margin-top: 4px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .02em;
      color: var(--toneNormalText);
      opacity: .95;
      user-select:none;
    }

    .tone-normal { --toneBorder: var(--toneNormalBorder); --toneText: var(--toneNormalText); }
    .tone-gray   { --toneBorder: var(--toneGrayBorder);   --toneText: var(--toneGrayText); }
    .tone-red    { --toneBorder: var(--toneRed);          --toneText: var(--toneRed2); }

    .physGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .physBox.tone-normal, .physBox.tone-gray, .physBox.tone-red{ border-color: var(--toneBorder); }
    .physBox.tone-normal .iconBox, .physBox.tone-gray .iconBox, .physBox.tone-red .iconBox{ border-color: var(--toneBorder); }
    .physBox.tone-normal .select, .physBox.tone-gray .select, .physBox.tone-red .select{ border-color: var(--toneBorder); color: var(--toneText); }
    .physBox.tone-normal .coef, .physBox.tone-gray .coef, .physBox.tone-red .coef{ color: var(--toneText); }

    /* sins 2 rows fixed */
    .sinsWrap{ display:flex; flex-direction:column; gap: 10px; }
    .sinsRow{ display:grid; gap: 10px; }
    .sinsRow.top{ grid-template-columns: repeat(4, 1fr); }
    .sinsRow.bottom{ grid-template-columns: repeat(3, 1fr); }

    .sinCell{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      min-width: 0;
    }
    .sinCell .sinIcon{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(202,166,106,.35);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .sinCell .sinIcon img{
      width: 22px;
      height: 22px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .sinCell .sinName{
      font-size: 13px;
      color: rgba(243,211,154,.95);
      font-weight: 800;
      letter-spacing: .01em;
      white-space: nowrap;
    }
    .sinBox.tone-normal .select, .sinBox.tone-gray .select, .sinBox.tone-red .select{ color: var(--toneText); }
    .sinBox.tone-normal .coef, .sinBox.tone-gray .coef, .sinBox.tone-red .coef{ color: var(--toneText); }

    /* stagger */
    .staggerBoard{
      border: 1px solid rgba(202,166,106,.35);
      background: linear-gradient(180deg, rgba(70,40,18,.50), rgba(35,18,10,.38));
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .staggerBarOuter{
      border: 1px solid rgba(202,166,106,.55);
      border-radius: 999px;
      padding: 6px;
      background: rgba(0,0,0,.25);
    }
    .staggerBar{
      position: relative;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.22));
      overflow: hidden;
    }
    .staggerBar .fill{
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, var(--barOrange), var(--barOrange2));
      opacity: .95;
    }
    .markerLayer{ position:absolute; inset:0; pointer-events:none; }
    .marker{
      position:absolute;
      top: -5px;
      transform: translateX(-50%);
      width: 8px;
      height: 26px;
      border-radius: 2px;
      background: #f3f0e8;
      box-shadow: 0 0 0 1px rgba(0,0,0,.35), 0 8px 14px rgba(0,0,0,.35);
      opacity: .98;
    }
    .tickLayer{ position: relative; height: 22px; margin-top: 8px; }
    .tick{
      position:absolute;
      transform: translateX(-50%);
      font-weight: 900;
      font-size: 16px;
      color: rgba(243,211,154,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.45);
      white-space: nowrap;
    }
    .staggerActions{ display:flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }

    .row-actions{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 12px; }

    /* ===== ÌäπÏÑ± ÌÇ§ÏõåÎìú ===== */
    .kwWrap{ display:flex; flex-direction:column; gap: 10px; }
    .kwRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .kwInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      color: var(--text);
      outline:none;
      min-width: 0;
      transition: color .15s ease, text-decoration-color .15s ease;
    }
    .kwRow .btnSmall{
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
    .kwRow.deleted{
      border-color: var(--toneRed);
      box-shadow: 0 0 0 1px rgba(255,75,75,.15) inset;
    }
    .kwRow.deleted .kwInput{
      color: var(--toneRed2);
      text-decoration: line-through;
      text-decoration-color: rgba(220,220,220,.70);
      text-decoration-thickness: 2px;
    }
    .kwFooter{
      display:flex;
      justify-content:flex-end;
      margin-top: 6px;
    }

    /* ===== Ï†ÑÏö© ÌÇ§ÏõåÎìú Ìé∏Ïßë ===== */
    .dkPage{ width: min(1240px, 100%); display:flex; flex-direction:column; gap: 14px; margin:0 auto; }

    .dkTop{
      display:grid;
      grid-template-columns: 320px 1fr 300px;
      gap: 18px;
      align-items:stretch;
    }
    .box{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }

    .dkIconPreview{
      width: 100%;
      height: 260px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .dkIconPreview img{ width:100%; height:100%; object-fit: contain; display:none; }
    .dkIconPreview .ph{ color: rgba(238,241,255,.55); font-size: 12px; text-align:center; padding: 0 6px; }

    .dkButtons{ display:flex; flex-direction:column; gap: 10px; }

    .dkContentArea textarea{
      height: 320px;
      resize: vertical;
      text-align: center;
      line-height: 1.9;
      font-size: 14px;
    }

    .dkActionCol{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .stateBtn{
      font-weight: 900;
      letter-spacing: .02em;
    }
    .stateBtn.buff{
      color: rgba(243,211,154,.95);
      border-color: rgba(202,166,106,.40);
      background: rgba(202,166,106,.12);
    }
    .stateBtn.debuff{
      color: var(--toneRed2);
      border-color: rgba(255,75,75,.50);
      background: rgba(255,75,75,.10);
    }

    .btnDanger{
      border-color: rgba(255,75,75,.35);
      background: rgba(255,75,75,.10);
    }
    .btnDanger:hover{
      border-color: rgba(255,75,75,.55);
      background: rgba(255,75,75,.14);
    }

    .dkListBox{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px;
      min-height: 460px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .dkItem{
      display:grid;
      grid-template-columns: 92px 1fr 120px;
      gap: 12px;
      align-items: start;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .dkItem:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
    }
    .dkItem.active{
      box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
    }

    .dkItem.buff{
      border-color: rgba(202,166,106,.60);
      background: rgba(202,166,106,.08);
    }
    .dkItem.debuff{
      border-color: rgba(255,75,75,.60);
      background: rgba(255,75,75,.06);
    }

    .dkLeft{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      width: 100%;
      padding-top: 2px;
    }
    .dkLeftTitle{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.25;
      color: rgba(243,211,154,.95);
      text-align:center;
      white-space: normal;
      word-break: break-word;
      width: 100%;
    }

    .dkMiniIcon{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .dkItem.buff .dkMiniIcon{ border-color: rgba(202,166,106,.45); }
    .dkItem.debuff .dkMiniIcon{ border-color: rgba(255,75,75,.45); }
    .dkMiniIcon img{ width:100%; height:100%; object-fit: contain; display:none; }
    .dkMiniIcon .ph{ font-size: 11px; color: rgba(238,241,255,.45); }

    .dkMeta{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 6px;
      padding-top: 6px;
      min-width: 0;
    }
    .dkMeta .d{
      font-size: 13px;
      color: rgba(238,241,255,.75);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      width: 100%;
    }

    .dkTag{
      font-weight: 900;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      text-align:center;
      align-self: start;
      margin-top: 4px;
    }
    .dkTag.buff{ color: rgba(243,211,154,.95); border-color: rgba(202,166,106,.55); }
    .dkTag.debuff{ color: var(--toneRed2); border-color: rgba(255,75,75,.60); }

    .dkFooterBar{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 6px;
    }

    /* ===== PASSIVE (Í∞úÌé∏) ===== */
    /* ‚úÖ Ìå®ÏãúÎ∏åÎäî Í∞ÄÎ°úÎ•º Ï†úÌïúÌïòÏßÄ ÏïäÍ≥†, ÏÇ¨Ïù¥ÎìúÎ∞î ÏòÜ ÎÇ®Îäî Ìè≠ÏùÑ Ï†ÑÎ∂Ä ÏÇ¨Ïö© */
    .passivePage{
      width: 100%;
      max-width: none;
      margin: 0;
    }

    .passTop{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: stretch;
    }

    .passEditor textarea{
      height: 360px;
      resize: vertical;
      line-height: 1.85;
      font-size: 14px;
      text-align: left;
    }

    .passLabel{
      color: rgba(243,211,154,.95);
      font-weight: 900;
      margin-bottom: 6px;
    }

    .passHeaderPick{ display:flex; gap:10px; flex-wrap:wrap; }
    .pvStyleBtn.active{
      border-color: rgba(202,166,106,.70);
      background: rgba(202,166,106,.14);
    }

    .pvBoardBox{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px;
    }

    .pvBoardHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .pvBoardHint{
      color:var(--muted);
      font-size:13px;
    }

    .pvBoardScroll{
      max-height: 560px;
      overflow:auto;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      border-radius: 14px;
    }

    .pvCard{
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
      border-radius: 14px;
      overflow:hidden;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .pvCard:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.18);
    }
    .pvCard.active{
      box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
    }

    .pvHdr{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      font-weight: 900;
      color: rgba(255,255,255,.95);
      position: relative;
      overflow:hidden;
    }
    .pvHdr .slashes{
      margin-left:auto;
      display:flex;
      gap: 6px;
      opacity: .95;
    }
    .pvHdr .slashes i{
      width: 10px;
      height: 18px;
      transform: skewX(-20deg);
      display:block;
      background: rgba(0,0,0,.30);
    }

    .pvHdr.orange{ background: linear-gradient(90deg, #ff7a2f, #8b3b12); }
    .pvHdr.red{    background: linear-gradient(90deg, #ff3d3d, #7a1a1a); }
    .pvHdr.brown{  background: linear-gradient(90deg, #b9833c, #5a3a16); }

    .pvBody{
      padding: 12px 12px 14px;
      color: rgba(255,255,255,.92);
      line-height: 1.75;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .pvHL{
      padding: 0 2px;
      border: 2px solid rgba(255,122,47,.95);
      border-radius: 0;
      background: rgba(255,122,47,.12);
      color: rgba(255,140,70,.98);
      font-weight: 900;

      text-decoration-line: underline;
      text-decoration-color: rgba(255,255,255,.92);
      text-decoration-thickness: 2px;
      text-underline-offset: 3px;
    }

    /* ‚úÖ Ï†ÑÏö©ÌÇ§ÏõåÎìú ÌëúÏãú(Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÏÉâ) */
    .pvKW{
      font-weight: 900;
      padding: 0 2px;
      border-bottom: 2px solid rgba(255,255,255,.92);
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.92);
      text-underline-offset: 3px;
    }
    .pvKW.buff{ color: rgba(243,211,154,.95); }
    .pvKW.debuff{ color: rgba(255,120,120,.98); }

    /* Í∞ïÏ°∞ ÏïàÏóêÏÑúÎèÑ ÌÇ§ÏõåÎìú ÏÉâ Ïú†ÏßÄ */
    .pvHL .pvKW.buff{ color: rgba(243,211,154,.95); }
    .pvHL .pvKW.debuff{ color: rgba(255,120,120,.98); }

/* ===== SKILL Color Effects ===== */
.fxGreen{
  color: #6CFF9E;     /* Î∞ùÏùÄ Ï¥àÎ°ù */
  font-weight: 900;
}

.fxBlue{
  color: #7EC8FF;     /* Î∞ùÏùÄ ÌååÎûë */
  font-weight: 900;
}

.fxRed{
  color: #FF2B2B;     /* üî• Îçî Í∞ïÌïú Îπ®Í∞ï */
  font-weight: 900;
}

    /* ===== responsive ===== */
    @media (max-width: 1120px){
      .core-grid{ grid-template-columns: 1fr; }
      .dkTop{ grid-template-columns: 1fr; }
      .kwRow{ grid-template-columns: 1fr; }
      .kwFooter button{ width:100%; }
      .passTop{ grid-template-columns: 1fr; }
      .pvBoardScroll{ max-height: 460px; }
    }
    @media (max-width: 980px){
      .editor{ grid-template-columns: 1fr; }
      .sidebar{ border-right:none; border-bottom:1px solid var(--line); }
      .physGrid{ grid-template-columns: 1fr; }
      .sinsRow.top{ grid-template-columns: repeat(2, 1fr); }
      .sinsRow.bottom{ grid-template-columns: repeat(2, 1fr); }
      .tick{ font-size: 14px; }
      .dkItem{ grid-template-columns: 92px 1fr; }
      .dkTag{ justify-self:start; }
    }

/* ===== SKILL (FIXED LAYOUT) ===== */
.skillPage{ width: 100%; max-width: none; }

/* ===== SKILL text line align ===== */
/* ‚úÖ Ïä§ÌÇ¨ ÌéòÏù¥ÏßÄÎ•º "ÏúÑ(3Ïó¥) + ÏïÑÎûò(Ï†ÄÏû•Îêú Ïä§ÌÇ¨)" 2Îã®ÏúºÎ°ú */
.skillEditorGrid{
  width: min(1600px, 100%);
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr;     /* 1Ïó¥ Ïª®ÌÖåÏù¥ÎÑà */
  gap: 18px;
  align-items: start;
}

/* ‚úÖ ÏúÑÏ™Ω: 3Ïó¥(ÎØ∏Î¶¨Î≥¥Í∏∞ / Ìé∏Ïßë / Ïä§ÌÇ¨ÏàòÏπò) */
.skillTopGrid{
  display: grid;
  grid-template-columns: 520px 1fr 340px; /* ÏõêÌïòÎäî ÎπÑÏú®Î°ú Ï°∞Ï†à Í∞ÄÎä• */
  gap: 18px;
  align-items: start;
}

/* ‚úÖ grid ÏûêÏãù overflow/Ïπ®Î≤î Î∞©ÏßÄ ÌïµÏã¨ */
.skillTopGrid > *{ min-width: 0; }
.skillEditorGrid > *{ min-width: 0; }

/* Î∞ïÏä§Í∞Ä Î∞ñÏúºÎ°ú ÌäÄÎäî Í±∏ ÏûòÎùºÏ§å */
.skillTopGrid .box{ overflow: hidden; }
.skillSavedBox{ overflow: hidden; }

.coinEffectWrapper{
  position: relative;
  width: 28px;
  height: 28px;
  flex: 0 0 auto;
}

.coinEffectFrame{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display:block;
}

.coinEffectRoman{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  font-weight: 1000;
  color: rgba(255,255,255,.95);
  pointer-events: none;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
}

/* ===== SKILL text line align (ADD BACK) ===== */
.skLines{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.skLine{
  display:grid;
  grid-template-columns: 28px 1fr; /* ÏôºÏ™Ω ÏΩîÏù∏ Ïπ∏ */
  gap:10px;
  align-items:start;
}

.skLead{
  display:flex;
  align-items:flex-start;
  justify-content:center;
  font-weight:1000;
  text-align:center;
  opacity:.95;
  min-width:0;
}

.skBody{
  min-width:0;
}

/* ===== Skill Preview v3 (3Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº) ===== */
.skillPreviewCard.v2{
  background: rgba(0,0,0,.34);
  border: 1px solid rgba(255,255,255,.14);
}

/* ===== Skill Preview v2: ÏΩîÏù∏ -> ÌÉÄÏù¥ÌãÄ ÏúÑ, ÏΩîÏù∏ÏùÄ ÏôºÏ™Ω Ï†ïÎ†¨ ===== */
#skPreviewCard.skillPreviewCard.v2{
  width: min(420px, 100%);
  margin: 0 auto;
}

/* ÏΩîÏù∏ Ï§Ñ: ÏôºÏ™Ω Ï†ïÎ†¨ + ÌÉÄÏù¥ÌãÄÍ≥º Í∞ôÏùÄ Ìè≠ */
#skPreviewCard.skillPreviewCard.v2 #skCoinRow{
  display:flex;
  justify-content:flex-start;   /* ‚úÖ ÏôºÏ™Ω Ï†ïÎ†¨ */
  align-items:center;
  gap:6px;
  margin: 0 auto;               /* Ïπ¥Îìú Í∏∞Ï§Ä Ï§ëÏïôÏóê ‚ÄúÌè≠‚ÄùÎßå ÎßûÏ∂§ */
  width: 100%;
  max-width: 360px;             /* ‚úÖ 2Î≤à Ïù¥ÎØ∏ÏßÄ ÎäêÎÇå */
}

/* ÏΩîÏù∏ ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞(ÏûëÍ≤å) */
#skPreviewCard.skillPreviewCard.v2 #skCoinRow .skCoinIcon{
  width:16px;
  height:16px;
}

/* ÌÉÄÏù¥ÌãÄÎ∞îÎèÑ Í∞ôÏùÄ Ìè≠ */
#skPreviewCard.skillPreviewCard.v2 #skTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
}

/* ÌîÑÎ†àÏûÑ ÏúÑÏ™Ω Îçî compact */
.skillPreviewCard.v2 .skTop{
  gap: 10px;
}
.skillPreviewCard.v2 .skFrame{
  width: 100px;
  height: 100px;
}

/* ‚úÖ ÏΩîÏù∏ + ÌÉÄÏù¥ÌãÄ Ìïú Ï§ÑÎ°ú */
.skHeaderRow{
  display:flex;
  align-items:center;
  gap: 10px;
}

/* ===== Skill Preview v2 (2Î≤à ÏÇ¨ÏßÑ Ïä§ÌÉÄÏùº) ===== */
.skillPreviewCard.v2{
  width: min(420px, 100%);      /* ‚úÖ 2Î≤àÏ≤òÎüº 'Ïπ¥Îìú Ìè≠'ÏùÑ Ïû°ÏïÑÏ§å */
  margin: 0 auto;

  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  background: rgba(0,0,0,.22);
  padding: 14px;

  display: flex;               /* ‚úÖ 1Ïó¥ ÏÑ∏Î°ú Ïä§ÌÉù */
  flex-direction: column;
  gap: 12px;

  overflow: hidden;
}

.skillPreviewCard.v2 .skTop{
  display:flex;
  flex-direction: column;
  align-items:center;
  gap: 8px;
}

.skillPreviewCard.v2 .skFrame{
  width: 230px;                /* ‚úÖ 2Î≤àÏ≤òÎüº ÏúÑÏóê ÌÅºÏßÅÌïòÍ≤å */
  height: 230px;
}

.skillPreviewCard.v2 .skTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
}

/* ‚úÖ 2Î≤à Ïù¥ÎØ∏ÏßÄ: ÏÑ±Ïû•Í≥ÑÏàò ÎùºÏù∏ */
.skillPreviewCard.v2 .skGrowthRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  margin-top: 2px;
  padding: 6px 8px;
}

.skillPreviewCard.v2 .skGrowthIcon{
  width: 18px;
  height: 18px;
  object-fit: contain;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
  opacity: .95;
}

.skillPreviewCard.v2 .skGrowthText{
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  text-shadow: 0 2px 10px rgba(0,0,0,.45);
  letter-spacing: -.01em;
  display:flex;
  align-items:baseline;
  gap: 6px;
}

.skillPreviewCard.v2 .skGrowthLabel{
  opacity: .92;
}

.skillPreviewCard.v2 .skGrowthPlus{
  opacity: .95;
}

/* Ïä§ÌÉØÌëú v2: 2Î≤à ÏÇ¨ÏßÑÏ≤òÎüº 'Í∞àÏÉâ Î∞îÌÉï + Í∏à ÎùºÏù∏' ÎäêÎÇå */
.skStatTable.skStat2col.v2{
  width: 100%;
  border: 1px solid rgba(202,166,106,.60);
  border-radius: 14px;
  overflow: hidden;
  background: rgba(25,14,8,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.skStatTable.skStat2col.v2 .skStatTr{
  grid-template-columns: 1fr 120px;  /* ‚úÖ Ïò§Î•∏Ï™Ω Í∞í Ïπ∏ Í≥†Ï†ï ÎäêÎÇå */
  border-bottom: 1px solid rgba(202,166,106,.22);
}

.skStatTable.skStat2col.v2 .skStatTh{
  padding: 12px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(45,26,14,.60);
  border-right: 1px solid rgba(202,166,106,.22);
  text-align: left;
}

.skStatTable.skStat2col.v2 .skStatTd{
  padding: 12px 12px;
  justify-content: center;      /* ‚úÖ 2Î≤àÏ≤òÎüº Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  gap: 8px;
  background: rgba(15,10,8,.35);
}

/* Ìö®Í≥º Î∞ïÏä§: 2Î≤àÏ≤òÎüº 'Î≥∏Î¨∏Ïù¥ ÏïÑÎûòÎ°ú Í∏∏Í≤å' */
.skillPreviewCard.v2 .skEffectBox{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  min-height: 160px;
}

/* ÌîÑÎ†àÏûÑ/ÌÉÄÏù¥ÌãÄÎ∞î */
.skFrame{
  width: 260px;
  height: 260px;
  position: relative;
  display:grid;
  place-items:center;
}
.skFrame > img{ width: 100%; height: 100%; object-fit: contain; display:block; }
#skFrameImg{ position:absolute; inset:0; z-index:2; pointer-events:none; }

.skInner{
  position:absolute;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%);

  width: 64%;
  height: 64%;
  border-radius: 999px;
  overflow:hidden;
  display:grid;
  place-items:center;
  z-index:1;
}
.skInner img{ width:100%; height:100%; object-fit:contain; display:none; }

.skTitleBar{
  width: 260px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 12px 14px;
  position: relative;
  overflow:hidden; /* ‚úÖ stripesÍ∞Ä ÌäÄÎ©¥ Ïó¨Í∏∞ÏÑú ÏûòÎ¶º */
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.skTitle{ font-weight: 1000; letter-spacing: -.02em; color: rgba(255,255,255,.92); text-align:left; padding-left: 6px; }

.skTitleStripes{
  position:absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%) skewX(-18deg);
  width: 54px;
  height: 22px;
  border-radius: 6px;
  background:
    linear-gradient(90deg,
      rgba(0,0,0,.0) 0%,
      rgba(0,0,0,.0) 20%,
      rgba(255,255,255,.18) 20%,
      rgba(255,255,255,.18) 32%,
      rgba(0,0,0,.0) 32%,
      rgba(0,0,0,.0) 44%,
      rgba(255,255,255,.18) 44%,
      rgba(255,255,255,.18) 56%,
      rgba(0,0,0,.0) 56%,
      rgba(0,0,0,.0) 68%,
      rgba(255,255,255,.18) 68%,
      rgba(255,255,255,.18) 80%,
      rgba(0,0,0,.0) 80%,
      rgba(0,0,0,.0) 100%);
}

/* ÏΩîÏù∏ ÏïÑÏù¥ÏΩò */
.skCoinRow{
  display:flex;
  justify-content:center;
  gap:6px;
  margin: 8px 0 6px 0;
}
.skCoinIcon{ width: 22px; height: 22px; object-fit:contain; }

/* ===== Ïä§ÌÉØÌëú (ÏÇêÏ†∏ÎÇòÏò¥ Î∞©ÏßÄ) ===== */
.skStatTable.skStat2col{
  width: 100%;
  border: 1px solid rgba(202,166,106,.55);
  border-radius: 14px;
  overflow: hidden; /* ‚úÖ Ìëú ÌÖåÎëêÎ¶¨ ÏÇêÏ†∏ÎÇòÏò¥ Î∞©ÏßÄ */
  background: rgba(0,0,0,.28);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
  min-width: 0;     /* ‚úÖ */
}

.skStatTr{
  display: grid;
  grid-template-columns: 140px 1fr;
  border-bottom: 1px solid rgba(202,166,106,.22);
  min-width: 0;
}
.skStatTr:last-child{ border-bottom: none; }

.skStatTh{
  padding: 14px 16px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: linear-gradient(180deg, rgba(60,40,18,.65), rgba(20,12,8,.45));
  border-right: 1px solid rgba(202,166,106,.22);
  letter-spacing: .01em;
  min-width: 0;
}

.skStatTd{
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 10px;
  font-weight: 1000;
  color: rgba(238,241,255,.95);
  background: linear-gradient(180deg, rgba(40,26,14,.55), rgba(12,10,10,.35));
  min-width: 0;              /* ‚úÖ */
  overflow: hidden;          /* ‚úÖ */
  text-overflow: ellipsis;   /* ‚úÖ */
  white-space: nowrap;       /* ‚úÖ */
}

.skMiniIcon, .skStatIcon{
  width: 22px;
  height: 22px;
  object-fit: contain;
  flex: 0 0 auto;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
}

/* ===== Coin Effect inline icon (in description text) ===== */
.coinEff{
  display:inline-flex;
  align-items:center;
  gap:6px;
  vertical-align: middle;
  margin: 0 2px;
  line-height: 0;           /* Í∏ÄÏûê line-height ÏòÅÌñ• Ï†úÍ±∞ */
}

.coinEffIcon{
  position: relative;
  width: 22px;              /* ‚úÖ 22 -> 16 */
  height: 22px;             /* ‚úÖ 22 -> 16 */
  flex: 0 0 22px;            /* ‚úÖ Í≥†Ï†ï */
  display: block;
  vertical-align: middle;
  line-height: 0;
}

.coinEffIcon img{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

.coinEffRoman{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(.86); /* ‚úÖ ÏÇ¥Ïßù Ï∂ïÏÜå */
  width:100%;
  text-align:center;
  font-size: 9px;              /* ‚úÖ ÏûëÍ≤å */
  font-weight: 1000;
  letter-spacing: -0.08em;     /* ‚úÖ Í∏¥ Î°úÎßàÏà´Ïûê Ìè≠ Ï§ÑÏù¥Í∏∞ */
  white-space: nowrap;         /* ‚úÖ Ï§ÑÎ∞îÍøà Í∏àÏßÄ */
  line-height: 1;              /* ‚úÖ ÏúÑÏïÑÎûò ÏÇêÏ†∏ÎÇòÏò¥ Î∞©ÏßÄ */
  color: rgba(255,255,255,.95);
  text-shadow: 0 2px 6px rgba(0,0,0,.70);
  pointer-events:none;
  overflow:hidden;             /* ‚úÖ ÎßàÏßÄÎßâ ÏïàÏ†ÑÏû•Ïπò */
}

/* ‚úÖ ÌîÑÎ†àÏûÑ Ïù¥ÎØ∏ÏßÄÎ•º Î∞ïÏä§Ïóê 'Îî±' Î∂ôÏó¨ÏÑú Í∑∏Î¶¨Í∏∞ */
.coinEffIcon img{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

/* Ìö®Í≥º Î∞ïÏä§ */
.skEffectBox{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  min-height: 220px;
  white-space: pre-normal;
  line-height: 1.75;
  font-size: 13px;
  color: rgba(238,241,255,.92);
  min-width: 0;
  overflow-wrap: anywhere; /* ‚úÖ Í∏¥ ÌÖçÏä§Ìä∏ÎèÑ ÌäÄÏßÄ ÏïäÍ≤å */
}

/* ===== Ìé∏Ïßë ÏòÅÏó≠(Í∞ÄÏö¥Îç∞) ===== */
#skText{
  height: 320px;
  resize: vertical;
  line-height: 1.85;
  font-size: 14px;
  text-align: left;
}

/* ===== Ï†ÄÏû•Îêú Ïä§ÌÇ¨(Îß® ÏïÑÎûò Ï†ÑÏ≤¥Ìè≠) ===== */
.skillSavedBox{
  grid-column: 1 / -1;
}

.skillSlots{
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
  align-items: flex-end;
}

.skSlot{
  width: 96px;
  height: 96px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  display:grid;
  place-items:center;
  overflow:hidden;
  cursor:pointer;
  position: relative;
  flex: 0 0 auto;
}

.skSlot.active{
  border-color: rgba(202,166,106,.65);
  box-shadow: 0 0 0 2px rgba(202,166,106,.18) inset;
}

.skSlot .slotFrame{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: contain;
}

.skSlot .slotInner{
  position:absolute;
  inset:18%;           /* ÎÇ¥Î∂Ä ÏõêÌòï ÏòÅÏó≠ ÌÅ¨Í∏∞ */
  border-radius:999px;
  overflow:hidden;
  display:grid;
  place-items:center;
}

.skSlot .slotInner img{
  width:100%;
  height:100%;
  object-fit: contain;
  display:block;
}

.skSlot > img{
  width:100%;
  height:100%;
  object-fit: contain;
  display:block;
}

/* ===== Î∞òÏùëÌòï ===== */
@media (max-width: 1280px){
  .skillTopGrid{ grid-template-columns: 1fr; }
  .skillPreviewCard{ grid-template-columns: 1fr; }
  .skTitleBar, .skFrame{ width: 100%; max-width: 360px; }
}

/* ===== Coin Sign Layout (Skill) ===== */
.coinWrap{
  display:flex;
  align-items:center;
  gap:10px;
}

.coinSignBtn{
  width:44px;
  height:44px;
  display:grid;
  place-items:center;
  padding:0;
  font-weight:1000;
}

/* ===== Skill List (Saved Skills -> List Cards) ===== */
.skList{
  display:flex;
  flex-direction:column;
  gap: 12px;
  margin-top: 10px;
}

.skListCard{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: 16px;
  overflow:hidden;
  cursor:pointer;
  transition: background .15s ease, border-color .15s ease, transform .08s ease;
}
/* Îß§Ïπò ÌôîÎ©¥ "ÌòÑÏû¨ ÎΩëÏùÄ Ïä§ÌÇ¨" 2Ïó¥ Î∞∞Ïπò + Ï∂ïÏÜå */
#myPickedSkills,
#enemyPickedSkills{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:8px;
  align-items:start;
}

#myPickedSkills .skillPickItem,
#enemyPickedSkills .skillPickItem{
  margin:0 !important;
}

.matchPickedMini{
  margin:0 !important;
  width:auto !important;
  zoom:.36;                 /* Í∏∞Ï°¥Î≥¥Îã§ Îçî Ï∂ïÏÜå */
  transform-origin: top left;
}

/* Ï§åÏúºÎ°ú ÏÉùÍ∏∞Îäî ÏïÑÎûò Ïó¨Î∞± Ï§ÑÏù¥Í∏∞ */
#myPickedSkills .matchPickedMini,
#enemyPickedSkills .matchPickedMini{
  display:block;
}

/* Ïπ¥Îìú Ïïà Ïù¥ÎØ∏ÏßÄ/Î≥∏Î¨∏ Í≥ºÌïú ÎÜíÏù¥ Ï°∞Í∏à Îçî ÏïïÏ∂ï */
#myPickedSkills .matchPickedMini .skListFrame,
#enemyPickedSkills .matchPickedMini .skListFrame{
  margin-bottom:4px !important;
}

#myPickedSkills .matchPickedMini .skListFx,
#enemyPickedSkills .matchPickedMini .skListFx{
  max-height:70px !important;
}.skListCard:hover{
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.18);
}
.skListCard:active{ transform: translateY(1px); }
.skListCard.active{
  box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
  border-color: rgba(202,166,106,.35);
}

.skListTop{
  display:grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  padding: 12px;
  align-items: start;
}

.skListArt{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 8px;
  min-width:0;
}
.skListFrame{
  width: 110px;
  height: 110px;
  position: relative;
  display:grid;
  place-items:center;
}
.skListFrame > img{ width:100%; height:100%; object-fit:contain; display:block; }
.skListFrame .inner{
  position:absolute;
  inset: 18%;
  border-radius: 999px;
  overflow:hidden;
  display:grid;
  place-items:center;
}
.skListFrame .inner img{ width:100%; height:100%; object-fit:contain; display:block; }

/* ‚úÖ Ïä§ÌÇ¨ Î™©Î°ù ÌîÑÎ†àÏûÑ/ÎÇ¥Î∂Ä Ïù¥ÎØ∏ÏßÄ Î†àÏù¥Ïñ¥ Í≥†Ï†ï (ÌîÑÎ†àÏûÑÏù¥ Ìï≠ÏÉÅ ÏúÑ) */
.skListFrame{
  position: relative;
  overflow: hidden; /* ÌòπÏãú Î™®Î•º ÏÇêÏ†∏ÎÇòÏò¥ Î∞©ÏßÄ */
}

/* ÌîÑÎ†àÏûÑ Ïù¥ÎØ∏ÏßÄÎ•º 'ÏúÑ'Î°ú */
.skListFrame > img{
  position: absolute;
  inset: 0;
  z-index: 2;
  pointer-events: none;
}

/* Ïú†Ï†Ä Ïù¥ÎØ∏ÏßÄ(ÎÇ¥Î∂Ä)Î•º 'ÏïÑÎûò'Î°ú + ÏõêÌòï ÌÅ¥Î¶Ω Ïú†ÏßÄ */
.skListFrame .inner{
  position: absolute;
  inset: 18%;
  z-index: 1;
  border-radius: 999px;
  overflow: hidden;
}

/* ÎÇ¥Î∂Ä Ïù¥ÎØ∏ÏßÄÎäî ÌÅ¥Î¶Ω ÏïàÏóêÏÑúÎßå */
.skListFrame .inner img{
  width: 100%;
  height: 100%;
  object-fit: contain; /* ÎØ∏Î¶¨Î≥¥Í∏∞Îûë ÎèôÏùº ÎäêÎÇåÏù¥Î©¥ contain */
  display: block;
}

.skListCoins{
  display:flex;
  justify-content:center;
  gap: 4px;
}
.skListCoins img{ width: 16px; height: 16px; object-fit:contain; }

.skListMain{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap: 10px;
}

.skListTitleBar{
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 10px 12px;
  position: relative;
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
.skListTitle{
  font-weight: 1000;
  letter-spacing: -.02em;
  color: rgba(255,255,255,.92);
  padding-left: 4px;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

.skListStat{
  width: 100%;
  border: 1px solid rgba(202,166,106,.35);
  border-radius: 14px;
  overflow:hidden;
  background: rgba(0,0,0,.22);
}
.skListStatRow{
  display:grid;
  grid-template-columns: 120px 1fr;
  border-bottom: 1px solid rgba(202,166,106,.18);
}
.skListStatRow:last-child{ border-bottom:none; }
.skListStatTh{
  padding: 10px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(60,40,18,.45);
  border-right: 1px solid rgba(202,166,106,.18);
}
.skListStatTd{
  padding: 10px 12px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap: 8px;
  font-weight: 1000;
  color: rgba(238,241,255,.92);
  background: rgba(20,12,8,.25);
}

.skListActions{
  padding: 0 12px 12px;
  display:flex;
  justify-content:center;
}

.skListToggle{
  width: 100%;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);
  padding: 10px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  cursor:pointer;
}
.skListToggle:hover{
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.18);
}

.skListBody{
  padding: 0 12px 12px;
  display:none;
}
.skListBody.open{ display:block; }

.skListEffect{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  white-space: pre-wrap;
  line-height: 1.75;
  font-size: 13px;
  color: rgba(238,241,255,.92);
}

/* Î∞òÏùëÌòï */
@media (max-width: 980px){
  .skListTop{ grid-template-columns: 1fr; }
  .skListArt{ flex-direction:row; justify-content:center; }
}

/* ===== Keyword Tooltip ===== */
.kwTip.hidden{ display:none; }

.kwTip{
  position: fixed;
  z-index: 9999999;
  pointer-events: none; /* Ìà¥ÌåÅ ÏúÑÏóê ÎßàÏö∞Ïä§Í∞Ä Ïò¨ÎùºÍ∞ÄÎèÑ ÍπúÎπ°ÏûÑ Î∞©ÏßÄ */
}

/* ===== Keyword Modal Buff/Debuff Toggle ===== */
.kwStateToggle{
  font-weight: 900;
  font-size: 13px;
  padding: 8px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.18);
  border: 2px solid rgba(243,211,154,.95); /* Í∏∞Î≥∏: Î≤ÑÌîÑ(ÎÖ∏ÎûÄ ÌÖåÎëêÎ¶¨) */
  color: rgba(243,211,154,.98);
}

.kwStateToggle.debuff{
  border-color: rgba(255,75,75,.90);       /* ÎîîÎ≤ÑÌîÑ: Îπ®Í∞Ñ ÌÖåÎëêÎ¶¨ */
  color: rgba(255,120,120,.98);            /* ÎîîÎ≤ÑÌîÑ: Îπ®Í∞Ñ Í∏ÄÏî® */
}

/* ===== Keyword Modal Tabs ===== */
.kwTabs{
  display:flex;
  gap:8px;
  padding:6px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius: 999px;
}

.kwTab{
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.10);
  background: transparent;
  color: rgba(238,241,255,.70);
}

.kwTab.active{
  color: rgba(243,211,154,.98);
  border-color: rgba(202,166,106,.55);
  background: rgba(202,166,106,.14);
}

.kwTipBox{
  width: min(380px, 90vw);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px;
  background: rgba(10,10,12,.96);
  box-shadow: 0 18px 60px rgba(0,0,0,.60);
  padding: 12px;
  display: grid;
  grid-template-columns: 68px 1fr;
  gap: 12px;
}

.kwTipIcon{
  width: 68px; height: 68px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25);
  overflow: hidden;
  display: grid;
  place-items: center;
}
.kwTipIcon img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display:block;
}

.kwTipTitle{
  font-weight: 900;
  margin-bottom: 6px;
}

/* Î≤ÑÌîÑ */
.kwTipTitle.buff{
  color: rgba(243,211,154,.95);
}

/* ÎîîÎ≤ÑÌîÑ */
.kwTipTitle.debuff{
  color: rgba(255,120,120,.98);
}
.kwTipText{
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 13px;
  color: rgba(238,241,255,.85);
}

.kwTipTitle.debuff{
  color: rgba(255,120,120,.98);
}
.kwTipTitle.buff{
  color: rgba(243,211,154,.95);
}

/* ===== Skill List (Grid) ===== */
#skListNormal,
#skListSpecial{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 14px;
  align-items: start;
}

/* ÌôîÎ©¥ ÎÑìÏùÑ Îïå Ï°∞Í∏à Îçî Ï¥òÏ¥òÌïòÍ≤å */
@media (min-width: 1400px){
  #skListNormal,
  #skListSpecial{
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  }
}

/* === Saved Skill Card -> v2(ÏÑ∏Î°ú 1Ïó¥) === */
.skListCard{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: 18px;
  overflow:hidden;
}

.skListTop{
  display:flex;
  flex-direction: column;
  align-items:center;
  gap: 12px;
  padding: 14px;
}

.skListArt{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 8px;
}

.skListFrame{
  width: 230px;
  height: 230px;
}

.skListCoins{
  display:flex;
  justify-content:center;
  gap:6px;
}

.skListTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 12px 14px;
  position: relative;
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}

.skListTitle{
  font-weight: 1000;
  letter-spacing: -.02em;
  color: rgba(255,255,255,.92);
  padding-left: 6px;
  text-align:left;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

/* Í≥µÍ≤©Î†àÎ≤®/ÏÑ±Ïû•Í≥ÑÏàò Ï§Ñ */
.skListGrowthRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  margin-top: 2px;
  padding: 6px 8px;
}

.skListGrowthIcon{
  width: 18px;
  height: 18px;
  object-fit: contain;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
  opacity: .95;
}

.skListGrowthText{
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  text-shadow: 0 2px 10px rgba(0,0,0,.45);
  letter-spacing: -.01em;
  display:flex;
  align-items:baseline;
  gap: 6px;
}

/* Ïä§ÌÉØÌëúÎ•º ÎØ∏Î¶¨Î≥¥Í∏∞(v2) Ïä§ÌÉÄÏùºÎ°ú */
.skListStat{
  width: 100%;
  max-width: 360px;
  border: 1px solid rgba(202,166,106,.60);
  border-radius: 14px;
  overflow: hidden;
  background: rgba(25,14,8,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.skListStatRow{
  display:grid;
  grid-template-columns: 1fr 120px;
  border-bottom: 1px solid rgba(202,166,106,.22);
}
.skListStatRow:last-child{ border-bottom:none; }

.skListStatTh{
  padding: 12px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(45,26,14,.60);
  border-right: 1px solid rgba(202,166,106,.22);
  text-align:left;
}

.skListStatTd{
  padding: 12px 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  font-weight: 1000;
  color: rgba(238,241,255,.92);
  background: rgba(15,10,8,.35);
}

/* ===== View Mode (Read Only) ===== */
.readonly input,
.readonly textarea,
.readonly select{
  pointer-events:none;
  opacity:.92;
}
.readonly .file input[type="file"]{ pointer-events:none; }
.readonly .row-actions,
.readonly .dkFooterBar,
.readonly #pvAddBtn,
.readonly #pvSaveBtn,
.readonly #pvDeleteBtn,
.readonly #dkAddBtn,
.readonly #dkSaveBtn,
.readonly #dkDeleteBtn,
.readonly #btnSaveCore,
.readonly #btnResetCore,
.readonly #skSaveBtn,
.readonly #skNewBtn,
.readonly #skDeleteBtn,
.readonly #btnClearImg,
.readonly #dkIconClear,
.readonly #skImgClear{
  display:none !important;
}

/* ===== View Mode: CORE Ï†ÑÏö© UI Ï†ïÎ¶¨ ===== */
.readonly .upload-row{ display:none !important; }      /* ‚úÖ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú/Ï†úÍ±∞ Ï§Ñ ÌÜµÏß∏Î°ú Ï†úÍ±∞ */
.readonly .staggerActions{ display:none !important; }  /* ‚úÖ ÌùêÌä∏ Ï∂îÍ∞Ä/ÏÇ≠Ï†ú Î≤ÑÌäº Ï†úÍ±∞ */

/* ===== View Mode: trait keyword chips ===== */
.traitChips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.traitChip{
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(202,166,106,.35);
  background: rgba(0,0,0,.18);
  color: rgba(243,211,154,.95);
  font-weight: 900;
  font-size: 13px;
  line-height: 1.2;
}

.traitChip.deleted{
  border-color: rgba(255,75,75,.55);
  color: rgba(255,120,120,.98);
  text-decoration: line-through;
  text-decoration-thickness: 2px;
  text-decoration-color: rgba(255,180,180,.95);
}

/* ===== View Mode: trait keyword line ===== */
.traitLine{
  border: 1px solid rgba(202,166,106,.40);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.18));
  padding: 12px 14px;
  color: rgba(243,211,154,.95);
  font-weight: 900;
  letter-spacing: -.01em;
  line-height: 1.45;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.readonly #traitKwList{ display:none !important; }  /* ‚úÖ Í∏∞Ï°¥ Ìé∏Ïßë Î¶¨Ïä§Ìä∏ Ïà®ÍπÄ */
.readonly .kwFooter{ display:none !important; }     /* ‚úÖ 'ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä' Î≤ÑÌäº ÏòÅÏó≠ Ïà®ÍπÄ */

/* ===== View Mode: Name title vibe ===== */
.readonly #charName{
  background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.22));
  border-color: rgba(202,166,106,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.35);
  padding: 14px 16px;
}

/* ‚úÖ Ìé∏ÏßëÎ™®ÎìúÏóêÏÑúÎäî Î≥¥Í∏∞Ï†ÑÏö© ÏöîÏïΩ(Ïπ©) Ïà®ÍπÄ */
.traitLine{ display:none; }
.readonly .traitLine{ display:block; }

/* ===== View Mode: PASSIVE Ï†ÑÏö© UI Ï†ïÎ¶¨ ===== */
.readonly #panel-passive .passTop{ 
  display:none !important;            /* ‚úÖ ÏúÑ Ìé∏ÏßëÎûÄ ÌÜµÏß∏Î°ú Ï†úÍ±∞ */
}

.readonly #panel-passive .pvBoardHead{
  display:none !important;            /* ‚úÖ "ÏïÑÎûò Î™©Î°ùÏóêÏÑú..." + Ï∂îÍ∞ÄÎ≤ÑÌäº Ï§Ñ Ï†úÍ±∞ */
}

.readonly #panel-passive .pvBoardBox{
  margin-top: 0 !important;           /* ‚úÖ ÏúÑÍ∞Ä ÏÇ¨ÎùºÏ†∏ÏÑú Îú®Îäî Ïó¨Î∞± Ï†úÍ±∞ */
}

/* ===== View Mode: SKILL Ï†ÑÏö© (Î™©Î°ùÎßå ÎÇ®Í∏∞Í∏∞) ===== */
.readonly #panel-skill .skillTopGrid{
  display:none !important;   /* ‚úÖ ÎØ∏Î¶¨Î≥¥Í∏∞/Ìé∏Ïßë/ÏàòÏπò 3Ïó¥ ÌÜµÏß∏Î°ú Ïà®ÍπÄ */
}
.readonly #panel-skill .skillSavedBox{
  display:block !important;  /* ‚úÖ Ïä§ÌÇ¨ Î™©Î°ùÏùÄ Ïú†ÏßÄ */
}

/* ===== View Mode: PASSIVE only list ===== */
.readonly #panel-passive .passTop{ display:none !important; }      /* ÏúÑ Ìé∏ÏßëÎûÄ Ï†úÍ±∞ */
.readonly #panel-passive .pvBoardHint{ display:none !important; }  /* ÏïàÎÇ¥Î¨∏ Ï†úÍ±∞ */

/* ===== View Mode: SKILL only list ===== */
.readonly #panel-skill .skillTopGrid{ display:none !important; }   /* ÎØ∏Î¶¨Î≥¥Í∏∞/Ìé∏Ïßë/ÏàòÏπò Ï†úÍ±∞ */
.readonly #panel-skill .skillSavedBox{ margin-top: 0 !important; } /* ÏúÑÍ∞Ä ÏÇ¨ÎùºÏ†∏ÎèÑ Î∂ôÍ≤å */

/* ===== View Mode: DK only list ===== */
.readonly #panel-dk .dkTop{ display:none !important; }             /* ÏúÑ Ìé∏Ïßë 3Ïπ∏ Ï†úÍ±∞ */
.readonly #panel-dk .dkListBox > div:first-child{ display:none !important; } /* ÏïàÎÇ¥Î¨∏ Ï†úÍ±∞ */

/* ===== Skill Kind Toggle ===== */
.skKindToggle{
  display:flex;
  gap:8px;
}

.skKindBtn{
  flex:1;
  border-radius:12px;
  font-weight:900;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  color: rgba(238,241,255,.82);
}

.skKindBtn.active{
  color: rgba(243,211,154,.98);
  border-color: rgba(202,166,106,.60);
  background: rgba(202,166,106,.14);
  box-shadow: 0 0 0 1px rgba(202,166,106,.16) inset;
}

#skSpawnWrap.disabled{
  opacity:.55;
}
#skSpawnWrap.disabled input{
  pointer-events:none;
}

#sanityPanicText, #sanityGainText, #sanityLossText{
  width:100%;
  min-height:84px;
  resize:vertical;
}

/* ===== AI ÏÉÅÎåÄ ÌÖåÎßà ÌÖçÏä§Ìä∏ (ÎáåÌö°) ===== */
.aiEnemyName.leiheng{
  font-weight: 1000;
  font-size: 18px;
  line-height: 1.15;
  letter-spacing: .3px;
  color: #f1c25a;
  text-shadow:
    0 0 10px rgba(180,20,20,.35),
    0 1px 0 rgba(0,0,0,.85);
}

.aiEnemySub.leiheng{
  margin-top: 2px;
  font-weight: 900;
  font-size: 13px;
  letter-spacing: .2px;
  color: #ffd46f;
  text-shadow:
    0 0 8px rgba(140,10,10,.28),
    0 1px 0 rgba(0,0,0,.85);
}

.aiEnemyDesc{
  margin-top: 10px;
  color: rgba(238,241,255,.95);
}

/* ===== ÎáåÌö° ÌÖåÎßà ÌÖçÏä§Ìä∏ ===== */
.lhThemeName{
  display:block;
  font-weight:1000;
  letter-spacing:.04em;
  line-height:1.05;
  color:#d7ecff;
  text-shadow:
    0 0 10px rgba(110,190,255,.35),
    0 0 20px rgba(80,150,255,.20),
    0 2px 10px rgba(0,0,0,.65);
}

.lhThemeSub{
  display:block;
  margin-top:3px;
  font-size:12px;
  font-weight:800;
  letter-spacing:.12em;
  color:rgba(188,222,255,.92);
  text-shadow: 0 1px 8px rgba(0,0,0,.55);
}

.lhThemeMeta{
  border:1px solid rgba(120,190,255,.22) !important;
  background:
    linear-gradient(180deg, rgba(70,120,170,.14), rgba(20,30,45,.14)),
    rgba(255,255,255,.04) !important;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.03),
    0 8px 20px rgba(0,0,0,.18);
}

/* ===== AI Ï†Å Î©îÌÉÄ ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà Ïú†ÏßÄ ===== */
#playEnemyCharMeta{
  white-space: pre-line;
}

/* ===== ÎáåÌö° Ïù¥Î¶Ñ ÌÖåÎßà ===== */
#playEnemyCharMeta .aiNameLei{
  display:block;
  font-weight: 1000;
  font-size: 20px;
  line-height: 1.1;
  letter-spacing: .04em;
  color: #ffd87a;
  text-shadow:
    0 0 10px rgba(255,140,40,.35),
    0 0 20px rgba(255,70,70,.25),
    0 2px 8px rgba(0,0,0,.65);
}

/* ===== ÎáåÌö° Î∂ÄÏ†ú ÌÖåÎßà ===== */
#playEnemyCharMeta .aiSubLei{
  display:block;
  margin-top: 2px;
  margin-bottom: 8px;
  font-weight: 800;
  font-size: 12px;
  letter-spacing: .10em;
  color: rgba(255,215,130,.92);
  text-shadow: 0 1px 6px rgba(0,0,0,.55);
}

.aiInfoActions{
  margin-top:10px;
  display:flex;
  gap:8px;
}

.aiWaveInfoPanel{
  margin-top:10px;
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  background:rgba(0,0,0,.22);
  overflow:hidden;
}

.aiWaveInfoPanel.hidden{ display:none; }

.aiWaveInfoHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
}
.aiWaveInfoHead .t{
  font-weight:900;
  color:rgba(243,211,154,.95);
}
.aiWaveInfoHead .x{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  color:rgba(238,241,255,.9);
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
}

.aiWaveInfoList{
  padding:10px;
  display:grid;
  gap:8px;
}

.aiWaveCard{
  border:1px solid rgba(255,255,255,.10);
  border-radius:12px;
  background:rgba(255,255,255,.02);
  padding:10px;
  display:grid;
  gap:8px;
}
.aiWaveTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.aiWaveTitle{
  font-weight:900;
  color:rgba(238,241,255,.96);
}
.aiWaveTag{
  font-size:12px;
  font-weight:900;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
}
.aiWaveTag.boss{
  color:rgba(255,120,120,.98);
}
.aiWaveTag.enemy{
  color:rgba(243,211,154,.95);
}
.aiWaveDesc{
  color:rgba(238,241,255,.72);
  font-size:13px;
  white-space:pre-wrap;
}
.aiWaveBtn{
  justify-self:start;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  color:rgba(238,241,255,.92);
  border-radius:10px;
  padding:7px 10px;
  cursor:pointer;
}
.aiWaveBtn[disabled]{
  opacity:.5;
  cursor:not-allowed;
}

/* ===== MATCH UI ===== */
.matchHome{ padding: 18px; }
.matchBoard{
  display:grid;
  grid-template-columns: minmax(360px, 1fr) 420px minmax(360px, 1fr);
  gap: 14px;
  align-items:start;
}
.teamPanel{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  background: rgba(0,0,0,.22);
  overflow:hidden;
  box-shadow: 0 12px 35px rgba(0,0,0,.28);
}
.teamPanel.enemy{
  border-color: rgba(255,120,120,.18);
}
.teamPanel.my{
  border-color: rgba(202,166,106,.30);
}

.teamHead{
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,.10);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
}
.teamNameWrap{ min-width:0; }
.teamSide{
  font-size:11px;
  color: var(--muted);
  font-weight:700;
}
.teamName{
  font-size:16px;
  font-weight:1000;
  color: rgba(255,255,255,.95);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.spdBadge{
  border:1px solid rgba(255,255,255,.16);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  background: rgba(0,0,0,.22);
  white-space:nowrap;
}

.teamBody{
  padding: 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.teamMainGrid{
  display:grid;
  grid-template-columns: 120px 1fr;
  gap:10px;
}
.portraitMini{
  height: 160px;
  border:1px solid rgba(255,255,255,.10);
  border-radius: 12px;
  background: rgba(0,0,0,.22);
  display:grid;
  place-items:center;
  overflow:hidden;
}
.portraitMini img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:none;
}
.portraitMini .ph{
  color: var(--muted);
  font-size:12px;
}

.coreInfoStack{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0;
}
.miniBlock{
  border:1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  background: rgba(255,255,255,.02);
  padding: 8px;
}
.miniLabel{
  font-size:12px;
  font-weight:900;
  color: rgba(243,211,154,.95);
  margin-bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.miniBtn{
  padding:6px 8px;
  font-size:11px;
  border-radius: 10px;
}

.miniStatGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:6px;
}
.statMiniCell{
  border:1px solid rgba(255,255,255,.08);
  border-radius:10px;
  padding:6px 8px;
  background: rgba(0,0,0,.18);
  display:flex;
  justify-content:space-between;
  gap:6px;
  font-size:12px;
}
.statMiniCell b{ color: rgba(243,211,154,.92); }
.statMiniCell span{
  font-weight:900;
  color: rgba(255,255,255,.92);
}

.staggerMiniLine{
  border:1px solid rgba(202,166,106,.25);
  border-radius:10px;
  padding:7px 8px;
  background: rgba(35,20,10,.22);
  font-size:12px;
  line-height:1.45;
  color: rgba(255,255,255,.9);
}

.staggerMiniWrap{
  border:1px solid rgba(255,255,255,.10);
  border-radius:10px;
  padding:8px 10px;
  background:rgba(255,255,255,.02);
}
.staggerMiniBar{
  position:relative;
  height:12px;
  border-radius:999px;
  border:1px solid rgba(202,166,106,.45);
  background:linear-gradient(90deg, rgba(217,90,43,.95), rgba(240,122,51,.95));
  overflow:hidden;
}
.staggerMiniMark{
  position:absolute;
  top:-1px;
  width:3px;
  height:14px;
  background:rgba(255,255,255,.9);
  box-shadow:0 0 0 1px rgba(0,0,0,.2);
}
.staggerMiniLabels{
  margin-top:6px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  font-size:12px;
  color:rgba(243,211,154,.95);
  font-weight:800;
}
.staggerMiniLabels span{
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
}

.resWrap{ display:flex; flex-direction:column; gap:6px; }
.resLine{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.resChip{
  border:1px solid rgba(255,255,255,.10);
  border-radius:999px;
  padding:4px 8px;
  font-size:11px;
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.88);
}
.resChip .k{ color: var(--muted); }
.resChip .v{ font-weight:900; }

.chipWrap{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  min-height: 24px;
}
.chip{
  border:1px solid rgba(255,255,255,.10);
  border-radius:999px;
  padding:4px 8px;
  font-size:11px;
  background: rgba(255,255,255,.03);
}
.chip.buff{
  border-color: rgba(202,166,106,.40);
  color: rgba(243,211,154,.95);
}
.chip.debuff{
  border-color: rgba(255,75,75,.45);
  color: rgba(255,120,120,.98);
}
.chip.empty{
  color: var(--muted);
  border-style:dashed;
}

.passivePreviewLine{
  color: rgba(238,241,255,.85);
  font-size:12px;
  line-height:1.45;
  min-height: 18px;
}

.slotGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:8px;
}
.slotBtn{
  border:1px solid rgba(255,255,255,.12);
  border-radius:10px;
  background: rgba(0,0,0,.22);
  padding:8px;
  text-align:center;
  font-size:12px;
  cursor:pointer;
}
.slotBtn.active{
  border-color: rgba(202,166,106,.60);
  background: rgba(202,166,106,.12);
}
.slotBtn.ai{
  border-color: rgba(255,120,120,.35);
}

.pickedSkillList, .specialSkillList{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.skillPickItem{
  border:1px solid rgba(255,255,255,.10);
  border-radius:10px;
  padding:8px;
  background: rgba(0,0,0,.20);
  font-size:12px;
  line-height:1.45;
}
.skillPickItem .nm{
  font-weight:900;
  color: rgba(255,255,255,.94);
}
.skillPickItem .meta{
  color: var(--muted);
  margin-top:2px;
}
.skillPickItem button{
  margin-top:6px;
  width:100%;
  padding:7px 8px;
  font-size:11px;
  border-radius: 10px;
}

.centerPanel{
  position:sticky;
  top: 14px;
}
.turnCard{
  border:1px solid rgba(202,166,106,.32);
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(35,24,12,.30), rgba(0,0,0,.20));
  padding: 10px;
}
.turnTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.turnLabel{
  font-size:11px;
  color: var(--muted);
  font-weight:800;
}
.turnNum{
  font-size:26px;
  font-weight:1000;
  line-height:1;
  color: rgba(243,211,154,.95);
}
.turnBtns{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.turnBtns button{
  padding:8px 10px;
  font-size:12px;
  border-radius:10px;
}
.turnInfoRows{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.turnInfoRow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:12px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:10px;
  padding:7px 8px;
  background: rgba(0,0,0,.18);
}
.turnInfoRow span:first-child{ color: var(--muted); }
.turnInfoRow span:last-child{ font-weight:900; }

.matchLogBox{
  height: 420px;
  overflow:auto;
  padding: 10px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.25);
  border-radius: 14px;
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 12px;
  color: rgba(238,241,255,.85);
}

@media (max-width: 1480px){
  .matchBoard{
    grid-template-columns: 1fr;
  }
  .centerPanel{
    position: static;
    order: -1;
  }
}

  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <h1>Î¶ºÎ≤ÑÏä§ Ïª¥ÌçºÎãà Ïï†ÎìúÏò®</h1>
        <p class="sub">Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë + Ï†ÑÏö© ÌÇ§ÏõåÎìú(ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ)</p>
      </div>
      <div class="pill">core v1.0</div>
    </header>

    <!-- HOME -->
    <section class="screen card" id="view-home">
      <div class="home">
        <h2>Î¶ºÎ≤ÑÏä§ Ïª¥ÌçºÎãà ÏµúÍ∞ïÏûêÏ†Ñ</h2>
        <p>ÌîåÎ†àÏù¥ÌïòÍ±∞ÎÇò Ï∫êÎ¶≠ÌÑ∞Î•º ÎßåÎì§Ïñ¥ÏÑú, ÏµúÍ∞ïÏùÑ Í∞ÄÎ†§Î≥¥Ïûê.</p>
        <div class="actions">
          <button class="primary" id="btn-play" type="button">ÌîåÎ†àÏù¥</button>
          <button id="btn-go-editor" type="button">Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞</button>
          <button id="btn-go-library" type="button">Ï∫êÎ¶≠ÌÑ∞ Î≥¥Í∏∞ Î∞è Î∂àÎü¨Ïò§Í∏∞</button>
        </div>
        <div class="toast" id="home-toast"></div>
      </div>
    </section>

<!-- PLAY MODE SELECT -->
<section class="screen card hidden" id="view-play-mode">
  <div class="home">
    <h2>ÌîåÎ†àÏù¥ ÏÑ†ÌÉù</h2>
    <p>Ïñ¥Îñ§ Î∞©ÏãùÏúºÎ°ú ÌîåÎ†àÏù¥Ìï†ÏßÄ Í≥®ÎùºÏ§ò.</p>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px;">
      <button id="btn-play-char" type="button" class="primary" style="padding:18px 12px; font-size:16px; font-weight:900;">
        Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏ†Ñ
      </button>

      <button id="btn-play-ai" type="button" style="padding:18px 12px; font-size:16px; font-weight:900;">
        AI ÎåÄÏ†Ñ
      </button>
    </div>

    <div class="actions" style="margin-top:14px;">
      <button class="ghost" id="btn-play-mode-back" type="button">ÌôàÏúºÎ°ú</button>
    </div>

    <div class="toast" id="playModeToast"></div>
  </div>
</section>

<!-- PLAY LOBBY -->
<section class="screen card hidden" id="view-play">
  <div class="home">
    <h2>Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏ†Ñ</h2>
    <p>ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÏÉÅÎåÄÎ•º Í≥®ÎùºÏÑú Îß§ÏπòÎ•º ÏãúÏûëÌï¥.</p>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px;">
      <div class="frame" style="margin:0;">
        <div class="hdr">ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ <span class="slash"></span></div>
        <div class="body">
          <select id="playMyChar" class="select"></select>
          <div class="toast" id="playMyCharMeta" style="display:block;margin-top:10px;"></div>
        </div>
      </div>

      <div class="frame" style="margin:0;">
        <div class="hdr">ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞ <span class="slash"></span></div>
        <div class="body">
          <select id="playEnemyChar" class="select"></select>
          <div class="toast" id="playEnemyCharMeta" style="display:block;margin-top:10px;"></div>

          <div class="aiInfoActions" style="margin-top:10px;">
            <button type="button" id="btnAiWaveInfo" class="ghost">ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌôïÏù∏</button>
          </div>

          <div id="aiWaveInfoPanel" class="hidden" style="margin-top:10px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(0,0,0,.18);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08);">
              <div style="font-weight:900; color:rgba(243,211,154,.95);">Ïõ®Ïù¥Î∏å ÏÉÅÏÑ∏Ï†ïÎ≥¥</div>
              <button type="button" id="btnAiWaveInfoClose" class="ghost" style="padding:6px 10px;">Îã´Í∏∞</button>
            </div>
            <div id="aiWaveInfoList" style="padding:10px 12px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:14px;">
      <button class="primary" id="btn-start-match" type="button">Îß§Ïπò ÏãúÏûë</button>
      <button id="btn-play-random" type="button">ÏÉÅÎåÄ ÎûúÎç§</button>
      <button class="ghost" id="btn-play-back" type="button">ÌôàÏúºÎ°ú</button>
    </div>

    <div class="toast" id="playToast"></div>
  </div>
</section>

<!-- MATCH -->
<section class="screen card hidden" id="view-match">
  <div class="home matchHome">
    <h2>Îß§Ïπò</h2>
    <p id="matchTitle">-</p>

    <!-- ÏÉÅÎã® Ï†ÑÏû• -->
    <div class="matchBoard" id="matchBoard" style="margin-top:14px;">

      <!-- ÎÇ¥ ÌåÄ (ÏôºÏ™Ω) -->
      <div class="teamPanel my" id="myPanel">
        <div class="teamHead">
          <div class="teamNameWrap">
            <div class="teamSide">ÎÇ¥ ÌåÄ</div>
            <div class="teamName" id="myNameView">-</div>
          </div>
          <div class="spdBadge" id="mySpd">SPD -</div>
        </div>

        <div class="teamBody">
          <div class="teamMainGrid">
            <div class="portraitMini" id="myPortraitMini">
              <img id="myPortraitMiniImg" alt="">
              <div class="ph">Ï¥àÏÉÅ</div>
            </div>

            <div class="coreInfoStack">
              <div class="miniBlock">
                <div class="miniLabel">Ïä§ÌÖåÏù¥ÌÑ∞Ïä§</div>
                <div class="miniStatGrid" id="myStatsMini"></div>
              </div>

              <div class="miniBlock">
                <div class="miniLabel">ÌùêÌä∏Îü¨Ïßê</div>
                <div id="myStaggerMini"></div>
              </div>

              <div class="miniBlock">
                <div class="miniLabel">ÎÇ¥ÏÑ±</div>
                <div class="resWrap">
                  <div class="resLine" id="myPhysMini"></div>
                  <div class="resLine" id="mySinMini"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">ÌÇ§ÏõåÎìú</div>
            <div class="chipWrap" id="myKeywordsMini"></div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÌòÑÌô©</div>
            <div class="chipWrap" id="myStatusChips"></div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">Ìå®ÏãúÎ∏å <button class="miniBtn" type="button" id="btnMyPassive">ÏÉÅÏÑ∏Ï†ïÎ≥¥</button></div>
            <div class="passivePreviewLine" id="myPassivePreview">-</div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">ÏÇ¨Ïö© Í∞ÄÎä• Ïä¨Î°Ø</div>
            <div class="slotGrid" id="mySlots"></div>
          </div>

<div class="miniBlock">
  <div class="miniLabel">ÌòÑÏû¨ ÎΩëÏùÄ Ïä§ÌÇ¨</div>
  <div class="pickedSkillList" id="myPickedSkills"></div>
</div>

<div class="miniBlock">
  <div class="miniLabel">ÌäπÏàò Ïä§ÌÇ¨ Î™©Î°ù (ÌÅ¥Î¶≠ Ïãú Ï∂îÍ∞Ä)</div>
  <div class="specialSkillList" id="mySpecialSkills"></div>
</div>
        </div>
      </div>

      <!-- Í∞ÄÏö¥Îç∞ ÌÑ¥/Î°úÍ∑∏ -->
      <div class="centerPanel">
        <div class="turnCard">
          <div class="turnTop">
            <div>
              <div class="turnLabel">TURN</div>
              <div class="turnNum" id="matchTurnNo">1</div>
            </div>
            <div class="turnBtns">
              <button class="primary" id="btn-match-roll" type="button">ÏÜçÎèÑ/Ïä§ÌÇ¨ ÎΩëÍ∏∞</button>
              <button id="btn-match-next" type="button">ÌÑ¥ ÏßÑÌñâ(ÎçîÎØ∏)</button>
            </div>
          </div>

          <div class="turnInfoRows">
            <div class="turnInfoRow">
              <span>ÎÇ¥ Ïä¨Î°Ø</span>
              <span id="mySlotInfo">-</span>
            </div>
            <div class="turnInfoRow">
              <span>Ï†Å Ïä¨Î°Ø</span>
              <span id="enemySlotInfo">-</span>
            </div>
          </div>
        </div>

        <div class="frame" style="margin-top:12px;">
          <div class="hdr">Ï†ÑÌà¨ Î°úÍ∑∏ <span class="slash"></span></div>
          <div class="body">
            <div id="matchLog" class="matchLogBox"></div>
          </div>
        </div>
      </div>

      <!-- Ï†Å (Ïò§Î•∏Ï™Ω) -->
      <div class="teamPanel enemy" id="enemyPanel">
        <div class="teamHead">
          <div class="teamNameWrap">
            <div class="teamSide">Ï†Å</div>
            <div class="teamName" id="enemyNameView">-</div>
          </div>
          <div class="spdBadge" id="enemySpd">SPD -</div>
        </div>

        <div class="teamBody">
          <div class="teamMainGrid">
            <div class="portraitMini" id="enemyPortraitMini">
              <img id="enemyPortraitMiniImg" alt="">
              <div class="ph">Ï¥àÏÉÅ</div>
            </div>

            <div class="coreInfoStack">
              <div class="miniBlock">
                <div class="miniLabel">Ïä§ÌÖåÏù¥ÌÑ∞Ïä§</div>
                <div class="miniStatGrid" id="enemyStatsMini"></div>
              </div>

              <div class="miniBlock">
                <div class="miniLabel">ÌùêÌä∏Îü¨Ïßê</div>
                <div id="enemyStaggerMini"></div>
              </div>

              <div class="miniBlock">
                <div class="miniLabel">ÎÇ¥ÏÑ±</div>
                <div class="resWrap">
                  <div class="resLine" id="enemyPhysMini"></div>
                  <div class="resLine" id="enemySinMini"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">ÌÇ§ÏõåÎìú</div>
            <div class="chipWrap" id="enemyKeywordsMini"></div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">Î≤ÑÌîÑ/ÎîîÎ≤ÑÌîÑ ÌòÑÌô©</div>
            <div class="chipWrap" id="enemyStatusChips"></div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">Ìå®ÏãúÎ∏å <button class="miniBtn" type="button" id="btnEnemyPassive">ÏÉÅÏÑ∏Ï†ïÎ≥¥</button></div>
            <div class="passivePreviewLine" id="enemyPassivePreview">-</div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">Ï†ÅÏù¥ ÎΩëÏùÄ Ïä§ÌÇ¨ / Ïä¨Î°Ø ÏßÄÏ†ï (AI)</div>
            <div class="slotGrid" id="enemySlots"></div>
          </div>

          <div class="miniBlock">
            <div class="miniLabel">ÌòÑÏû¨ ÎΩëÏùÄ Ïä§ÌÇ¨</div>
            <div class="pickedSkillList" id="enemyPickedSkills"></div>
          </div>
        </div>
      </div>

    </div>

    <div class="actions" style="margin-top:14px;">
      <button class="ghost" id="btn-match-exit" type="button">Î°úÎπÑÎ°ú</button>
      <button class="ghost" id="btn-match-home" type="button">ÌôàÏúºÎ°ú</button>
    </div>

    <div class="toast" id="matchToast"></div>
  </div>
</section>
<!-- CHARACTER LIBRARY -->
<section class="screen card hidden" id="view-library">
  <div class="home">
    <h2>Ï∫êÎ¶≠ÌÑ∞ Î≥¥Í∏∞ Î∞è Î∂àÎü¨Ïò§Í∏∞</h2>
    <p>Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥ÏÑú Î≥¥Í∏∞ Ï†ÑÏö©ÏúºÎ°ú Ïó¥Í±∞ÎÇò, Ìé∏ÏßëÏúºÎ°ú Î∂àÎü¨Ïò¨ Ïàò ÏûàÏñ¥.</p>

    <div class="actions" style="margin-bottom:12px;">
      <button type="button" id="btn-import-character">ÌååÏùº Î∂àÎü¨Ïò§Í∏∞</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
      <button type="button" class="primary" id="btn-save-as-character">ÌòÑÏû¨ ÏûëÏóÖÏùÑ Ï∫êÎ¶≠ÌÑ∞Î°ú Ï†ÄÏû•</button>
      <button type="button" class="ghost" id="btn-lib-back">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </div>

    <div id="charList" style="display:flex; flex-direction:column; gap:12px;"></div>
    <div class="toast" id="libToast"></div>
  </div>
</section>

    <!-- EDITOR -->
    <section class="screen card hidden" id="view-editor">
      <div class="editor">
        <aside class="sidebar">
          <h3>Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë</h3>
          <div class="nav">
            <button type="button" id="tab-core" class="active">ÌïµÏã¨ Ï†ïÎ≥¥</button>
            <button type="button" id="tab-passive">Ìå®ÏãúÎ∏å Ìé∏Ïßë</button>
            <button type="button" id="tab-skill">Ïä§ÌÇ¨ Ìé∏Ïßë</button>
            <button type="button" id="tab-dk">Ï†ÑÏö© ÌÇ§ÏõåÎìú Ìé∏Ïßë</button>
          </div>
          <div class="bottom">
            <button type="button" class="ghost" id="btn-back">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
          </div>
        </aside>

        <main class="content">
          <!-- CORE -->
          <section id="panel-core">
            <div class="centerBoard">
              <div class="core-grid">
                <!-- LEFT -->
                <div>
                  <div class="frame">
                    <div class="hdr">Ïù¥Î¶Ñ <span class="slash"></span></div>
                    <div class="body">
                      <div class="name-row">
                        <input id="charName" type="text" />
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">Ïù¥ÎØ∏ÏßÄ <span class="slash"></span></div>
                    <div class="body">
                      <div class="portrait">
                        <img id="portraitImg" alt="Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞" />
                        <div class="ph" id="portraitPh">
                          ÏïÑÏßÅ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏñ¥.<br/>
                          ÏïÑÎûòÏóêÏÑú ÏóÖÎ°úÎìúÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎèº.
                        </div>
                      </div>

                      <div class="upload-row">
                        <button class="primary file" type="button">
                          Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
                          <input id="fileInput" type="file" accept="image/*" />
                        </button>
                        <button type="button" id="btnClearImg">Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞</button>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ÌùêÌä∏Îü¨Ïßê Íµ¨Í∞Ñ <span class="slash"></span></div>
                    <div class="body">
                      <div class="staggerBoard">
                        <div class="staggerBarOuter">
                          <div class="staggerBar" aria-label="ÌùêÌä∏Îü¨Ïßê Íµ¨Í∞Ñ Î∞î">
                            <div class="fill"></div>
                            <div class="markerLayer" id="markerLayer"></div>
                          </div>
                        </div>
                        <div class="tickLayer" id="tickLayer"></div>
                      </div>

                      <div class="staggerActions">
                        <button type="button" id="btnAddStagger" class="primary">ÌùêÌä∏ Ï∂îÍ∞Ä</button>
                        <button type="button" id="btnDelStagger">ÌùêÌä∏ ÏÇ≠Ï†ú</button>
                      </div>
                    </div>
                  </div>

<div class="frame" style="margin-top:14px;">
  <div class="hdr">Ï†ïÏã†Î†• Ìö®Í≥º <span class="slash"></span></div>
  <div class="body">
    <!-- Ïù¥ÎØ∏ÏßÄ -->
    <div class="field">
      <div class="label">Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ</div>

      <div class="portrait" style="min-height:180px;">
        <img id="sanityFxImg" alt="Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞" />
        <div class="ph" id="sanityFxPh">
          ÏïÑÏßÅ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏñ¥.<br/>
          ÏïÑÎûòÏóêÏÑú ÏóÖÎ°úÎìúÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎèº.
        </div>
      </div>

      <div class="upload-row" style="margin-top:10px;">
        <button class="primary file" type="button">
          Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
          <input id="sanityFxFile" type="file" accept="image/*" />
        </button>
        <button type="button" id="btnClearSanityFxImg">Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞</button>
      </div>
    </div>

    <!-- Ìå®Îãâ Ìö®Í≥º -->
    <div class="field" style="margin-top:12px;">
      <div class="label">Ìå®Îãâ Ìö®Í≥º</div>
      <textarea id="sanityPanicText" rows="4" placeholder="Ïòà: ÌÑ¥ ÏãúÏûë Ïãú, Í≥µÍ≤© ÏúÑÎ†• Ï¶ùÍ∞Ä 1 ..."></textarea>
    </div>

    <!-- Ï†ïÏã†Î†• Ï¶ùÍ∞Ä Ï°∞Í±¥ -->
    <div class="field" style="margin-top:12px;">
      <div class="label">Ï†ïÏã†Î†• Ï¶ùÍ∞Ä Ï°∞Í±¥</div>
      <textarea id="sanityGainText" rows="4" placeholder="Ïòà: Ìï© ÏäπÎ¶¨ Ïãú ÌöüÏàòÏóê ÎπÑÎ°ÄÌïòÏó¨ Ï¶ùÍ∞Ä ..."></textarea>
    </div>

    <!-- Ï†ïÏã†Î†• Í∞êÏÜå Ï°∞Í±¥ -->
    <div class="field" style="margin-top:12px;">
      <div class="label">Ï†ïÏã†Î†• Í∞êÏÜå Ï°∞Í±¥</div>
      <textarea id="sanityLossText" rows="4" placeholder="Ïòà: Ìï© Ìå®Î∞∞ Ïãú 4 Í∞êÏÜå"></textarea>
    </div>
  </div>
</div>

                  <div class="row-actions">
                    <button class="primary" id="btnSaveCore" type="button">Ï†ÄÏû•</button>
                    <button id="btnResetCore" type="button">Ï¥àÍ∏∞Ìôî</button>
                  </div>

                  <div class="toast" id="coreToast"></div>
                </div>

                <!-- RIGHT -->
                <div>
                  <div class="frame">
                    <div class="hdr">Ïä§ÌÖåÏù¥ÌÑ∞Ïä§ <span class="slash"></span></div>
                    <div class="body">
                      <div class="statList">
                        <div class="rowItem">
                          <div class="iconBox" title="Ï≤¥Î†• ÏïÑÏù¥ÏΩò"><img src="assets/icon_hp.png" alt="Ï≤¥Î†•" /></div>
                          <div class="label">Ï≤¥Î†•</div>
                          <div class="grow"><input id="statHp" class="numInput" type="number" min="0" step="1" /></div>
                        </div>

                        <div class="rowItem">
                          <div class="iconBox" title="ÏÜçÎèÑ ÏïÑÏù¥ÏΩò"><img src="assets/icon_speed.png" alt="ÏÜçÎèÑ" /></div>
                          <div class="label">ÏÜçÎèÑ</div>
                          <div class="grow inline">
                            <input id="statSpdMin" class="numInput" type="number" min="0" step="1" />
                            <span class="sep">~</span>
                            <input id="statSpdMax" class="numInput" type="number" min="0" step="1" />
                          </div>
                        </div>

                        <div class="rowItem">
                          <div class="iconBox" title="Î∞©Ïñ¥Î†àÎ≤® ÏïÑÏù¥ÏΩò"><img src="assets/icon_deflv.png" alt="Î∞©Ïñ¥Î†àÎ≤®" /></div>
                          <div class="label">Î∞©Ïñ¥Î†àÎ≤®</div>
                          <div class="grow"><input id="statDefLv" class="numInput" type="number" min="0" step="1" /></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">Î¨ºÎ¶¨ ÎÇ¥ÏÑ± Ï†ïÎ≥¥ <span class="slash"></span></div>
                    <div class="body">
                      <div class="physGrid">
                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_slash.png" alt="Ï∞∏Í≤©" /></div>
                          <div class="grow">
                            <select id="physSlash" class="select"></select>
                            <div class="coef" id="coef_physSlash">[x1.0]</div>
                          </div>
                        </div>

                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_pierce.png" alt="Í¥ÄÌÜµ" /></div>
                          <div class="grow">
                            <select id="physPierce" class="select"></select>
                            <div class="coef" id="coef_physPierce">[x1.0]</div>
                          </div>
                        </div>

                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_blunt.png" alt="ÌÉÄÍ≤©" /></div>
                          <div class="grow">
                            <select id="physBlunt" class="select"></select>
                            <div class="coef" id="coef_physBlunt">[x1.0]</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">Ï£ÑÏïÖ ÎÇ¥ÏÑ± Ï†ïÎ≥¥ <span class="slash"></span></div>
                    <div class="body">
                      <div class="sinsWrap">
                        <div class="sinsRow top">
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">Î∂ÑÎÖ∏</div>
                            <div class="sinIcon"><img src="assets/icon_wrath.png" alt="Î∂ÑÎÖ∏" /></div>
                            <select class="select" id="sinWrath"></select>
                            <div class="coef" id="coef_sinWrath">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ÏÉâÏöï</div>
                            <div class="sinIcon"><img src="assets/icon_lust.png" alt="ÏÉâÏöï" /></div>
                            <select class="select" id="sinLust"></select>
                            <div class="coef" id="coef_sinLust">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ÎÇòÌÉú</div>
                            <div class="sinIcon"><img src="assets/icon_sloth.png" alt="ÎÇòÌÉú" /></div>
                            <select class="select" id="sinSloth"></select>
                            <div class="coef" id="coef_sinSloth">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ÌÉêÏãù</div>
                            <div class="sinIcon"><img src="assets/icon_gluttony.png" alt="ÌÉêÏãù" /></div>
                            <select class="select" id="sinGluttony"></select>
                            <div class="coef" id="coef_sinGluttony">[x1.0]</div>
                          </div>
                        </div>

                        <div class="sinsRow bottom">
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">Ïö∞Ïö∏</div>
                            <div class="sinIcon"><img src="assets/icon_gloom.png" alt="Ïö∞Ïö∏" /></div>
                            <select class="select" id="sinGloom"></select>
                            <div class="coef" id="coef_sinGloom">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">Ïò§Îßå</div>
                            <div class="sinIcon"><img src="assets/icon_pride.png" alt="Ïò§Îßå" /></div>
                            <select class="select" id="sinPride"></select>
                            <div class="coef" id="coef_sinPride">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ÏßàÌà¨</div>
                            <div class="sinIcon"><img src="assets/icon_envy.png" alt="ÏßàÌà¨" /></div>
                            <select class="select" id="sinEnvy"></select>
                            <div class="coef" id="coef_sinEnvy">[x1.0]</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ÌäπÏÑ± ÌÇ§ÏõåÎìú <span class="slash"></span></div>
                    <div class="body">
                      <div class="kwWrap" id="traitKwList"></div>
                      <div class="kwFooter">
                        <button class="primary" type="button" id="btnTraitKwAdd">ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

          <!-- PASSIVE (Í∞úÌé∏) -->
          <section id="panel-passive" class="hidden">
            <div class="passivePage">
              <div class="frame">
                <div class="hdr">Ìå®ÏãúÎ∏å Ìé∏Ïßë <span class="slash"></span></div>
                <div class="body">
                  <!-- ÏúÑ: Ìé∏Ïßë -->
                  <div class="passTop">
                    <div class="box passEditor">
                      <div class="passRow">
                        <div class="passLabel">Ìå®ÏãúÎ∏å Ïù¥Î¶Ñ</div>
                        <input id="pvName" class="textInput" type="text" placeholder="Ïòà: ÏòàÏßÄÏïà" />
                      </div>

                      <div class="passRow" style="margin-top:10px;">
                        <div class="passLabel">Ï§ëÏöîÎèÑ</div>
                        <div class="passHeaderPick">
                          <button type="button" class="pvStyleBtn active" data-style="brown">Î≥¥ÌÜµ</button>
                          <button type="button" class="pvStyleBtn" data-style="orange">Ï§ëÏöî</button>
                          <button type="button" class="pvStyleBtn" data-style="red">Îß§Ïö∞Ï§ëÏöî</button>
                        </div>
                      </div>

                      <div class="passRow" style="margin-top:10px;">
                        <div class="passLabel">ÎÇ¥Ïö©</div>
                        <textarea id="pvText" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï§ò. (Í∞ïÏ°∞Îäî ÏïÑÎûò Î≤ÑÌäº)"></textarea>
                      </div>

                      <div class="row-actions" style="margin-top:12px;">
                        <!-- ‚úÖ ÌÇ§ÏõåÎìú Î≤ÑÌäº Ï∂îÍ∞Ä -->
                        <button type="button" id="pvKeywordBtn">ÌÇ§ÏõåÎìú</button>
                        <button type="button" id="pvHighlightBtn">Í∞ïÏ°∞</button>
                        <button type="button" class="primary" id="pvSaveBtn">Ï†ÄÏû•</button>
                        <button type="button" class="btnDanger" id="pvDeleteBtn">ÏÇ≠Ï†ú</button>
                      </div>

                      <div class="toast" id="pvToast"></div>
                    </div>
                  </div>

                  <!-- ÏïÑÎûò: ÏôÑÏÑ±Îêú Ìå®ÏãúÎ∏å(ÎÑìÍ≤å) -->
                  <div class="pvBoardBox">
                    <div class="pvBoardHead">
                      <div class="pvBoardHint">ÏïÑÎûò Î™©Î°ùÏóêÏÑú ÏÑ†ÌÉùÌïòÎ©¥ ÏúÑÏóêÏÑú ÏàòÏ†ïÌï† Ïàò ÏûàÏñ¥.</div>
                      <button class="primary" type="button" id="pvAddBtn">Ìå®ÏãúÎ∏å Ï∂îÍ∞Ä</button>
                    </div>
                    <div class="pvBoardScroll" id="pvBoard"></div>
                  </div>

                </div>
              </div>
            </div>
          </section>

<section id="panel-skill" class="hidden">
  <div class="skillPage">
    <div class="frame">
      <div class="hdr">Ïä§ÌÇ¨ Ìé∏Ïßë <span class="slash"></span></div>
      <div class="body">

<div class="skillEditorGrid">

  <!-- ‚úÖ ÏúÑ 3Ïó¥ ÏòÅÏó≠ -->
  <div class="skillTopGrid">

    <!-- (1) LEFT: ÎØ∏Î¶¨Î≥¥Í∏∞ -->
    <div class="box">
      <div class="passLabel">ÎØ∏Î¶¨Î≥¥Í∏∞</div>

<div class="skillPreviewCard v2" id="skPreviewCard">

<!-- ÏúÑ: ÌîÑÎ†àÏûÑ -->
<div class="skTop">
  <div class="skFrame">
    <img id="skFrameImg" alt="frame" />
    <div class="skInner">
      <img id="skInnerImg" alt="inner" />
    </div>
  </div>
</div>

<!-- ‚úÖ ÏΩîÏù∏(ÏôºÏ™Ω Ï†ïÎ†¨) -->
<div class="skCoinRow skCoinRowV2" id="skCoinRow"></div>

<!-- ‚úÖ ÌÉÄÏù¥ÌãÄ(ÏΩîÏù∏ ÏïÑÎûò) -->
<div class="skTitleBar skTitleBarV2" id="skTitleBar">
  <div class="skTitle" id="skTitleTxt">ÎßàÌÉÑÏÇ¨Í≤©</div>
  <div class="skTitleStripes" aria-hidden="true"></div>
</div>

<!-- ‚úÖ Í≥µÍ≤©Î†àÎ≤®/ÏÑ±Ïû•Í≥ÑÏàò ÎùºÏù∏ (ÌÉÄÏù¥ÌãÄ ÏïÑÎûò) -->
<div class="skGrowthRow skGrowthRowV3" id="skGrowthRow">
  <img class="skGrowthIcon" src="assets/icon_growth.png" alt="ÏÑ±Ïû•Í≥ÑÏàò">
  <div class="skGrowthText">
    <span id="skPrevGrowthBase">0</span>
    <span class="skGrowthLabel">ÏÑ±Ïû•Í≥ÑÏàò</span>
    <span class="skGrowthPlus">(
      <span id="skPrevGrowthSign">+</span>
      <span id="skPrevGrowthPlus">0</span>
    )</span>
  </div>
</div>

  <!-- Ïä§ÌÉØÌëú: (ÏõêÎûò Ïò§Î•∏Ï™ΩÏóê ÏûàÎçò Í≤É) ÏïÑÎûòÎ°ú Ïù¥Îèô -->
  <div class="skStatTable skStat2col v2">
    <div class="skStatTr">
      <div class="skStatTh">Í≥µÍ≤© Ïú†Ìòï</div>
      <div class="skStatTd" id="skPrevAtkCell">
        <img class="skMiniIcon" id="skPrevAtkIcon" alt="">
        <span id="skPrevAtk">Í¥ÄÌÜµ</span>
      </div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">Ï£ÑÏïÖ ÏÜçÏÑ±</div>
      <div class="skStatTd" id="skPrevSinCell">
        <img class="skMiniIcon" id="skPrevSinIcon" alt="">
        <span id="skPrevSin">Ïò§Îßå</span>
      </div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">Ïä§ÌÇ¨ ÏúÑÎ†•</div>
      <div class="skStatTd"><span id="skPrevPow">0</span></div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">ÏΩîÏù∏ ÏúÑÎ†•</div>
      <div class="skStatTd"><span id="skPrevCoin">+0</span></div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">Í≥µÍ≤© Í∞ÄÏ§ëÏπò</div>
      <div class="skStatTd"><span id="skPrevW">1</span></div>
    </div>
  </div>

  <!-- Ìö®Í≥º -->
  <div class="skEffectBox" id="skEffectBox"></div>

</div>

      <div style="margin-top:12px;">
        <div class="passLabel">Ïä§ÌÇ¨ Ïù¥ÎØ∏ÏßÄ(Ïú†Ï†Ä ÏóÖÎ°úÎìú)</div>

        <div class="skImgPick">
          <div class="skImgPreview" id="skImgPreview">
            <img id="skImgEl" alt="Ïä§ÌÇ¨ Ïù¥ÎØ∏ÏßÄ" />
            <div class="ph" id="skImgPh">Ïù¥ÎØ∏ÏßÄ</div>
          </div>

          <div class="dkButtons" style="margin:0;">
            <button class="primary file" type="button">
              Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
              <input id="skImgFile" type="file" accept="image/*" />
            </button>
            <button type="button" id="skImgClear">Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞</button>
          </div>
        </div>
      </div>
    </div>

    <!-- (2) MIDDLE: Ìé∏Ïßë -->
    <div class="box">
      <div class="passLabel">Ïä§ÌÇ¨ Ïù¥Î¶Ñ</div>
      <input id="skName" class="textInput" type="text" placeholder="Ïòà: ÎßàÌÉÑÏÇ¨Í≤©" />

      <div style="margin-top:12px;" class="skillRow2">
        <div>
          <div class="passLabel">Í≥µÍ≤© Ïú†Ìòï</div>
          <select id="skAtkType" class="select">
            <option value="slash">Ï∞∏Í≤©</option>
            <option value="pierce">Í¥ÄÌÜµ</option>
            <option value="blunt">ÌÉÄÍ≤©</option>
          </select>
        </div>

        <div>
          <div class="passLabel">Ï£ÑÏïÖ ÏÜçÏÑ±</div>
          <select id="skSin" class="select">
            <option value="wrath">Î∂ÑÎÖ∏</option>
            <option value="lust">ÏÉâÏöï</option>
            <option value="sloth">ÎÇòÌÉú</option>
            <option value="gluttony">ÌÉêÏãù</option>
            <option value="melancholy">Ïö∞Ïö∏</option>
            <option value="pride">Ïò§Îßå</option>
            <option value="envy">ÏßàÌà¨</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;" class="skillRow2">
        <div>
          <div class="passLabel">Ïä§ÌÇ¨ Îì±Í∏â(ÌîÑÎ†àÏûÑ 1~3)</div>
          <select id="skTier" class="select">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="passLabel">Ïä§ÌÇ¨ Ìö®Í≥º</div>
        <textarea id="skText" placeholder="Ìö®Í≥ºÎ•º ÏûÖÎ†•Ìï¥Ï§ò. ÌÇ§ÏõåÎìú Î≤ÑÌäºÏúºÎ°ú [[kw:...]] ÌÜ†ÌÅ∞ÏùÑ ÎÑ£ÏùÑ Ïàò ÏûàÏñ¥."></textarea>
      </div>

      <div class="row-actions" style="margin-top:12px;">
        <button type="button" id="skKeywordBtn">ÌÇ§ÏõåÎìú</button>
        <button type="button" id="skCoinEffectBtn">ÏΩîÏù∏ Ìö®Í≥º</button>
        <button type="button" id="skHighlightBtn">Í∞ïÏ°∞</button>
  <button type="button" id="skGreenBtn">ÎÖπÏÉâ Ìö®Í≥º</button>
  <button type="button" id="skBlueBtn">ÌååÎûÄÏÉâ Ìö®Í≥º</button>
  <button type="button" id="skRedBtn">Îπ®Í∞ÑÏÉâ Ìö®Í≥º</button>
      </div>
    </div>

    <!-- (3) RIGHT: Ïä§ÌÇ¨ ÏàòÏπò + Ï†ÄÏû•/ÏÇ≠Ï†ú -->
    <div class="box">
<div class="passLabel">Ïä§ÌÇ¨ ÏàòÏπò</div>

<div style="margin-top:10px;">
  <div class="passLabel">Ïä§ÌÇ¨ Ïú†Ìòï</div>
  <button id="skSkillTypeBtn" type="button" class="ghostBtn" data-skilltype="attack" style="width:100%; margin-top:6px;">
    Í≥µÍ≤© Ïä§ÌÇ¨
  </button>
</div>

<div style="margin-top:10px;">
  <div class="passLabel" id="skLevelLabel">Í≥µÍ≤© Î†àÎ≤®</div>
  <input id="skAtkLevel" class="numInput" type="number" step="1" value="0" />
</div>

<div style="margin-top:10px;">
  <div class="passLabel">ÏÑ±Ïû•Í≥ÑÏàò</div>
  <input id="skGrowth" class="numInput" type="number" step="1" value="0" />
</div>

<div style="margin-top:10px;">
  <div class="passLabel">Ïä§ÌÇ¨ ÏúÑÎ†•</div>
  <input id="skPower" class="numInput" type="number" step="1" value="15" />
</div>

      <div style="margin-top:10px;">
        <div class="passLabel">ÏΩîÏù∏ ÏúÑÎ†•</div>
        <div class="coinWrap">
          <button type="button" id="skCoinSignBtn" class="coinSignBtn" data-sign="+">+</button>
          <input id="skCoinPower" class="numInput" type="number" step="1" value="4" />
        </div>
      </div>

      <!-- ‚úÖ ÏΩîÏù∏ Ï¢ÖÎ•ò/Í∞úÏàòÎäî Ïó¨Í∏∞(Ïò§Î•∏Ï™Ω)Ïóê ÎëîÎã§ -->
      <div style="margin-top:10px;">
        <div class="passLabel">ÏΩîÏù∏ Ï¢ÖÎ•ò</div>
        <select id="skCoinType" class="select">
          <option value="normal">ÏùºÎ∞ò ÏΩîÏù∏</option>
          <option value="fixed">ÌååÍ¥¥ Î∂àÍ∞Ä ÏΩîÏù∏</option>
          <option value="extract">Ï†ÅÏ∂ú ÏΩîÏù∏</option>
          <option value="annihilate">ÏÜåÎ©∏ ÏΩîÏù∏</option>
        </select>
      </div>

      <div style="margin-top:10px;">
        <div class="passLabel">ÏΩîÏù∏ Í∞ØÏàò</div>
        <input id="skCoinCount" class="numInput" type="number" min="1" step="1" value="1" />
      </div>

<div style="margin-top:10px;">
  <div class="passLabel">Í≥µÍ≤© Í∞ÄÏ§ëÏπò</div>
  <input id="skWeight" class="numInput" type="number" step="1" value="1" />
</div>

<!-- ‚úÖ Ïä§ÌÇ¨ Ï¢ÖÎ•ò ÌÜ†Í∏Ä -->
<div style="margin-top:10px;">
  <div class="passLabel">Ïä§ÌÇ¨ Ï¢ÖÎ•ò</div>
  <div class="skKindToggle" id="skKindToggle">
    <button type="button" class="skKindBtn active" data-kind="normal">ÏùºÎ∞ò Ïä§ÌÇ¨</button>
    <button type="button" class="skKindBtn" data-kind="special">ÌäπÏàò Ïä§ÌÇ¨</button>
  </div>
</div>

<!-- ‚úÖ ÏùºÎ∞ò Ïä§ÌÇ¨Ïùº ÎïåÎßå ÌôúÏÑ±ÌôîÎêòÎäî Îì±Ïû• ÌôïÎ•† -->
<div style="margin-top:10px;" id="skSpawnWrap">
  <div class="passLabel">Ïä§ÌÇ¨ Îì±Ïû• ÌôïÎ•† (%)</div>
  <input id="skillSpawnChance" class="numInput" type="number" min="0" max="100" step="1" value="100" />
  <div style="margin-top:6px; color:var(--muted); font-size:12px;">ÏùºÎ∞ò Ïä§ÌÇ¨Îßå ÏÇ¨Ïö©Îê®</div>
</div>

      <div class="row-actions" style="margin-top:12px;">
        <button type="button" class="primary" id="skSaveBtn">Ï†ÄÏû•</button>
        <button type="button" id="skNewBtn">ÏÉà Ïä§ÌÇ¨</button>
        <button type="button" class="btnDanger" id="skDeleteBtn">ÏÇ≠Ï†ú</button>
      </div>

      <div class="toast" id="skToast"></div>
    </div>

  </div><!-- /.skillTopGrid -->

  <!-- ‚úÖ ÏïÑÎûò: Ï†ÄÏû•Îêú Ïä§ÌÇ¨ÏùÑ ‚ÄúÎß® ÏïÑÎûò Ï†ÑÏ≤¥Ìè≠‚ÄùÏúºÎ°ú Î∂ÑÎ¶¨ -->
<div class="box skillSavedBox">
  <div class="passLabel">ÏùºÎ∞ò Ïä§ÌÇ¨ Î™©Î°ù</div>
  <div class="skList" id="skListNormal"></div>

  <div style="height:14px;"></div>

  <div class="passLabel">ÌäπÏàò Ïä§ÌÇ¨ Î™©Î°ù</div>
  <div class="skList" id="skListSpecial"></div>
</div>

</div><!-- /.skillEditorGrid -->
</section>

          <!-- Ï†ÑÏö© ÌÇ§ÏõåÎìú -->
            <section id="panel-dk" class="hidden">
            <div class="dkPage">
              <div class="frame">
                <div class="hdr">Ï†ÑÏö© ÌÇ§ÏõåÎìú Ìé∏Ïßë <span class="slash"></span></div>
                <div class="body">
                  <div class="dkTop">
                    <div class="box">
                      <div class="dkIconPreview">
                        <img id="dkIconImg" alt="Ï†ÑÏö© ÌÇ§ÏõåÎìú ÏïÑÏù¥ÏΩò" />
                        <div class="ph" id="dkIconPh">Ïù¥ÎØ∏ÏßÄ</div>
                      </div>
                      <div class="dkButtons">
                        <button class="primary file" type="button">
                          Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
                          <input id="dkIconFile" type="file" accept="image/*" />
                        </button>
                        <button type="button" id="dkIconClear">Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞</button>
                      </div>
                    </div>

                    <div class="box dkContentArea">
                      <div style="display:flex; flex-direction:column; gap:10px;">
                        <div style="color: rgba(243,211,154,.95); font-weight:900;">ÌÇ§ÏõåÎìú Ïù¥Î¶Ñ</div>
                        <input id="dkName" class="textInput" type="text" placeholder="ÌÇ§ÏõåÎìú Ïù¥Î¶Ñ" />

                        <div style="color: rgba(243,211,154,.95); font-weight:900; margin-top:6px;">ÎÇ¥Ïö©</div>
                        <textarea id="dkText" placeholder="ÎÇ¥Ïö©"></textarea>
                      </div>
                    </div>

                    <div class="box dkActionCol">
                      <button type="button" id="dkStateBtn" class="stateBtn buff">Î≤ÑÌîÑ</button>
                      <button type="button" id="dkSaveBtn" class="primary">Ï†ÄÏû•</button>
                      <button type="button" id="dkDeleteBtn" class="btnDanger">ÌÇ§ÏõåÎìú ÏÇ≠Ï†ú</button>
                      <div class="toast" id="dkToast"></div>
                    </div>
                  </div>

                  <div class="dkListBox" style="margin-top:14px;">
                    <div style="color:var(--muted); font-size:13px;">
                      ÏïÑÎûò Î™©Î°ùÏóêÏÑú ÌÇ§ÏõåÎìúÎ•º ÏÑ†ÌÉùÌïòÎ©¥ ÏúÑÏóêÏÑú ÏàòÏ†ïÌï† Ïàò ÏûàÏñ¥.
                    </div>
                    <div id="dkList"></div>
                    <div class="dkFooterBar">
                      <button class="primary" type="button" id="dkAddBtn">ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä</button>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </section>
  </div>

  <!-- ‚úÖ ÌÇ§ÏõåÎìú ÌîºÏª§ Î™®Îã¨ (script Î∞ñ!) -->
  <div id="kwModal" class="hidden" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    align-items:center; justify-content:center;
    padding:18px; z-index:9999;">
    <div style="
      width:min(720px, 100%); max-height:80vh; overflow:auto;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(10,10,12,.96);
      box-shadow:0 18px 60px rgba(0,0,0,.60);
      padding:12px;">
<div style="display:flex; align-items:center; gap:10px; padding:6px 6px 10px;">
  <div style="font-weight:900; color:rgba(243,211,154,.95);" id="kwModalTitle">ÌÇ§ÏõåÎìú</div>

  <!-- ‚úÖ ÌÉ≠ -->
  <div class="kwTabs" role="tablist" aria-label="ÌÇ§ÏõåÎìú ÌÉ≠">
    <button type="button" class="kwTab active" data-tab="base" aria-selected="true">Í∏∞Î≥∏</button>
    <button type="button" class="kwTab" data-tab="rep" aria-selected="false">ÎåÄÌëú</button>
    <button type="button" class="kwTab" data-tab="ded" aria-selected="false">Ï†ÑÏö©</button>
  </div>

  <div style="margin-left:auto;">
    <button type="button" id="kwStateToggle" class="kwStateToggle buff">Î≤ÑÌîÑ</button>
    <button type="button" id="kwCloseBtn">Îã´Í∏∞</button>
  </div>
</div>

<div id="kwModalList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>

  <!-- ‚úÖ ÌÇ§ÏõåÎìú Ìà¥ÌåÅ (Ïó¨Í∏∞Î°ú Ïù¥Îèô!) -->
  <div id="kwTip" class="kwTip hidden" role="tooltip" aria-hidden="true">
    <div class="kwTipBox">
      <div class="kwTipIcon"><img id="kwTipImg" alt=""></div>
      <div class="kwTipBody">
        <div id="kwTipTitle" class="kwTipTitle"></div>
        <div id="kwTipText" class="kwTipText"></div>
      </div>
    </div>
  </div>

  <script>
// ‚úÖ Ïä§ÌÇ¨ Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ ÌÇ§Îäî KEY_SK ÌïòÎÇòÎßå ÏÇ¨Ïö©
function saveSkillsStore(skillsArr) {
  try {
    localStorage.setItem(KEY_SK, JSON.stringify(skillsArr || []));
  } catch (e) {
    console.error("Ïä§ÌÇ¨ Ï†ÄÏû• Ïã§Ìå®:", e);
  }
}

function loadSkillsStore() {
  try {
    const raw = localStorage.getItem(KEY_SK);
    if (!raw) return [];
    return normalizeSkills(JSON.parse(raw));
  } catch (e) {
    console.error("Ïä§ÌÇ¨ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", e);
    return [];
  }
}

// ===== [Ï∂îÍ∞Ä] ÏòõÎÇ† Îç∞Ïù¥ÌÑ∞/ÎàÑÎùΩÍ∞í Î≥¥Ï†ï =====
function normalizeSkills(skills) {
  if (!Array.isArray(skills)) return [];

  return skills.map((s, i) => {
    const kind =
      s.kind === "special" || s.type === "special" ? "special" : "normal";

    const rawChance =
      s.spawnChance ?? s.rate ?? 100;

    const spawnChance = Number.isFinite(+rawChance)
      ? Math.max(0, Math.min(100, +rawChance))
      : 100;

    return {
      id: s.id ?? `skill_${i}`,
      name: s.name ?? "Ïù¥Î¶Ñ ÏóÜÏùå",

      // ÎÇòÎ®∏ÏßÄ Í∞íÎì§ Î®ºÏ†Ä Ïú†ÏßÄ
      ...s,

      // ÎßàÏßÄÎßâÏóê ÌÜµÏùº ÌïÑÎìúÎ°ú ÎçÆÍ∏∞ (ÌïµÏã¨)
      kind,
      spawnChance
    };
  });
}

/***********************
 * ‚úÖ IndexedDB (Ïù¥ÎØ∏ÏßÄ ÏòÅÍµ¨ Ï†ÄÏû•) Ïú†Ìã∏
 ***********************/
const MEDIA_DB_NAME = "limbus_addon_media_v1";
const MEDIA_DB_VER  = 1;
const MEDIA_STORE   = "images"; // key -> Blob

function openMediaDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(MEDIA_DB_NAME, MEDIA_DB_VER);

    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(MEDIA_STORE)){
        db.createObjectStore(MEDIA_STORE); // key: string, value: Blob
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPutBlob(key, blob){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readwrite");
    tx.objectStore(MEDIA_STORE).put(blob, key);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

async function idbGetBlob(key){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readonly");
    const req = tx.objectStore(MEDIA_STORE).get(key);
    req.onsuccess = () => { db.close(); resolve(req.result || null); };
    req.onerror = () => { db.close(); reject(req.error); };
  });
}

async function idbDel(key){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readwrite");
    tx.objectStore(MEDIA_STORE).delete(key);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

function dataURLToBlob(dataURL){
  const [head, body] = String(dataURL).split(",", 2);
  const mime = (head.match(/data:(.*?);base64/)||[])[1] || "application/octet-stream";
  const bin = atob(body || "");
  const len = bin.length;
  const arr = new Uint8Array(len);
  for(let i=0;i<len;i++) arr[i] = bin.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function blobToDataURL(blob){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

async function exportCharacterToFile(charId){
  const data = loadCharData(charId);
  if(!data){
    alert("Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥.");
    return;
  }

  // 1) Ïñ¥Îñ§ Ïù¥ÎØ∏ÏßÄ ÌÇ§Î•º Ìè¨Ìï®Ìï†ÏßÄ ÏàòÏßë
  const mediaKeys = new Set();

  // core portrait
  const corePortraitKey = data?.core?.portraitKey || "";
  if(corePortraitKey) mediaKeys.add(corePortraitKey);

  // dedicated keyword icons
  const dks = Array.isArray(data?.dedicatedKeywords) ? data.dedicatedKeywords : [];
  for(const k of dks){
    if(k?.iconKey) mediaKeys.add(k.iconKey);
  }

  // skill images
  const skills = Array.isArray(data?.skills) ? data.skills : [];
  for(const s of skills){
    if(s?.imgKey) mediaKeys.add(s.imgKey);
  }

  // 2) IndexedDBÏóêÏÑú Blob ÏùΩÏñ¥ÏÑú dataURLÎ°ú Ìå®ÌÇπ
  const media = {}; // key -> dataURL
  for(const key of mediaKeys){
    try{
      const blob = await idbGetBlob(key);
      if(blob){
        media[key] = await blobToDataURL(blob);
      }
    }catch(e){
      console.warn("media export fail:", key, e);
    }
  }

  // 3) ÏµúÏ¢Ö ÎÇ¥Î≥¥ÎÇ¥Í∏∞ payload
  const payload = {
    kind: "limbus_char_export",
    version: 1,
    exportedAt: nowISO(),
    char: data,     // core/passives/skills/dedicatedKeywords Í∑∏ÎåÄÎ°ú
    media: media    // Ïù¥ÎØ∏ÏßÄÎì§(Blob -> dataURL)
  };

  const json = JSON.stringify(payload);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;

  const safeName = String(data?.name || "character").trim().replace(/[\\/:*?"<>|]/g, "_");
  a.download = `${safeName}.limbuschar.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => URL.revokeObjectURL(url), 500);
}

async function importCharacterFromFile(file){
  const text = await file.text();
  let pack = null;

  try{
    pack = JSON.parse(text);
  }catch(e){
    alert("ÌååÏùºÏù¥ JSONÏù¥ ÏïÑÎãàÏïº.");
    return;
  }

  if(!pack || pack.kind !== "limbus_char_export"){
    alert("Ïù¥ ÌååÏùºÏùÄ ÎÇ¥Î≥¥ÎÇ∏ Ï∫êÎ¶≠ÌÑ∞ ÌååÏùºÏù¥ ÏïÑÎãå Í≤É Í∞ôÏïÑ.");
    return;
  }

  const data = pack.char;
  const media = pack.media || {};

  if(!data || !data.core){
    alert("Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏ†ïÏÉÅ(Íπ®Ïßê).");
    return;
  }

  // ‚úÖ ÏÉà Ï∫êÎ¶≠ÌÑ∞Î°ú Ï†ÄÏû•Ìï† Í±∞ÎùºÎ©¥ id ÏÉàÎ°ú Î∞úÍ∏â
  // (Í∏∞Ï°¥ id Í∑∏ÎåÄÎ°ú ÎçÆÏñ¥Ïì∞Î©¥ Ï∂©Îèå Í∞ÄÎä•)
  const newId = charUid();

  // 1) media Î≥µÏõê: dataURL -> Blob -> IndexedDBÏóê key Í∑∏ÎåÄÎ°ú Ï†ÄÏû•
  // (key Ïù¥Î¶ÑÏù¥ core_portrait_v1 Í∞ôÏùÄ Í≥†Ï†ïÌÇ§Î©¥ Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞ÏôÄ Ï∂©ÎèåÎÇ† Ïàò ÏûàÏùå)
  // Í∑∏ÎûòÏÑú "ÌÇ§ Ïû¨Îß§Ìïë"Ïù¥ ÏïàÏ†ÑÌï®. ÏïÑÎûòÎäî Ïû¨Îß§Ìïë Î∞©Ïãù.

  const remap = {}; // oldKey -> newKey

  function remapKey(oldKey){
    if(!oldKey) return "";
    if(remap[oldKey]) return remap[oldKey];

    // Ï∫êÎ¶≠ÌÑ∞Î≥ÑÎ°ú Î∂ÑÎ¶¨ÎêòÍ≤å ÌÇ§Î•º ÏÉàÎ°ú ÎßåÎì¶
    // Ïòà: core_portrait_v1 -> core_portrait_<newId>
    const nk = `${oldKey}__${newId}`;
    remap[oldKey] = nk;
    return nk;
  }

  // core portraitKey remap
  if(data.core.portraitKey){
    data.core.portraitKey = remapKey(data.core.portraitKey);
  }

  // dk iconKey remap
  if(Array.isArray(data.dedicatedKeywords)){
    for(const k of data.dedicatedKeywords){
      if(k.iconKey) k.iconKey = remapKey(k.iconKey);
    }
  }

  // skill imgKey remap
  if(Array.isArray(data.skills)){
    for(const s of data.skills){
      if(s.imgKey) s.imgKey = remapKey(s.imgKey);
    }
  }

  // media Ï†ÄÏû•(Ïû¨Îß§ÌïëÎêú ÌÇ§Î°ú)
  for(const [oldKey, dataURL] of Object.entries(media)){
    const newKey = remapKey(oldKey);
    try{
      const blob = dataURLToBlob(dataURL);
      await idbPutBlob(newKey, blob);
    }catch(e){
      console.warn("media import fail:", oldKey, e);
    }
  }

  // 2) char data Ï†ÄÏû•
  const name = (data?.name || data?.core?.name || "Í∞ÄÏ†∏Ïò® Ï∫êÎ¶≠ÌÑ∞").trim();

  // char Ï†ÄÏû• Ìè¨Îß∑(ÎÑ§ snapshotCurrentWorkspace Íµ¨Ï°∞Îûë ÎßûÏ∂§)
  const saved = {
    version: 1,
    savedAt: nowISO(),
    name,
    core: data.core || null,
    passives: data.passives || [],
    skills: data.skills || [],
    dedicatedKeywords: data.dedicatedKeywords || [],
  };

  // charList Í∞±Ïã†
  const list = loadCharList();
  list.unshift({
    id: newId,
    name,
    createdAt: nowISO(),
    updatedAt: nowISO(),
  });
  saveCharList(list);
  saveCharData(newId, saved);

  alert(`Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å: ${name}`);
  renderCharacterLibrary();
}

function makeObjectURLFromBlob(blob){
  return URL.createObjectURL(blob);
}

/***********************
 * ‚úÖ ObjectURL ÎàÑÏàò Î∞©ÏßÄ(Î¶¨ÌîÑÎ†àÏãú/Ïû¨Î†åÎçî Ïãú URL Ìï¥Ï†ú)
 ***********************/
let _portraitObjectURL = "";
function setPortraitFromObjectURL(url){
  if(_portraitObjectURL){
    try{ URL.revokeObjectURL(_portraitObjectURL); }catch(e){}
    _portraitObjectURL = "";
  }
  if(!url){
    setPortrait("");
    return;
  }
  _portraitObjectURL = url;
  setPortrait(url);
}

// dk / modal ÏïÑÏù¥ÏΩò url Ìï¥Ï†úÏö©
const _iconObjectURLMap = new Map(); // key -> objectURL
function revokeIconURL(key){
  const u = _iconObjectURLMap.get(key);
  if(u){
    try{ URL.revokeObjectURL(u); }catch(e){}
    _iconObjectURLMap.delete(key);
  }
}

async function applyIconKeyToImg(imgEl, iconKey){
  const prevKey = imgEl?.dataset?.iconKey || "";
  if(prevKey && prevKey !== iconKey){
    revokeIconURL(prevKey);
  }
  if(imgEl?.dataset) imgEl.dataset.iconKey = iconKey || "";

  if(!iconKey){
    imgEl.src = "";
    imgEl.style.display = "none";
    return;
  }
  const blob = await idbGetBlob(iconKey);
  if(!blob){
    imgEl.src = "";
    imgEl.style.display = "none";
    return;
  }
  if(!_iconObjectURLMap.has(iconKey)){
    _iconObjectURLMap.set(iconKey, makeObjectURLFromBlob(blob));
  }
  imgEl.src = _iconObjectURLMap.get(iconKey);
  imgEl.style.display = "block";
}

/***********************
 * ‚úÖ Character Save/Load (v1)
 ***********************/
const KEY_CHAR_LIST = "limbus_char_list_v1";       // [{id,name,updatedAt,createdAt}]
const KEY_CHAR_DATA_PREFIX = "limbus_char_";       // limbus_char_<id>_v1
const KEY_CHAR_DATA_SUFFIX = "_v1";

function nowISO(){ return new Date().toISOString(); }
function charUid(){ return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

let APP_MODE = "edit"; // "edit" | "view"
function setAppMode(mode){
  APP_MODE = (mode === "view") ? "view" : "edit";
  document.body.classList.toggle("readonly", APP_MODE === "view");

  // ‚úÖ ÌÉ≠ ÎùºÎ≤®ÏùÄ Î≥¥Í∏∞ Î™®ÎìúÏóêÏÑúÎßå Î≥ÄÍ≤Ω
  applyViewTabLabels();

  if(APP_MODE === "view"){
    applyViewCoreUI();
  }else{
    // ‚úÖ Ìé∏Ïßë Î™®ÎìúÎ°ú ÎèåÏïÑÏò¨ Îïå view Ï†ÑÏö© ÏûîÏÉÅ Ï†úÍ±∞
    cleanupViewArtifacts();
  }
}

function applyViewTabLabels(){
  const coreBtn  = document.getElementById("tab-core");
  const pvBtn    = document.getElementById("tab-passive");
  const skBtn    = document.getElementById("tab-skill");   // ‚úÖ Ï∂îÍ∞Ä
  const dkBtn    = document.getElementById("tab-dk");      // (ÎÇòÏ§ëÏö©)

  // ÏóÜÏúºÎ©¥ Ï¢ÖÎ£å
  if(!coreBtn || !pvBtn || !skBtn) return;

  // ÏõêÎûò ÌÖçÏä§Ìä∏ Î∞±ÏóÖ(1Ìöå)
  if(!coreBtn.dataset.origText) coreBtn.dataset.origText = coreBtn.textContent;
  if(!pvBtn.dataset.origText)   pvBtn.dataset.origText   = pvBtn.textContent;
  if(!skBtn.dataset.origText)   skBtn.dataset.origText   = skBtn.textContent; // ‚úÖ Ï∂îÍ∞Ä
  if(dkBtn && !dkBtn.dataset.origText) dkBtn.dataset.origText = dkBtn.textContent;

  if(APP_MODE === "view"){
    coreBtn.textContent = coreBtn.dataset.origText; // ÌïµÏã¨ Ï†ïÎ≥¥ Í∑∏ÎåÄÎ°ú
    pvBtn.textContent   = "Ìå®ÏãúÎ∏å";
    skBtn.textContent   = "Ïä§ÌÇ¨";                   // ‚úÖ Ïó¨Í∏∞!
    dkBtn.textContent = "Ï†ÑÏö© ÌÇ§ÏõåÎìú";           // ÎÇòÏ§ëÏóê ÏºúÎ©¥ Îê®
  }else{
    coreBtn.textContent = coreBtn.dataset.origText;
    pvBtn.textContent   = pvBtn.dataset.origText;
    skBtn.textContent   = skBtn.dataset.origText;   // ‚úÖ Î≥µÍµ¨
    if(dkBtn) dkBtn.textContent = dkBtn.dataset.origText;
  }
}

function cleanupViewArtifacts(){
  // ‚úÖ Î≥¥Í∏∞ Î™®ÎìúÏóêÏÑú ÎßåÎì§Ïñ¥Îëî traitLine(Ïπ© ÏöîÏïΩ)Ïù¥ Ìé∏Ïßë Î™®ÎìúÏóê ÎÇ®ÏïÑ Î≥¥Ïù¥Îäî Î¨∏Ï†ú Î∞©ÏßÄ
  const traitSection = [...document.querySelectorAll("#panel-core .frame")].find(f => {
    const h = f.querySelector(".hdr");
    return h && h.textContent.includes("ÌäπÏÑ± ÌÇ§ÏõåÎìú");
  });
  const body = traitSection?.querySelector(".body");
  const old = body?.querySelector(".traitLine");
  if(old) old.remove();
}

function applyViewCoreUI(){
  if(APP_MODE !== "view") return;

  // 1) Ïù¥Î¶Ñ: ÏûÖÎ†•Ïπ∏ÏùÑ "ÌÉÄÏù¥ÌãÄ"Ï≤òÎüº Î≥¥Ïù¥Í≤å
  const nameInput = document.getElementById("charName");
  if(nameInput){
    nameInput.style.fontSize = "26px";
    nameInput.style.fontWeight = "1000";
    nameInput.style.letterSpacing = "-0.02em";
    nameInput.style.color = "rgba(243,211,154,.98)";
    nameInput.style.textShadow = "0 2px 18px rgba(0,0,0,.55)";
    nameInput.style.textAlign = "left";
  }

  // 2) ÌäπÏÑ± ÌÇ§ÏõåÎìú: 1Ï§Ñ ÏöîÏïΩ ÏÉùÏÑ±
  const traitFrameBody = document.querySelector("#panel-core .frame .hdr:nth-child(1)"); // ÏïàÏ†ÑÌïòÏßÄ ÏïäÏïÑÏÑú ÏïÑÎûò Î∞©Ïãù ÏÇ¨Ïö©
  const traitSection = [...document.querySelectorAll("#panel-core .frame")].find(f => {
    const h = f.querySelector(".hdr");
    return h && h.textContent.includes("ÌäπÏÑ± ÌÇ§ÏõåÎìú");
  });

  if(traitSection){
    const body = traitSection.querySelector(".body");
    if(body){
      // Í∏∞Ï°¥ ÏöîÏïΩÎ∞î ÏûàÏúºÎ©¥ Ï†úÍ±∞ ÌõÑ Ïû¨ÏÉùÏÑ±
      const old = body.querySelector(".traitLine");
      if(old) old.remove();

// ‚úÖ ÌòÑÏû¨ UIÏóê Î°úÎìúÎêú ÌÇ§ÏõåÎìú ÏùΩÍ∏∞(ÏÇ≠Ï†úÌëúÏãú Ìè¨Ìï®)
const rows = [...document.querySelectorAll("#traitKwList .kwRow")];

const items = rows
  .map(r => ({
    text: (r.querySelector(".kwInput")?.value || "").trim(),
    deleted: r.classList.contains("deleted")
  }))
  .filter(x => x.text);

const line = document.createElement("div");
line.className = "traitLine";

if(items.length === 0){
  line.textContent = "ÌäπÏÑ± ÌÇ§ÏõåÎìú ÏóÜÏùå";
} else {
  const wrap = document.createElement("div");
  wrap.className = "traitChips";

  for(const it of items){
    const chip = document.createElement("span");
    chip.className = "traitChip" + (it.deleted ? " deleted" : "");
    chip.textContent = it.text;
    wrap.appendChild(chip);
  }

  line.appendChild(wrap);
}

body.appendChild(line);
    }
  }
}

function loadCharList(){
  try{
    const raw = JSON.parse(localStorage.getItem(KEY_CHAR_LIST) || "[]");
    return Array.isArray(raw) ? raw : [];
  }catch(e){ return []; }
}
function saveCharList(list){
  localStorage.setItem(KEY_CHAR_LIST, JSON.stringify(list || []));
}
function charDataKey(id){
  return `${KEY_CHAR_DATA_PREFIX}${id}${KEY_CHAR_DATA_SUFFIX}`;
}
function loadCharData(id){
  try{
    return JSON.parse(localStorage.getItem(charDataKey(id)) || "null");
  }catch(e){ return null; }
}
function saveCharData(id, data){
  localStorage.setItem(charDataKey(id), JSON.stringify(data));
}

// ‚úÖ workspace keys (Ïó¨Í∏∞ Ìïú Î≤àÎßå!)
const KEY_CORE = "limbus_addon_core_v10";
const KEY_PV   = "limbus_addon_passives_v1";
const KEY_SK   = "limbus_addon_skills_v1";
const KEY_DK   = "limbus_addon_dedicated_keywords_v3";

// ‚úÖ Î∂ÄÌåÖ Ïãú 1Ìöå: ÏÑ†ÌÉùÌïú Ï∫êÎ¶≠ÌÑ∞Î•º Î®ºÏ†Ä ÏûëÏóÖÍ≥µÍ∞ÑÏóê Ï£ºÏûÖ
(function bootOnceLoadCharacter(){
  const loadId = localStorage.getItem("limbus_load_char_once");
  if(!loadId) return;

  const mode = localStorage.getItem("limbus_app_mode_once") || "edit";
  localStorage.removeItem("limbus_load_char_once");
  localStorage.removeItem("limbus_app_mode_once");

  const data = loadCharData(loadId);
  if(!data) return;

  localStorage.setItem(KEY_CORE, JSON.stringify(data.core || null));
  localStorage.setItem(KEY_PV,   JSON.stringify(data.passives || []));
  localStorage.setItem(KEY_SK,   JSON.stringify(data.skills || []));
  localStorage.setItem(KEY_DK,   JSON.stringify(data.dedicatedKeywords || []));

  // Î™®ÎìúÎäî ‚ÄúÎ∞îÎ°ú Ï†ÅÏö©‚Äù ÎßêÍ≥†, ÏïÑÎûòÏóêÏÑú Ìïú Î≤àÎßå ÏùΩÏñ¥ÏÑú Ï†ÅÏö©Ìï† Ïö©ÎèÑ
  localStorage.setItem("limbus_app_mode_boot", mode);
})();

// ‚úÖ Î∂ÄÌåÖ Î™®Îìú 1Ìöå Ï†ÅÏö©(Î∞òÎìúÏãú setAppMode Î∞ñ!)
(() => {
  const bootMode = localStorage.getItem("limbus_app_mode_boot");
  if(bootMode){
    localStorage.removeItem("limbus_app_mode_boot");
    setAppMode(bootMode);
  }
})();

const viewLibrary = document.getElementById("view-library");
const libToast = document.getElementById("libToast");
const charListEl = document.getElementById("charList");

const btnImportCharacter = document.getElementById("btn-import-character");
const importFileInput = document.getElementById("importFile");

btnImportCharacter?.addEventListener("click", () => {
  importFileInput?.click();
});

importFileInput?.addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    await importCharacterFromFile(file);
    toast(libToast, "ÌååÏùº Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!");
  }catch(err){
    console.error(err);
    toast(libToast, "ÌååÏùº Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®!");
  }finally{
    // Í∞ôÏùÄ ÌååÏùº Îã§Ïãú ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÍ≤å Ï¥àÍ∏∞Ìôî
    importFileInput.value = "";
  }
});

function normalizeSkill(skill){
  return {
    ...skill,
    kind: skill.kind === "special" ? "special" : "normal",
    spawnChance: Number.isFinite(+skill.spawnChance)
      ? Math.max(0, Math.min(100, +skill.spawnChance))
      : 100,
  };
}

function renderCharacterLibrary(){
  if(!charListEl) return;
  charListEl.innerHTML = "";

  const list = loadCharList();
  if(list.length === 0){
    const d = document.createElement("div");
    d.style.color = "rgba(238,241,255,.55)";
    d.style.fontSize = "13px";
    d.textContent = "ÏïÑÏßÅ Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏñ¥. 'ÌòÑÏû¨ ÏûëÏóÖÏùÑ Ï∫êÎ¶≠ÌÑ∞Î°ú Ï†ÄÏû•'ÏùÑ ÎàåÎü¨Î¥ê.";
    charListEl.appendChild(d);
    return;
  }

  for(const it of list){
    const row = document.createElement("div");
    row.style.cssText = "border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:16px;padding:12px;display:flex;align-items:center;gap:10px;cursor:pointer;";
    // ‚úÖ row Ï†ÑÏ≤¥ ÌÅ¥Î¶≠ Ïãú Í∏∞Î≥∏ ÎèôÏûë = Î≥¥Í∏∞
    row.dataset.action = "view";
    row.dataset.id = it.id;
    row.dataset.name = it.name || "";

    const title = document.createElement("div");
    title.style.fontWeight = "900";
    title.textContent = it.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)";

    const meta = document.createElement("div");
    meta.style.cssText = "margin-left:auto;display:flex;gap:8px;";

    const mkBtn = (txt, action, cls="") => {
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = txt;
      if(cls) b.className = cls;
      b.dataset.action = action;
      b.dataset.id = it.id;
      b.dataset.name = it.name || "";
      return b;
    };

    meta.appendChild(mkBtn("Î≥¥Í∏∞", "view"));
    meta.appendChild(mkBtn("Ìé∏Ïßë", "edit", "primary"));
    meta.appendChild(mkBtn("ÎÇ¥Î≥¥ÎÇ¥Í∏∞", "export"));
    meta.appendChild(mkBtn("ÏÇ≠Ï†ú", "delete", "btnDanger"));

    row.appendChild(title);
    row.appendChild(meta);
    charListEl.appendChild(row);
  }
}

charListEl.addEventListener("click", async (e) => {
  // 1) Î≤ÑÌäºÏù¥Î©¥ Î≤ÑÌäº action, ÏïÑÎãàÎ©¥ row action(view)
  const btn = e.target.closest("button[data-action]");
  const row = e.target.closest("div[data-action][data-id]");

  const act = (btn?.dataset.action || row?.dataset.action || "");
  const id  = (btn?.dataset.id || row?.dataset.id || "");
  const nm  = (btn?.dataset.name || row?.dataset.name || "");

  if(!act || !id) return;

  e.preventDefault();
  e.stopPropagation();

  if(act === "view" || act === "edit"){
    localStorage.setItem("limbus_app_mode_once", act === "view" ? "view" : "edit");
    localStorage.setItem("limbus_load_char_once", id);
    localStorage.setItem("limbus_load_char_name_once", nm); // ‚úÖ ÏïàÏ†ÑÏû•Ïπò
    location.reload();
    return;
  }

  if(act === "export"){
    try{ await exportCharacterToFile(id); }
    catch(err){ console.error(err); alert("ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®(Ïù¥ÎØ∏ÏßÄ/Ï†ÄÏû•Í≥µÍ∞Ñ Î¨∏Ï†úÏùº Ïàò ÏûàÏñ¥)."); }
    return;
  }

  if(act === "delete"){
    if(!confirm(`"${nm || "(Ïù¥Î¶Ñ ÏóÜÏùå)"}" Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌï†Íπå? (Ïù¥ÎØ∏ÏßÄÎäî DBÏóê ÎÇ®ÏùÑ Ïàò ÏûàÏñ¥)`)) return;
    const list2 = loadCharList().filter(x => x.id !== id);
    saveCharList(list2);
    localStorage.removeItem(charDataKey(id));
    toast(libToast, "ÏÇ≠Ï†ú ÏôÑÎ£å!");
    renderCharacterLibrary();
  }
});

document.getElementById("btn-go-library").addEventListener("click", () => {
  hide(viewHome); hide(viewEditor);
  show(viewLibrary);
  setAppMode("edit"); // ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏûêÏ≤¥Îäî Ï°∞Ïûë Í∞ÄÎä•
  renderCharacterLibrary();
});

document.getElementById("btn-lib-back").addEventListener("click", () => {
  setAppMode("edit");               // ‚úÖ Ï∂îÍ∞Ä
  hide(viewLibrary);
  show(viewHome);
});

document.getElementById("btn-save-as-character").addEventListener("click", () => {
  const snap = snapshotCurrentWorkspace();
  const id = charUid();

  // Î™©Î°ù Ï†ÄÏû•
  const list = loadCharList();
  list.unshift({
    id,
    name: snap.name,
    createdAt: nowISO(),
    updatedAt: nowISO(),
  });
  saveCharList(list);

  // Î≥∏Î¨∏ Ï†ÄÏû•
  saveCharData(id, snap);

  toast(libToast, `Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å: ${snap.name}`);
  renderCharacterLibrary();
});

    // ===== view switch =====
    const viewHome = document.getElementById("view-home");
    const viewEditor = document.getElementById("view-editor");
    
    const homeToast = document.getElementById("home-toast");

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function toast(el, msg){
      if(!el) return;
      el.textContent = msg;
      el.style.display = "block";
    }
    function clearToast(el){
      if(!el) return;
      el.textContent = "";
      el.style.display = "none";
    }

// ===== PLAY/MATCH views =====
const viewPlayMode = document.getElementById("view-play-mode");
const viewPlay  = document.getElementById("view-play");
const viewMatch = document.getElementById("view-match");

const playMyChar = document.getElementById("playMyChar");
const playEnemyChar = document.getElementById("playEnemyChar");
const btnAiWaveInfo = document.getElementById("btnAiWaveInfo");
const btnAiWaveInfoClose = document.getElementById("btnAiWaveInfoClose");
const aiWaveInfoPanel = document.getElementById("aiWaveInfoPanel");
const aiWaveInfoList = document.getElementById("aiWaveInfoList");
const playToast = document.getElementById("playToast");
const playMyCharMeta = document.getElementById("playMyCharMeta");
const playEnemyCharMeta = document.getElementById("playEnemyCharMeta");

const matchTitle = document.getElementById("matchTitle");
const matchLog = document.getElementById("matchLog");
const matchToast = document.getElementById("matchToast");

/* ===== MATCH STATE ===== */
let MATCH_STATE = null;

/* ===== MATCH UI elements ===== */
const EL_MATCH = {
  myName: document.getElementById("myNameView"),
  enemyName: document.getElementById("enemyNameView"),
  mySpd: document.getElementById("mySpd"),
  enemySpd: document.getElementById("enemySpd"),

  myPortraitImg: document.getElementById("myPortraitMiniImg"),
  enemyPortraitImg: document.getElementById("enemyPortraitMiniImg"),

  myStats: document.getElementById("myStatsMini"),
  enemyStats: document.getElementById("enemyStatsMini"),

  myStagger: document.getElementById("myStaggerMini"),
  enemyStagger: document.getElementById("enemyStaggerMini"),

  myPhys: document.getElementById("myPhysMini"),
  enemyPhys: document.getElementById("enemyPhysMini"),
  mySin: document.getElementById("mySinMini"),
  enemySin: document.getElementById("enemySinMini"),

  myKeywords: document.getElementById("myKeywordsMini"),
  enemyKeywords: document.getElementById("enemyKeywordsMini"),

  myStatus: document.getElementById("myStatusChips"),
  enemyStatus: document.getElementById("enemyStatusChips"),

  myPassivePrev: document.getElementById("myPassivePreview"),
  enemyPassivePrev: document.getElementById("enemyPassivePreview"),

  mySlots: document.getElementById("mySlots"),
  enemySlots: document.getElementById("enemySlots"),

  mySpecialSkills: document.getElementById("mySpecialSkills"),
  enemyPickedSkills: document.getElementById("enemyPickedSkills"),
  myPickedSkills: document.getElementById("myPickedSkills"),

  turnNo: document.getElementById("matchTurnNo"),
  mySlotInfo: document.getElementById("mySlotInfo"),
  enemySlotInfo: document.getElementById("enemySlotInfo"),

  btnRoll: document.getElementById("btn-match-roll"),
  btnMyPassive: document.getElementById("btnMyPassive"),
  btnEnemyPassive: document.getElementById("btnEnemyPassive"),
};

/* ===== safe helpers ===== */
function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function appendMatchLog(line){
  if(!matchLog) return;
  matchLog.textContent += (matchLog.textContent ? "\n" : "") + line;
  matchLog.scrollTop = matchLog.scrollHeight;
}
function getCoreName(data){
  return data?.name || data?.title || data?.core?.name || "Ïù¥Î¶Ñ ÏóÜÏùå";
}
function getCoreStats(core){
  const st = core?.status || {};

  return [
    ["HP", st?.hp ?? core?.hp ?? core?.HP ?? "-"],
    ["Î∞©Ïñ¥ Lv", st?.defLv ?? core?.defLevel ?? core?.defLv ?? "-"],
    ["Ï†ïÏã†Î†•", "0"], // ‚úÖ Ìï≠ÏÉÅ 0 ÌëúÏãú
  ];
}
function parseResWordToShort(v){
  const t = String(v || "").trim();
  if(!t) return "-";
  if(t.includes("ÏïΩÏ†ê")) return "ÏïΩÏ†ê";
  if(t.includes("Í≤¨Îî§")) return "Í≤¨Îî§";
  if(t.includes("ÏπòÎ™Ö")) return "ÏπòÎ™Ö";
  if(t.includes("ÎÇ¥ÏÑ±")) return "ÎÇ¥ÏÑ±";
  if(t.includes("Î≥¥ÌÜµ")) return "Î≥¥ÌÜµ";
  return t;
}

function parsePreviewSummaryToBattleData(preview, fallbackName){
  const summary = String(preview?.summary || "");
  const name = preview?.name || preview?.title || fallbackName || "Ï†Å";

  const out = {
    name,
    core: {
      name,
      status: { hp: "-", spdMin: 1, spdMax: 6, defLv: "-", sp: 0, skillSlots: 1 },
      phys: {},
      sins: {},
      staggers: []
    },
    passives: [],
    skills: [],
    dedicatedKeywords: []
  };

  const mCore = summary.match(/HP\s*([0-9]+)\s*\/\s*ÏÜçÎèÑ\s*([0-9]+)\s*~\s*([0-9]+)\s*\/\s*Î∞©Ïñ¥\s*Î†àÎ≤®\s*([0-9]+)/);
  if(mCore){
    out.core.status.hp = Number(mCore[1]);
    out.core.status.spdMin = Number(mCore[2]);
    out.core.status.spdMax = Number(mCore[3]);
    out.core.status.defLv = Number(mCore[4]);
  }

  // ÌùêÌä∏Îü¨Ïßê Íµ¨Í∞ÑÏù¥ summaryÏóê ÏóÜÏúºÎ©¥ ÎÑ§ ÏòàÏãú Í∏∞Ï§Ä Í∏∞Î≥∏Í∞í [1,50] Ï§òÎèÑ Îê® (ÏõêÏπò ÏïäÏúºÎ©¥ Ï†úÍ±∞)
  out.core.staggers = [1, 50];

  const mPhys = summary.match(/Ï∞∏Í≤©:\s*([^\s/]+)\s*\/\s*Í¥ÄÌÜµ:\s*([^\s/]+)\s*\/\s*ÌÉÄÍ≤©:\s*([^\n]+)/);
  if(mPhys){
    out.core.phys = {
      slash: parseResWordToShort(mPhys[1]),
      pierce: parseResWordToShort(mPhys[2]),
      blunt: parseResWordToShort(mPhys[3]),
    };
  }

  const passiveBlock = (summary.match(/\[Ìå®ÏãúÎ∏å\]([\s\S]*?)(?:\n\s*\[|$)/) || [])[1] || "";
  const passiveLines = passiveBlock
    .split("\n")
    .map(s => s.replace(/^‚Ä¢\s*/, "").trim())
    .filter(Boolean);

  out.passives = passiveLines.map((nm, i) => ({ id:`pv_preview_${i}`, name:nm, text:"" }));

  const kwLine = (summary.match(/\[Ï†ÑÏö© ÌÇ§ÏõåÎìú\]\s*([^\n]+)/) || [])[1] || "";
  out.dedicatedKeywords = kwLine
    .split("/")
    .map(s => s.trim())
    .filter(Boolean)
    .map((name, i) => ({ id:`dk_preview_${i}`, name, state:"buff", text:"" }));

  return out;
}
function getStaggerText(core){
  const arr =
    core?.staggers ||
    core?.staggerThresholds ||
    core?.stagger ||
    core?.staggerPoints ||
    [];

  if(Array.isArray(arr) && arr.length){
    return `Íµ¨Í∞Ñ: ${arr.join(" / ")}`;
  }
  return "Íµ¨Í∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå";
}
function collectKeywords(data){
  // Îß§Ïπò ÌôîÎ©¥ "ÌÇ§ÏõåÎìú"Îäî Ï†ÑÏö© ÌÇ§ÏõåÎìúÎßå ÌëúÏãú
  const dk = Array.isArray(data?.dedicatedKeywords) ? data.dedicatedKeywords : [];

  const uniq = [...new Set(
    dk.map(k => String(k?.name || "").trim()).filter(Boolean)
  )];

  return uniq.map(name => {
    const info = (typeof findKeywordAny === "function") ? findKeywordAny(name) : null;
    return {
      name,
      state: info?.state === "debuff" ? "debuff" : "buff"
    };
  });
}
function getPassivePreview(data){
  const arr = Array.isArray(data?.passives) ? data.passives : [];
  if(!arr.length) return "-";
  return arr.slice(0,2).map(p => p?.title || p?.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)").join(" / ");
}
function getSkillsByType(data, type){
  const arr = Array.isArray(data?.skills) ? data.skills : [];
  return arr.filter(s => String(s?.skillType || "normal") === type);
}
function getSkillsByType(data, type){
  const arr = Array.isArray(data?.skills) ? data.skills : [];
  return arr.filter(s => {
    const t = String(
      s?.skillType ??
      s?.kind ??       // ‚úÖ ÎÑ§ JSON ÎåÄÏùë
      s?.type ??
      "normal"
    ).toLowerCase();
    return t === String(type).toLowerCase();
  });
}

function getNormalSkills(data){
  const src = (data && data.char) ? data.char : (data || {});
  const arr = Array.isArray(src?.skills) ? src.skills : [];

  return arr.filter(s => {
    const t = String(
      s?.skillType ??
      s?.kind ??
      s?.type ??
      "normal"
    ).toLowerCase().trim();

    // ‚úÖ Íµ¨Î≤ÑÏ†Ñ/ÌòºÌï© Îç∞Ïù¥ÌÑ∞ Î∞©Ïñ¥
    if (s?.isSpecial === true) return false;
    if (t === "special" || t === "ÌäπÏàò") return false;

    return true;
  });
}

function getSpecialSkills(data){
  const src = (data && data.char) ? data.char : (data || {});
  const arr = Array.isArray(src?.skills) ? src.skills : [];

  return arr.filter(s => {
    const t = String(
      s?.skillType ??
      s?.kind ??
      s?.type ??
      "normal"
    ).toLowerCase().trim();

    if (s?.isSpecial === true) return true;
    return (t === "special" || t === "ÌäπÏàò");
  });
}

function getSkillName(s){
  return s?.name || s?.title || "Ïä§ÌÇ¨";
}

function getSkillWeight(s){
  return s?.weight ?? s?.attackWeight ?? "-";
}

function getSkillAppearRate(s){
  // ‚úÖ spawnChanceÍπåÏßÄ ÏßÄÏõê
  const v =
    s?.appearRate ??
    s?.spawnRate ??
    s?.spawnChance ??
    s?.chance;

  return (v === 0 || v) ? `${v}%` : "-";
}

function pickWeightedSkills(skills, count){
  if(!Array.isArray(skills) || !skills.length) return [];

  const pool = skills.map(s => ({
    skill: s,
    // ‚úÖ spawnChanceÍπåÏßÄ ÏßÄÏõê
    w: Number(
      s?.appearRate ??
      s?.spawnRate ??
      s?.spawnChance ??
      s?.chance ??
      100
    ) || 100
  }));

  const out = [];
  for(let i=0;i<count;i++){
    let sum = pool.reduce((a,b)=>a + Math.max(1,b.w), 0);
    let r = Math.random() * sum;
    let picked = pool[0];

    for(const p of pool){
      r -= Math.max(1,p.w);
      if(r <= 0){ picked = p; break; }
    }
    out.push(picked.skill);
  }
  return out;
}function randomSpeed(core){
  const st = core?.status || {};
  const min = Number(st?.spdMin ?? core?.speedMin ?? core?.spdMin ?? 1) || 1;
  const max = Number(st?.spdMax ?? core?.speedMax ?? core?.spdMax ?? 6) || 6;

  const lo = Math.min(min, max);
  const hi = Math.max(min, max);
  return Math.floor(Math.random() * (hi - lo + 1)) + lo;
}
function getSlotCount(core){
  const st = core?.status || {};
  return Number(st?.skillSlots ?? core?.skillSlots ?? core?.slots ?? 1) || 1;
}

/* ===== render helpers ===== */
function renderStatMini(el, core){
  if(!el) return;
  const rows = getCoreStats(core);
  el.innerHTML = rows.map(([k,v]) => `
    <div class="statMiniCell"><b>${escHtml(k)}</b><span>${escHtml(v)}</span></div>
  `).join("");
}
function getStaggerPoints(core){
  const arr = core?.staggers || core?.staggerThresholds || core?.stagger || core?.staggerPoints || [];
  if(!Array.isArray(arr)) return [];
  return arr
    .map(v => Number(v))
    .filter(v => Number.isFinite(v) && v > 0)
    .sort((a,b)=>a-b);
}

function renderStaggerMini(el, core){
  if(!el) return;

  const pts = getStaggerPoints(core);
  if(!pts.length){
    el.innerHTML = `<div class="staggerMiniLine">Íµ¨Í∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå</div>`;
    return;
  }

  const maxVal = Math.max(100, ...pts);
  const marks = pts.map(v => {
    const left = Math.max(0, Math.min(100, (v / maxVal) * 100));
    return `<i class="staggerMiniMark" style="left:calc(${left}% - 1px)"></i>`;
  }).join("");

  const labels = pts.map(v => `<span>${escHtml(v)}%</span>`).join("");

  el.innerHTML = `
    <div class="staggerMiniWrap">
      <div class="staggerMiniBar">${marks}</div>
      <div class="staggerMiniLabels">${labels}</div>
    </div>
  `;
}

function normalizePhysRes(raw){
  if(!raw) return {};
  return {
    "Ï∞∏Í≤©": raw["Ï∞∏Í≤©"] ?? raw.slash ?? "-",
    "Í¥ÄÌÜµ": raw["Í¥ÄÌÜµ"] ?? raw.pierce ?? "-",
    "ÌÉÄÍ≤©": raw["ÌÉÄÍ≤©"] ?? raw.blunt ?? "-"
  };
}

function normalizeSinRes(raw){
  if(!raw) return {};

  // ‚úÖ Îì§Ïñ¥Ïò§Îäî ÌòïÌÉúÍ∞Ä Îã§ÏñëÌï¥ÏÑú ÏµúÎåÄÌïú ÎÑìÍ≤å Î∞õÏùå
  const src =
    raw?.sins ||
    raw?.sinRes ||
    raw?.sin ||
    raw;

  const pick = (...vals) => {
    for(const v of vals){
      if(v !== undefined && v !== null && String(v).trim() !== ""){
        return parseResWordToShort(v);
      }
    }
    return "-";
  };

  return {
    "Î∂ÑÎÖ∏": pick(src["Î∂ÑÎÖ∏"], src.sinWrath, src.wrath, src.Wrath),
    "ÏÉâÏöï": pick(src["ÏÉâÏöï"], src.sinLust, src.lust, src.Lust),
    "ÎÇòÌÉú": pick(src["ÎÇòÌÉú"], src.sinSloth, src.sloth, src.Sloth),
    "ÌÉêÏãù": pick(src["ÌÉêÏãù"], src.sinGluttony, src.gluttony, src.Gluttony),
    "Ïö∞Ïö∏": pick(src["Ïö∞Ïö∏"], src.sinGloom, src.gloom, src.sinMelancholy, src.melancholy, src.Gloom),
    "Ïò§Îßå": pick(src["Ïò§Îßå"], src.sinPride, src.pride, src.Pride),
    "ÏßàÌà¨": pick(src["ÏßàÌà¨"], src.sinEnvy, src.envy, src.Envy)
  };
}

function renderResLine(el, obj, keys){
  if(!el) return;
  const chips = keys.map(k => {
    const v = obj?.[k];
    return `<span class="resChip"><span class="k">${escHtml(k)}</span> <span class="v">${escHtml(v ?? "-")}</span></span>`;
  });
  el.innerHTML = chips.join("");
}
function renderChipWrap(el, items, typeMap){
  if(!el) return;
  if(!items || !items.length){
    el.innerHTML = `<span class="chip empty">ÏóÜÏùå</span>`;
    return;
  }
  el.innerHTML = items.map(t => {
    const cls = typeMap?.[t] ? ` ${typeMap[t]}` : "";
    return `<span class="chip${cls}">${escHtml(t)}</span>`;
  }).join("");
}
function renderKeywordWrap(el, items){
  if(!el) return;
  if(!items || !items.length){
    el.innerHTML = `<span class="chip empty">ÏóÜÏùå</span>`;
    return;
  }

  el.innerHTML = items.map(k => {
    const nm = escHtml(k.name || "");
    const st = (k.state === "debuff") ? "debuff" : "buff";
    return `<span class="pvKW ${st}" data-kw="${nm}" data-state="${st}">${nm}</span>`;
  }).join(" ");
}
function renderSlots(el, unitKey){
  if(!el || !MATCH_STATE) return;
  const unit = MATCH_STATE[unitKey];
  el.innerHTML = "";
  const count = unit.slotCount || 1;
  for(let i=0;i<count;i++){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `slotBtn ${unitKey==="enemy" ? "ai" : ""} ${unit.selectedSlot===i ? "active" : ""}`;
    btn.textContent = `${i+1} Ïä¨Î°Ø`;
    btn.addEventListener("click", () => {
      unit.selectedSlot = i;
      renderSlots(EL_MATCH.mySlots, "my");
      renderSlots(EL_MATCH.enemySlots, "enemy");
      refreshTurnSideInfo();
    });
    el.appendChild(btn);
  }
}
function renderPickedSkills(el, list){
  if(!el) return;

  if(!list || !list.length){
    el.innerHTML = `<div class="skillPickItem"><div class="meta">ÏïÑÏßÅ ÏóÜÏùå</div></div>`;
    return;
  }

  el.innerHTML = "";

  list.forEach((s, idx) => {
    const card = document.createElement("div");
    card.className = "skListCard matchPickedMini";
    card.style.marginBottom = "8px";

    const top = document.createElement("div");
    top.className = "skListTop";

    // Ï¢åÏ∏° ÏïÑÌä∏
    const art = document.createElement("div");
    art.className = "skListArt";

    const frameBox = document.createElement("div");
    frameBox.className = "skListFrame";

    const frame = document.createElement("img");
    frame.alt = "frame";
    frame.src = (typeof framePath === "function")
      ? framePath(s.sin, Number(s.tier || 1))
      : "";
    frameBox.appendChild(frame);

    const inner = document.createElement("div");
    inner.className = "inner";

    const innerImg = document.createElement("img");
    innerImg.alt = "skill image";

    // ‚úÖ imgKey(Í∏∞Ï°¥) ÎòêÎäî imgSrc(JSON Í≤ΩÎ°ú) ÏßÄÏõê
// ‚úÖ imgKey(Í∏∞Ï°¥) / imgSrc(JSON Í≤ΩÎ°ú) / AI Ïä§ÌÇ¨Î™Ö fallback ÏßÄÏõê
if(s.imgSrc){
  innerImg.src = s.imgSrc;
}else if(s.imgKey && typeof idbGetBlob === "function" && typeof makeObjectURLFromBlob === "function"){
  idbGetBlob(s.imgKey).then(blob => {
    if(blob){
      innerImg.src = makeObjectURLFromBlob(blob);
    }else{
      const fb = (typeof getAiSkillImageFallback === "function") ? getAiSkillImageFallback(getSkillName(s)) : "";
      innerImg.src = fb || "";
    }
  }).catch(()=>{
    const fb = (typeof getAiSkillImageFallback === "function") ? getAiSkillImageFallback(getSkillName(s)) : "";
    innerImg.src = fb || "";
  });
}else{
  const fb = (typeof getAiSkillImageFallback === "function") ? getAiSkillImageFallback(getSkillName(s)) : "";
  innerImg.src = fb || "";
}

    inner.appendChild(innerImg);
    frameBox.appendChild(inner);
    art.appendChild(frameBox);

    // ÏΩîÏù∏ ÏïÑÏù¥ÏΩò
    const coinRow = document.createElement("div");
    coinRow.className = "skListCoins";
    const coinCount = Math.max(1, Number(s.coinCount || s.qty || 1));
    const coinType  = String(s.coinType || "normal");
    for(let i=0;i<coinCount;i++){
      const c = document.createElement("img");
      c.src = (typeof coinIconPath === "function") ? coinIconPath(coinType) : "";
      c.alt = "coin";
      coinRow.appendChild(c);
    }
    art.appendChild(coinRow);

    // Ïö∞Ï∏° Î≥∏Î¨∏
    const main = document.createElement("div");
    main.className = "skListMain";

    const titleBar = document.createElement("div");
    titleBar.className = "skListTitleBar";
    titleBar.innerHTML = `<div class="skListTitle">${idx+1}. ${escHtml(getSkillName(s))}</div>`;

    const stat = document.createElement("div");
    stat.className = "skListStat";

    const rows = [
      ["Í≥µÍ≤© Í∞ÄÏ§ëÏπò", String(getSkillWeight(s))],
      ["Îì±Ïû• ÌôïÎ•†", String(getSkillAppearRate(s))],
      ["Ï£ÑÏïÖ ÏÜçÏÑ±", (typeof sinLabel === "function" ? sinLabel(s.sin) : (s.sin || "-"))],
      ["Í≥µÍ≤© Ïú†Ìòï", (typeof atkLabel === "function" ? atkLabel(s.atkType) : (s.atkType || "-"))],
    ];

    for(const [th, td] of rows){
      const r = document.createElement("div");
      r.className = "skListStatRow";

      const thEl = document.createElement("div");
      thEl.className = "skListStatTh";
      thEl.textContent = th;

      const tdEl = document.createElement("div");
      tdEl.className = "skListStatTd";

      if(th === "Ï£ÑÏïÖ ÏÜçÏÑ±" && typeof sinIconPath === "function"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = sinIconPath(s.sin);
        img.alt = td;
        tdEl.appendChild(img);
      }

      if(th === "Í≥µÍ≤© Ïú†Ìòï" && typeof atkIconPath === "function"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = atkIconPath(s.atkType);
        img.alt = td;
        tdEl.appendChild(img);
      }

      const sp = document.createElement("span");
      sp.textContent = td;
      tdEl.appendChild(sp);

      r.appendChild(thEl);
      r.appendChild(tdEl);
      stat.appendChild(r);
    }

    main.appendChild(titleBar);
    main.appendChild(stat);

    // Ìö®Í≥º ÌÖçÏä§Ìä∏(ÏûàÏúºÎ©¥)
    const textRaw = String(s.text || "").trim();
    if(textRaw){
      const eff = document.createElement("div");
      eff.className = "skListFx";
      eff.innerHTML = (typeof skToHtml === "function")
        ? skToHtml(textRaw)
        : escHtml(textRaw).replace(/\n/g, "<br>");
      main.appendChild(eff);

      // ‚úÖ Ìö®Í≥º Ïïà ÌÇ§ÏõåÎìú Ìà¥ÌåÅ
      if(typeof bindKwTooltipHover === "function"){
        setTimeout(() => bindKwTooltipHover(eff), 0);
      }
    }

    top.appendChild(art);
    top.appendChild(main);
    card.appendChild(top);
    el.appendChild(card);
  });
}
function renderSpecialSkillList(el){
  if(!el || !MATCH_STATE) return;
  const list = MATCH_STATE.my.specialSkills || [];
  if(!list.length){
    el.innerHTML = `<div class="skillPickItem"><div class="meta">ÌäπÏàò Ïä§ÌÇ¨ ÏóÜÏùå</div></div>`;
    return;
  }
  el.innerHTML = "";
  list.forEach((s) => {
    const wrap = document.createElement("div");
    wrap.className = "skillPickItem";
    wrap.innerHTML = `
      <div class="nm">${escHtml(getSkillName(s))}</div>
      <div class="meta">Í≥µÍ≤© Í∞ÄÏ§ëÏπò: ${escHtml(getSkillWeight(s))}</div>
      <button type="button">ÌòÑÏû¨ ÎΩëÏùÄ Ïä§ÌÇ¨Ïóê Ï∂îÍ∞Ä</button>
    `;
    wrap.querySelector("button")?.addEventListener("click", () => {
      MATCH_STATE.my.pickedSkills.push(s);
      renderPickedSkills(EL_MATCH.myPickedSkills, MATCH_STATE.my.pickedSkills);
      appendMatchLog(`ÎÇ¥ ÌäπÏàò Ïä§ÌÇ¨ Ï∂îÍ∞Ä: ${getSkillName(s)}`);
    });
    el.appendChild(wrap);
  });
}
function refreshTurnSideInfo(){
  if(!MATCH_STATE) return;
  EL_MATCH.mySlotInfo.textContent = `${(MATCH_STATE.my.slotCount||1)}Ïπ∏ / ÏÑ†ÌÉù ${((MATCH_STATE.my.selectedSlot??0)+1)}Î≤à`;
  EL_MATCH.enemySlotInfo.textContent = `${(MATCH_STATE.enemy.slotCount||1)}Ïπ∏ / ÏÑ†ÌÉù ${((MATCH_STATE.enemy.selectedSlot??0)+1)}Î≤à`;
}
async function tryRenderPortrait(imgEl, data){
  if(!imgEl) return;
  imgEl.style.display = "none";
  imgEl.src = "";

  // 1) Í∏∞Ï°¥ objectURL ÌÇ§ Í∏∞Î∞ò (Í∞ÄÏû• ÏïàÏ†Ñ)
  const key = data?.core?.portraitKey || data?.core?.portrait?.blobKey || data?.portraitKey || "";
  if(key && typeof applyIconKeyToImg === "function"){
    try{
      await applyIconKeyToImg(imgEl, key);
      return;
    }catch(e){}
  }

  // 2) data URL / src ÏßÅÏ†ë Ï†ÄÏû•Îêú Í≤ΩÏö∞
  const src = data?.core?.portraitUrl || data?.core?.portraitSrc || data?.portrait || "";
  if(src){
    imgEl.src = src;
    imgEl.style.display = "block";
  }
}

/* ===== main match init/render ===== */
function createBattleUnitFromChar(data, side){
  // ‚úÖ {char:{...}} ÎûòÌçºÎ°ú Îì§Ïñ¥Ïò§Îäî Í≤ΩÏö∞ ÏûêÎèô Ïñ∏Îû©
  const src = (data && data.char) ? data.char : (data || {});
  const rawCore = src?.core || {};
const st = rawCore?.status || {};

// ‚úÖ Îß§Ïπò ÌôîÎ©¥ÏóêÏÑú Ïì∞Í∏∞ Ïâ¨Ïö¥ ÌòïÌÉúÎ°ú core Ï†ïÍ∑úÌôî
const core = {
  ...rawCore,
  status: {
    ...st,
    hp: st.hp ?? rawCore.hp ?? rawCore.HP ?? "-",
    defLv: st.defLv ?? rawCore.defLv ?? rawCore.defLevel ?? "-",
    spdMin: st.spdMin ?? rawCore.spdMin ?? rawCore.speedMin ?? 1,
    spdMax: st.spdMax ?? rawCore.spdMax ?? rawCore.speedMax ?? 6,
    skillSlots: st.skillSlots ?? rawCore.skillSlots ?? 1,
    sanity: 0
  },

  // Î†åÎçîÎü¨ Ìò∏ÌôòÏö© Î≥ÑÏπ≠Îì§
  hp: rawCore.hp ?? st.hp ?? "-",
  defLevel: rawCore.defLevel ?? rawCore.defLv ?? st.defLv ?? "-",
  sanity: 0,
  speedMin: rawCore.speedMin ?? rawCore.spdMin ?? st.spdMin ?? 1,
  speedMax: rawCore.speedMax ?? rawCore.spdMax ?? st.spdMax ?? 6,
  skillSlots: rawCore.skillSlots ?? st.skillSlots ?? 1,

  // ÎÇ¥ÏÑ±/ÌùêÌä∏Îü¨Ïßê Ìò∏Ìôò
  physRes: rawCore.physRes || rawCore.physicalRes || rawCore.phys || {},
  sinRes: rawCore.sinRes || rawCore.sins || {},
  staggers: rawCore.staggers || rawCore.staggerThresholds || rawCore.stagger || rawCore.staggerPoints || []
};

  const normalSkills = getNormalSkills(src);
  const specialSkills = getSpecialSkills(src);

  return {
    side,
    raw: { ...src, core },                 // ‚úÖ Î∞òÎìúÏãú Ïñ∏Îû©Îêú char Ï†ÄÏû•
    core,
    slotCount: getSlotCount(core),
    selectedSlot: 0,
    speed: "-",
    normalSkills,
    specialSkills,
    pickedSkills: [],
    statusChips: [],
  };
}

async function initMatchScreenData({ myData, enemyData, enemyIsAi=false, enemyAiMeta=null }){
  MATCH_STATE = {
    turn: 1,
    enemyIsAi,
    enemyAiMeta,
    my: createBattleUnitFromChar(myData, "my"),
    enemy: createBattleUnitFromChar(enemyData, "enemy"),
  };

  await renderMatchScreen();
}

async function renderMatchScreen(){
  if(!MATCH_STATE) return;

  const myData = MATCH_STATE.my.raw;
  const enData = MATCH_STATE.enemy.raw;

  EL_MATCH.myName.textContent = getCoreName(myData);
  EL_MATCH.enemyName.textContent = getCoreName(enData);

  EL_MATCH.mySpd.textContent = `SPD ${MATCH_STATE.my.speed}`;
  EL_MATCH.enemySpd.textContent = `SPD ${MATCH_STATE.enemy.speed}`;
  EL_MATCH.turnNo.textContent = String(MATCH_STATE.turn);

  renderStatMini(EL_MATCH.myStats, myData.core || {});
  renderStatMini(EL_MATCH.enemyStats, enData.core || {});

  renderStaggerMini(EL_MATCH.myStagger, myData.core || {});
  renderStaggerMini(EL_MATCH.enemyStagger, enData.core || {});

renderResLine(
  EL_MATCH.myPhys,
  normalizePhysRes((myData.core || {}).physRes || (myData.core || {}).physicalRes || (myData.core || {}).phys || {}),
  ["Ï∞∏Í≤©","Í¥ÄÌÜµ","ÌÉÄÍ≤©"]
);
renderResLine(
  EL_MATCH.enemyPhys,
  normalizePhysRes((enData.core || {}).physRes || (enData.core || {}).physicalRes || (enData.core || {}).phys || {}),
  ["Ï∞∏Í≤©","Í¥ÄÌÜµ","ÌÉÄÍ≤©"]
);

renderResLine(
  EL_MATCH.mySin,
  normalizeSinRes((myData.core || {}).sinRes || (myData.core || {}).sins || {}),
  ["Î∂ÑÎÖ∏","ÏÉâÏöï","ÎÇòÌÉú","ÌÉêÏãù","Ïö∞Ïö∏","Ïò§Îßå","ÏßàÌà¨"]
);
renderResLine(
  EL_MATCH.enemySin,
  normalizeSinRes((enData.core || {}).sinRes || (enData.core || {}).sins || {}),
  ["Î∂ÑÎÖ∏","ÏÉâÏöï","ÎÇòÌÉú","ÌÉêÏãù","Ïö∞Ïö∏","Ïò§Îßå","ÏßàÌà¨"]
);

renderKeywordWrap(EL_MATCH.myKeywords, collectKeywords(myData));
renderKeywordWrap(EL_MATCH.enemyKeywords, collectKeywords(enData));

ensureKwTooltipBound(EL_MATCH.myKeywords);
ensureKwTooltipBound(EL_MATCH.enemyKeywords);

  renderChipWrap(EL_MATCH.myStatus, MATCH_STATE.my.statusChips);
  renderChipWrap(EL_MATCH.enemyStatus, MATCH_STATE.enemy.statusChips);

EL_MATCH.myPassivePrev.textContent = "";
EL_MATCH.enemyPassivePrev.textContent = "";

  renderSlots(EL_MATCH.mySlots, "my");
  renderSlots(EL_MATCH.enemySlots, "enemy");

  renderSpecialSkillList(EL_MATCH.mySpecialSkills);
  renderPickedSkills(EL_MATCH.myPickedSkills, MATCH_STATE.my.pickedSkills);
  renderPickedSkills(EL_MATCH.enemyPickedSkills, MATCH_STATE.enemy.pickedSkills);

  refreshTurnSideInfo();

  await tryRenderPortrait(EL_MATCH.myPortraitImg, myData);
  await tryRenderPortrait(EL_MATCH.enemyPortraitImg, enData);
}

/* ===== actions ===== */
function rollTurnForBoth(){
  if(!MATCH_STATE) return;

  MATCH_STATE.my.speed = randomSpeed(MATCH_STATE.my.core);
  MATCH_STATE.enemy.speed = randomSpeed(MATCH_STATE.enemy.core);

  MATCH_STATE.my.pickedSkills = pickWeightedSkills(MATCH_STATE.my.normalSkills, MATCH_STATE.my.slotCount);
  MATCH_STATE.enemy.pickedSkills = pickWeightedSkills(MATCH_STATE.enemy.normalSkills, MATCH_STATE.enemy.slotCount);

  // AI: Ï†ÅÏùÄ ÏÜçÎèÑ ÎÜíÏùÄ Ïä¨Î°ØÎ∂ÄÌÑ∞ ÏûÑÏùò ÏßÄÏ†ï(ÏùºÎã® ÎçîÎØ∏)
  MATCH_STATE.enemy.selectedSlot = 0;
  if(MATCH_STATE.enemy.slotCount > 1){
    MATCH_STATE.enemy.selectedSlot = Math.floor(Math.random() * MATCH_STATE.enemy.slotCount);
  }

  renderMatchScreen();

  appendMatchLog(`[ÌÑ¥ ${MATCH_STATE.turn}] ÏÜçÎèÑ Íµ¥Î¶º`);
  appendMatchLog(`- ÎÇ¥ ÏÜçÎèÑ: ${MATCH_STATE.my.speed}`);
  appendMatchLog(`- Ï†Å ÏÜçÎèÑ: ${MATCH_STATE.enemy.speed}`);

  if(MATCH_STATE.enemy.pickedSkills.length){
    const aiNames = MATCH_STATE.enemy.pickedSkills.map(s => getSkillName(s)).join(", ");
    appendMatchLog(`- Ï†ÅÏù¥ ÎΩëÏùÄ Ïä§ÌÇ¨: ${aiNames} (ÏÑ†ÌÉù Ïä¨Î°Ø ${MATCH_STATE.enemy.selectedSlot+1})`);
  }
}

function injectPassiveKeywordTokens(textRaw, unitRaw){
  let text = String(textRaw || "");
  if(!text) return text;

  const allKw = [];

  // Í∏∞Î≥∏/ÎåÄÌëú
  for(const k of (Array.isArray(BASE_KEYWORDS) ? BASE_KEYWORDS : [])){
    if(k?.name) allKw.push({
      name: String(k.name),
      state: (k.state === "debuff") ? "debuff" : "buff"
    });
  }
  for(const k of (Array.isArray(REP_KEYWORDS) ? REP_KEYWORDS : [])){
    if(k?.name) allKw.push({
      name: String(k.name),
      state: (k.state === "debuff") ? "debuff" : "buff"
    });
  }

  // ÌòÑÏû¨ Ïú†Îãõ Ï†ÑÏö©
  for(const k of (Array.isArray(unitRaw?.dedicatedKeywords) ? unitRaw.dedicatedKeywords : [])){
    if(k?.name) allKw.push({
      name: String(k.name),
      state: (k.state === "debuff") ? "debuff" : "buff"
    });
  }

  // Ï§ëÎ≥µ Ï†úÍ±∞ + Í∏¥ Ïù¥Î¶Ñ Ïö∞ÏÑ†
  const seen = new Set();
  const uniq = [];
  for(const kw of allKw){
    const key = `${kw.state}::${kw.name}`;
    if(seen.has(key)) continue;
    seen.add(key);
    uniq.push(kw);
  }
  uniq.sort((a,b) => b.name.length - a.name.length);

  if(!uniq.length) return text;

  // ‚úÖ Ïù¥ÎØ∏ Îì§Ïñ¥ÏûàÎäî [[kw:...]] ÌÜ†ÌÅ∞ÏùÄ Î≥¥Ìò∏
  const tokenStore = [];
  text = text.replace(/\[\[kw:(buff|debuff):([^\]]+)\]\]/g, (m) => {
    const idx = tokenStore.push(m) - 1;
    return `__KW_TOKEN_${idx}__`;
  });

  // ‚úÖ "Ìïú Î≤àÏóê" ÏπòÌôò (ÌÜ†ÌÅ∞ ÎÇ¥Î∂Ä Ïû¨ÏπòÌôò Î∞©ÏßÄ)
  const escapedNames = uniq.map(kw => kw.name.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"));
  const rx = new RegExp(escapedNames.join("|"), "g");

  text = text.replace(rx, (matched) => {
    const hit = uniq.find(kw => kw.name === matched);
    if(!hit) return matched;
    return `[[kw:${hit.state}:${hit.name}]]`;
  });

  // Î≥¥Ìò∏ ÌÜ†ÌÅ∞ Î≥µÏõê
  text = text.replace(/__KW_TOKEN_(\d+)__/g, (m, n) => tokenStore[Number(n)] || m);

  return text;
}
function openMatchPassiveModal(unitRaw){
  const src = (unitRaw && unitRaw.char) ? unitRaw.char : (unitRaw || {});
  const list = Array.isArray(src?.passives) ? src.passives : [];

  document.getElementById("matchPassiveModal")?.remove();

  const modal = document.createElement("div");
  modal.id = "matchPassiveModal";
  modal.style.cssText = `
    position:fixed; inset:0; z-index:99999;
    background:rgba(0,0,0,.6);
    display:flex; align-items:center; justify-content:center;
    padding:18px;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    width:min(920px, 100%);
    max-height:82vh; overflow:auto;
    border:1px solid rgba(255,255,255,.14);
    border-radius:16px;
    background:rgba(8,10,14,.96);
    box-shadow:0 18px 60px rgba(0,0,0,.6);
  `;

  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);">
      <div style="font-weight:900;color:rgba(243,211,154,.95);">Ìå®ÏãúÎ∏å</div>
      <button type="button" id="matchPassiveClose" class="ghost">Îã´Í∏∞</button>
    </div>
    <div id="matchPassiveBody" style="padding:12px;"></div>
  `;

  modal.appendChild(box);
  document.body.appendChild(modal);

  const body = box.querySelector("#matchPassiveBody");

  if(!list.length){
    body.innerHTML = `<div style="color:rgba(238,241,255,.65);">Ìå®ÏãúÎ∏å ÏóÜÏùå</div>`;
  }else{
    body.innerHTML = list.map((p, i) => {
      const title = escHtml(p?.name || p?.title || `Ìå®ÏãúÎ∏å ${i+1}`);
      const styleCls = (p?.style === "red") ? "red" : "brown";
      const importance = escHtml(String(p?.importance || p?.rank || p?.tier || "").trim());

      const textRaw = injectPassiveKeywordTokens(
        String(p?.text || p?.content || p?.desc || "").trim(),
        src
      );

      const textHtml = textRaw
        ? (typeof applyInlineTokensEscaped === "function"
            ? applyInlineTokensEscaped(escHtml(textRaw)).replace(/\n/g, "<br>")
            : escHtml(textRaw).replace(/\n/g, "<br>"))
        : `<span style="opacity:.65;">ÏÑ§Î™Ö ÏóÜÏùå</span>`;

      return `
        <div class="pvCard" style="margin-bottom:10px;">
          <div class="pvHdr ${styleCls}">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <span>${title}</span>
              ${importance ? `<span style="font-size:11px;padding:2px 6px;border:1px solid rgba(255,255,255,.18);border-radius:999px;opacity:.9;">${importance}</span>` : ""}
            </div>
            <div class="slashes"><i></i><i></i><i></i></div>
          </div>
          <div class="pvBody">${textHtml}</div>
        </div>
      `;
    }).join("");
  }

  // ‚úÖ Ìå®ÏãúÎ∏å Î™®Îã¨ ÎÇ¥Î∂Ä ÌÇ§ÏõåÎìú Ìà¥ÌåÅ ÌôúÏÑ±Ìôî
  if(typeof bindKwTooltipHover === "function"){
    bindKwTooltipHover(body);
  }

  const close = () => modal.remove();
  modal.addEventListener("click", (e) => { if(e.target === modal) close(); });
  box.querySelector("#matchPassiveClose")?.addEventListener("click", close);
}

/* Î≤ÑÌäº Ïó∞Í≤∞ */
EL_MATCH.btnRoll?.addEventListener("click", () => {
  rollTurnForBoth();
});

EL_MATCH.btnMyPassive?.addEventListener("click", () => {
  if(!MATCH_STATE) return;
  openMatchPassiveModal(MATCH_STATE.my.raw);
});

EL_MATCH.btnEnemyPassive?.addEventListener("click", () => {
  if(!MATCH_STATE) return;
  openMatchPassiveModal(MATCH_STATE.enemy.raw);
});

document.getElementById("btn-match-next")?.addEventListener("click", () => {
  if(!MATCH_STATE){
    toast(matchToast, "Îß§Ïπò ÏÉÅÌÉúÍ∞Ä ÏóÜÏñ¥.");
    return;
  }
  MATCH_STATE.turn += 1;
  EL_MATCH.turnNo.textContent = String(MATCH_STATE.turn);
  appendMatchLog(`--- ÌÑ¥ ${MATCH_STATE.turn} ÏãúÏûë ---`);
  toast(matchToast, "Îã§Ïùå ÌÑ¥ (ÎçîÎØ∏)");
});

// ===== AI battle mode =====
let playBattleMode = "char"; // "char" | "ai"

const playArena = document.getElementById("playArena");
const playLobbyHome = document.querySelector("#view-play .home");
const playLobbyTitle = document.querySelector("#view-play .playTitle");
const btnPlayRandom = document.getElementById("btn-play-random");

const AI_OPPONENTS = [
  {
    id: "ai_lei_heng",
    name: "ÎáåÌö° | Èõ∑Ê©´",
    subtitle: "Lei Heng | Èõ∑Ê®™",
    desc: "ÏóÑÏßÄ Ïπ¥Ìè¨ IIII / ÏÜåÏßÄ Ï≤úÌá¥ÏÑ±",
    theme: {
      bg: "assets/bg_ai_leiheng_train.png",
      panel: "rgba(30,18,8,0.72)",
      line: "rgba(255,190,90,0.28)",
      glow: "rgba(255,160,60,0.24)",
      name: "rgba(255,226,150,0.98)",
      sub: "rgba(255,212,110,0.92)"
    },
    coreText: "ÎÇúÏù¥ÎèÑ/ÌïµÏã¨Ï†ïÎ≥¥Îäî Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Î∂ôÏùº ÏòàÏ†ï"
  }
];

// ===== AI Î≥¥Ïä§ Ïõ®Ïù¥Î∏å Ï†ïÏùò =====
const AI_BOSSES = {
  ai_lei_heng: {
    id: "ai_lei_heng",
    name: "ÎáåÌö°",
    sub: "Lei Heng | Èõ∑Ê®™",
    waves: [
      { wave: 1, type: "enemy", charId: "thumb_soldato_2", visibleInInfo: true },
      { wave: 2, type: "enemy", charId: "thumb_soldato_3", visibleInInfo: true },
      { wave: 3, type: "boss",  charId: "ai_lei_heng",     visibleInInfo: false }
    ]
  }
};

// ===== Ï†ÑÌà¨ Ï†Ñ ÏÉÅÏÑ∏Ï†ïÎ≥¥(ÎØ∏Î¶¨Î≥¥Í∏∞) Îç∞Ïù¥ÌÑ∞ =====
// Ïó¨Í∏∞ summaryÎäî ÎÇòÏ§ëÏóê ÎÑ§Í∞Ä ÏßÅÏ†ë ÍµêÏ≤¥ÌïòÎ©¥ Îèº.
const PREVIEW_CHAR_INFO = {
thumb_soldato_2: {
  title: "Í∞Å Ïû°Ìûå ÏóÑÏßÄ ÏÜîÎã§ÌÜ† II",
  summary:
`[ÌïµÏã¨ ÏÉÅÌÉú]
HP 1338 / ÏÜçÎèÑ 2~5 / Î∞©Ïñ¥ Î†àÎ≤® 74
Ï∞∏Í≤©: ÏïΩÏ†ê / Í¥ÄÌÜµ: Í≤¨Îî§ / ÌÉÄÍ≤©: Î≥¥ÌÜµ

[Ìå®ÏãúÎ∏å]
‚Ä¢ Í∑úÏú® ÏßëÌñâ - Ï§ÄÎπÑ Îã®Í≥Ñ
‚Ä¢ Í∑úÏú® ÏßëÌñâ - ÏïÑÎûòÌÑ± Î∂ÄÏàòÍ∏∞
‚Ä¢ Ïñ¥Í∏ãÎÇú Í∑úÏú®
‚Ä¢ Ï∂îÎ†• ÏÉÅÏã§
‚Ä¢ Í∑úÏú® ÏßëÌñâ - Ïó∞Ïû• Îã®Í≥Ñ

[Ï£ºÏöî Ïä§ÌÇ¨]
‚Ä¢ ÏßÑÌÉï Íø∞Îö´Í∏∞ (ÎÇòÌÉú / ÌÉÄÍ≤©) ÏúÑÎ†• 8, ÏΩîÏù∏ +5 x2, Îì±Ïû•ÌôïÎ•† 40%
  - ÏßÑÎèô/ÌôîÏÉÅ Ìï© ÏàòÏπòÏóê Îî∞Îùº ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÏßÑÎèô Î∂ÄÏó¨ + ÏßÑÎèô ÌöüÏàò Ï¶ùÍ∞Ä

‚Ä¢ ÏûëÏó¥ Íø∞Îö´Í∏∞ (Î∂ÑÎÖ∏ / Í¥ÄÌÜµ) ÏúÑÎ†• 8, ÏΩîÏù∏ +6 x2, Îì±Ïû•ÌôïÎ•† 40%
  - ÏßÑÎèô/ÌôîÏÉÅ Ìï© ÏàòÏπòÏóê Îî∞Îùº ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÌôîÏÉÅ Î∂ÄÏó¨ + ÌôîÏÉÅ ÌöüÏàò Ï¶ùÍ∞Ä

‚Ä¢ Ï∂îÏßÑ Í∞ÄÎ•¥Í∏∞ (Î∂ÑÎÖ∏ / Í¥ÄÌÜµ) ÏúÑÎ†• 9, ÏΩîÏù∏ +6 x2, Îì±Ïû•ÌôïÎ•† 20%
  - ÌååÍ¥¥ Î∂àÍ∞Ä ÏΩîÏù∏
  - Ï∂îÏßÑÌÉÑ ÏÜåÎ™®
  - ÏßÑÎèô/ÌôîÏÉÅ ÎèôÏãú Î∂ÄÏó¨
  - ÏßÑÎèô Ìè≠Î∞ú / ÏßÑÌè≠ Î≥ÄÌôò Ïó∞Í≥Ñ

‚Ä¢ Ï∂îÏßÑÌÉÑ Ïû¨Ïû•Ï†Ñ (ÌäπÏàò / Ìï©Í∞ÄÎä• ÏàòÎπÑ)
  - Ìï© ÏäπÎ¶¨ Ïãú Ïû¨Ïû•Ï†Ñ
  - Ìï© Ìå®Î∞∞ Ïãú Ï∂îÏßÑÌÉÑ Í∞êÏÜå
  - Ï°∞Í±¥ Ï∂©Ï°± Ïãú ÏΩîÏù∏ ÏúÑÎ†• +5

[Ï†ÑÏö© ÌÇ§ÏõåÎìú]
Ï∂îÎ†• ÏÉÅÏã§ / Ïû¨Ïû•Ï†Ñ / Ï∂îÏßÑÌÉÑ / ÏßÑÎèô - ÏûëÏó¥`
},
  thumb_soldato_3: {
    name: "Í∞Å Ïû°Ìûå ÏóÑÏßÄ ÏÜîÎã§ÌÜ† III",
    summary:
`[ÌïµÏã¨ ÏÉÅÌÉú]
HP 2007 / ÏÜçÎèÑ 4~7 / Î∞©Ïñ¥ Î†àÎ≤® 84
Ï∞∏Í≤©: Î≥¥ÌÜµ / Í¥ÄÌÜµ: Í≤¨Îî§ / ÌÉÄÍ≤©: Î≥¥ÌÜµ

[Ìå®ÏãúÎ∏å]
‚Ä¢ Í∑úÏú® ÏßëÌñâ - Ï§ÄÎπÑ Îã®Í≥Ñ
‚Ä¢ Í∑úÏú® ÏßëÌñâ - ÏïÑÎûòÌÑ± Î∂ÄÏàòÍ∏∞
‚Ä¢ Ïñ¥Í∏ãÎÇú Í∑úÏú®
‚Ä¢ Ï∂îÎ†• ÏÉÅÏã§
‚Ä¢ Í∑úÏú® ÏßëÌñâ - Ïó∞Ïû• Îã®Í≥Ñ

[Ï£ºÏöî Ïä§ÌÇ¨]
‚Ä¢ ÏßÑÌÉï Íø∞Îö´Í∏∞ - Ï∂î[Êé®] (ÎÇòÌÉú / ÌÉÄÍ≤©) ÏúÑÎ†• 10, ÏΩîÏù∏ +5 x2, Îì±Ïû•ÌôïÎ•† 40%
  - Ï∂îÏßÑÌÉÑÏùÑ ÏÜåÎ™®ÌïòÏó¨ ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÏßÑÎèô/ÌôîÏÉÅ Ìï© ÏàòÏπòÏóê Îî∞Îùº ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÏßÑÎèô Î∂ÄÏó¨ + ÏßÑÎèô ÌöüÏàò Ï¶ùÍ∞Ä

‚Ä¢ ÏûëÏó¥ Íø∞Îö´Í∏∞ - Ï∂î[Êé®] (Î∂ÑÎÖ∏ / Í¥ÄÌÜµ) ÏúÑÎ†• 10, ÏΩîÏù∏ +6 x2, Îì±Ïû•ÌôïÎ•† 40%
  - Ï∂îÏßÑÌÉÑÏùÑ ÏÜåÎ™®ÌïòÏó¨ ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÏßÑÎèô/ÌôîÏÉÅ Ìï© ÏàòÏπòÏóê Îî∞Îùº ÏΩîÏù∏ ÏúÑÎ†• Ï¶ùÍ∞Ä
  - ÌôîÏÉÅ Î∂ÄÏó¨ + ÌôîÏÉÅ ÌöüÏàò Ï¶ùÍ∞Ä

‚Ä¢ Ï∂îÏßÑ Í∞ÄÎ•¥Í∏∞ - Ï∂î[Êé®] (Î∂ÑÎÖ∏ / Í¥ÄÌÜµ) ÏúÑÎ†• 11, ÏΩîÏù∏ +6 x2, Îì±Ïû•ÌôïÎ•† 20%
  - ÌååÍ¥¥ Î∂àÍ∞Ä ÏΩîÏù∏
  - Ï∂îÏßÑÌÉÑ ÏÜåÎ™®
  - ÏßÑÎèô/ÌôîÏÉÅ ÎèôÏãú Î∂ÄÏó¨
  - ÏßÑÎèô Ìè≠Î∞ú / ÏßÑÌè≠ Î≥ÄÌôò Ïó∞Í≥Ñ

‚Ä¢ Ï∂îÏßÑÌÉÑ Ïû¨Ïû•Ï†Ñ (ÌäπÏàò / Ìï©Í∞ÄÎä• ÏàòÎπÑ)
  - ÌååÍ¥¥ Î∂àÍ∞Ä ÏΩîÏù∏
  - Ìï© ÏäπÎ¶¨ Ïãú Ïû¨Ïû•Ï†Ñ
  - Ìï© Ìå®Î∞∞ Ïãú Ï∂îÏßÑÌÉÑ Í∞êÏÜå
  - Ï°∞Í±¥ Ï∂©Ï°± Ïãú ÏΩîÏù∏ ÏúÑÎ†• +5

[Ï†ÑÏö© ÌÇ§ÏõåÎìú]
Ï∂îÎ†• ÏÉÅÏã§ / Ïû¨Ïû•Ï†Ñ / Ï∂îÏßÑÌÉÑ / ÏßÑÎèô - ÏûëÏó¥`
  }
};

// ===== ÎáåÌö° Ï†ÑÏö© ÌÖçÏä§Ìä∏/ÏùåÏÑ± Ìó¨Ìçº =====
const LEIHENG_VOICE_SRC = "assets/voice_ai_leiheng_select.mp3"; // ÌååÏùºÎ™ÖÏùÄ ÎÑ§Í∞Ä Î∞îÍøîÎèÑ Îê®
let lastPlayedAiVoiceId = "";
let _lhVoiceAudio = null;
let _aiBattleBgm = null;
let _aiBattleBgmKey = "";

function isLeiHengId(id){
  return String(id || "").replace(/^ai:/, "") === "ai_lei_heng";
}

function getThemedCharLabelHtml(c){
  if(!c) return "";
  const isLH = isLeiHengId(c.id);
  const n = String(c.name || "");
  const s = String(c.subtitle || "");

  if(!isLH){
    return `${escHtml(n)}<br>${escHtml(s)}`;
  }

  return `
    <span class="lhThemeName">${escHtml(n)}</span>
    <span class="lhThemeSub">${escHtml(s)}</span>
  `.trim();
}

function playLeiHengSelectVoice(){
  try{
    if(!_lhVoiceAudio){
      _lhVoiceAudio = new Audio(LEIHENG_VOICE_SRC);
      _lhVoiceAudio.preload = "auto";
    }
    _lhVoiceAudio.currentTime = 0;
    _lhVoiceAudio.play().catch(()=>{ /* ÏûêÎèôÏû¨ÏÉù Ï†úÌïú Î¨¥Ïãú */ });
  }catch(e){
    console.warn("ÎáåÌö° ÏùåÏÑ± Ïû¨ÏÉù Ïã§Ìå®:", e);
  }
}

const AI_BATTLE_BGM_BY_KEY = {
  ai_lei_heng: "assets/bgm_ai_lei_heng_wave12.mp3"
};

// ===== AI ÏÑ†ÌÉù ÏùåÏÑ± =====
function playAiBattleBgm(aiKey){
  const key = String(aiKey || "").trim();
  const srcMap = {
    ai_lei_heng: "assets/bgm_ai_lei_heng_wave12.mp3"
  };

  const src = srcMap[key] || "";

  // Í∞ôÏùÄ Î∏åÍ∏àÏù¥Î©¥ Îã§Ïãú Ïû¨ÏÉù Ïïà Ìï®
  if(src && _aiBattleBgm && _aiBattleBgm.src && _aiBattleBgm.src.includes(src)){
    return;
  }

  // Í∏∞Ï°¥ Î∏åÍ∏à Ï†ïÎ¶¨
  if(_aiBattleBgm){
    try{
      _aiBattleBgm.pause();
      _aiBattleBgm.currentTime = 0;
    }catch(e){}
    _aiBattleBgm = null;
  }

  // Ïû¨ÏÉùÌï† Í≤å ÏóÜÏúºÎ©¥ Ïó¨Í∏∞ÏÑú ÎÅù (= Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞ Í≥†Î•∏ Í≤ΩÏö∞ ÏûêÎèô Ï†ïÏßÄ)
  if(!src) return;

  const a = new Audio(src);
  a.preload = "auto";
  a.loop = true;
  a.volume = 0.45;

  a.play().then(() => {
    _aiBattleBgm = a;
    _aiBattleBgmKey = key;
  }).catch(err => {
    console.warn("AI battle BGM play blocked:", err);
    _aiBattleBgm = null;
    _aiBattleBgmKey = null;
  });
}

function getAiById(id){
  return AI_OPPONENTS.find(x => x.id === id) || null;
}

function applyPlayArenaThemeByAI(ai){
  // ‚úÖ Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Î∞∞Í≤Ω(ÎÑ§Í∞Ä ÏõêÌïòÎäî Î∂ÄÎ∂Ñ)
  const body = document.body;

  // ‚úÖ Í∏∞Ï°¥ Ïπ¥Îìú/Ïª®ÌÖåÏù¥ÎÑà ÌÜ§ÎèÑ Í∞ôÏù¥ Ïú†ÏßÄ
  const arena = playArena || document.getElementById("playArena");

  // --- Ï¥àÍ∏∞Ìôî(ÏÑ†ÌÉù Ìï¥Ï†ú / ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏ†ÑÏùº Îïå) ---
  // body Î∞∞Í≤Ω Ï¥àÍ∏∞Ìôî
  if(body){
    body.style.backgroundImage = "";
    body.style.backgroundSize = "";
    body.style.backgroundPosition = "";
    body.style.backgroundRepeat = "";
    body.style.backgroundAttachment = "";
  }

  // playArena Î∞∞Í≤Ω Ï¥àÍ∏∞Ìôî
  if(arena){
    arena.style.background = "";
    arena.style.backgroundImage = "";
    arena.style.backgroundSize = "";
    arena.style.backgroundPosition = "";
    arena.style.backgroundRepeat = "";
    arena.style.borderColor = "";
    arena.style.backgroundColor = "";
  }

  if(!ai){
    return;
  }

  const overlay = String(ai.theme?.arenaBg || "").trim();
  const img = String(ai.theme?.arenaImage || "").trim();

  // ‚úÖ 1) Ï†ÑÏ≤¥ Î∞∞Í≤Ω Ï†ÅÏö© (body)
  if(body && img){
    if(overlay){
      body.style.backgroundImage = `${overlay}, url("${img}")`;
      body.style.backgroundSize = "cover, cover";
      body.style.backgroundPosition = "center, center";
      body.style.backgroundRepeat = "no-repeat, no-repeat";
    }else{
      body.style.backgroundImage = `url("${img}")`;
      body.style.backgroundSize = "cover";
      body.style.backgroundPosition = "center";
      body.style.backgroundRepeat = "no-repeat";
    }
    body.style.backgroundAttachment = "fixed";
  }

  // ‚úÖ 2) Î°úÎπÑ Ïπ¥Îìú(playArena)Îäî ÏÇ¥ÏßùÎßå ÌÜ§ ÏûÖÌûàÍ∏∞ (Í∞ÄÎèÖÏÑ±Ïö©)
  if(arena){
    if(overlay){
      arena.style.background = overlay;
    }else{
      arena.style.background = "rgba(6,8,13,.55)";
    }
    arena.style.borderColor = ai.theme?.border || "rgba(255,255,255,0.14)";
  }
}

// Í∞ÑÎã® ÎùºÏö∞ÌÑ∞
function goHome(){
  show(viewHome);
  hide(viewEditor);
  hide(viewLibrary);
  hide(viewPlayMode);
  hide(viewPlay);
  hide(viewMatch);
}
function goPlayMode(){
  hide(viewHome);
  hide(viewEditor);
  hide(viewLibrary);
  show(viewPlayMode);
  hide(viewPlay);
  hide(viewMatch);
  clearToast(document.getElementById("playModeToast"));
}
function goPlayLobby(){
  hide(viewHome);
  hide(viewEditor);
  hide(viewLibrary);
  hide(viewPlayMode);
  show(viewPlay);
  hide(viewMatch);
  refreshPlayLobbySelectors();
}
function goMatch(){
  hide(viewHome);
  hide(viewEditor);
  hide(viewLibrary);
  hide(viewPlayMode);
  hide(viewPlay);
  show(viewMatch);
}

// Î°úÎπÑ ÏÖÄÎ†âÌÑ∞ Ï±ÑÏö∞Í∏∞
function refreshPlayLobbySelectors(){
  if(!playMyChar || !playEnemyChar) return;

  const list = loadCharList();

  // ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ ÏÖÄÎ†âÌä∏
  playMyChar.innerHTML = `<option value="">ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</option>`;
  for(const c of list){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)";
    playMyChar.appendChild(opt);
  }

  // ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞ ÏÖÄÎ†âÌä∏
  playEnemyChar.innerHTML = `<option value="">ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</option>`;

  if(playBattleMode === "ai"){
    // AI Î™©Î°ù
    const head = document.createElement("option");
    head.value = "";
    head.textContent = "AI Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù";
    playEnemyChar.appendChild(head);

    for(const ai of AI_OPPONENTS){
      const opt = document.createElement("option");
      opt.value = `ai:${ai.id}`;
      opt.textContent = ai.name;
      playEnemyChar.appendChild(opt);
    }
  }else{
    // ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù
    for(const c of list){
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)";
      playEnemyChar.appendChild(opt);
    }
  }

  updatePlayMeta();
}

function summarizeCharForLobby(charId){
  const data = loadCharData(charId);
  if(!data?.core) return "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå";

  const nm = data.name || data.core?.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)";
  const hp = data.core?.status?.hp ?? "?";
  const spdMin = data.core?.status?.spdMin ?? "?";
  const spdMax = data.core?.status?.spdMax ?? "?";
  const defLv = data.core?.status?.defLv ?? "?";

  const pvN = Array.isArray(data.passives) ? data.passives.length : 0;
  const skN = Array.isArray(data.skills) ? data.skills.length : 0;

  return `${nm}\nÏ≤¥Î†• ${hp} / ÏÜçÎèÑ ${spdMin}~${spdMax} / Î∞©Ïñ¥Î†àÎ≤® ${defLv}\nÌå®ÏãúÎ∏å ${pvN}Í∞ú / Ïä§ÌÇ¨ ${skN}Í∞ú`;
}

/* ‚úÖ AI ÏÑ†ÌÉù Ïãú Ï†ÑÏ≤¥ Î∞∞Í≤Ω Ï†ÅÏö© */
function applyPlayBodyBackground(url){
  if(!url){
    document.body.style.backgroundImage = "";
    document.body.style.backgroundSize = "";
    document.body.style.backgroundPosition = "";
    document.body.style.backgroundRepeat = "";
    document.body.style.backgroundAttachment = "";
    return;
  }

document.body.style.backgroundImage =
  `linear-gradient(rgba(5,6,8,.72), rgba(5,6,8,.78)), url('${url}')`;
  document.body.style.backgroundSize = "cover";
  document.body.style.backgroundPosition = "center";
  document.body.style.backgroundRepeat = "no-repeat";
  document.body.style.backgroundAttachment = "fixed";
}

function getAiWaveInfoByEnemyValue(enemyValue){
  if(!enemyValue || !String(enemyValue).startsWith("ai:")) return null;

  const aiId = String(enemyValue).slice(3);
  const boss = AI_BOSSES[aiId];
  if(!boss || !Array.isArray(boss.waves)) return null;

  return boss.waves.map(w => {
    const meta = PREVIEW_CHAR_INFO[w.charId] || null;
    return {
      wave: Number(w.wave || 0),
      type: w.type || "enemy",
      visibleInInfo: !!w.visibleInInfo,
      name: (w.visibleInInfo ? (meta?.name || w.charId) : (boss.name || "???")),
      desc: (w.visibleInInfo
        ? (meta?.summary || "ÏÉÅÏÑ∏Ï†ïÎ≥¥Îäî ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏñ¥.")
        : "Î≥¥Ïä§ÎùºÏÑú ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏñ¥.")
    };
  });
}

function renderAiWaveInfoPanel(){
  if(!aiWaveInfoList || !playEnemyChar) return;

  const enId = playEnemyChar.value || "";
  const waves = getAiWaveInfoByEnemyValue(enId);

  if(!waves){
    aiWaveInfoList.innerHTML = `<div style="color:rgba(238,241,255,.7);">AI ÏÉÅÎåÄÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï§ò.</div>`;
    return;
  }

  const rows = waves.map((w) => {
    const isBoss = (w.visibleInInfo === false) || (w.type === "boss");

    return `
      <div style="border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; margin-bottom:8px; background:rgba(0,0,0,.14);">
        <div style="font-weight:900; color:${isBoss ? 'rgba(255,120,120,.95)' : 'rgba(243,211,154,.95)'};">
          ${w.wave}Ïõ®Ïù¥Î∏å - ${w.visibleInInfo ? w.name : "???"}
        </div>
        <div style="margin-top:6px; white-space:pre-line; color:rgba(238,241,255,.9);">
          ${isBoss ? "Î≥¥Ïä§ÎùºÏÑú ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏñ¥." : (w.desc || "ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÏóÜÏùå")}
        </div>
      </div>
    `;
  }).join("");

  aiWaveInfoList.innerHTML = rows;
}

function updatePlayMeta(){
  const myMeta = playMyCharMeta;
  const enemyMeta = playEnemyCharMeta;
  if(!myMeta || !enemyMeta || !playMyChar || !playEnemyChar) return;

  // ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ Î©îÌÉÄ
  const myId = playMyChar.value || "";
  if(myId){
    myMeta.textContent = summarizeCharForLobby(myId);
  }else{
    myMeta.textContent = "ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï§ò.";
  }

  // ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞ Î©îÌÉÄ + AI Î∞∞Í≤Ω
  const enId = playEnemyChar.value || "";

  if(!enId){
    enemyMeta.textContent = (playBattleMode === "ai")
      ? "AI Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï§ò."
      : "ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï§ò.";
    lastPlayedAiVoiceId = "";
    playAiBattleBgm("");
    applyPlayBodyBackground("");
    if(aiWaveInfoPanel && !aiWaveInfoPanel.classList.contains("hidden")){
      renderAiWaveInfoPanel();
    }
    return;
  }

  // AI ÏÉÅÎåÄ
  if(enId.startsWith("ai:")){
    const aiId = enId.slice(3);
    const ai = AI_OPPONENTS.find(x => x.id === aiId);

    if(ai){
if(lastPlayedAiVoiceId !== ai.id){
  if(ai.id === "ai_lei_heng"){
    playLeiHengSelectVoice();   // ‚úÖ ÏÑ†ÌÉù ÏùåÏÑ±
  }
  playAiBattleBgm(ai.id);       // ‚úÖ Ï†ÑÌà¨ Î∏åÍ∏à
  lastPlayedAiVoiceId = ai.id;
}

      if(ai.id === "ai_lei_heng"){
        enemyMeta.innerHTML = `
          <span class="aiNameLei">${ai.name}</span>
          <span class="aiSubLei">${ai.sub || ""}</span>

          ÎÇúÏù¥ÎèÑ/ÌïµÏã¨Ï†ïÎ≥¥Îäî Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Î∂ôÏùº ÏòàÏ†ï
        `;
      }else{
        enemyMeta.textContent =
          `${ai.name}\n${ai.sub || ""}\n\nÎÇúÏù¥ÎèÑ/ÌïµÏã¨Ï†ïÎ≥¥Îäî Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Î∂ôÏùº ÏòàÏ†ï`;
      }

      if(ai.id === "ai_lei_heng"){
        applyPlayBodyBackground("assets/bg_ai_leiheng_train.png");
      }else{
        applyPlayBodyBackground("");
      }
    }else{
      enemyMeta.textContent = "AI Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏßÄ Î™ªÌñàÏñ¥.";
      applyPlayBodyBackground("");
    }

    // ‚úÖ Ïù¥ÎØ∏ÏßÄ 4Î≤àÏóêÏÑú ÎßêÌïú "Ìå®ÎÑê ÏûêÎèô Í∞±Ïã†" ÏúÑÏπò
    if(aiWaveInfoPanel && !aiWaveInfoPanel.classList.contains("hidden")){
      renderAiWaveInfoPanel();
    }
    return;
  }

  // ÏùºÎ∞ò ÏÉÅÎåÄ Ï∫êÎ¶≠ÌÑ∞
  enemyMeta.textContent = summarizeCharForLobby(enId);
  applyPlayBodyBackground("");
  playAiBattleBgm("");

  // ‚úÖ ÏùºÎ∞ò Ï∫êÎ¶≠ÌÑ∞Î°ú Î∞îÎÄåÏñ¥ÎèÑ Ìå®ÎÑê ÎÇ¥Ïö© Í∞±Ïã†
  if(aiWaveInfoPanel && !aiWaveInfoPanel.classList.contains("hidden")){
    renderAiWaveInfoPanel();
  }
}

playMyChar?.addEventListener("change", updatePlayMeta);
playEnemyChar?.addEventListener("change", updatePlayMeta);
btnAiWaveInfo?.addEventListener("click", () => {
  if(!aiWaveInfoPanel) return;
  aiWaveInfoPanel.classList.remove("hidden");
  renderAiWaveInfoPanel();
});

btnAiWaveInfoClose?.addEventListener("click", () => {
  aiWaveInfoPanel?.classList.add("hidden");
});

// HOME: ÌîåÎ†àÏù¥ Î≤ÑÌäº -> Î°úÎπÑ
document.getElementById("btn-play").addEventListener("click", () => {
  goPlayMode();
});

// ÌîåÎ†àÏù¥ ÏÑ†ÌÉù ÌôîÎ©¥ Î≤ÑÌäºÎì§
document.getElementById("btn-play-mode-back")?.addEventListener("click", goHome);

document.getElementById("btn-play-char")?.addEventListener("click", () => {
  playBattleMode = "char";
  goPlayLobby();
});

document.getElementById("btn-play-ai")?.addEventListener("click", () => {
  playBattleMode = "ai";
  goPlayLobby();
});

// Î°úÎπÑ Î≤ÑÌäºÎì§
document.getElementById("btn-play-back")?.addEventListener("click", goHome);

document.getElementById("btn-play-random")?.addEventListener("click", () => {
if(playBattleMode === "ai"){
  if(AI_OPPONENTS.length === 0) return;

  const pick = AI_OPPONENTS[Math.floor(Math.random() * AI_OPPONENTS.length)];
  playEnemyChar.value = `ai:${pick.id}`;
  updatePlayMeta();
  toast(playToast, `AI ÎûúÎç§ ÏÑ†ÌÉù: ${pick.name}`);
  return;
}

  const list = loadCharList();
  if(list.length === 0) return;
  const pick = list[Math.floor(Math.random() * list.length)];
  playEnemyChar.value = pick.id;
  updatePlayMeta();
  toast(playToast, `ÏÉÅÎåÄ ÎûúÎç§ ÏÑ†ÌÉù: ${pick.name || "(Ïù¥Î¶Ñ ÏóÜÏùå)"}`);
});



document.getElementById("btn-start-match")?.addEventListener("click", async () => {
  const myId = playMyChar?.value || "";
  const enId = playEnemyChar?.value || "";

  if(!myId || !enId){
    toast(playToast, "ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞/ÏÉÅÎåÄÎ•º ÏÑ†ÌÉùÌï¥Ïïº Ìï¥.");
    return;
  }

  const my = loadCharData(myId);
  const myName = my?.name || my?.core?.name || "ÎÇò";

  // ===== AI ÎåÄÏ†Ñ =====
  if(playBattleMode === "ai"){
    const aiId = enId.startsWith("ai:") ? enId.slice(3) : enId;
    const ai = getAiById(aiId);
    if(!ai){
      toast(playToast, "AI ÏÉÅÎåÄÎ•º ÏÑ†ÌÉùÌï¥Ï§ò.");
      return;
    }

matchTitle.textContent = `${myName}  VS  ${ai.name}`;
matchLog.textContent = "";

// enemyDataÎ•º Ïã§Ï†ú ÌëúÏãúÏö©ÏúºÎ°ú Ï§ÄÎπÑ
const bossDef2 = AI_BOSSES?.[ai.id];
let enemyDisplayData = null;

// 1) Ïõ®Ïù¥Î∏å Ï≤´ ÌëúÏãú ÎåÄÏÉÅÏùò "Ïã§Ï†ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞" Ïö∞ÏÑ† ÏÇ¨Ïö©
if (bossDef2 && Array.isArray(bossDef2.waves) && bossDef2.waves.length) {
  const firstVisible = bossDef2.waves.find(w => w.visibleInInfo !== false) || bossDef2.waves[0];
  const waveCharId = firstVisible?.charId;

// ‚úÖ 1ÏàúÏúÑ: Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞
const savedEnemyChar = waveCharId ? loadCharData(waveCharId) : null;
if (savedEnemyChar) {
  enemyDisplayData = savedEnemyChar;
} else {
  // ‚úÖ 2ÏàúÏúÑ: Ai Ìè¥Îçî JSON ÏßÅÏ†ë Î°úÎìú (Î°úÏª¨ ÏÑúÎ≤ÑÏóêÏÑú Ïã§Ìñâ Ïãú)
  try {
    // waveCharId Í∏∞Ï§ÄÏúºÎ°ú ÌååÏùºÎ™Ö Îß§Ìïë
    const AI_JSON_PATHS = {
      "thumb_soldato_2": "Ai/Í∞Å Ïû°Ìûå ÏóÑÏßÄ ÏÜîÎã§ÌÜ† II.limbuschar.json",
      "thumb_soldato_3": "Ai/Í∞Å Ïû°Ìûå ÏóÑÏßÄ ÏÜîÎã§ÌÜ† III.limbuschar.json", // IIIÎèÑ ÎßåÎì§Î©¥ Ïù¥ Í≤ΩÎ°ú ÏÇ¨Ïö©
    };

    const jsonPath = AI_JSON_PATHS[waveCharId];
    if (jsonPath) {
      const res = await fetch(jsonPath);
      if (res.ok) {
        const json = await res.json();
        if (json?.char) {
          enemyDisplayData = json.char;

          // Ï¥àÏÉÅ Í≤ΩÎ°ú Í∞ïÏ†ú ÏßÄÏ†ï (II/III Í≥µÏö©)
          enemyDisplayData.core = enemyDisplayData.core || {};
          enemyDisplayData.core.portraitUrl = "assets/char_thumb_soldato_23.png";
        }
      }
    }
  } catch (e) {
    console.warn("AI JSON Î°úÎìú Ïã§Ìå®:", e);
  }

  // ‚úÖ 3ÏàúÏúÑ: PREVIEW summary ÌååÏã± fallback
  if (!enemyDisplayData) {
    const preview = PREVIEW_CHAR_INFO?.[waveCharId];
    if (preview) {
      enemyDisplayData = parsePreviewSummaryToBattleData(preview, ai.name);
      enemyDisplayData.core = enemyDisplayData.core || {};
      enemyDisplayData.core.portraitUrl = "assets/char_thumb_soldato_23.png";
    }
  }
}
}

// 2) Í∑∏ÎûòÎèÑ ÏóÜÏúºÎ©¥ ÏµúÏÜå ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞
if (!enemyDisplayData) {
  enemyDisplayData = {
    name: ai.name || "Ï†Å",
    core: {
      name: ai.name || "Ï†Å",
      hp: "-",
      atkLevel: "-",
      defLevel: "-",
      sanity: "-",
      speedMin: 1,
      speedMax: 6,
      skillSlots: 1,
      physRes: {},
      sinRes: {},
      staggerThresholds: []
    },
    passives: [],
    skills: [],
    dedicatedKeywords: []
  };
}
await initMatchScreenData({
  myData: my,
  enemyData: enemyDisplayData,
  enemyIsAi: true,
  enemyAiMeta: ai
});



goMatch();
return;
  }

  // ===== Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏ†Ñ =====
  if(myId === enId){
    toast(playToast, "ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÏÉÅÎåÄÍ∞Ä Í∞ôÏïÑ. Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞Î•º Í≥®ÎùºÏ§ò.");
    return;
  }

  const en = loadCharData(enId);
  const enName = en?.name || en?.core?.name || "ÏÉÅÎåÄ";

matchTitle.textContent = `${myName}  VS  ${enName}`;
matchLog.textContent = "";
matchLog.textContent += `Îß§Ïπò ÏãúÏûë!\n- ÎÇ¥ Ï∫êÎ¶≠ÌÑ∞: ${myName}\n- ÏÉÅÎåÄ: ${enName}\n`;

await initMatchScreenData({
  myData: my,
  enemyData: en,
  enemyIsAi: false,
  enemyAiMeta: null
});

goMatch();
});

document.getElementById("btn-go-editor").addEventListener("click", () => {
  setAppMode("edit");               // ‚úÖ Ï∂îÍ∞Ä
  hide(viewHome); show(viewEditor);
  clearToast(homeToast);
  selectTab("core");
  document.getElementById("charName").focus();
});

    document.getElementById("btn-back").addEventListener("click", () => {
      hide(viewEditor); show(viewHome);
      clearToast(homeToast);
    });

    // ===== tabs =====
    const tabs = {
      core: document.getElementById("tab-core"),
      passive: document.getElementById("tab-passive"),
      skill: document.getElementById("tab-skill"),
      dk: document.getElementById("tab-dk"),
    };
    const panels = {
      core: document.getElementById("panel-core"),
      passive: document.getElementById("panel-passive"),
      skill: document.getElementById("panel-skill"),
      dk: document.getElementById("panel-dk"),
    };
    function selectTab(key){
      Object.entries(tabs).forEach(([k,btn]) => btn.classList.toggle("active", k === key));
      Object.entries(panels).forEach(([k,p]) => p.classList.toggle("hidden", k !== key));
    }
    tabs.core.addEventListener("click", () => selectTab("core"));
    tabs.passive.addEventListener("click", () => selectTab("passive"));
    tabs.skill.addEventListener("click", () => selectTab("skill"));
    tabs.dk.addEventListener("click", () => selectTab("dk"));

// ‚úÖ Î∂ÄÌåÖ Ïãú 1Ìöå: ÏóêÎîîÌÑ∞ ÏûêÎèô Ïò§Ìîà
(() => {
  const flag = localStorage.getItem("limbus_open_editor_boot");
  if(!flag) return;
  localStorage.removeItem("limbus_open_editor_boot");

  // ÏóêÎîîÌÑ∞ ÌôîÎ©¥ÏúºÎ°ú Í∞ïÏ†ú ÏßÑÏûÖ
  hide(viewHome);
  if(typeof viewLibrary !== "undefined") hide(viewLibrary); // ÌòπÏãú ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïó¥Î†§ÏûàÏùÑ ÏàòÎèÑ ÏûàÏñ¥ÏÑú
  show(viewEditor);

  // Í∏∞Î≥∏ ÌÉ≠(ÏõêÌïòÎ©¥ passiveÎ°ú Î∞îÍøîÎèÑ Îê®)
  selectTab("core");
})();

// ‚úÖ Î∂ÄÌåÖ Ïãú: Î≥¥Í∏∞ Î™®ÎìúÎ©¥ ÏóêÎîîÌÑ∞ ÌôîÎ©¥ + ÏΩîÏñ¥ ÌÉ≠ Í∞ïÏ†ú
(() => {
  if (APP_MODE !== "view") return;

  // Ìôà/ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïà®Í∏∞Í≥† ÏóêÎîîÌÑ∞ ÌëúÏãú
  hide(viewHome);
  if (typeof viewLibrary !== "undefined") hide(viewLibrary);
  show(viewEditor);

  // Î≥¥Í∏∞ Î™®ÎìúÎäî Ìï≠ÏÉÅ ÏΩîÏñ¥ ÌÉ≠Î∂ÄÌÑ∞
  selectTab("core");
})();



    // ===== portrait upload preview =====
    const fileInput = document.getElementById("fileInput");
    const portraitImg = document.getElementById("portraitImg");
    const portraitPh = document.getElementById("portraitPh");
    const btnClearImg = document.getElementById("btnClearImg");

    function setPortrait(src){
      if(!src){
        portraitImg.style.display = "none";
        portraitImg.src = "";
        portraitPh.style.display = "block";
        return;
      }
      portraitImg.src = src;
      portraitImg.style.display = "block";
      portraitPh.style.display = "none";
    }

    // ‚úÖ CORE portrait: IndexedDB ÌÇ§
    let corePortraitKey = "";

    // ‚úÖ Ï¥àÏÉÅÌôî ÏóÖÎ°úÎìú: IndexedDBÏóê BlobÏúºÎ°ú ÏòÅÍµ¨ Ï†ÄÏû•
    fileInput.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      try{
        const dataURL = await compressImageToDataURL(f, {
          maxSize: 1024,
          mime: "image/webp",
          quality: 0.90
        });
        const blob = dataURLToBlob(dataURL);

        corePortraitKey = "core_portrait_v1";
        await idbPutBlob(corePortraitKey, blob);

        setPortraitFromObjectURL(makeObjectURLFromBlob(blob));
        toast(coreToast, "Ï¥àÏÉÅÌôî Ï†ÄÏû•Îê®(ÏòÅÍµ¨).");
      }catch(err){
        console.error(err);
        toast(coreToast, "Ï¥àÏÉÅÌôî Ï†ÄÏû• Ïã§Ìå®(Î∏åÎùºÏö∞Ï†Ä Ï†úÌïú/ÌååÏùº Î¨∏Ï†úÏùº Ïàò ÏûàÏñ¥).");
      }
    });

    btnClearImg.addEventListener("click", async () => {
      fileInput.value = "";
      setPortrait("");
      if(corePortraitKey){
        try{ await idbDel(corePortraitKey); }catch(e){}
      }
      corePortraitKey = "";
      toast(coreToast, "Ï¥àÏÉÅÌôî Ï†úÍ±∞ ÏôÑÎ£å!");
    });

    // ===== resistance options / coeff / tones =====
    const OPTIONS = ["ÎÇ¥ÏÑ±", "Í≤¨Îî§", "Î≥¥ÌÜµ", "ÏïΩÏ†ê", "Ï∑®ÏïΩ"];
    const MULT = { "ÎÇ¥ÏÑ±":0.5, "Í≤¨Îî§":0.75, "Î≥¥ÌÜµ":1.0, "ÏïΩÏ†ê":1.5, "Ï∑®ÏïΩ":2.0 };

    function toneOf(v){
      if(v === "ÏïΩÏ†ê" || v === "Ï∑®ÏïΩ") return "tone-red";
      if(v === "ÎÇ¥ÏÑ±" || v === "Í≤¨Îî§") return "tone-gray";
      return "tone-normal";
    }
    function setTone(el, tone){
      el.classList.remove("tone-red","tone-gray","tone-normal");
      el.classList.add(tone);
    }
    function fmtCoef(v){
      const n = MULT[v] ?? 1.0;
      return `[x${n.toFixed(n % 1 === 0 ? 1 : 2)}]`;
    }
    function fillSelect(selectEl, defaultValue, onChange){
      selectEl.innerHTML = "";
      for(const opt of OPTIONS){
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        selectEl.appendChild(o);
      }
      selectEl.value = defaultValue || "Î≥¥ÌÜµ";
      selectEl.addEventListener("change", onChange);
      onChange();
    }

    // physical
    const physSlash = document.getElementById("physSlash");
    const physPierce = document.getElementById("physPierce");
    const physBlunt = document.getElementById("physBlunt");
    const coef_physSlash = document.getElementById("coef_physSlash");
    const coef_physPierce = document.getElementById("coef_physPierce");
    const coef_physBlunt = document.getElementById("coef_physBlunt");

    function physUpdate(selectEl, coefEl){
      const box = selectEl.closest(".physBox");
      setTone(box, toneOf(selectEl.value));
      coefEl.textContent = fmtCoef(selectEl.value);
    }
    fillSelect(physSlash, "Î≥¥ÌÜµ", () => physUpdate(physSlash, coef_physSlash));
    fillSelect(physPierce, "Î≥¥ÌÜµ", () => physUpdate(physPierce, coef_physPierce));
    fillSelect(physBlunt, "Î≥¥ÌÜµ", () => physUpdate(physBlunt, coef_physBlunt));

    // sins
    const sinIds = [
      ["sinWrath","coef_sinWrath"],
      ["sinLust","coef_sinLust"],
      ["sinSloth","coef_sinSloth"],
      ["sinGluttony","coef_sinGluttony"],
      ["sinGloom","coef_sinGloom"],
      ["sinPride","coef_sinPride"],
      ["sinEnvy","coef_sinEnvy"],
    ];
    for(const [selId, coefId] of sinIds){
      const sel = document.getElementById(selId);
      const coef = document.getElementById(coefId);
      fillSelect(sel, "Î≥¥ÌÜµ", () => {
        setTone(sel.closest(".sinBox"), toneOf(sel.value));
        coef.textContent = fmtCoef(sel.value);
      });
    }

    // ===== stagger =====
    const markerLayer = document.getElementById("markerLayer");
    const tickLayer = document.getElementById("tickLayer");
    const btnAddStagger = document.getElementById("btnAddStagger");
    const btnDelStagger = document.getElementById("btnDelStagger");
    let staggers = [];

    function normalizePercent(input){
      const n = Number(String(input).trim());
      if(!Number.isFinite(n)) return null;
      if(n <= 0 || n >= 100) return null;
      return Math.round(n);
    }
    function renderStaggers(){
      markerLayer.innerHTML = "";
      tickLayer.innerHTML = "";
      const sorted = [...staggers].sort((a,b)=>a-b);
      for(const p of sorted){
        const m = document.createElement("div");
        m.className = "marker";
        m.style.left = `${p}%`;
        markerLayer.appendChild(m);

        const t = document.createElement("div");
        t.className = "tick";
        t.style.left = `${p}%`;
        t.textContent = `${p}%`;
        tickLayer.appendChild(t);
      }
    }
    btnDelStagger.addEventListener("click", () => { staggers = []; renderStaggers(); });
    btnAddStagger.addEventListener("click", () => {
      const ans = prompt("Î™á %Ïóê ÌùêÌä∏Îü¨Ïßê Íµ¨Í∞ÑÏùÑ Ï∂îÍ∞ÄÌï†Íπå? (1~99)");
      if(ans === null) return;
      const p = normalizePercent(ans);
      if(p === null){ alert("1~99 ÏÇ¨Ïù¥ Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï§ò."); return; }
      if(staggers.includes(p)){ alert("Ïù¥ÎØ∏ ÏûàÎäî Íµ¨Í∞ÑÏù¥Ïïº."); return; }
      staggers.push(p);
      renderStaggers();
    });
    renderStaggers();

    // ===== ÌäπÏÑ± ÌÇ§ÏõåÎìú =====
    const traitKwList = document.getElementById("traitKwList");
    const btnTraitKwAdd = document.getElementById("btnTraitKwAdd");

    function makeTraitRow(data = { text:"", deleted:false }){
      const row = document.createElement("div");
      row.className = "kwRow" + (data.deleted ? " deleted" : "");

      const input = document.createElement("input");
      input.className = "kwInput";
      input.type = "text";
      input.value = data.text || "";

      const btnToggle = document.createElement("button");
      btnToggle.type = "button";
      btnToggle.className = "btnSmall";
      btnToggle.textContent = data.deleted ? "ÌÇ§ÏõåÎìú Î≥µÍµ¨" : "ÌÇ§ÏõåÎìú ÏßÄÏö∞Í∏∞";

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btnSmall";
      btnDel.textContent = "ÏÇ≠Ï†ú";

      btnToggle.addEventListener("click", () => {
        const isDeleted = row.classList.toggle("deleted");
        btnToggle.textContent = isDeleted ? "ÌÇ§ÏõåÎìú Î≥µÍµ¨" : "ÌÇ§ÏõåÎìú ÏßÄÏö∞Í∏∞";
      });

      btnDel.addEventListener("click", () => row.remove());

      row.appendChild(input);
      row.appendChild(btnToggle);
      row.appendChild(btnDel);
      return row;
    }

    btnTraitKwAdd.addEventListener("click", () => {
      traitKwList.appendChild(makeTraitRow());
    });
    traitKwList.appendChild(makeTraitRow());

    // ===== core save/reset =====
    const coreToast = document.getElementById("coreToast");
// ===== sanity effect (Ï†ïÏã†Î†• Ìö®Í≥º) =====
const sanityFxFile = document.getElementById("sanityFxFile");
const sanityFxImg = document.getElementById("sanityFxImg");
const sanityFxPh = document.getElementById("sanityFxPh");
const btnClearSanityFxImg = document.getElementById("btnClearSanityFxImg");

const sanityPanicText = document.getElementById("sanityPanicText");
const sanityGainText = document.getElementById("sanityGainText");
const sanityLossText = document.getElementById("sanityLossText");

let sanityFxKey = "";              // IndexedDBÏóê Ï†ÄÏû•Îêú Ïù¥ÎØ∏ÏßÄ ÌÇ§
let sanityFxPendingDataURL = "";   // ÏïÑÏßÅ Ï†ÄÏû• Ïïà Ìïú ÏûÑÏãú Ïù¥ÎØ∏ÏßÄ(dataURL)

function setSanityFxPreview(src){
  if(!src){
    sanityFxImg.style.display = "none";
    sanityFxImg.src = "";
    sanityFxPh.style.display = "block";
    return;
  }
  sanityFxImg.src = src;
  sanityFxImg.style.display = "block";
  sanityFxPh.style.display = "none";
}

sanityFxFile?.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;

  try{
    sanityFxPendingDataURL = await compressImageToDataURL(f, {
      maxSize: 900,
      mime: "image/webp",
      quality: 0.88
    });
    setSanityFxPreview(sanityFxPendingDataURL);
    toast(coreToast, "Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉùÎê®. 'Ï†ÄÏû•'ÏùÑ ÎàÑÎ•¥Î©¥ Î∞òÏòÅÎèº.");
  }catch(err){
    console.error(err);
    toast(coreToast, "Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ïã§Ìå®.");
  }
});

btnClearSanityFxImg?.addEventListener("click", async () => {
  sanityFxFile.value = "";
  sanityFxPendingDataURL = "";
  setSanityFxPreview("");

  if(sanityFxKey){
    try{ await idbDel(sanityFxKey); }catch(e){}
    sanityFxKey = "";
  }
});

    function readTraitKeywords(){
      const rows = [...traitKwList.querySelectorAll(".kwRow")];
      return rows.map(r => ({
        text: r.querySelector(".kwInput")?.value ?? "",
        deleted: r.classList.contains("deleted")
      }));
    }
    function loadTraitKeywords(list){
      traitKwList.innerHTML = "";
      if(!Array.isArray(list) || list.length === 0){
        traitKwList.appendChild(makeTraitRow());
        return;
      }
      for(const it of list) traitKwList.appendChild(makeTraitRow(it));
    }

    document.getElementById("btnSaveCore").addEventListener("click", async () => {
      // Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÉàÎ°ú ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÎ©¥ Ï†ÄÏû• Ï†ÑÏóê IndexedDBÏóê Î®ºÏ†Ä ÎÑ£Í∏∞
      if(sanityFxPendingDataURL && String(sanityFxPendingDataURL).startsWith("data:image/")){
        try{
          const blob = dataURLToBlob(sanityFxPendingDataURL);
          sanityFxKey = "core_sanity_fx_v1";
          await idbPutBlob(sanityFxKey, blob);
          sanityFxPendingDataURL = "";
        }catch(e){
          console.error("sanity fx save fail:", e);
          toast(coreToast, "Ï†ïÏã†Î†• Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïã§Ìå®.");
          return;
        }
      }
      const payload = {
        name: document.getElementById("charName").value,
        portraitKey: corePortraitKey || "", // ‚úÖ Ïù¥ÎØ∏ÏßÄ Î¨∏ÏûêÏó¥ ÎåÄÏã† ÌÇ§Îßå Ï†ÄÏû•
        staggers: [...staggers],
        status: {
          hp: document.getElementById("statHp").value,
          spdMin: document.getElementById("statSpdMin").value,
          spdMax: document.getElementById("statSpdMax").value,
          defLv: document.getElementById("statDefLv").value,
        },
        phys: { slash: physSlash.value, pierce: physPierce.value, blunt: physBlunt.value },
        sins: Object.fromEntries(sinIds.map(([sid]) => [sid, document.getElementById(sid).value])),
        trait_keywords: readTraitKeywords(),
        sanity: {
          imgKey: sanityFxKey || "",
          panic: sanityPanicText?.value || "",
          gain: sanityGainText?.value || "",
          loss: sanityLossText?.value || ""
        },
      };
      try{
        localStorage.setItem(KEY_CORE, JSON.stringify(payload));
        toast(coreToast, "Ï†ÄÏû• ÏôÑÎ£å!");
      }catch(e){
        toast(coreToast, "Ï†ÄÏû• Ïã§Ìå®: Ï†ÄÏû•Í≥µÍ∞Ñ Ï†úÌïúÏùº Ïàò ÏûàÏñ¥.");
      }
    });

    document.getElementById("btnResetCore").addEventListener("click", async () => {
      document.getElementById("charName").value = "";
      fileInput.value = "";
      setPortrait("");

      if(corePortraitKey){
        try{ await idbDel(corePortraitKey); }catch(e){}
      }
      corePortraitKey = "";

      staggers = [];
      renderStaggers();

      document.getElementById("statHp").value = "";
      document.getElementById("statSpdMin").value = "";
      document.getElementById("statSpdMax").value = "";
      document.getElementById("statDefLv").value = "";

      physSlash.value = "Î≥¥ÌÜµ"; physUpdate(physSlash, coef_physSlash);
      physPierce.value = "Î≥¥ÌÜµ"; physUpdate(physPierce, coef_physPierce);
      physBlunt.value = "Î≥¥ÌÜµ"; physUpdate(physBlunt, coef_physBlunt);

      for(const [sid, cid] of sinIds){
        const sel = document.getElementById(sid);
        const coef = document.getElementById(cid);
        sel.value = "Î≥¥ÌÜµ";
        setTone(sel.closest(".sinBox"), "tone-normal");
        coef.textContent = fmtCoef("Î≥¥ÌÜµ");
      }

      // Ï†ïÏã†Î†• Ìö®Í≥º Ï¥àÍ∏∞Ìôî
      sanityPanicText.value = "";
      sanityGainText.value = "";
      sanityLossText.value = "";
      sanityFxFile.value = "";
      setSanityFxPreview("");
      sanityFxPendingDataURL = "";

      if(sanityFxKey){
        try{ await idbDel(sanityFxKey); }catch(e){}
      }
      sanityFxKey = "";

      loadTraitKeywords([]);
      localStorage.removeItem(KEY_CORE);
      toast(coreToast, "Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!");
    });

    // load core (async + Íµ¨Î≤ÑÏ†Ñ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò)
    (async () => {
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_CORE) || "null");
        if(!saved) return;

        document.getElementById("charName").value = saved.name || "";

        corePortraitKey = saved.portraitKey || "";

        // ‚úÖ Íµ¨Î≤ÑÏ†Ñ: saved.portrait(dataURL) -> IndexedDBÎ°ú Ïù¥Í¥Ä
        if(!corePortraitKey && saved.portrait && String(saved.portrait).startsWith("data:image/")){
          try{
            const blob = dataURLToBlob(saved.portrait);
            corePortraitKey = "core_portrait_v1";
            await idbPutBlob(corePortraitKey, blob);

            saved.portraitKey = corePortraitKey;
            delete saved.portrait;
            localStorage.setItem(KEY_CORE, JSON.stringify(saved));
          }catch(e){
            console.error("portrait migrate fail:", e);
          }
        }

        if(corePortraitKey){
          const blob = await idbGetBlob(corePortraitKey);
          if(blob){
            setPortraitFromObjectURL(makeObjectURLFromBlob(blob));
          }else{
            setPortrait("");
          }
        }else{
          setPortrait("");
        }

        if(Array.isArray(saved.staggers)){
          staggers = saved.staggers.map(normalizePercent).filter((x)=>typeof x === "number");
          staggers = [...new Set(staggers)];
        }
        renderStaggers();

        if(saved.status){
          document.getElementById("statHp").value = saved.status.hp ?? "";
          document.getElementById("statSpdMin").value = saved.status.spdMin ?? "";
          document.getElementById("statSpdMax").value = saved.status.spdMax ?? "";
          document.getElementById("statDefLv").value = saved.status.defLv ?? "";
        }
        if(saved.phys){
          physSlash.value = saved.phys.slash || "Î≥¥ÌÜµ"; physUpdate(physSlash, coef_physSlash);
          physPierce.value = saved.phys.pierce || "Î≥¥ÌÜµ"; physUpdate(physPierce, coef_physPierce);
          physBlunt.value = saved.phys.blunt || "Î≥¥ÌÜµ"; physUpdate(physBlunt, coef_physBlunt);
        }
        if(saved.sins){
          for(const [sid, cid] of sinIds){
            const sel = document.getElementById(sid);
            const coef = document.getElementById(cid);
            sel.value = saved.sins[sid] || "Î≥¥ÌÜµ";
            setTone(sel.closest(".sinBox"), toneOf(sel.value));
            coef.textContent = fmtCoef(sel.value);
          }
        }
        loadTraitKeywords(saved.trait_keywords || []);
        // Ï†ïÏã†Î†• Ìö®Í≥º Î∂àÎü¨Ïò§Í∏∞
        sanityPanicText.value = saved?.sanity?.panic ?? "";
        sanityGainText.value = saved?.sanity?.gain ?? "";
        sanityLossText.value = saved?.sanity?.loss ?? "";

        sanityFxPendingDataURL = "";
        sanityFxKey = saved?.sanity?.imgKey || "";
        setSanityFxPreview("");

        if(sanityFxKey){
          try{
            const blob = await idbGetBlob(sanityFxKey);
            if(blob){
              setSanityFxPreview(makeObjectURLFromBlob(blob));
            }else{
              setSanityFxPreview("");
            }
          }catch(e){
            console.error("sanity fx load fail:", e);
            setSanityFxPreview("");
          }
        }
        if(APP_MODE === "view") applyViewCoreUI();
      }catch(e){
        console.error("core load fail:", e);
      }
    })();

/* ‚úÖ Ïù¥ÎØ∏ÏßÄ Î¶¨ÏÇ¨Ïù¥Ï¶à+ÏïïÏ∂ï -> dataURL Î∞òÌôò */
async function compressImageToDataURL(file, {
  maxSize = 256,       // ÏïÑÏù¥ÏΩòÏùÄ 128~256 Ï∂îÏ≤ú, Ï¥àÏÉÅÌôîÎäî 768~1400
  mime = "image/webp", // webp ÎØ∏ÏßÄÏõêÏù¥Î©¥ ÏûêÎèôÏúºÎ°ú jpegÎ°ú ÎÇ¥Î†§Í∞ê
  quality = 0.82
} = {}){
  const dataURL = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(String(r.result || ""));
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  const img = await new Promise((res, rej) => {
    const im = new Image();
    im.onload = () => res(im);
    im.onerror = rej;
    im.src = dataURL;
  });

  const ow = img.naturalWidth || img.width;
  const oh = img.naturalHeight || img.height;

  const scale = Math.min(1, maxSize / Math.max(ow, oh));
  const w = Math.max(1, Math.round(ow * scale));
  const h = Math.max(1, Math.round(oh * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.drawImage(img, 0, 0, w, h);

  let out = canvas.toDataURL(mime, quality);
  if(mime === "image/webp" && !out.startsWith("data:image/webp")){
    out = canvas.toDataURL("image/jpeg", quality);
  }
  return out;
}

    const dkToast = document.getElementById("dkToast");

    const dkIconFile = document.getElementById("dkIconFile");
    const dkIconImg = document.getElementById("dkIconImg");
    const dkIconPh = document.getElementById("dkIconPh");
    const dkIconClear = document.getElementById("dkIconClear");

    const dkName = document.getElementById("dkName");
    const dkText = document.getElementById("dkText");
    const dkStateBtn = document.getElementById("dkStateBtn");
    const dkSaveBtn = document.getElementById("dkSaveBtn");
    const dkDeleteBtn = document.getElementById("dkDeleteBtn");
    const dkAddBtn = document.getElementById("dkAddBtn");
    const dkList = document.getElementById("dkList");

    /** @type {{id:string, name:string, text:string, state:'buff'|'debuff', iconKey:string}[]} */
    let dks = [];
    let activeDkId = null;
    let dkPendingIcon = "";

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function setDkIcon(src){
      if(!src){
        dkIconImg.style.display = "none";
        dkIconImg.src = "";
        dkIconPh.style.display = "block";
        return;
      }
      dkIconImg.src = src;
      dkIconImg.style.display = "block";
      dkIconPh.style.display = "none";
    }

    // ÏóÖÎ°úÎìú: ÏùºÎã® pending(dataURL)Î°úÎßå Ïû°ÏïÑÎëêÍ≥†, "Ï†ÄÏû•" ÎàåÎ†ÄÏùÑ Îïå DBÏóê Ï†ÄÏû•
    dkIconFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      try{
        dkPendingIcon = await compressImageToDataURL(f, {
          maxSize: 256,
          mime: "image/webp",
          quality: 0.82
        });

        setDkIcon(dkPendingIcon);
        toast(dkToast, "ÏïÑÏù¥ÏΩò ÏÑ†ÌÉùÎê®(ÏïïÏ∂ïÎê®). 'Ï†ÄÏû•'ÏùÑ ÎàÑÎ•¥Î©¥ ÏòÅÍµ¨ Î∞òÏòÅÎèº.");
      }catch(err){
        console.error(err);
        toast(dkToast, "ÏïÑÏù¥ÏΩò Ï≤òÎ¶¨ Ïã§Ìå®(ÌååÏùºÏù¥ ÏÜêÏÉÅÎêêÍ±∞ÎÇò Î∏åÎùºÏö∞Ï†Ä Ï†úÌïúÏùº Ïàò ÏûàÏñ¥).");
      }
    });

    dkIconClear.addEventListener("click", async () => {
      dkIconFile.value = "";
      setDkIcon("");
      dkPendingIcon = "";

      // ‚úÖ ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏûàÏúºÎ©¥: DBÏóêÏÑúÎèÑ ÏÇ≠Ï†ú + iconKey ÎπÑÏö∞Í∏∞
      if(activeDkId){
        const idx = dks.findIndex(x => x.id === activeDkId);
        if(idx >= 0){
          const oldKey = dks[idx].iconKey || "";
          if(oldKey){
            try{ await idbDel(oldKey); }catch(e){}
            revokeIconURL(oldKey);
          }
          dks[idx] = { ...dks[idx], iconKey: "" };
          saveDks();
          renderDkList();
          toast(dkToast, "ÏïÑÏù¥ÏΩò Ï†úÍ±∞ ÏôÑÎ£å!");
          return;
        }
      }
    });

    function setDkState(state){
      if(state === "debuff"){
        dkStateBtn.textContent = "ÎîîÎ≤ÑÌîÑ";
        dkStateBtn.classList.remove("buff");
        dkStateBtn.classList.add("debuff");
        dkStateBtn.dataset.state = "debuff";
      }else{
        dkStateBtn.textContent = "Î≤ÑÌîÑ";
        dkStateBtn.classList.remove("debuff");
        dkStateBtn.classList.add("buff");
        dkStateBtn.dataset.state = "buff";
      }
    }

    function dkAutosave(){
      if(!activeDkId) return;
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      dks[idx] = {
        ...dks[idx],
        name: dkName.value,
        text: dkText.value,
        state: (dkStateBtn.dataset.state === "debuff") ? "debuff" : "buff",
        // ‚úÖ iconKeyÎäî ÏûêÎèôÏ†ÄÏû•ÏóêÏÑú Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
      };
      saveDks();
    }

    dkName.addEventListener("input", dkAutosave);
    dkText.addEventListener("input", dkAutosave);

    dkStateBtn.addEventListener("click", () => {
      const cur = dkStateBtn.dataset.state || "buff";
      setDkState(cur === "buff" ? "debuff" : "buff");
      dkAutosave();
    });

    function saveDks(){
      try{
        localStorage.setItem(KEY_DK, JSON.stringify(dks));
      }catch(e){
        console.error("DK Ï†ÄÏû• Ïã§Ìå®:", e);
        toast(dkToast, "Ï†ÑÏö© ÌÇ§ÏõåÎìú Ï†ÄÏû• Ïã§Ìå®! (Í∂åÌïú/Ïö©Îüâ Î¨∏Ï†úÏùº Ïàò ÏûàÏñ¥)");
      }
    }

    function clearDkEditor(){
      activeDkId = null;
      dkName.value = "";
      dkText.value = "";
      dkIconFile.value = "";
      setDkIcon("");
      setDkState("buff");
      renderDkList();
    }

    async function loadDkToEditor(item){
      dkPendingIcon = "";
      activeDkId = item.id;
      dkName.value = item.name || "";
      dkText.value = item.text || "";
      setDkState(item.state || "buff");

      // ÎØ∏Î¶¨Î≥¥Í∏∞: IndexedDBÏóêÏÑú ÏùΩÏñ¥Ïò§Í∏∞
      setDkIcon("");
      if(item.iconKey){
        try{
          const blob = await idbGetBlob(item.iconKey);
          if(blob){
            setDkIcon(makeObjectURLFromBlob(blob));
          }else{
            setDkIcon("");
          }
        }catch(e){
          console.error(e);
          setDkIcon("");
        }
      }

      renderDkList();
    }

    function displayTitle(k){
      const nm = String(k.name || "").trim();
      if(nm) return nm;
      const txt = String(k.text || "").trim();
      if(!txt) return "(ÎÇ¥Ïö© ÏóÜÏùå)";
      const firstLine = txt.split("\n")[0].trim();
      return firstLine || "(ÎÇ¥Ïö© ÏóÜÏùå)";
    }

    function renderDkList(){
      dkList.innerHTML = "";

      if(dks.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(238,241,255,.55)";
        empty.style.fontSize = "13px";
        empty.style.padding = "10px 6px";
        empty.textContent = "ÏïÑÏßÅ Ï†ÑÏö© ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏñ¥. ÏïÑÎûò 'ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä'Î°ú ÎßåÎì§Ïûê.";
        dkList.appendChild(empty);
        return;
      }

      for(const k of dks){
        const item = document.createElement("div");
        const toneClass = (k.state === "debuff") ? " debuff" : " buff";
        item.className = "dkItem" + toneClass + (k.id === activeDkId ? " active" : "");

        const left = document.createElement("div");
        left.className = "dkLeft";

        const icon = document.createElement("div");
        icon.className = "dkMiniIcon";

        // ‚úÖ iconKey -> IndexedDBÎ°ú Î°úÎìú
        const img = document.createElement("img");
        img.alt = "ÏïÑÏù¥ÏΩò";
        img.style.display = "none";
        icon.appendChild(img);

        const ph = document.createElement("div");
        ph.className = "ph";
        ph.textContent = "ÏïÑÏù¥ÏΩò";
        icon.appendChild(ph);

        if(k.iconKey){
          applyIconKeyToImg(img, k.iconKey).then(() => {
            if(img.style.display === "block") ph.style.display = "none";
          });
        }

        const titleEl = document.createElement("div");
        titleEl.className = "dkLeftTitle";
        titleEl.textContent = displayTitle(k);

        left.appendChild(icon);
        left.appendChild(titleEl);

        const meta = document.createElement("div");
        meta.className = "dkMeta";

        const d = document.createElement("div");
        d.className = "d";
        d.textContent = String(k.text || "").trim() || "(ÎÇ¥Ïö© ÏóÜÏùå)";
        meta.appendChild(d);

        const tag = document.createElement("div");
        tag.className = "dkTag " + (k.state === "debuff" ? "debuff" : "buff");
        tag.textContent = (k.state === "debuff") ? "ÎîîÎ≤ÑÌîÑ" : "Î≤ÑÌîÑ";

        item.appendChild(left);
        item.appendChild(meta);
        item.appendChild(tag);

        item.addEventListener("click", () => loadDkToEditor(k));
        dkList.appendChild(item);
      }
    }

    dkAddBtn.addEventListener("click", () => {
      const it = { id: uid(), name: "", text: "", state: "buff", iconKey: "" };
      dks.unshift(it);
      saveDks();
      loadDkToEditor(it);
      toast(dkToast, "ÏÉà Ï†ÑÏö© ÌÇ§ÏõåÎìúÎ•º ÎßåÎì§ÏóàÏñ¥. Ïù¥Î¶Ñ/ÎÇ¥Ïö© ÏûëÏÑ± ÌõÑ Ï†ÄÏû•Ìï¥Ï§ò.");
      selectTab("dk");
    });

    dkSaveBtn.addEventListener("click", async () => {
      if(!activeDkId){
        toast(dkToast, "Î®ºÏ†Ä ÏïÑÎûòÏóêÏÑú ÌÇ§ÏõåÎìúÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò, 'ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä'Î°ú ÎßåÎì§Ïñ¥Ï§ò.");
        return;
      }
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      // ‚úÖ Í∏∞Ï°¥ iconKey Ïú†ÏßÄ
      let iconKey = dks[idx].iconKey || "";

      // ‚úÖ pending ÏïÑÏù¥ÏΩòÏù¥ ÏûàÏúºÎ©¥ IndexedDBÏóê Ï†ÄÏû•(ÌÇ§Îäî Ìï≠Î™© id Í∏∞Î∞ò Í≥†Ï†ï)
      if(dkPendingIcon && String(dkPendingIcon).startsWith("data:image/")){
        try{
          const blob = dataURLToBlob(dkPendingIcon);
          iconKey = `dk_icon_${activeDkId}`;
          await idbPutBlob(iconKey, blob);
          revokeIconURL(iconKey); // Ï∫êÏãú URL Í∞±Ïã†
        }catch(e){
          console.error(e);
          toast(dkToast, "ÏïÑÏù¥ÏΩò Ï†ÄÏû• Ïã§Ìå®(Î∏åÎùºÏö∞Ï†Ä Ï†úÌïú/ÌòïÏãù Î¨∏Ï†ú).");
          return;
        }
      }

      dks[idx] = {
        ...dks[idx],
        name: dkName.value,
        text: dkText.value,
        state: (dkStateBtn.dataset.state === "debuff") ? "debuff" : "buff",
        iconKey: iconKey || ""
      };

      saveDks();
      dkPendingIcon = "";
      toast(dkToast, "Ï†ÄÏû• ÏôÑÎ£å!");
      renderDkList();

      if(iconKey){
        try{
          const blob = await idbGetBlob(iconKey);
          if(blob) setDkIcon(makeObjectURLFromBlob(blob));
        }catch(e){}
      }
    });

    dkDeleteBtn.addEventListener("click", async () => {
      if(!activeDkId){
        toast(dkToast, "ÏÇ≠Ï†úÌï† ÌÇ§ÏõåÎìúÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï§ò.");
        return;
      }
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      // ‚úÖ ÏïÑÏù¥ÏΩòÎèÑ Í∞ôÏù¥ ÏÇ≠Ï†ú
      const oldKey = dks[idx].iconKey || "";
      if(oldKey){
        try{ await idbDel(oldKey); }catch(e){}
        revokeIconURL(oldKey);
      }

      dks.splice(idx, 1);
      saveDks();
      toast(dkToast, "ÌÇ§ÏõåÎìú ÏÇ≠Ï†ú ÏôÑÎ£å!");
      clearDkEditor();
    });

    // ‚úÖ DK Ï¥àÍ∏∞ Î°úÎìú + Íµ¨Î≤ÑÏ†Ñ icon(dataURL) ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
    (async () => {
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_DK) || "[]");
        if(Array.isArray(saved)) dks = saved;

        let changed = false;
        for(const k of dks){
          // Íµ¨Î≤ÑÏ†Ñ: icon(dataURL) -> iconKey(DB)
          if(k.icon && String(k.icon).startsWith("data:image/") && !k.iconKey){
            try{
              const blob = dataURLToBlob(k.icon);
              const key = `dk_icon_${k.id}`;
              await idbPutBlob(key, blob);
              k.iconKey = key;
              delete k.icon;
              changed = true;
            }catch(e){
              console.error("dk icon migrate fail:", e);
            }
          }
          if(k.icon && k.iconKey){
            delete k.icon;
            changed = true;
          }
        }
        if(changed) localStorage.setItem(KEY_DK, JSON.stringify(dks));
      }catch(e){
        console.error(e);
      }
      clearDkEditor();
    })();

    const pvToast = document.getElementById("pvToast");
    const pvName = document.getElementById("pvName");
    const pvText = document.getElementById("pvText");
    const pvSaveBtn = document.getElementById("pvSaveBtn");
    const pvDeleteBtn = document.getElementById("pvDeleteBtn");
    const pvAddBtn = document.getElementById("pvAddBtn");
    const pvBoard = document.getElementById("pvBoard");
    const skList = document.getElementById("skList");
    const pvHighlightBtn = document.getElementById("pvHighlightBtn");
    const pvKeywordBtn = document.getElementById("pvKeywordBtn");
    const pvStyleBtns = [...document.querySelectorAll(".pvStyleBtn")];

const skListNormal = document.getElementById("skListNormal");
const skListSpecial = document.getElementById("skListSpecial");

    let passives = [];
    let activePvId = null;
    let activePvStyle = "brown"; // Î≥¥ÌÜµ=brown | Ï§ëÏöî=orange | Îß§Ïö∞Ï§ëÏöî=red

    function pvUid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
function pvSaveStore(){
  try{
    const raw = JSON.stringify(passives);
    localStorage.setItem(KEY_PV, raw);

    // ‚úÖ Ïã§Ï†úÎ°ú Ï†ÄÏû•ÎêêÎäîÏßÄ Í≤ÄÏ¶ù
    const check = localStorage.getItem(KEY_PV);
    if(check !== raw){
      throw new Error("KEY_PV write verify failed");
    }

    return true;
  }catch(e){
    console.error("Ìå®ÏãúÎ∏å Ï†ÄÏû• Ïã§Ìå®:", e);
    try{ toast(pvToast, "Ìå®ÏãúÎ∏å Ï†ÄÏû• Ïã§Ìå®! (Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû•Í≥µÍ∞Ñ/Í∂åÌïú Î¨∏Ï†úÏùº Ïàò ÏûàÏñ¥)"); }catch(_){}
    return false;
  }
}
    function pvLoadStore(){
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_PV) || "[]");
        if(Array.isArray(saved)) passives = saved;
      }catch(e){}
    }
    function pvToastMsg(msg){
      toast(pvToast, msg);
    }
    function pvSetStyle(style){
      activePvStyle = style;
      pvStyleBtns.forEach(b => b.classList.toggle("active", b.dataset.style === style));
    }
    pvStyleBtns.forEach(btn => {
      btn.addEventListener("click", () => pvSetStyle(btn.dataset.style || "brown"));
    });

    function pvHasHighlightTokens(text){
      return String(text || "").includes("[[hl]]") || String(text || "").includes("[[/hl]]");
    }
    function pvWrapSelectionWithHighlight(){
      const el = pvText;
      const start = el.selectionStart ?? 0;
      const end = el.selectionEnd ?? 0;
      if(start === end) return false;

      const txt = el.value;
      const before = txt.slice(0, start);
      const sel = txt.slice(start, end);
      const after = txt.slice(end);

      el.value = before + "[[hl]]" + sel + "[[/hl]]" + after;
      const newPos = end + "[[hl]]".length + "[[/hl]]".length;
      el.focus();
      el.setSelectionRange(newPos, newPos);
      return true;
    }
    function pvStripAllHighlights(text){
      return String(text || "").replaceAll("[[hl]]","").replaceAll("[[/hl]]","");
    }

    pvHighlightBtn.addEventListener("click", () => {
      const ok = pvWrapSelectionWithHighlight();
      if(!ok){
        pvToastMsg("Í∞ïÏ°∞Ìï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Ï§ò.");
        return;
      }
      pvToastMsg("ÏÑ†ÌÉùÌïú Î∂ÄÎ∂ÑÏóê Í∞ïÏ°∞Î•º Ï†ÅÏö©ÌñàÏñ¥.");
      pvRenderBoard();
    });

    /* ‚úÖ Ï†ÑÏö©ÌÇ§ÏõåÎìú ÌÜ†ÌÅ∞ -> Ïπ¥ÎìúÏóêÏÑú ÏÉâ ÌëúÏãú */
/* ‚úÖ Ï†ÑÏö©ÌÇ§ÏõåÎìú ÌÜ†ÌÅ∞ -> Ïπ¥ÎìúÏóêÏÑú ÏÉâ ÌëúÏãú */
function pvToHtml(text){
  const esc = String(text || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");

  return esc
    .replaceAll("[[hl]]", '<span class="pvHL">')
    .replaceAll("[[/hl]]", "</span>")
    .replaceAll(/\[\[kw:(buff|debuff):([^\]]+)\]\]/g, (m, st, name) => {
      const cls = (st === "debuff") ? "debuff" : "buff";
      const safeName = String(name).replaceAll('"', "&quot;");
      return `<span class="pvKW ${cls}" data-kw="${safeName}" data-state="${st}">${name}</span>`;
    });
}

    function pvDisplayTitle(p){
      const n = String(p.name || "").trim();
      if(n) return n;
      const t = pvStripAllHighlights(String(p.text || "")).trim();
      if(!t) return "(ÎÇ¥Ïö© ÏóÜÏùå)";
      return (t.split("\n")[0] || "(ÎÇ¥Ïö© ÏóÜÏùå)").trim();
    }

    function pvRenderBoard(){
      if(!pvBoard) return;
      pvBoard.innerHTML = "";

      if(passives.length === 0){
        const d = document.createElement("div");
        d.style.color = "rgba(238,241,255,.55)";
        d.style.fontSize = "13px";
        d.style.padding = "8px";
        d.textContent = "ÏïÑÏßÅ Ìå®ÏãúÎ∏åÍ∞Ä ÏóÜÏñ¥. Ïò§Î•∏Ï™ΩÏùò 'Ìå®ÏãúÎ∏å Ï∂îÍ∞Ä'Î°ú ÎßåÎì§Ïûê.";
        pvBoard.appendChild(d);
        return;
      }

      for(const p of passives){
        const card = document.createElement("div");
        card.className = "pvCard" + (p.id === activePvId ? " active" : "");

        const hdr = document.createElement("div");
        hdr.className = "pvHdr " + (p.style || "brown");
        hdr.textContent = pvDisplayTitle(p);

        const sl = document.createElement("div");
        sl.className = "slashes";
        sl.innerHTML = "<i></i><i></i><i></i>";
        hdr.appendChild(sl);

        const body = document.createElement("div");
        body.className = "pvBody";
        body.innerHTML = pvToHtml(p.text || "");

        card.appendChild(hdr);
        card.appendChild(body);

        card.addEventListener("click", () => {
          activePvId = p.id;
          pvName.value = p.name || "";
          pvText.value = p.text || "";
          pvSetStyle(p.style || "brown");
          pvRenderBoard();
        });

        pvBoard.appendChild(card);
      }
    }

    function pvClearEditor(){
      activePvId = null;
      pvName.value = "";
      pvText.value = "";
      pvSetStyle("brown");
      pvRenderBoard();
    }

    pvAddBtn.addEventListener("click", () => {
      const it = { id: pvUid(), name: "", text: "", style: "brown" };
      passives.push(it);
      pvSaveStore();

      activePvId = it.id;
      pvName.value = "";
      pvText.value = "";
      pvSetStyle("brown");

      pvRenderBoard();
      pvToastMsg("ÏÉà Ìå®ÏãúÎ∏åÎ•º Ï∂îÍ∞ÄÌñàÏñ¥. Ïù¥Î¶Ñ/ÎÇ¥Ïö© ÏûëÏÑ± ÌõÑ Ï†ÄÏû•Ìï¥Ï§ò.");
      selectTab("passive");
    });

function forceSavePassivesIfEditing(){
  // Ìé∏Ïßë Ï§ëÏù∏ Ìå®ÏãúÎ∏åÍ∞Ä ÏûàÏúºÎ©¥, ÌòÑÏû¨ ÏûÖÎ†•Ïπ∏ Í∞íÏùÑ passives[]Ïóê Î∞òÏòÅ
  if(activePvId){
    const idx = passives.findIndex(x => x.id === activePvId);
    if(idx >= 0){
      passives[idx] = {
        ...passives[idx],
        name: pvName.value,
        text: pvText.value,
        style: activePvStyle
      };
    }
  }

  // localStorage Î∞òÏòÅ
  try{
    localStorage.setItem(KEY_PV, JSON.stringify(passives));
  }catch(e){
    console.error("Ìå®ÏãúÎ∏å Í∞ïÏ†úÏ†ÄÏû• Ïã§Ìå®:", e);
    try{ toast(pvToast, "Ìå®ÏãúÎ∏å Ï†ÄÏû• Ïã§Ìå®(Ïö©Îüâ/Í∂åÌïú Î¨∏Ï†úÏùº Ïàò ÏûàÏñ¥)."); }catch(_){}
  }
}

// ‚úÖ Ìå®ÏãúÎ∏å Ìé∏Ïßë ÏûêÎèôÏ†ÄÏû• (ÏûÖÎ†•/Ïä§ÌÉÄÏùº Î∞îÎÄî ÎïåÎßàÎã§)
pvName?.addEventListener("input", forceSavePassivesIfEditing);
pvText?.addEventListener("input", forceSavePassivesIfEditing);

// Ïä§ÌÉÄÏùº Î≤ÑÌäº ÌÅ¥Î¶≠ ÏãúÏóêÎèÑ Ï†ÄÏû•
pvStyleBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    // pvSetStyle()Îäî Í∏∞Ï°¥ ÏΩîÎìúÍ∞Ä Ïù¥ÎØ∏ Ìò∏Ï∂úÌïòÎãàÍπå, Í∑∏ Îí§Ïóê Ï†ÄÏû•Îßå Ï∂îÍ∞Ä
    forceSavePassivesIfEditing();
  });
});

    pvSaveBtn.addEventListener("click", () => {
      if(!activePvId){
        pvToastMsg("Î®ºÏ†Ä ÏïÑÎûòÏóêÏÑú Ìå®ÏãúÎ∏åÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò, 'Ìå®ÏãúÎ∏å Ï∂îÍ∞Ä'Î°ú ÎßåÎì§Ïñ¥Ï§ò.");
        return;
      }
      const idx = passives.findIndex(x => x.id === activePvId);
      if(idx < 0) return;

      passives[idx] = {
        ...passives[idx],
        name: pvName.value,
        text: pvText.value,
        style: activePvStyle
      };

pvSaveStore();
pvToastMsg("Ï†ÄÏû• ÏôÑÎ£å!");
pvRenderBoard();
    });

    pvDeleteBtn.addEventListener("click", () => {
      if(!activePvId){
        pvToastMsg("ÏÇ≠Ï†úÌï† Ìå®ÏãúÎ∏åÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï§ò.");
        return;
      }
      const idx = passives.findIndex(x => x.id === activePvId);
      if(idx < 0) return;

      passives.splice(idx, 1);
      pvSaveStore();
      pvToastMsg("ÏÇ≠Ï†ú ÏôÑÎ£å!");
      pvClearEditor();
    });

/* ========= ÌÇ§ÏõåÎìú(Í∏∞Î≥∏/ÎåÄÌëú/Ï†ÑÏö©) ÌîºÏª§ ========= */
const kwModal = document.getElementById("kwModal");
const kwCloseBtn = document.getElementById("kwCloseBtn");
const kwModalList = document.getElementById("kwModalList");
const kwModalTitle = document.getElementById("kwModalTitle");
const kwTabBtns = [...document.querySelectorAll(".kwTab")];
const kwStateToggle = document.getElementById("kwStateToggle");
let kwStateFilter = "buff"; // ‚úÖ Í∏∞Î≥∏ÏùÄ Î≤ÑÌîÑÎßå

function setKwStateFilter(next){
  kwStateFilter = (next === "debuff") ? "debuff" : "buff";

  if(kwStateToggle){
    kwStateToggle.classList.remove("buff","debuff");
    kwStateToggle.classList.add(kwStateFilter);
    kwStateToggle.textContent = (kwStateFilter === "debuff") ? "ÎîîÎ≤ÑÌîÑ" : "Î≤ÑÌîÑ";
  }

  renderKwModal(); // ‚úÖ Î¶¨Ïä§Ìä∏ Îã§Ïãú Í∑∏Î¶¨Í∏∞
}

kwStateToggle?.addEventListener("click", () => {
  setKwStateFilter(kwStateFilter === "buff" ? "debuff" : "buff");
});

/** ‚úÖ Í∏∞Î≥∏/ÎåÄÌëú ÌÇ§ÏõåÎìú(ÏàòÏ†ï Î∂àÍ∞Ä, assets ÏïÑÏù¥ÏΩò) */
const REP_KEYWORDS = [
  // debuff
  { name:"ÌôîÏÉÅ", state:"debuff", icon:"assets/icon_rep_burn.png", text:"ÌÑ¥ Ï¢ÖÎ£å Ïãú, Ìö®Í≥º ÏúÑÎ†•ÎßåÌÅº Í≥†Ï†ï ÌîºÌï¥Î•º Î∞õÍ≥† ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"Ï∂úÌòà", state:"debuff", icon:"assets/icon_rep_bleed.png", text:"Í≥µÍ≤© Ïä§ÌÇ¨Ïùò ÏΩîÏù∏ ÌåêÏ†ï Ïãú, Ìö®Í≥º ÏúÑÎ†•ÎßåÌÅº Í≥†Ï†ï Ï≤¥Î†• ÌîºÌï¥Î•º Î∞õÏùå. Í≥µÍ≤© Ïä§ÌÇ¨Ïùò ÏΩîÏù∏ ÌåêÏ†ï ÌõÑ ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"ÏßÑÎèô", state:"debuff", icon:"assets/icon_rep_tremor.png", text:"ÏßÑÎèô Ìè≠Î∞ú Ïä§ÌÇ¨Î°ú ÌîºÍ≤© Ïãú, Ìö®Í≥º ÏúÑÎ†•ÎßåÌÅº ÌùêÌä∏Îü¨Ïßê ÏÜêÏÉÅ. ÌÑ¥ Ï¢ÖÎ£å ÌõÑ ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"ÌååÏó¥", state:"debuff", icon:"assets/icon_rep_rupture.png", text:"Í≥µÍ≤© Ïä§ÌÇ¨Î°ú ÌîºÍ≤© Ïãú, Ìö®Í≥º ÏúÑÎ†•ÎßåÌÅº Í≥†Ï†ï Ï≤¥Î†• ÌîºÌï¥Î•º Î∞õÏùå. ÌîºÍ≤© ÌõÑ ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"Ïπ®Ïû†", state:"debuff", icon:"assets/icon_rep_sinking.png", text:"Í≥µÍ≤© Ïä§ÌÇ¨Î°ú ÌîºÍ≤© Ïãú, Ìö®Í≥º ÏúÑÎ†•ÎßåÌÅº Í≥†Ï†ï Ï†ïÏã†Î†• ÌîºÌï¥Î•º Î∞õÏùå (Ï†ïÏã†Î†•Ïù¥ ÏóÜÎäî ÎåÄÏÉÅÏóêÍ≤åÎäî Ïö∞Ïö∏ ÏÜçÏÑ± ÌîºÌï¥Î°ú Ï†ÅÏö©Îê®) ÌîºÍ≤© ÌõÑ ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"ÏßÑÎèô Ìè≠Î∞ú", state:"debuff", icon:"assets/icon_rep_tremor_boom.png", text:"ÎåÄÏÉÅÏùò ÏßÑÎèô ÏúÑÎ†•ÎßåÌÅº ÌùêÌä∏Îü¨Ïßê ÏÜêÏÉÅÏùÑ ÏûÖÌûò" },
  { name:"ÏßÑÌè≠ Î≥ÄÌôò", state:"debuff", icon:"assets/icon_rep_tremor_urthim.png", text:"ÎåÄÏÉÅÏùò ÏßÑÎèô ÎòêÎäî Î≥ÄÍ≤ΩÎêú ÏßÑÎèôÏùÑ Îã§Î•∏ Ïú†ÌòïÏùò ÏßÑÎèôÏúºÎ°ú Î≥ÄÍ≤ΩÌï®. Î≥ÄÍ≤Ω Ïãú Í∏∞Ï°¥ Ìö®Í≥ºÏùò ÏúÑÎ†•, ÌöüÏàòÍ∞Ä Ïú†ÏßÄÎê®" },
  // buff
  { name:"Ï∂©Ï†Ñ", state:"buff", icon:"assets/icon_rep_charge.png", text:"ÏÜåÎ™® Ïãú ÌäπÏ†ï Ïä§ÌÇ¨Ïùò ÏúÑÎ†•Ïù¥ ÏÉÅÏäπÌï®. ÌöüÏàòÎ•º ÏµúÎåÄ 20ÍπåÏßÄ ÏñªÏùÑ Ïàò ÏûàÏùå. ÌÑ¥ Ï¢ÖÎ£å Ïãú ÌöüÏàò 1 Í∞êÏÜå" },
  { name:"Ìò∏Ìù°", state:"buff", icon:"assets/icon_rep_breath.png", text:"Ï†ÅÏ§ë Ïãú Ìö®Í≥º ÏúÑÎ†• 1Îãπ 5%Ïùò ÌôïÎ•†Î°ú 120%Ïùò ÏπòÎ™ÖÌÉÄ ÌîºÌï¥Î•º ÏûÖÌûò. ÌÑ¥ Ï¢ÖÎ£å Ïãú, ÏπòÎ™ÖÌÉÄ Î∞úÎèô ÌõÑ ÌöüÏàò 1 Í∞êÏÜå" },
];

const BASE_KEYWORDS = [
  // debuff
  { name:"Ï∑®ÏïΩ", state:"debuff", icon:"assets/icon_base_fragile.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Î°ú Î∞õÎäî ÌîºÌï¥Í∞Ä ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Ï¶ùÍ∞Ä (ÏàòÏπò 1Îãπ 10%)" },
  { name:"ÏÜçÎ∞ï", state:"debuff", icon:"assets/icon_base_bind.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÏÜçÎèÑÍ∞Ä ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä/Í∞êÏÜå" },
  { name:"ÏúÑÎ†• Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_power_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"Í≥µÍ≤© ÏúÑÎ†• Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_atk_power_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Í≥µÍ≤© Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"ÏàòÎπÑ ÏúÑÎ†• Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_def_power_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÏàòÎπÑ Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"Ìï© ÏúÑÎ†• Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_clash_power_down.png", text:"Ìï© ÏßÑÌñâ Ïãú, Ìï© ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"ÎçîÌïòÍ∏∞ ÏΩîÏù∏ ÏïΩÌôî", state:"debuff", icon:"assets/icon_base_plus_coin_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÎçîÌïòÍ∏∞ ÏΩîÏù∏ ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"ÎπºÍ∏∞ ÏΩîÏù∏ ÏïΩÌôî", state:"debuff", icon:"assets/icon_base_minus_coin_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÎπºÍ∏∞ ÏΩîÏù∏ ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Í∞êÏÜå" },
  { name:"ÌîºÌï¥Îüâ Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_damage_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Î°ú Í∞ÄÌïòÎäî ÌîºÌï¥Í∞Ä ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ 10%Ïî© Í∞êÏÜå (ÏµúÎåÄ 10)" },
  { name:"Í≥µÍ≤© Î†àÎ≤® Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_atk_level_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Í≥µÍ≤© Î†àÎ≤®Ïù¥ ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Í∞êÏÜå" },
  { name:"Î∞©Ïñ¥ Î†àÎ≤® Í∞êÏÜå", state:"debuff", icon:"assets/icon_base_def_level_down.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Î∞©Ïñ¥ Î†àÎ≤®Ïù¥ ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Í∞êÏÜå" },
  { name:"ÎßàÎπÑ", state:"debuff", icon:"assets/icon_base_paralysis.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÏàòÏπòÎßåÌÅº ÏΩîÏù∏ ÏúÑÎ†•Ïù¥ 0ÏúºÎ°ú Í≥†Ï†ï" },

  // buff
  { name:"Î≥¥Ìò∏", state:"buff", icon:"assets/icon_base_protection.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Î°ú Î∞õÎäî ÌîºÌï¥Í∞Ä ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Í∞êÏÜå (ÏàòÏπò 1Îãπ 10%)" },
  { name:"Ïã†ÏÜç", state:"buff", icon:"assets/icon_base_haste.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÏÜçÎèÑÍ∞Ä ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"ÏúÑÎ†• Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_power_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"Í≥µÍ≤© ÏúÑÎ†• Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_atk_power_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Í≥µÍ≤© Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"ÏàòÎπÑ ÏúÑÎ†• Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_def_power_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÏàòÎπÑ Ïä§ÌÇ¨Ïùò ÏµúÏ¢Ö ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"Ìï© ÏúÑÎ†• Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_clash_power_up.png", text:"Ìï© ÏßÑÌñâ Ïãú, Ìï© ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"ÎçîÌïòÍ∏∞ ÏΩîÏù∏ Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_plus_coin_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÎçîÌïòÍ∏∞ ÏΩîÏù∏ ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"ÎπºÍ∏∞ ÏΩîÏù∏ Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_minus_coin_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà ÎπºÍ∏∞ ÏΩîÏù∏ ÏúÑÎ†•Ïù¥ ÏàòÏπòÎßåÌÅº Ï¶ùÍ∞Ä" },
  { name:"ÌîºÌï¥Îüâ Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_damage_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Ïä§ÌÇ¨Î°ú Í∞ÄÌïòÎäî ÌîºÌï¥Í∞Ä ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ 10%Ïî© Ï¶ùÍ∞Ä (ÏµúÎåÄ 10)" },
  { name:"Í≥µÍ≤© Î†àÎ≤® Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_atk_level_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Í≥µÍ≤© Î†àÎ≤®Ïù¥ ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Ï¶ùÍ∞Ä" },
  { name:"Î∞©Ïñ¥ Î†àÎ≤® Ï¶ùÍ∞Ä", state:"buff", icon:"assets/icon_base_def_level_up.png", text:"Ìïú ÌÑ¥ ÎèôÏïà Î∞©Ïñ¥ Î†àÎ≤®Ïù¥ ÏàòÏπòÏóê ÎπÑÎ°ÄÌïòÏó¨ Ï¶ùÍ∞Ä" },
];

/** Ï†ÑÏö© ÌÇ§ÏõåÎìú Î°úÎìú(localStorage) */
function loadDedicatedKeywords(){
  try{
    const raw = JSON.parse(localStorage.getItem(KEY_DK) || "[]");
    if(Array.isArray(raw)) return raw;
  }catch(e){}
  return [];
}

/** ÌÉ≠ ÏÉÅÌÉú */
let kwActiveTab = "base"; // base | rep | ded

function setKwTab(tab){
  kwActiveTab = tab;
  kwTabBtns.forEach(b => {
    const on = (b.dataset.tab === tab);
    b.classList.toggle("active", on);
    b.setAttribute("aria-selected", on ? "true" : "false");
  });

  if(kwModalTitle){
    kwModalTitle.textContent =
      (tab === "base") ? "Í∏∞Î≥∏ ÌÇ§ÏõåÎìú" :
      (tab === "rep")  ? "ÎåÄÌëú ÌÇ§ÏõåÎìú" : "Ï†ÑÏö© ÌÇ§ÏõåÎìú";
  }
  renderKwModal();
}

function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end = textarea.selectionEnd ?? textarea.value.length;
  const v = textarea.value;
  textarea.value = v.slice(0, start) + text + v.slice(end);
  const pos = start + text.length;
  textarea.focus();
  textarea.setSelectionRange(pos, pos);
}

let kwTargetTextarea = null;

function openKwModalFor(textarea){
  kwTargetTextarea = textarea || pvText;
  kwModal.classList.remove("hidden");
  setKwTab(kwActiveTab);
}
function openKwModal(){
  openKwModalFor(pvText);
}
function closeKwModal(){
  kwModal.classList.add("hidden");
}

/** Í≥µÌÜµ Î†åÎçî row */
function makeKwRow({name, state, iconSrc, iconKey, isDedicated}){
  const row = document.createElement("button");
  row.type = "button";
  row.style.display = "grid";
  row.style.gridTemplateColumns = "52px 1fr 90px";
  row.style.gap = "10px";
  row.style.alignItems = "center";
  row.style.textAlign = "left";
  row.style.padding = "12px";
  row.style.borderRadius = "14px";

  const icon = document.createElement("div");
  icon.style.width = "48px";
  icon.style.height = "48px";
  icon.style.borderRadius = "14px";
  icon.style.border = "1px solid rgba(255,255,255,.12)";
  icon.style.background = "rgba(0,0,0,.22)";
  icon.style.display = "grid";
  icon.style.placeItems = "center";
  icon.style.overflow = "hidden";

  // ÏïÑÏù¥ÏΩò: (1) assets Í≤ΩÎ°ú (2) Ï†ÑÏö©ÌÇ§ÏõåÎìú iconKey(IndexedDB)
  const img = document.createElement("img");
  img.alt = "ÏïÑÏù¥ÏΩò";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.display = "none";
  icon.appendChild(img);

  const ph = document.createElement("div");
  ph.textContent = "ÏïÑÏù¥ÏΩò";
  ph.style.fontSize = "11px";
  ph.style.color = "rgba(238,241,255,.45)";
  icon.appendChild(ph);

  if(iconSrc){
    img.src = iconSrc;
    img.style.display = "block";
    ph.style.display = "none";
  }else if(isDedicated && iconKey){
    applyIconKeyToImg(img, iconKey).then(() => {
      if(img.style.display === "block") ph.style.display = "none";
    });
  }

  const title = document.createElement("div");
  title.style.fontWeight = "900";
  title.style.color = "rgba(243,211,154,.95)";
  title.textContent = name;

  const isDebuff = (state === "debuff");
  const tag = document.createElement("div");
  tag.textContent = isDebuff ? "ÎîîÎ≤ÑÌîÑ" : "Î≤ÑÌîÑ";
  tag.style.fontWeight = "900";
  tag.style.fontSize = "12px";
  tag.style.padding = "8px 10px";
  tag.style.borderRadius = "999px";
  tag.style.border = "1px solid rgba(255,255,255,.12)";
  tag.style.background = "rgba(0,0,0,.18)";
  tag.style.textAlign = "center";
  tag.style.color = isDebuff ? "rgba(255,120,120,.98)" : "rgba(243,211,154,.95)";

  row.appendChild(icon);
  row.appendChild(title);
  row.appendChild(tag);

    // ‚úÖ ÌÜ†ÌÅ∞ÏùÄ ÌÜµÏùº: Ïñ¥ÎîîÏÑú Ïò§Îì† ÎèôÏùºÌïòÍ≤å [[kw:state:name]]
row.addEventListener("click", async () => {
  const nm = String(name || "").trim() || "ÌÇ§ÏõåÎìú";
  const st = (state === "debuff") ? "debuff" : "buff";

  const target = kwTargetTextarea || pvText;
  insertAtCursor(target, `[[kw:${st}:${nm}]]`);
  closeKwModal();

  // ‚úÖ ÌÉÄÍ≤üÏóê Îî∞Îùº Í∞±Ïã†
  if(target === skText){
    await renderSkillPreview();
  }else{
    pvRenderBoard();
  }
});

  return row;
}

function renderKwModal(){
  kwModalList.innerHTML = "";

  // ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞
  if(kwActiveTab === "base"){
    for(const k of BASE_KEYWORDS){
      if(k.state !== kwStateFilter) continue;
      kwModalList.appendChild(makeKwRow({
        name: k.name,
        state: k.state,
        iconSrc: k.icon,
        isDedicated: false
      }));
    }
    return;
  }

  if(kwActiveTab === "rep"){
    for(const k of REP_KEYWORDS){
      if(k.state !== kwStateFilter) continue;
      kwModalList.appendChild(makeKwRow({
        name: k.name,
        state: k.state,
        iconSrc: k.icon,
        isDedicated: false
      }));
    }
    return;
  }

  // Ï†ÑÏö©
  const list = loadDedicatedKeywords();

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "rgba(238,241,255,.55)";
    empty.style.fontSize = "13px";
    empty.style.padding = "8px";
    empty.textContent = "Ï†ÑÏö© ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏñ¥. Ï†ÑÏö© ÌÇ§ÏõåÎìú ÌÉ≠ÏóêÏÑú Î®ºÏ†Ä ÎßåÎì§Ïñ¥Ï§ò.";
    kwModalList.appendChild(empty);
    return;
  }

  const filtered = list.filter(k => {
    const st = (k.state === "debuff") ? "debuff" : "buff";
    return st === kwStateFilter;
  });

  if(filtered.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "rgba(238,241,255,.55)";
    empty.style.fontSize = "13px";
    empty.style.padding = "8px";
    empty.textContent = (kwStateFilter === "debuff")
      ? "ÎîîÎ≤ÑÌîÑ Ï†ÑÏö© ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏñ¥."
      : "Î≤ÑÌîÑ Ï†ÑÏö© ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏñ¥.";
    kwModalList.appendChild(empty);
    return;
  }

  for(const k of filtered){
    const nm = (k.name && String(k.name).trim()) ? k.name : "(Ïù¥Î¶Ñ ÏóÜÏùå)";
    kwModalList.appendChild(makeKwRow({
      name: nm,
      state: (k.state === "debuff") ? "debuff" : "buff",
      iconKey: k.iconKey || "",
      isDedicated: true
    }));
  }
} // ‚úÖ Ïù¥ Îã´Îäî Ï§ëÍ¥ÑÌò∏Í∞Ä ÏóÜÏñ¥ÏÑú Î®πÌÜµÎÇ¨Îçò Í±∞Ïïº

// ‚úÖ ÌÉ≠ ÌÅ¥Î¶≠(Ìï®Ïàò Î∞ñ!)
kwTabBtns.forEach(btn => {
  btn.addEventListener("click", () => setKwTab(btn.dataset.tab || "base"));
});

// ‚úÖ Ïó¥Í∏∞/Îã´Í∏∞(Ìï®Ïàò Î∞ñ!)
pvKeywordBtn?.addEventListener("click", () => openKwModalFor(pvText));
kwCloseBtn?.addEventListener("click", closeKwModal);
kwModal?.addEventListener("click", (e) => { if(e.target === kwModal) closeKwModal(); });

/* ========= ÌÇ§ÏõåÎìú Hover Tooltip ========= */
const kwTip = document.getElementById("kwTip");
const kwTipImg = document.getElementById("kwTipImg");
const kwTipTitle = document.getElementById("kwTipTitle");
const kwTipText = document.getElementById("kwTipText");

function normKwName(v){
  return String(v || "")
    .trim()
    .replace(/\s+/g, "")
    .replace(/[‚Äê-‚Äí‚Äì‚Äî‚Äï\-]/g, "-") // ÌïòÏù¥ÌîàÎ•ò ÌÜµÏùº
    .toLowerCase();
}

function getDedicatedKeywordIconFallback(name){
  const n = normKwName(name);

  const map = {
    [normKwName("Ï∂îÎ†• ÏÉÅÏã§")]: "assets/kw_thrust_loss.png",
    [normKwName("Ïû¨Ïû•Ï†Ñ")]: "assets/kw_reload.png",
    [normKwName("Ï∂îÏßÑÌÉÑ")]: "assets/kw_propellant_bullet.png",
    [normKwName("ÏßÑÎèô - ÏûëÏó¥")]: "assets/kw_tremor_burn.png",
  };

  return map[n] || "";
}

function getAiSkillImageFallback(skillName){
  const n = String(skillName || "").trim();

  const map = {
    // ÏÜîÎã§ÌÜ† II / III Í≥µÏö© (ÎÑ§Í∞Ä assets Ìè¥ÎçîÏóê ÎÑ£ÏùÑ Ïù¥Î¶Ñ)
    "ÏßÑÌÉï Íø∞Îö´Í∏∞": "assets/sk_thumb_soldato_jintang_ggettulgi.png",
    "ÏûëÏó¥ Íø∞Îö´Í∏∞": "assets/sk_thumb_soldato_jakyeol_ggettulgi.png",
    "Ï∂îÏßÑ Í∞ÄÎ•¥Í∏∞": "assets/sk_thumb_soldato_chujin_gareugi.png",
    "Ï∂îÏßÑÌÉÑ Ïû¨Ïû•Ï†Ñ": "assets/sk_thumb_soldato_reload.png"
  };

  return map[n] || "";
}

function findKeywordAny(name){
  const key = String(name || "").trim();
  if(!key) return null;

  const keyNorm = normKwName(key);

  const sameKw = (a, b) => normKwName(a) === normKwName(b);

  // 1) Í∏∞Î≥∏ ÌÇ§ÏõåÎìú
  let hit = (Array.isArray(BASE_KEYWORDS) ? BASE_KEYWORDS : []).find(x => sameKw(x?.name, key));
  if(hit){
    return {
      name: hit.name,
      state: hit.state,
      text: hit.text,
      iconSrc: hit.icon || hit.iconSrc || "",
      isDedicated: false,
      iconKey: ""
    };
  }

  // 2) ÎåÄÌëú ÌÇ§ÏõåÎìú
  hit = (Array.isArray(REP_KEYWORDS) ? REP_KEYWORDS : []).find(x => sameKw(x?.name, key));
  if(hit){
    return {
      name: hit.name,
      state: hit.state,
      text: hit.text,
      iconSrc: hit.icon || hit.iconSrc || "",
      isDedicated: false,
      iconKey: ""
    };
  }

  // 3) Ï†ÑÏö© ÌÇ§ÏõåÎìú(localStorage)
  const localList = loadDedicatedKeywords?.() || [];
  hit = localList.find(x => sameKw(x?.name, key));
  if(!hit){
    hit = localList.find(x => {
      const n = normKwName(x?.name);
      return n && (n.includes(keyNorm) || keyNorm.includes(n));
    });
  }
  if(hit){
    return {
      name: String(hit.name || "").trim() || key,
      state: (hit.state === "debuff") ? "debuff" : "buff",
      text: String(hit.text || "").trim(),
      iconSrc: hit.iconSrc || hit.icon || getDedicatedKeywordIconFallback(hit.name),
      isDedicated: true,
      iconKey: hit.iconKey || ""
    };
  }

  // 4) Îß§Ïπò Ï§ë Ï∫êÎ¶≠ÌÑ∞(JSON) Ï†ÑÏö© ÌÇ§ÏõåÎìú fallback (ÏïÑÍµ∞/Ï†Å Îëò Îã§)
  try{
    const unitLists = [
      ...(Array.isArray(MATCH_STATE?.my?.raw?.dedicatedKeywords) ? [MATCH_STATE.my.raw.dedicatedKeywords] : []),
      ...(Array.isArray(MATCH_STATE?.enemy?.raw?.dedicatedKeywords) ? [MATCH_STATE.enemy.raw.dedicatedKeywords] : []),
    ];

    for(const arr of unitLists){
      let loose = arr.find(x => sameKw(x?.name, key));
      if(!loose){
        loose = arr.find(x => {
          const n = normKwName(x?.name);
          return n && (n.includes(keyNorm) || keyNorm.includes(n));
        });
      }

      if(loose){
        const kwName = String(loose.name || "").trim() || key;
        return {
          name: kwName,
          state: (loose.state === "debuff") ? "debuff" : "buff",
          text: String(loose.text || "").trim(),
          iconSrc: loose.iconSrc || loose.icon || getDedicatedKeywordIconFallback(kwName),
          isDedicated: true,
          iconKey: loose.iconKey || ""
        };
      }
    }
  }catch(e){}

  return null;
}

async function showKwTipFor(name, stateHint, clientX, clientY){
  const info = findKeywordAny(name);

  const titleText = String(name || "").trim() || "ÌÇ§ÏõåÎìú";
  kwTipTitle.textContent = titleText;

  // ‚úÖ ÏÉâ: Ï∞æÏùÄ state Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÌÜ†ÌÅ∞Ïùò data-state ÌûåÌä∏ ÏÇ¨Ïö©
  const st = info?.state || (stateHint === "debuff" ? "debuff" : "buff");
  kwTipTitle.classList.remove("buff","debuff");
  kwTipTitle.classList.add(st === "debuff" ? "debuff" : "buff");

  // ‚úÖ ÌÖçÏä§Ìä∏
  if(info && info.text){
    kwTipText.textContent = info.text;
  }else{
    kwTipText.textContent = "ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º Ï∞æÏßÄ Î™ªÌñàÏñ¥.";
  }

  // ‚úÖ ÏïÑÏù¥ÏΩò: (Í∏∞Î≥∏/ÎåÄÌëú)=assets src, (Ï†ÑÏö©)=IndexedDB iconKey
  if(info?.iconSrc){
    kwTipImg.src = info.iconSrc;
    kwTipImg.style.display = "block";
  }else if(info?.isDedicated && info.iconKey){
    try{
      await applyIconKeyToImg(kwTipImg, info.iconKey);
      if(kwTipImg.src){
        kwTipImg.style.display = "block";
      }else{
        const fb = getDedicatedKeywordIconFallback(info?.name || name);
        kwTipImg.src = fb || "";
        kwTipImg.style.display = fb ? "block" : "none";
      }
    }catch(e){
      const fb = getDedicatedKeywordIconFallback(info?.name || name);
      kwTipImg.src = fb || "";
      kwTipImg.style.display = fb ? "block" : "none";
    }
  }else{
    const fb = getDedicatedKeywordIconFallback(info?.name || name);
    kwTipImg.src = fb || "";
    kwTipImg.style.display = fb ? "block" : "none";
  }

  kwTip.classList.remove("hidden");
  kwTip.setAttribute("aria-hidden", "false");

  const pad = 14;
  const offset = 16;

  // ÏûÑÏãú ÏúÑÏπò
  kwTip.style.left = (clientX + offset) + "px";
  kwTip.style.top  = (clientY + offset) + "px";

  // ÌôîÎ©¥ Î∞îÍπ• Î≥¥Ï†ï
  const rect = kwTip.getBoundingClientRect();
  let x = clientX + offset;
  let y = clientY + offset;

  if(x + rect.width + pad > window.innerWidth) x = clientX - rect.width - offset;
  if(y + rect.height + pad > window.innerHeight) y = clientY - rect.height - offset;

  x = Math.max(pad, Math.min(x, window.innerWidth - rect.width - pad));
  y = Math.max(pad, Math.min(y, window.innerHeight - rect.height - pad));

  kwTip.style.left = x + "px";
  kwTip.style.top  = y + "px";
}

function hideKwTip(){
  kwTip.classList.add("hidden");
  kwTip.setAttribute("aria-hidden", "true");
}

/* ‚úÖ pvBoard ÏïàÏùò .pvKWÏóê hoverÎ°úÎßå ÌëúÏãú (ÎñºÎ©¥ Ï¶âÏãú ÏÇ¨ÎùºÏßê) */
pvBoard.addEventListener("mousemove", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  const kwEl = t.closest(".pvKW");
  if(!kwEl) { hideKwTip(); return; }

  const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
  const stateHint = kwEl.getAttribute("data-state") || ""; // ‚úÖ base/repÎèÑ Ïó¨Í∏∞ Îì§Ïñ¥ÏûàÏùå
  showKwTipFor(name, stateHint, e.clientX, e.clientY);
});

/* ‚úÖ ÌÇ§ÏõåÎìú(span.pvKW)ÏóêÏÑú Î≤óÏñ¥ÎÇòÎ©¥ Ï¶âÏãú Ïà®ÍπÄ */
pvBoard.addEventListener("mouseout", (e) => {
  const from = e.target;
  if(!(from instanceof HTMLElement)) return;

  const fromKw = from.closest(".pvKW");
  if(!fromKw) return;

  const to = e.relatedTarget;
  if(to instanceof HTMLElement && to.closest(".pvKW")) return;

  hideKwTip();
});

/* ‚úÖ Î≥¥Îìú ÏûêÏ≤¥Î•º Îñ†ÎÇòÎèÑ Ïà®ÍπÄ */
pvBoard.addEventListener("mouseleave", hideKwTip);

// ‚úÖ Ïä§ÌÇ¨ Î™©Î°ù(ÌÜµÌï©/Î∂ÑÎ¶¨ Îëò Îã§)ÏóêÏÑú ÌÇ§ÏõåÎìú Ìà¥ÌåÅ ÏûëÎèô
function bindKwTooltipHover(rootEl){
  if(!rootEl) return;

  rootEl.addEventListener("mousemove", (e) => {
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;

    const kwEl = t.closest(".pvKW");
    if(!kwEl) { hideKwTip(); return; }

    const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
    const stateHint = kwEl.getAttribute("data-state") || "";
    showKwTipFor(name, stateHint, e.clientX, e.clientY);
  });

  rootEl.addEventListener("mouseout", (e) => {
    const from = e.target;
    if(!(from instanceof HTMLElement)) return;

    const fromKw = from.closest(".pvKW");
    if(!fromKw) return;

    const to = e.relatedTarget;
    if(to instanceof HTMLElement && to.closest(".pvKW")) return;

    hideKwTip();
  });

  rootEl.addEventListener("mouseleave", hideKwTip);
}

// Í∏∞Ï°¥ Îã®Ïùº Î™©Î°ù + Î∂ÑÎ¶¨ Î™©Î°ù Îëò Îã§ Ïª§Î≤Ñ
bindKwTooltipHover(skList);
bindKwTooltipHover(skListNormal);
bindKwTooltipHover(skListSpecial);

bindKwTooltipHover(document.getElementById("myKeywordsMini"));
bindKwTooltipHover(document.getElementById("enemyKeywordsMini"));

pvLoadStore();
pvClearEditor();
pvRenderBoard();

function ensureKwTooltipBound(el){
  if(!el) return;
  if(el.dataset.kwTipBound === "1") return;
  if(typeof bindKwTooltipHover === "function"){
    bindKwTooltipHover(el);
    el.dataset.kwTipBound = "1";
  }
}

function toRoman(num){
  const romanMap = [
    { value: 1000, numeral: "M" },
    { value: 900, numeral: "CM" },
    { value: 500, numeral: "D" },
    { value: 400, numeral: "CD" },
    { value: 100, numeral: "C" },
    { value: 90, numeral: "XC" },
    { value: 50, numeral: "L" },
    { value: 40, numeral: "XL" },
    { value: 10, numeral: "X" },
    { value: 9, numeral: "IX" },
    { value: 5, numeral: "V" },
    { value: 4, numeral: "IV" },
    { value: 1, numeral: "I" }
  ];

  let result = "";
  let n = Math.floor(Number(num) || 0);
  if(n <= 0) return "";

  for(const item of romanMap){
    while(n >= item.value){
      result += item.numeral;
      n -= item.value;
    }
  }
  return result;
}

// ===== SKILL =====
const skToast = document.getElementById("skToast");
const skName = document.getElementById("skName");
const skAtkType = document.getElementById("skAtkType");
const skSin = document.getElementById("skSin");
const skTier = document.getElementById("skTier");
const skAtkLevel = document.getElementById("skAtkLevel");
const skGrowth   = document.getElementById("skGrowth");
const skActionTypeBtn = document.getElementById("skSkillTypeBtn");
const skLevelLabel = document.getElementById("skLevelLabel");
const skPrevGrowthBase = document.getElementById("skPrevGrowthBase"); // Í≥µÍ≤©Î†àÎ≤® ÌëúÏãú
const skPrevGrowthPlus = document.getElementById("skPrevGrowthPlus"); // ÏÑ±Ïû•Í≥ÑÏàò ÌëúÏãú
const skPrevGrowthSign = document.getElementById("skPrevGrowthSign");
const skPower = document.getElementById("skPower");
const skCoinPower = document.getElementById("skCoinPower");
const skCoinSignBtn = document.getElementById("skCoinSignBtn");
const skWeight = document.getElementById("skWeight");
const skText = document.getElementById("skText");

const skKindToggle = document.getElementById("skKindToggle");
const skSpawnWrap = document.getElementById("skSpawnWrap");
const skillSpawnChance = document.getElementById("skillSpawnChance");

let skCurrentKind = "normal"; // "normal" | "special"

const selectedKindBtn = document.querySelector("#skKindToggle .skKindBtn.active");
const skillKind = selectedKindBtn?.dataset.kind === "special" ? "special" : "normal";

const spawnChanceInput = document.getElementById("skillSpawnChance");
const spawnChance = Math.max(0, Math.min(100, Number(spawnChanceInput?.value || 100)));

const skKeywordBtn = document.getElementById("skKeywordBtn");
skKeywordBtn?.addEventListener("click", () => openKwModalFor(skText));
const skHighlightBtn = document.getElementById("skHighlightBtn");
const skSaveBtn = document.getElementById("skSaveBtn");
const skDeleteBtn = document.getElementById("skDeleteBtn");
const skNewBtn = document.getElementById("skNewBtn");

const skImgFile = document.getElementById("skImgFile");
const skImgClear = document.getElementById("skImgClear");
const skImgEl = document.getElementById("skImgEl");
const skImgPh = document.getElementById("skImgPh");
const skAtkIcon = document.getElementById("skAtkIcon");
const skSinIcon = document.getElementById("skSinIcon");
const skFrameImg = document.getElementById("skFrameImg");
const skInnerImg = document.getElementById("skInnerImg");
const skTitleTxt = document.getElementById("skTitleTxt");
const skTitleBar = document.getElementById("skTitleBar");

const skPrevAtkIcon = document.getElementById("skPrevAtkIcon");
const skPrevSinIcon = document.getElementById("skPrevSinIcon");
const skPrevAtk = document.getElementById("skPrevAtk");
const skPrevSin = document.getElementById("skPrevSin");

const skPrevPow = document.getElementById("skPrevPow");
const skPrevCoin = document.getElementById("skPrevCoin");
const skPrevW = document.getElementById("skPrevW");
const skCoinType = document.getElementById("skCoinType");
const skCoinCount = document.getElementById("skCoinCount");
const skCoinRow = document.getElementById("skCoinRow");
const skEffectBox = document.getElementById("skEffectBox");

const skGreenBtn = document.getElementById("skGreenBtn");
const skBlueBtn  = document.getElementById("skBlueBtn");
const skRedBtn   = document.getElementById("skRedBtn");

const skCoinEffectBtn = document.getElementById("skCoinEffectBtn");

/** @type {{id:string,name:string,atkType:'slash'|'pierce'|'blunt',sin:string,tier:number,atkLevel:number,growth:number,qty:number,power:number,coinSign:'+'|'-',coinPower:number,weight:number,text:string,imgKey:string,coinType?:string,coinCount?:number}[]} */
let skills = [];
let activeSkId = null;
let skPendingImgDataURL = "";

function skUid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function setSkillKind(kind){
  skCurrentKind = (kind === "special") ? "special" : "normal";

  // Î≤ÑÌäº active ÌëúÏãú
  document.querySelectorAll(".skKindBtn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.kind === skCurrentKind);
  });

  // ÏùºÎ∞ò Ïä§ÌÇ¨Ïùº ÎïåÎßå Îì±Ïû• ÌôïÎ•† ÌôúÏÑ±Ìôî
  const isNormal = skCurrentKind === "normal";
  if(skSpawnWrap){
    skSpawnWrap.classList.toggle("disabled", !isNormal);
  }
  if(skillSpawnChance){
    skillSpawnChance.disabled = !isNormal;
    if(!isNormal){
      // ÌäπÏàòÏä§ÌÇ¨Ïù¥Î©¥ ÏÇ¨Ïã§ÏÉÅ ÏùòÎØ∏ ÏóÜÏùå (ÌëúÏãúÎßå Ïú†ÏßÄÌï¥ÎèÑ ÎêòÍ≥† 100ÏúºÎ°ú Í≥†Ï†ïÌï¥ÎèÑ Îê®)
      // skillSpawnChance.value = "100";
    }
  }
}

function clampSkillSpawn(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return 100;
  return Math.max(0, Math.min(100, Math.round(n)));
}

function skSaveStore(){
  try{
    // ‚úÖ localStorageÏóêÎäî "Í∞ÄÎ≤ºÏö¥ Îç∞Ïù¥ÌÑ∞Îßå" Ï†ÄÏû•ÌïúÎã§ (Ïù¥ÎØ∏ÏßÄÎäî imgKeyÎßå)
    const compact = skills.map(s => ({
      id: s.id,
      name: s.name || "",
      atkType: s.atkType || "pierce",
      sin: s.sin || "pride",
      tier: Number(s.tier || 1),
      power: Number(s.power || 0),
      coinSign: (s.coinSign === "-") ? "-" : "+",
      coinPower: Number(s.coinPower || 0),
      atkLevel: Number(s.atkLevel || 0),
      growth: Number(s.growth || 0),
      weight: Number(s.weight || 0),
kind: (s.kind === "special") ? "special" : "normal",
actionType: (s.actionType === "defense") ? "defense" : "attack",
spawnChance: clampSkillSpawn(s.spawnChance ?? 100),
      coinType: s.coinType || "normal",
      coinCount: Number(s.coinCount || 1),
      text: s.text || "",
      imgKey: s.imgKey || "" // ‚úÖ ÌÇ§Îßå!
    }));

    const raw = JSON.stringify(compact);
    localStorage.setItem(KEY_SK, raw);

    const ok = localStorage.getItem(KEY_SK);
    if(ok !== raw) throw new Error("localStorage write verify failed");

    return true;
  }catch(e){
    console.error("SK Ï†ÄÏû• Ïã§Ìå®:", e);
    const isQuota =
      String(e?.name || "").includes("Quota") ||
      String(e || "").includes("Quota") ||
      String(e || "").includes("QUOTA");

    const msg = isQuota
      ? "Ïä§ÌÇ¨ Ï†ÄÏû• Ïã§Ìå®: Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû•Í≥µÍ∞Ñ(localStorage)Ïù¥ ÍΩâ Ï∞ºÏñ¥. (ÌÅ∞ Î¨∏ÏûêÏó¥Ïù¥ ÏÑûÏòÄÏùÑ Í∞ÄÎä•ÏÑ± ÎÜíÏùå)"
      : "Ïä§ÌÇ¨ Ï†ÄÏû• Ïã§Ìå®: Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ï†ÄÏû•ÏùÑ ÎßâÏïòÍ±∞ÎÇò(ÏãúÌÅ¨Î¶ø/Í∂åÌïú), ÏΩîÎìú ÏóêÎü¨Í∞Ä ÏûàÏñ¥.";

    try{ toast(skToast, msg); }catch(_){}
    return false;
  }
}

function skLoadStore(){
  try{
    const raw = localStorage.getItem(KEY_SK);
    if(!raw){
      skills = [];
      return;
    }
    const saved = JSON.parse(raw);
    skills = Array.isArray(saved) ? saved : [];
  }catch(e){
    console.error("SK Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", e);
    skills = [];
    try{ toast(skToast, "Ïä§ÌÇ¨ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Í∞Ä Íπ®Ï°åÍ±∞ÎÇò JSON ÌååÏã± Ïò§Î•òÏïº."); }catch(_){}
  }
}

function setSkImgPreview(src){
  if(!src){
    skImgEl.style.display = "none";
    skImgEl.src = "";
    skImgPh.style.display = "block";
    return;
  }
  skImgEl.src = src;
  skImgEl.style.display = "block";
  skImgPh.style.display = "none";
}

// ===== Ïä§ÌÇ¨ Ïú†Ìòï(Í≥µÍ≤©/Î∞©Ïñ¥) =====
const SK_ACTION_TYPES = {
  attack: [
    { value: "slash",  label: "Ï∞∏Í≤©" },
    { value: "pierce", label: "Í¥ÄÌÜµ" },
    { value: "blunt",  label: "ÌÉÄÍ≤©" },
  ],
  defense: [
    { value: "counter",        label: "Î∞òÍ≤©" },
    { value: "guard",          label: "ÏàòÎπÑ" },
    { value: "evade",          label: "ÌöåÌîº" },
    { value: "clash_counter",  label: "Ìï©Í∞ÄÎä• Î∞òÍ≤©" },
    { value: "clash_guard",    label: "Ìï©Í∞ÄÎä• ÏàòÎπÑ" },
  ]
};

let skActionType = "attack"; // "attack" | "defense"

function isDefenseLevelType(atkType){
  // ÏàòÎπÑ / ÌöåÌîº / Ìï©Í∞ÄÎä• ÏàòÎπÑ => Î∞©Ïñ¥ Î†àÎ≤® ÏÇ¨Ïö©
  return atkType === "guard" || atkType === "evade" || atkType === "clash_guard";
}

function setSkActionType(nextType, keepValue = true){
  skActionType = (nextType === "defense") ? "defense" : "attack";

  // Î≤ÑÌäº ÌÖçÏä§Ìä∏/ÏÉÅÌÉú
  if(skActionTypeBtn){
    skActionTypeBtn.dataset.action = skActionType;
    skActionTypeBtn.textContent = (skActionType === "defense") ? "Î∞©Ïñ¥ Ïä§ÌÇ¨" : "Í≥µÍ≤© Ïä§ÌÇ¨";
    skActionTypeBtn.classList.toggle("neg", skActionType === "defense");
    skActionTypeBtn.classList.toggle("pos", skActionType !== "defense");
  }

  // Í≥µÍ≤©Ïú†Ìòï select ÏòµÏÖò Ïû¨Íµ¨ÏÑ±
  const prev = keepValue ? (skAtkType?.value || "") : "";
  const opts = SK_ACTION_TYPES[skActionType];

  if(skAtkType){
    skAtkType.innerHTML = "";
    for(const o of opts){
      const op = document.createElement("option");
      op.value = o.value;
      op.textContent = o.label;
      skAtkType.appendChild(op);
    }

    const hasPrev = opts.some(o => o.value === prev);
    skAtkType.value = hasPrev ? prev : opts[0].value;
  }

  // Î†àÎ≤® ÎùºÎ≤® Í∞±Ïã† (Í≥µÍ≤©/Î∞©Ïñ¥ Î†àÎ≤®)
  const useDefLv = isDefenseLevelType(skAtkType?.value);
  if(skLevelLabel){
    skLevelLabel.textContent = useDefLv ? "Î∞©Ïñ¥ Î†àÎ≤®" : "Í≥µÍ≤© Î†àÎ≤®";
  }

  // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¶âÏãú Î∞òÏòÅ
  renderSkillPreview();
}

function refreshSkLevelLabelOnly(){
  const useDefLv = isDefenseLevelType(skAtkType?.value);
  if(skLevelLabel){
    skLevelLabel.textContent = useDefLv ? "Î∞©Ïñ¥ Î†àÎ≤®" : "Í≥µÍ≤© Î†àÎ≤®";
  }
}

function atkLabel(v){
  const map = {
    slash: "Ï∞∏Í≤©",
    pierce: "Í¥ÄÌÜµ",
    blunt: "ÌÉÄÍ≤©",
    counter: "Î∞òÍ≤©",
    guard: "ÏàòÎπÑ",
    evade: "ÌöåÌîº",
    clash_counter: "Ìï©Í∞ÄÎä• Î∞òÍ≤©",
    clash_guard: "Ìï©Í∞ÄÎä• ÏàòÎπÑ",
  };
  return map[String(v)] || "Í≥µÍ≤©";
}
function sinLabel(v){
  const map = {
    wrath:"Î∂ÑÎÖ∏", lust:"ÏÉâÏöï", sloth:"ÎÇòÌÉú", gluttony:"ÌÉêÏãù",
    melancholy:"Ïö∞Ïö∏", pride:"Ïò§Îßå", envy:"ÏßàÌà¨"
  };
  return map[v] || v;
}

/** ‚úÖ ÌîÑÎ†àÏûÑ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú */
function framePath(sin, tier){
  const t = Math.min(3, Math.max(1, Number(tier)||1));
  const s = String(sin || "wrath").trim();
  return `assets/frame_${s}_${t}.png`;
}

function coinIconPath(type){
  const map = {
    normal: "assets/icon_coin_normal.png",
    fixed: "assets/icon_coin_fixed.png",
    extract: "assets/icon_coin_extract.png",
    annihilate: "assets/icon_coin_annihilate.png"
  };
  return map[type] || "";
}

function coinIconPath(type){
  const map = {
    normal: "assets/icon_coin_normal.png",
    fixed: "assets/icon_coin_fixed.png",
    extract: "assets/icon_coin_extract.png",
    annihilate: "assets/icon_coin_annihilate.png"
  };
  return map[type] || "";
}

function sinIconPath(sin){
  const map = {
    wrath:"assets/icon_wrath.png",
    lust:"assets/icon_lust.png",
    sloth:"assets/icon_sloth.png",
    gluttony:"assets/icon_gluttony.png",
    melancholy:"assets/icon_gloom.png",
    pride:"assets/icon_pride.png",
    envy:"assets/icon_envy.png",
  };
  return map[String(sin)] || "";
}

function levelIconPath(useDefense){
  return useDefense ? "assets/icon_deflv.png" : "assets/icon_growth.png";
}

function atkIconPath(atk){
  const map = {
    // Í≥µÍ≤© Ïä§ÌÇ¨
    slash: "assets/icon_slash.png",
    pierce: "assets/icon_pierce.png",
    blunt: "assets/icon_blunt.png",

    // Î∞©Ïñ¥ Ïä§ÌÇ¨ (ÏïÑÏù¥ÏΩò ÌååÏùºÎ™ÖÏùÄ ÎÑ§ asset Ïù¥Î¶ÑÏóê ÎßûÍ≤å ÏàòÏ†ï Í∞ÄÎä•)
    counter: "assets/icon_counter.png",
    guard: "assets/icon_guard.png",
    evade: "assets/icon_evade.png",
    clash_counter: "assets/icon_counter_clash.png",
    clash_guard: "assets/icon_guard_clash.png",
  };
  return map[String(atk)] || "";
}
function sinIconPath(sin){
  const map = {
    wrath:"assets/icon_wrath.png",
    lust:"assets/icon_lust.png",
    sloth:"assets/icon_sloth.png",
    gluttony:"assets/icon_gluttony.png",
    melancholy:"assets/icon_gloom.png",
    pride:"assets/icon_pride.png",
    envy:"assets/icon_envy.png",
  };
  return map[String(sin)] || "";
}

/** ‚úÖ ÌÉÄÏù¥ÌãÄÎ∞î(6Î≤à)ÎèÑ Ï£ÑÏïÖÏóê ÎßûÏ∂∞ ÌÜ§Îßå ÏÇ¥Ïßù Î≥ÄÍ≤Ω (ÏõêÌïòÎ©¥ ÎÇòÏ§ëÏóê Îçî ÎîîÌÖåÏùºÌïòÍ≤å Í∞ÄÎä•) */
function applyTitleToneBySin(sin){
  const tone = {
    wrath:      { a:"rgba(255,60,60,.42)",  b:"rgba(90,10,10,.18)" },   // Îπ®Í∞ï
    lust:       { a:"rgba(255,140,40,.42)", b:"rgba(90,40,10,.18)" },   // Ï£ºÌô©
    sloth:      { a:"rgba(255,220,60,.40)", b:"rgba(90,70,10,.16)" },   // ÎÖ∏Îûë
    gluttony:   { a:"rgba(60,220,120,.34)", b:"rgba(10,70,30,.16)" },   // Ï¥àÎ°ù
    melancholy: { a:"rgba(120,210,255,.34)", b:"rgba(10,40,70,.16)" },  // Ïó∞ÌååÎûë
    pride:      { a:"rgba(60,120,255,.34)", b:"rgba(10,20,70,.16)" },   // ÎÇ®ÏÉâ
    envy:       { a:"rgba(170,90,255,.34)", b:"rgba(50,10,70,.16)" },   // Î≥¥Îùº
  }[String(sin)] || { a:"rgba(202,166,106,.22)", b:"rgba(0,0,0,.12)" };

  skTitleBar.style.background = `linear-gradient(180deg, ${tone.a}, ${tone.b})`;
  skTitleBar.style.borderColor = "rgba(255,255,255,.12)";
}

function escHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* ‚úÖ (A) Ïù∏ÎùºÏù∏ ÌÜ†ÌÅ∞ Ï†ÅÏö©: "Ïù¥ÎØ∏ escapeÎêú Î¨∏ÏûêÏó¥"ÏùÑ ÎåÄÏÉÅÏúºÎ°úÎßå Ï≤òÎ¶¨ */
function applyInlineTokensEscaped(escText){
  return String(escText || "")
    .replaceAll("[[g]]",  '<span class="fxGreen">').replaceAll("[[/g]]","</span>")
    .replaceAll("[[b]]",  '<span class="fxBlue">').replaceAll("[[/b]]","</span>")
    .replaceAll("[[r]]",  '<span class="fxRed">').replaceAll("[[/r]]","</span>")
    .replaceAll("[[hl]]", '<span class="pvHL">').replaceAll("[[/hl]]","</span>")
    .replaceAll(/\[\[kw:(buff|debuff):([^\]]+)\]\]/g, (m, st, name) => {
      const cls = (st === "debuff") ? "debuff" : "buff";
      const safeName = String(name).replaceAll('"', "&quot;");
      return `<span class="pvKW ${cls}" data-kw="${safeName}" data-state="${st}">${name}</span>`;
    });
}

/* ‚úÖ Ï§Ñ Îã®ÏúÑ Î†åÎçî: [[coin:n]]Ïù¥ Ï§Ñ Îß® ÏïûÏù¥Î©¥ ÏôºÏ™Ω Ïπ∏Ïóê ÏΩîÏù∏ Î±ÉÏßÄÎ°ú Î∂ÑÎ¶¨ */
function skToHtml(text){
  const lines = String(text || "").split("\n");

  const out = lines.map((rawLine) => {
    let line = String(rawLine || "").replace(/^\s+/, ""); // ÏïûÍ≥µÎ∞± Ï†úÍ±∞

    // 1) Îß® Ïïû coin ÌÜ†ÌÅ∞Îßå leadÎ°ú Î∂ÑÎ¶¨
    let leadHtml = "";
    const m = line.match(/^\[\[coin:(\d+)\]\]\s*/);
    if(m){
      const n = Number(m[1] || 0);
      const rn = toRoman(n);
      leadHtml = `
        <span class="coinEffIcon" style="width:22px;height:22px;flex:0 0 22px;position:relative;display:block;">
          <img src="assets/icon_coin_effect_frame.png" alt="coin" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;">
          <span class="coinEffRoman" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:1000;color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.70);line-height:1;">
            ${escHtml(rn)}
          </span>
        </span>
      `.trim();
      line = line.slice(m[0].length);
    }

    // 2) Î≥∏Î¨∏: Î®ºÏ†Ä escape ‚Üí ÌÜ†ÌÅ∞Ï≤òÎ¶¨ ‚Üí (ÎÇ®ÏùÄ) [[coin:n]] Ïù∏ÎùºÏù∏ ÏïÑÏù¥ÏΩò Î≥ÄÌôò
    let body = escHtml(line);
    body = applyInlineTokensEscaped(body);

    body = body.replace(/\[\[coin:(\d+)\]\]/g, (mm, nn) => {
      const rn = toRoman(Number(nn));
      return `<span class="coinEff" style="display:inline-flex;align-items:center;gap:4px;vertical-align:middle;margin:0 2px;">
        <span class="coinEffIcon" style="position:relative;width:22px;height:22px;flex:0 0 22px;display:block;">
          <img src="assets/icon_coin_effect_frame.png" alt="coin" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;">
          <span class="coinEffRoman" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:1000;color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.70);line-height:1;">
            ${escHtml(rn)}
          </span>
        </span>
      </span>`;
    });

    if(!body.trim()) body = "&nbsp;";

    return `
      <div class="skLine">
        <div class="skLead">${leadHtml}</div>
        <div class="skBody">${body}</div>
      </div>
    `.trim();
  }).join("");

  return `<div class="skLines">${out}</div>`;
}

function snapshotCurrentWorkspace(){
  // ‚úÖ Ìå®ÏãúÎ∏å Ìé∏Ïßë Ï§ëÏù∏ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Î®ºÏ†Ä Í∞ïÏ†ú Î∞òÏòÅ
  try{
    if(typeof forceSavePassivesIfEditing === "function"){
      forceSavePassivesIfEditing();
    }else{
      // ÌòπÏãú Ìï®ÏàòÍ∞Ä ÏóÜÎçîÎùºÎèÑ ÌòÑÏû¨ passives Î∞∞Ïó¥ÏùÄ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•
      if(activePvId){
        const idx = passives.findIndex(x => x.id === activePvId);
        if(idx >= 0){
          passives[idx] = {
            ...passives[idx],
            name: pvName?.value || "",
            text: pvText?.value || "",
            style: activePvStyle || "brown"
          };
          pvSaveStore();
        }
      }
    }
  }catch(e){
    console.error("Ìå®ÏãúÎ∏å Í∞ïÏ†úÎ∞òÏòÅ Ïã§Ìå®:", e);
  }

  // core
  let core = null;
  try{ core = JSON.parse(localStorage.getItem(KEY_CORE) || "null"); }catch(e){ core = null; }

  // ‚úÖ passivesÎäî localStorage Ïû¨Ï°∞ÌöåÎ≥¥Îã§ ÌòÑÏû¨ Î©îÎ™®Î¶¨Í∞íÏùÑ Ïö∞ÏÑ† ÏÇ¨Ïö©
  let pass = [];
  try{
    pass = Array.isArray(passives) ? JSON.parse(JSON.stringify(passives)) : [];
  }catch(e){
    pass = [];
  }

  // skills
  let sk = [];
  try{ sk = JSON.parse(localStorage.getItem(KEY_SK) || "[]"); }catch(e){ sk = []; }

  // dedicated keywords
  let dk = [];
  try{ dk = JSON.parse(localStorage.getItem(KEY_DK) || "[]"); }catch(e){ dk = []; }

  return {
    version: 1,
    savedAt: nowISO(),
    name: (core?.name || "").trim() || "Ïù¥Î¶ÑÏóÜÎäî Ï∫êÎ¶≠ÌÑ∞",
    core: core,
    passives: pass,
    skills: sk,
    dedicatedKeywords: dk,
  };
}

async function restoreWorkspaceFromChar(charData){
  if(!charData) return;

  // localStorageÏóê Í∑∏ÎåÄÎ°ú ÍΩÇÏïÑÏ£ºÍ≥†,
  localStorage.setItem(KEY_CORE, JSON.stringify(charData.core || null));
  localStorage.setItem(KEY_PV, JSON.stringify(charData.passives || []));
  localStorage.setItem(KEY_SK, JSON.stringify(charData.skills || []));
  localStorage.setItem(KEY_DK, JSON.stringify(charData.dedicatedKeywords || []));

  // ÌôîÎ©¥ Í∞±Ïã†: Í∞Å ÌååÌä∏Í∞Ä Ïù¥ÎØ∏ "load" IIFEÎ•º Í∞ÄÏßÄÍ≥† ÏûàÏúºÎãà
  // Í∞ÄÏû• ÏïàÏ†ÑÌïú Î∞©Î≤ïÏùÄ Í∑∏ÎÉ• ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ÏßÄÎßå,
  // ÏßÄÍ∏à Íµ¨Ï°∞ÏóêÏÑúÎèÑ ÏµúÏÜå ÎèôÏûëÌïòÍ≤å ÌïòÎ†§Î©¥ ÏïÑÎûòÏ≤òÎüº Ï£ºÏöî Î†åÎçî Ïû¨Ìò∏Ï∂ú:
  try{
    // coreÎäî IIFEÍ∞Ä ÏûàÏúºÎãà Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®Ìûà ÏÉàÎ°úÍ≥†Ïπ® Ï∂îÏ≤ú.
    // Í∑∏ÎûòÎèÑ Ï¶âÏãú Î∞òÏòÅÏù¥ ÌïÑÏöîÌïòÎ©¥ location.reload()Í∞Ä Ï†úÏùº ÏïàÏ†Ñ.
    location.reload();
  }catch(e){}
}

/** ‚úÖ ÎØ∏Î¶¨Î≥¥Í∏∞ Í∞±Ïã† */
async function renderSkillPreview(){
  const nm = String(skName.value || "").trim() || "Ïä§ÌÇ¨";
  const atk = skAtkType.value;
  const sin = skSin.value;
  const tier = Number(skTier.value || 1);
  const pow = Number(skPower.value || 0);
  const coinP = Number(skCoinPower.value || 0);
  const sign = (skCoinSignBtn.dataset.sign === "-") ? "-" : "+";
  const atkLv = Number(skAtkLevel?.value || 0);
  const growth = Number(skGrowth?.value || 0);
  const w = Number(skWeight.value || 0);
  const txt = skText.value || "";
if(skAtkIcon) skAtkIcon.src = atkIconPath(atk);
if(skSinIcon) skSinIcon.src = sinIconPath(sin);
  skTitleTxt.textContent = nm;
  skPrevAtk.textContent = atkLabel(atk);
  skPrevSin.textContent = sinLabel(sin);

if(skPrevAtkIcon){
  skPrevAtkIcon.src = atkIconPath(atk);
  skPrevAtkIcon.alt = atkLabel(atk);
}
if(skPrevSinIcon){
  skPrevSinIcon.src = sinIconPath(sin);
  skPrevSinIcon.alt = sinLabel(sin);
}
  skPrevPow.textContent = String(Number.isFinite(pow) ? pow : 0);
  skPrevCoin.textContent = `${sign}${Number.isFinite(coinP) ? Math.abs(coinP) : 0}`;
  skPrevW.textContent = String(Number.isFinite(w) ? w : 0);

// ‚úÖ Í≥µÍ≤©Î†àÎ≤® / Î∞©Ïñ¥Î†àÎ≤® ÌëúÏãú + ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω
if(skPrevGrowthBase) skPrevGrowthBase.textContent = String(Number.isFinite(atkLv) ? atkLv : 0);
if(skPrevGrowthPlus) skPrevGrowthPlus.textContent = String(Number.isFinite(growth) ? Math.abs(growth) : 0);
if(skPrevGrowthSign) skPrevGrowthSign.textContent = (growth < 0) ? "-" : "+";

// ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í≥µÍ≤©Ïú†Ìòï Í∏∞Ï§ÄÏúºÎ°ú "Î∞©Ïñ¥ Î†àÎ≤®" Í≥ÑÏó¥Ïù∏ÏßÄ ÌåêÏ†ï
const isDefLevelType = ["guard", "evade", "guardclash"].includes(String(atk));

// ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÑ±Ïû•Ï§Ñ ÏöîÏÜåÎì§ (ÎÑ§ ÌååÏùº Íµ¨Ï°∞ Í∏∞Ï§Ä: class ÏÇ¨Ïö©)
const prevGrowthIconEl = document.querySelector("#skPreviewCard .skGrowthIcon");
const prevGrowthLabelEl = document.querySelector("#skPreviewCard .skGrowthLabel");

if(prevGrowthLabelEl){
  prevGrowthLabelEl.textContent = isDefLevelType ? "Î∞©Ïñ¥Î†àÎ≤®" : "ÏÑ±Ïû•Í≥ÑÏàò";
}

if(prevGrowthIconEl){
  // ÌååÏùºÎ™ÖÏùÄ ÎÑ§Í∞Ä ÎßåÎì† Ïã§Ï†ú ÌååÏùºÎ™Ö Í∏∞Ï§ÄÏúºÎ°ú ÎßûÏ∂∞Ï§ò
  // (ÏòàÏãú) assets/icon_attack_level.png / assets/icon_defense_level.png
  prevGrowthIconEl.src = isDefLevelType
    ? "assets/icon_defense_level.png"
    : "assets/icon_growth.png";
  prevGrowthIconEl.alt = isDefLevelType ? "Î∞©Ïñ¥Î†àÎ≤®" : "ÏÑ±Ïû•Í≥ÑÏàò";
}

// ÏΩîÏù∏ ÏïÑÏù¥ÏΩò Î†åÎçî
if(skCoinRow){
  skCoinRow.innerHTML = "";

  const count = skCoinCount ? Number(skCoinCount.value || 1) : 1;
  const type  = skCoinType  ? skCoinType.value : "normal";

  for(let i=0;i<count;i++){
    const img = document.createElement("img");
    img.src = coinIconPath(type);
    img.className = "skCoinIcon";
    skCoinRow.appendChild(img);
  }
}

// Ìö®Í≥º Î†åÎçî(ÌÇ§ÏõåÎìú span Ìè¨Ìï®)
if(skEffectBox){
  skEffectBox.innerHTML = skToHtml(txt);
}

  // ÌîÑÎ†àÏûÑ
  skFrameImg.src = framePath(sin, tier);
  applyTitleToneBySin(sin);

  // ÎÇ¥Î∂Ä Ïù¥ÎØ∏ÏßÄ: (1) pending (2) Ï†ÄÏû•Îêú active skill imgKey
  if(skPendingImgDataURL && skPendingImgDataURL.startsWith("data:image/")){
    skInnerImg.src = skPendingImgDataURL;
    skInnerImg.style.display = "block";
  }else{
    skInnerImg.src = "";
    skInnerImg.style.display = "none";

    // activeSkIdÍ∞Ä ÏûàÍ≥† imgKeyÍ∞Ä ÏûàÏúºÎ©¥ IndexedDBÏóêÏÑú Î°úÎìú
    const it = skills.find(x => x.id === activeSkId);
    const key = it?.imgKey || "";
    if(key){
      try{
        const blob = await idbGetBlob(key);
        if(blob){
          skInnerImg.src = makeObjectURLFromBlob(blob);
          skInnerImg.style.display = "block";
        }
      }catch(e){}
    }
  }
}

// ÌéºÏπ® ÏÉÅÌÉú Í∏∞ÏñµÏö©
const _skOpenMap = new Map(); // skillId -> boolean

function setOpen(id, v){ _skOpenMap.set(id, !!v); }
function isOpen(id){ return !!_skOpenMap.get(id); }

/** ‚úÖ Î¶¨Ïä§Ìä∏ Î†åÎçî (Ïä§ÌÇ¨ Î™©Î°ù Ïπ¥Îìú) */
async function renderSkillList(){
  // ‚úÖ Î∂ÑÎ¶¨ Î¶¨Ïä§Ìä∏ Ïö∞ÏÑ† ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ skListÎ°ú Ìè¥Î∞±)
  const useSplit = !!(skListNormal && skListSpecial);

  // Ï¥àÍ∏∞Ìôî
  if(useSplit){
    skListNormal.innerHTML = "";
    skListSpecial.innerHTML = "";
  }else{
    if(!skList) return;
    skList.innerHTML = "";
  }

  // Îπà Î™©Î°ù Ï≤òÎ¶¨
  if(skills.length === 0){
    const makeEmpty = () => {
      const d = document.createElement("div");
      d.style.color = "rgba(238,241,255,.55)";
      d.style.fontSize = "13px";
      d.style.padding = "8px";
      d.textContent = "ÏïÑÏßÅ Ï†ÄÏû•Îêú Ïä§ÌÇ¨Ïù¥ ÏóÜÏñ¥. ÏúÑÏóêÏÑú ÎßåÎì§Í≥† Ï†ÄÏû•Ìï¥Ï§ò.";
      return d;
    };

    if(useSplit){
      skListNormal.appendChild(makeEmpty());
      skListSpecial.appendChild(makeEmpty());
    }else{
      skList.appendChild(makeEmpty());
    }
    return;
  }

  // Í∞Å Î™©Î°ù ÎπÑÏóàÏùÑ Îïå ÏïàÎÇ¥Î¨∏ ÎÑ£Í∏∞ ÏúÑÌï¥ Ïπ¥Ïö¥Ìä∏
  let normalCount = 0;
  let specialCount = 0;

  for(const s of skills){
    const card = document.createElement("div");
    card.className = "skListCard" + (s.id === activeSkId ? " active" : "");

    // === TOP (ÌÅ¥Î¶≠ÌïòÎ©¥ Ìé∏ÏßëÍ∏∞Ïóê Î°úÎìú) ===
    const top = document.createElement("div");
    top.className = "skListTop";

    // ART (ÌîÑÎ†àÏûÑ+ÎÇ¥Î∂Ä)
    const art = document.createElement("div");
    art.className = "skListArt";

    const frameBox = document.createElement("div");
    frameBox.className = "skListFrame";

    const frame = document.createElement("img");
    frame.alt = "frame";
    frame.src = framePath(s.sin, s.tier);
    frameBox.appendChild(frame);

    const inner = document.createElement("div");
    inner.className = "inner";

    const innerImg = document.createElement("img");
    innerImg.alt = "skill image";
    inner.appendChild(innerImg);
    frameBox.appendChild(inner);

    if(s.imgKey){
      try{
        const blob = await idbGetBlob(s.imgKey);
        innerImg.src = blob ? makeObjectURLFromBlob(blob) : "";
      }catch(e){
        innerImg.src = "";
      }
    }else{
      innerImg.src = "";
    }

    art.appendChild(frameBox);

    // coin icons
    const coinRow = document.createElement("div");
    coinRow.className = "skListCoins";
    const count = Math.max(1, Number(s.coinCount || s.qty || 1));
    const type  = String(s.coinType || "normal");
    for(let i=0;i<count;i++){
      const c = document.createElement("img");
      c.src = coinIconPath(type);
      c.alt = "coin";
      coinRow.appendChild(c);
    }
    art.appendChild(coinRow);

    // MAIN
    const main = document.createElement("div");
    main.className = "skListMain";

    // titlebar tone
    const titleBar = document.createElement("div");
    titleBar.className = "skListTitleBar";
    const tone = {
      wrath:      { a:"rgba(255,60,60,.42)",  b:"rgba(90,10,10,.18)" },
      lust:       { a:"rgba(255,140,40,.42)", b:"rgba(90,40,10,.18)" },
      sloth:      { a:"rgba(255,220,60,.40)", b:"rgba(90,70,10,.16)" },
      gluttony:   { a:"rgba(60,220,120,.34)", b:"rgba(10,70,30,.16)" },
      melancholy: { a:"rgba(120,210,255,.34)", b:"rgba(10,40,70,.16)" },
      pride:      { a:"rgba(60,120,255,.34)", b:"rgba(10,20,70,.16)" },
      envy:       { a:"rgba(170,90,255,.34)", b:"rgba(50,10,70,.16)" },
    }[String(s.sin)] || { a:"rgba(202,166,106,.22)", b:"rgba(0,0,0,.12)" };
    titleBar.style.background = `linear-gradient(180deg, ${tone.a}, ${tone.b})`;

    const title = document.createElement("div");
    title.className = "skListTitle";
    title.textContent = String(s.name || "").trim() || "Ïä§ÌÇ¨";
    titleBar.appendChild(title);

    // stats
    const stat = document.createElement("div");
    stat.className = "skListStat";

    const kindText = (String(s.kind || "normal") === "special") ? "ÌäπÏàò Ïä§ÌÇ¨" : "ÏùºÎ∞ò Ïä§ÌÇ¨";
    const chanceNum = Number(s.spawnChance ?? 100);
    const chanceText = `${Number.isFinite(chanceNum) ? chanceNum : 100}%`;

    const rows = [
      ["ÌñâÎèô Ïú†Ìòï", atkLabel(s.atkType)],
      ["Ï£ÑÏïÖ ÏÜçÏÑ±", sinLabel(s.sin)],
      ["Ïä§ÌÇ¨ ÏúÑÎ†•", String(Number(s.power ?? 0) || 0)],
      ["ÏΩîÏù∏ ÏúÑÎ†•", `${(s.coinSign === "-") ? "-" : "+"}${Math.abs(Number(s.coinPower ?? 0) || 0)}`],
      ["Í≥µÍ≤© Í∞ÄÏ§ëÏπò", String(Number(s.weight ?? 0) || 0)],
      ["Ïä§ÌÇ¨ Ï¢ÖÎ•ò", kindText],       // ‚úÖ Ï∂îÍ∞Ä
      ["Îì±Ïû• ÌôïÎ•†", chanceText],     // ‚úÖ Ï∂îÍ∞Ä
    ];

    for(const [th, td] of rows){
      const r = document.createElement("div");
      r.className = "skListStatRow";

      const thEl = document.createElement("div");
      thEl.className = "skListStatTh";
      thEl.textContent = th;

      const tdEl = document.createElement("div");
      tdEl.className = "skListStatTd";

      if(th === "Í≥µÍ≤© Ïú†Ìòï"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = atkIconPath(s.atkType);
        img.alt = td;
        tdEl.appendChild(img);
      }
      if(th === "Ï£ÑÏïÖ ÏÜçÏÑ±"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = sinIconPath(s.sin);
        img.alt = td;
        tdEl.appendChild(img);
      }

      const sp = document.createElement("span");
      sp.textContent = td;
      tdEl.appendChild(sp);

      r.appendChild(thEl);
      r.appendChild(tdEl);
      stat.appendChild(r);
    }

    main.appendChild(titleBar);

    // Í≥µÍ≤©Î†àÎ≤® / ÏÑ±Ïû•Í≥ÑÏàò Ï§Ñ
    const growthRow = document.createElement("div");
    growthRow.className = "skListGrowthRow";

    const gIcon = document.createElement("img");
    gIcon.className = "skListGrowthIcon";
const useDefLv = isDefenseLevelType(s.atkType);
gIcon.src = levelIconPath(useDefLv);
gIcon.alt = useDefLv ? "Î∞©Ïñ¥ Î†àÎ≤®" : "ÏÑ±Ïû•Í≥ÑÏàò";

    const atkLv = Number(s.atkLevel ?? 0);
    const gr = Number(s.growth ?? 0);
    const sign = (gr < 0) ? "-" : "+";
    const absGr = Math.abs(gr);

    const gText = document.createElement("div");
    gText.className = "skListGrowthText";
gText.innerHTML = `
  <span>${atkLv}</span>
  <span class="skGrowthLabel">${useDefLv ? "Î∞©Ïñ¥Î†àÎ≤®" : "ÏÑ±Ïû•Í≥ÑÏàò"}</span>
  <span class="skGrowthPlus">(${sign} ${absGr})</span>
`;

    growthRow.appendChild(gIcon);
    growthRow.appendChild(gText);

    main.appendChild(growthRow);
    main.appendChild(stat);

    top.appendChild(art);
    top.appendChild(main);

    // top ÌÅ¥Î¶≠ => Ìé∏ÏßëÍ∏∞Ïóê Î°úÎìú
    top.addEventListener("click", async () => {
      await loadSkillToEditor(s.id);
    });

    card.appendChild(top);

    // === ACTION: [ÏΩîÏù∏Î≥Ñ Ìö®Í≥º] ÌÜ†Í∏Ä ===
    const act = document.createElement("div");
    act.className = "skListActions";

    const toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "skListToggle";
    toggle.textContent = "[ ÏΩîÏù∏Î≥Ñ Ìö®Í≥º ]";

    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const now = !isOpen(s.id);
      setOpen(s.id, now);
      body.classList.toggle("open", now);
    });

    act.appendChild(toggle);
    card.appendChild(act);

    const body = document.createElement("div");
    body.className = "skListBody" + (isOpen(s.id) ? " open" : "");

    const eff = document.createElement("div");
    eff.className = "skListEffect";
    eff.innerHTML = skToHtml(s.text || "");
    body.appendChild(eff);

    body.addEventListener("click", (e) => e.stopPropagation());

    card.appendChild(body);

    // ‚úÖ ÏùºÎ∞ò/ÌäπÏàò Î™©Î°ùÏúºÎ°ú Î∂ÑÎ∞∞
    if(useSplit){
      const kind = String(s.kind || "normal");
      if(kind === "special"){
        skListSpecial.appendChild(card);
        specialCount++;
      }else{
        skListNormal.appendChild(card);
        normalCount++;
      }
    }else{
      skList.appendChild(card);
    }
  }

  // ‚úÖ Í∞Å Î∂ÑÎ¶¨ Î™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏúºÎ©¥ ÏïàÎÇ¥Î¨∏ ÌëúÏãú
  if(useSplit){
    if(normalCount === 0){
      const d = document.createElement("div");
      d.style.color = "rgba(238,241,255,.55)";
      d.style.fontSize = "13px";
      d.style.padding = "8px";
      d.textContent = "ÏùºÎ∞ò Ïä§ÌÇ¨Ïù¥ ÏïÑÏßÅ ÏóÜÏñ¥.";
      skListNormal.appendChild(d);
    }
    if(specialCount === 0){
      const d = document.createElement("div");
      d.style.color = "rgba(238,241,255,.55)";
      d.style.fontSize = "13px";
      d.style.padding = "8px";
      d.textContent = "ÌäπÏàò Ïä§ÌÇ¨Ïù¥ ÏïÑÏßÅ ÏóÜÏñ¥.";
      skListSpecial.appendChild(d);
    }
  }
}

skKindToggle?.addEventListener("click", (e) => {
  const btn = e.target.closest(".skKindBtn");
  if(!btn) return;
  setSkillKind(btn.dataset.kind || "normal");
});

/** ‚úÖ Ìé∏ÏßëÍ∏∞ Î°úÎìú */
async function loadSkillToEditor(id){
  const it = skills.find(x => x.id === id);
  if(!it) return;

  activeSkId = it.id;
  skPendingImgDataURL = "";

  skName.value = it.name || "";
  setSkActionType(it.actionType || "attack", false);
skAtkType.value = it.atkType || (skActionType === "defense" ? "counter" : "pierce");
refreshSkLevelLabelOnly();
  skSin.value = it.sin || "pride";
  skTier.value = String(it.tier || 1);
  if(skAtkLevel) skAtkLevel.value = String(it.atkLevel ?? 0);
  if(skGrowth)   skGrowth.value   = String(it.growth ?? 0);
  skPower.value = String(it.power ?? 0);
  skCoinPower.value = String(Math.abs(it.coinPower ?? 0));
  setCoinSign(it.coinSign === "-" ? "-" : "+");
  skWeight.value = String(it.weight ?? 0);
  setSkillKind(it.kind || "normal");
if(skillSpawnChance) skillSpawnChance.value = String(it.spawnChance ?? 100);
  skText.value = it.text || "";

  if(skCoinType)  skCoinType.value  = it.coinType || "normal";
  if(skCoinCount) skCoinCount.value = String(it.coinCount ?? 1);



  // Ïù¥ÎØ∏ÏßÄ ÌîÑÎ¶¨Î∑∞(ÏôºÏ™Ω ÏóÖÎ°úÎìú Î∞ïÏä§)
  setSkImgPreview("");
  if(it.imgKey){
    try{
      const blob = await idbGetBlob(it.imgKey);
      if(blob) setSkImgPreview(makeObjectURLFromBlob(blob));
    }catch(e){}
  }

await renderSkillList();
await renderSkillPreview();
  toast(skToast, "Ïä§ÌÇ¨ Î∂àÎü¨Ïò¥.");
}

setSkActionType("attack", false);


/** ÏÉà Ïä§ÌÇ¨(ÏóêÎîîÌÑ∞ Ï¥àÍ∏∞Ìôî) */
async function newSkill(){
  activeSkId = null;
  skPendingImgDataURL = "";
  skName.value = "";
  setSkActionType("attack", false);
skAtkType.value = "pierce";
refreshSkLevelLabelOnly();
  skSin.value = "pride";
  skTier.value = "1";
  if(skAtkLevel) skAtkLevel.value = "0";
  if(skGrowth)   skGrowth.value   = "0";
  skPower.value = "15";
  skCoinPower.value = "4";
  setCoinSign("+");
  skWeight.value = "1";
  skText.value = "";
  skImgFile.value = "";
  setSkImgPreview("");
await renderSkillList();
await renderSkillPreview();
  toast(skToast, "ÏÉà Ïä§ÌÇ¨ ÏûëÏÑ± Ï§ë.");
  if(skCoinType)  skCoinType.value  = "normal";
  if(skCoinCount) skCoinCount.value = "1";
setSkillKind("normal");
if(skillSpawnChance) skillSpawnChance.value = "100";
}

/** ÏΩîÏù∏ Î∂ÄÌò∏ Î≤ÑÌäº */
function setCoinSign(sign){
  const s = (sign === "-") ? "-" : "+";
  skCoinSignBtn.dataset.sign = s;
  skCoinSignBtn.textContent = s;
  skCoinSignBtn.classList.toggle("neg", s === "-");
  skCoinSignBtn.classList.toggle("pos", s === "+");
}

skCoinSignBtn.addEventListener("click", () => {
  const cur = skCoinSignBtn.dataset.sign || "+";
  setCoinSign(cur === "+" ? "-" : "+");
  renderSkillPreview();
});

skActionTypeBtn?.addEventListener("click", () => {
  const cur = skActionTypeBtn.dataset.action || "attack";
  setSkActionType(cur === "attack" ? "defense" : "attack", false);
});

skAtkType?.addEventListener("change", () => {
  refreshSkLevelLabelOnly();
  renderSkillPreview();
});

/** Ïä§ÌÇ¨ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú -> pending + ÌîÑÎ¶¨Î∑∞. Ï†ÄÏû• ÎàÑÎ•¥Î©¥ IndexedDB Î∞òÏòÅ */
skImgFile.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    skPendingImgDataURL = await compressImageToDataURL(f, {
      maxSize: 512,
      mime: "image/webp",
      quality: 0.88
    });
    setSkImgPreview(skPendingImgDataURL);
    await renderSkillPreview();
    toast(skToast, "Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉùÎê®. 'Ï†ÄÏû•'ÏùÑ ÎàÑÎ•¥Î©¥ ÏòÅÍµ¨ Î∞òÏòÅÎèº.");
  }catch(err){
    console.error(err);
    toast(skToast, "Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ïã§Ìå®(ÌååÏùº/Î∏åÎùºÏö∞Ï†Ä Ï†úÌïú).");
  }
});

skImgClear.addEventListener("click", async () => {
  skImgFile.value = "";
  skPendingImgDataURL = "";
  setSkImgPreview("");

  // ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏûàÏúºÎ©¥ DBÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
  if(activeSkId){
    const idx = skills.findIndex(x => x.id === activeSkId);
    if(idx >= 0){
      const oldKey = skills[idx].imgKey || "";
      if(oldKey){
        try{ await idbDel(oldKey); }catch(e){}
      }
      skills[idx] = { ...skills[idx], imgKey: "" };
      skSaveStore();
      toast(skToast, "Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞ ÏôÑÎ£å!");
    }
  }
  await renderSkillPreview();
});

/** ÏûÖÎ†• Î≥ÄÌôî -> ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¶âÏãú */
[skName, skAtkType, skSin, skTier, skPower, skCoinPower, skWeight, skText, skCoinType, skCoinCount, skAtkLevel, skGrowth].forEach(el => {
  el?.addEventListener("input", renderSkillPreview);
  el?.addEventListener("change", renderSkillPreview);
});

/** ÌÇ§ÏõåÎìú Î≤ÑÌäº: Ïä§ÌÇ¨ textareaÎ•º ÌÉÄÍ≤üÏúºÎ°ú Ïó¥Í∏∞ */
skCoinEffectBtn?.addEventListener("click", () => {
  const input = prompt("Î™á Î≤àÏß∏ ÏΩîÏù∏ Ìö®Í≥ºÎ•º ÎÑ£ÏùÑÍπå? (Ïòà: 1, 2, 3...)");
  if(input === null) return;

  const num = Number(String(input).trim());
  if(!Number.isFinite(num) || num < 1){
    alert("1 Ïù¥ÏÉÅÏùò Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï§ò.");
    return;
  }

  insertAtCursor(skText, `[[coin:${Math.floor(num)}]]`);
  renderSkillPreview();
});

function wrapSelection(textarea, openTag, closeTag){
  const el = textarea;
  const start = el.selectionStart ?? 0;
  const end = el.selectionEnd ?? 0;
  if(start === end) return false;

  const txt = el.value;
  const before = txt.slice(0, start);
  const sel = txt.slice(start, end);
  const after = txt.slice(end);

  el.value = before + openTag + sel + closeTag + after;

  // Ïª§ÏÑúÎäî Í∞êÏãº Îí§ ÎÅùÏúºÎ°ú
  const pos = end + openTag.length + closeTag.length;
  el.focus();
  el.setSelectionRange(pos, pos);
  return true;
}

/** Í∞ïÏ°∞ Î≤ÑÌäº: pv Î∞©Ïãù Ïû¨ÏÇ¨Ïö©(ÌÜ†ÌÅ∞ [[hl]]) */
skHighlightBtn.addEventListener("click", () => {
  const el = skText;
  const start = el.selectionStart ?? 0;
  const end = el.selectionEnd ?? 0;
  if(start === end){
    toast(skToast, "Í∞ïÏ°∞Ìï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Ï§ò.");
    return;
  }
  const txt = el.value;
  el.value = txt.slice(0,start) + "[[hl]]" + txt.slice(start,end) + "[[/hl]]" + txt.slice(end);
  el.focus();
  el.setSelectionRange(end + 10 + 6, end + 10 + 6);
  toast(skToast, "ÏÑ†ÌÉùÌïú Î∂ÄÎ∂ÑÏóê Í∞ïÏ°∞Î•º Ï†ÅÏö©ÌñàÏñ¥.");
  renderSkillPreview();
});

skGreenBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[g]]", "[[/g]]");
  if(!ok){ toast(skToast, "Ìö®Í≥ºÎ•º Ï†ÅÏö©Ìï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Ï§ò."); return; }
  toast(skToast, "ÏÑ†ÌÉùÌïú Î∂ÄÎ∂ÑÏóê ÎÖπÏÉâ Ìö®Í≥ºÎ•º Ï†ÅÏö©ÌñàÏñ¥.");
  renderSkillPreview();
});

skBlueBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[b]]", "[[/b]]");
  if(!ok){ toast(skToast, "Ìö®Í≥ºÎ•º Ï†ÅÏö©Ìï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Ï§ò."); return; }
  toast(skToast, "ÏÑ†ÌÉùÌïú Î∂ÄÎ∂ÑÏóê ÌååÎûÄÏÉâ Ìö®Í≥ºÎ•º Ï†ÅÏö©ÌñàÏñ¥.");
  renderSkillPreview();
});

skRedBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[r]]", "[[/r]]");
  if(!ok){ toast(skToast, "Ìö®Í≥ºÎ•º Ï†ÅÏö©Ìï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Ï§ò."); return; }
  toast(skToast, "ÏÑ†ÌÉùÌïú Î∂ÄÎ∂ÑÏóê Îπ®Í∞ÑÏÉâ Ìö®Í≥ºÎ•º Ï†ÅÏö©ÌñàÏñ¥.");
  renderSkillPreview();
});

/** Ï†ÄÏû• */
skSaveBtn.addEventListener("click", async () => {
  try {
    const before = skills.slice(); // Î°§Î∞±Ïö©

    const payload = {
      id: activeSkId || skUid(),
      name: skName?.value || "",
      atkType: skAtkType?.value || "pierce",
      sin: skSin?.value || "pride",
      tier: Number(skTier?.value || 1),
      power: Number(skPower?.value || 0),
      coinSign: (skCoinSignBtn?.dataset?.sign === "-") ? "-" : "+",
      coinPower: Number(skCoinPower?.value || 0),
      atkLevel: Number(skAtkLevel?.value || 0),
      growth: Number(skGrowth?.value || 0),
      weight: Number(skWeight?.value || 0),
actionType: (skActionType === "defense") ? "defense" : "attack",

      // ‚úÖ ÏµúÏ¢Ö Ï†ÄÏû• ÌïÑÎìú (Ïù¥Î¶Ñ ÌÜµÏùº)
      kind: (skCurrentKind === "special") ? "special" : "normal",
      spawnChance: clampSkillSpawn(skillSpawnChance ? skillSpawnChance.value : 100),

      coinType: (skCoinType?.value || "normal"),
      coinCount: Number(skCoinCount?.value || 1),
      text: skText?.value || "",
      imgKey: ""
    };

    // Í∏∞Ï°¥ Ìï≠Î™©Ïù¥Î©¥ imgKey Ïú†ÏßÄ
    const prev = activeSkId ? skills.find(x => x.id === activeSkId) : null;
    payload.imgKey = prev?.imgKey || "";

    // pending Ïù¥ÎØ∏ÏßÄ ÏûàÏúºÎ©¥ IndexedDB Ï†ÄÏû•
    if (skPendingImgDataURL && skPendingImgDataURL.startsWith("data:image/")) {
      try {
        const blob = dataURLToBlob(skPendingImgDataURL);
        payload.imgKey = `skill_img_${payload.id}`;
        await idbPutBlob(payload.imgKey, blob);
      } catch (e) {
        console.error("Ïä§ÌÇ¨ Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïã§Ìå®:", e);
        toast(skToast, "Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ïã§Ìå®(Î∏åÎùºÏö∞Ï†Ä Ï†úÌïú/ÌòïÏãù Î¨∏Ï†ú).");
        return;
      }
    }

    // skills Î∞∞Ïó¥ Î∞òÏòÅ
    if (activeSkId) {
      const idx = skills.findIndex(x => x.id === activeSkId);
      if (idx >= 0) skills[idx] = payload;
      else skills.unshift(payload);
    } else {
      skills.unshift(payload);
    }

    activeSkId = payload.id;
    skPendingImgDataURL = "";

    // localStorage Ï†ÄÏû•
    if (!skSaveStore()) {
      skills = before;
      try { await renderSkillList(); } catch (_) {}
      try { await renderSkillPreview(); } catch (_) {}
      return;
    }

    // ‚úÖ Ï†ÄÏû• ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏Î•º Î®ºÏ†Ä Î≥¥Ïó¨Ï§å (Î†åÎçî ÏóêÎü¨Í∞Ä ÎÇòÎèÑ ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞± Î≥¥Ïù¥Í≤å)
    toast(skToast, "Ïä§ÌÇ¨ Ï†ÄÏû• ÏôÑÎ£å!");

    // Î†åÎçî
    try {
      await renderSkillList();
    } catch (e) {
      console.error("renderSkillList Ïã§Ìå®:", e);
      toast(skToast, "Ï†ÄÏû•ÏùÄ ÎêêÎäîÎç∞ Î™©Î°ù Í∞±Ïã† Ï§ë ÏóêÎü¨Í∞Ä ÎÇ¨Ïñ¥. ÏΩòÏÜî ÌôïÏù∏ ÌïÑÏöî.");
      return;
    }

    try {
      await renderSkillPreview();
    } catch (e) {
      console.error("renderSkillPreview Ïã§Ìå®:", e);
      // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïã§Ìå®Ìï¥ÎèÑ Ï†ÄÏû•ÏùÄ Îêú ÏÉÅÌÉú
    }

  } catch (e) {
    console.error("Ïä§ÌÇ¨ Ï†ÄÏû• Ìï∏Îì§Îü¨ Ï†ÑÏ≤¥ Ïã§Ìå®:", e);
    try { toast(skToast, `Ï†ÄÏû• Ïã§Ìå®: ${e?.message || e}`); } catch (_) {}
  }
});
/** ÏÇ≠Ï†ú */
skDeleteBtn.addEventListener("click", async () => {
  if(!activeSkId){
    toast(skToast, "ÏÇ≠Ï†úÌï† Ïä§ÌÇ¨ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï§ò.");
    return;
  }
  const idx = skills.findIndex(x => x.id === activeSkId);
  if(idx < 0) return;

  const oldKey = skills[idx].imgKey || "";
  if(oldKey){
    try{ await idbDel(oldKey); }catch(e){}
  }

  skills.splice(idx, 1);
  skSaveStore();
  toast(skToast, "Ïä§ÌÇ¨ ÏÇ≠Ï†ú ÏôÑÎ£å!");
  await newSkill();
});

/** ÏÉà Ïä§ÌÇ¨ */
skNewBtn.addEventListener("click", newSkill);

/** Ï¥àÍ∏∞ Î°úÎìú */
(async () => {
  try{ skLoadStore(); }catch(e){ console.error(e); }
  await renderSkillList();
  await newSkill();
})();

/** ‚úÖ Ïä§ÌÇ¨ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠ÏóêÏÑúÎèÑ ÌÇ§ÏõåÎìú hover Ìà¥ÌåÅ ÏûëÎèôÌïòÍ≤å Ïó∞Í≤∞ */
document.getElementById("skPreviewCard").addEventListener("mousemove", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  const kwEl = t.closest(".pvKW");
  if(!kwEl) { hideKwTip(); return; }

  const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
  const stateHint = kwEl.getAttribute("data-state") || "";
  showKwTipFor(name, stateHint, e.clientX, e.clientY);
});
document.getElementById("skPreviewCard").addEventListener("mouseout", (e) => {
  const from = e.target;
  if(!(from instanceof HTMLElement)) return;

  const fromKw = from.closest(".pvKW");
  if(!fromKw) return;

  const to = e.relatedTarget;
  if(to instanceof HTMLElement && to.closest(".pvKW")) return;

  hideKwTip();
});
document.getElementById("skPreviewCard").addEventListener("mouseleave", hideKwTip);

    // (ÏÑ†ÌÉù) ÌéòÏù¥ÏßÄ Îñ†ÎÇ† Îïå objectURL Ï†ïÎ¶¨
    window.addEventListener("beforeunload", () => {
      if(_portraitObjectURL){
        try{ URL.revokeObjectURL(_portraitObjectURL); }catch(e){}
      }
      for(const [k, u] of _iconObjectURLMap.entries()){
        try{ URL.revokeObjectURL(u); }catch(e){}
      }
      _iconObjectURLMap.clear();
    });

  </script>

<audio id="aiBattleBgm" preload="auto" loop></audio>
</body>
</html>
