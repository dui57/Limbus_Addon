<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ ì• ë“œì˜¨</title>
  <style>
    :root{
      --bg:#050608;
      --bg2:#0b0d10;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);

      --gold:#caa66a;
      --gold2:#f3d39a;

      --text:#eef1ff;
      --muted:rgba(238,241,255,.70);

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;

      --barOrange:#d95a2b;
      --barOrange2:#f07a33;

      --toneRed:#ff4b4b;
      --toneRed2:#ff6868;

      --toneGrayText: rgba(235,240,255,.40);
      --toneGrayBorder: rgba(235,240,255,.28);

      --toneNormalText: rgba(255,255,255,.92);
      --toneNormalBorder: rgba(255,255,255,.14);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(202,166,106,.14), transparent 58%),
        radial-gradient(900px 600px at 85% 25%, rgba(243,211,154,.08), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      display:grid;
      place-items:start center;
      padding: 22px;
    }

    /* âœ… ì „ì²´ ì•± ìµœëŒ€ í­ í™•ì¥ (íŒ¨ì‹œë¸Œê°€ ì¢ì•„ ë³´ì´ë˜ ì›ì¸ í•´ê²°) */
    .app{ width: min(1920px, 100%); }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 16px 18px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{ margin:0; font-size: 20px; letter-spacing:-0.02em; }
    .brand .sub{ margin:0; font-size: 13px; color: var(--muted); }
    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 7px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.22);
    }

    .screen{ margin-top: 14px; }
    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    button{
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 14px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space: nowrap;
    }
    button:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(180deg, rgba(202,166,106,.24), rgba(202,166,106,.10));
      border-color: rgba(202,166,106,.40);
    }
    .primary:hover{
      background: linear-gradient(180deg, rgba(202,166,106,.32), rgba(202,166,106,.14));
      border-color: rgba(202,166,106,.55);
    }
    .ghost{ background: transparent; }

    .home{ padding: 22px; }
    .home h2{ margin:0 0 6px; font-size: 18px; }
    .home p{ margin:0 0 18px; color: var(--muted); line-height: 1.6; font-size: 14px; }
    .actions{ display:flex; gap:12px; flex-wrap:wrap; }

    .toast{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      display:none;
      white-space: pre-wrap;
    }

    .hidden{ display:none; }

    /* âœ… í‚¤ì›Œë“œ ëª¨ë‹¬: ì¤‘ì•™ì •ë ¬ ë˜ê²Œ display:flex ê³ ì • */
    #kwModal{ display:flex; }
    #kwModal.hidden{ display:none !important; }

    /* ===== EDITOR layout ===== */
    .editor{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height: 640px;
    }
    .sidebar{
      padding: 16px;
      border-right: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .sidebar h3{
      margin: 2px 0 10px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .02em;
    }
    .nav{ display:flex; flex-direction:column; gap: 10px; }
    .nav button{
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .nav button.active{
      border-color: rgba(202,166,106,.65);
      background: linear-gradient(180deg, rgba(202,166,106,.18), rgba(202,166,106,.07));
      box-shadow: 0 8px 25px rgba(202,166,106,.12);
    }
    .sidebar .bottom{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
      display:flex;
      gap: 10px;
    }
    .sidebar .bottom button{ flex: 1; text-align:center; }

    /* âœ… content ê°€ìš´ë° ê³ ì • í•´ì œ (íŒ¨ì‹œë¸Œ í­ í™•ì¥) */
    .content{
      padding: 18px;
      background: rgba(255,255,255,.03);
      display:flex;
      justify-content: stretch;
    }

    .centerBoard{
      width: min(1040px, 100%);
      margin: 0 auto;
    }

    /* âœ… ì—¬ê¸°! content ì•ˆì˜ ê° íŒ¨ë„ì€ ê°€ë¡œ 100% ì‚¬ìš© */
    .content > section{ width: 100%; }

    .core-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items:start;
    }

    .frame{
      border: 1px solid rgba(202,166,106,.35);
      background: linear-gradient(180deg, rgba(12,13,16,.92), rgba(7,8,10,.92));
      border-radius: 16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      overflow:hidden;
    }
    .frame .hdr{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(202,166,106,.28);
      background: linear-gradient(180deg, rgba(202,166,106,.22), rgba(143,107,50,.10));
      color: var(--gold2);
      font-weight: 700;
      letter-spacing: .02em;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .frame .hdr .slash{
      margin-left:auto;
      width: 120px;
      height: 2px;
      background: linear-gradient(90deg, rgba(202,166,106,.0), rgba(202,166,106,.65), rgba(202,166,106,.0));
      opacity: .9;
    }
    .frame .body{ padding: 12px; }

    .name-row input, .kwInput, .numInput, .textInput, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
      min-width: 0;
      font-family: inherit;
    }
    .name-row input:focus, .kwInput:focus, .numInput:focus, .textInput:focus, textarea:focus{
      border-color: rgba(202,166,106,.70);
      box-shadow: 0 0 0 3px rgba(202,166,106,.14);
    }

    .portrait{
      height: 360px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background:
        radial-gradient(700px 320px at 30% 10%, rgba(202,166,106,.08), transparent 60%),
        rgba(0,0,0,.24);
      display:grid;
      place-items:center;
      overflow:hidden;
      position: relative;
    }
    .portrait img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:none;
    }
    .portrait .ph{
      color: rgba(238,241,255,.55);
      font-size: 13px;
      line-height: 1.6;
      text-align:center;
      padding: 0 20px;
    }
    .upload-row{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .file{
      position: relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      min-width: 160px;
    }
    .file input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .statList{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    .rowItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      min-width: 0;
      transition: border-color .15s ease;
    }
    .iconBox{
      width: 30px;
      height: 30px;
      display:grid;
      place-items:center;
      border-radius: 10px;
      border: 1px solid rgba(202,166,106,.35);
      background: rgba(0,0,0,.20);
      flex: 0 0 auto;
      overflow:hidden;
      transition: border-color .15s ease;
    }
    .iconBox img{
      width: 20px;
      height: 20px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .label{
      color: rgba(243,211,154,.95);
      font-weight: 800;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .grow{ flex: 1 1 auto; min-width: 0; }
    .inline{ display:flex; gap: 8px; align-items:center; min-width:0; }
    .inline .sep{ opacity:.6; font-size:12px; padding:0 4px; flex:0 0 auto; }

    .select{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: var(--toneNormalText);
      outline:none;
      appearance: none;
      min-width: 0;
      text-align:center;
      transition: border-color .15s ease, color .15s ease;
    }
    .coef{
      margin-top: 4px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .02em;
      color: var(--toneNormalText);
      opacity: .95;
      user-select:none;
    }

    .tone-normal { --toneBorder: var(--toneNormalBorder); --toneText: var(--toneNormalText); }
    .tone-gray   { --toneBorder: var(--toneGrayBorder);   --toneText: var(--toneGrayText); }
    .tone-red    { --toneBorder: var(--toneRed);          --toneText: var(--toneRed2); }

    .physGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .physBox.tone-normal, .physBox.tone-gray, .physBox.tone-red{ border-color: var(--toneBorder); }
    .physBox.tone-normal .iconBox, .physBox.tone-gray .iconBox, .physBox.tone-red .iconBox{ border-color: var(--toneBorder); }
    .physBox.tone-normal .select, .physBox.tone-gray .select, .physBox.tone-red .select{ border-color: var(--toneBorder); color: var(--toneText); }
    .physBox.tone-normal .coef, .physBox.tone-gray .coef, .physBox.tone-red .coef{ color: var(--toneText); }

    /* sins 2 rows fixed */
    .sinsWrap{ display:flex; flex-direction:column; gap: 10px; }
    .sinsRow{ display:grid; gap: 10px; }
    .sinsRow.top{ grid-template-columns: repeat(4, 1fr); }
    .sinsRow.bottom{ grid-template-columns: repeat(3, 1fr); }

    .sinCell{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      min-width: 0;
    }
    .sinCell .sinIcon{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(202,166,106,.35);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .sinCell .sinIcon img{
      width: 22px;
      height: 22px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .sinCell .sinName{
      font-size: 13px;
      color: rgba(243,211,154,.95);
      font-weight: 800;
      letter-spacing: .01em;
      white-space: nowrap;
    }
    .sinBox.tone-normal .select, .sinBox.tone-gray .select, .sinBox.tone-red .select{ color: var(--toneText); }
    .sinBox.tone-normal .coef, .sinBox.tone-gray .coef, .sinBox.tone-red .coef{ color: var(--toneText); }

    /* stagger */
    .staggerBoard{
      border: 1px solid rgba(202,166,106,.35);
      background: linear-gradient(180deg, rgba(70,40,18,.50), rgba(35,18,10,.38));
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .staggerBarOuter{
      border: 1px solid rgba(202,166,106,.55);
      border-radius: 999px;
      padding: 6px;
      background: rgba(0,0,0,.25);
    }
    .staggerBar{
      position: relative;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.22));
      overflow: hidden;
    }
    .staggerBar .fill{
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, var(--barOrange), var(--barOrange2));
      opacity: .95;
    }
    .markerLayer{ position:absolute; inset:0; pointer-events:none; }
    .marker{
      position:absolute;
      top: -5px;
      transform: translateX(-50%);
      width: 8px;
      height: 26px;
      border-radius: 2px;
      background: #f3f0e8;
      box-shadow: 0 0 0 1px rgba(0,0,0,.35), 0 8px 14px rgba(0,0,0,.35);
      opacity: .98;
    }
    .tickLayer{ position: relative; height: 22px; margin-top: 8px; }
    .tick{
      position:absolute;
      transform: translateX(-50%);
      font-weight: 900;
      font-size: 16px;
      color: rgba(243,211,154,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.45);
      white-space: nowrap;
    }
    .staggerActions{ display:flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }

    .row-actions{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 12px; }

    /* ===== íŠ¹ì„± í‚¤ì›Œë“œ ===== */
    .kwWrap{ display:flex; flex-direction:column; gap: 10px; }
    .kwRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .kwInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      color: var(--text);
      outline:none;
      min-width: 0;
      transition: color .15s ease, text-decoration-color .15s ease;
    }
    .kwRow .btnSmall{
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
    .kwRow.deleted{
      border-color: var(--toneRed);
      box-shadow: 0 0 0 1px rgba(255,75,75,.15) inset;
    }
    .kwRow.deleted .kwInput{
      color: var(--toneRed2);
      text-decoration: line-through;
      text-decoration-color: rgba(220,220,220,.70);
      text-decoration-thickness: 2px;
    }
    .kwFooter{
      display:flex;
      justify-content:flex-end;
      margin-top: 6px;
    }

    /* ===== ì „ìš© í‚¤ì›Œë“œ í¸ì§‘ ===== */
    .dkPage{ width: min(1240px, 100%); display:flex; flex-direction:column; gap: 14px; margin:0 auto; }

    .dkTop{
      display:grid;
      grid-template-columns: 320px 1fr 300px;
      gap: 18px;
      align-items:stretch;
    }
    .box{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }

    .dkIconPreview{
      width: 100%;
      height: 260px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .dkIconPreview img{ width:100%; height:100%; object-fit: contain; display:none; }
    .dkIconPreview .ph{ color: rgba(238,241,255,.55); font-size: 12px; text-align:center; padding: 0 6px; }

    .dkButtons{ display:flex; flex-direction:column; gap: 10px; }

    .dkContentArea textarea{
      height: 320px;
      resize: vertical;
      text-align: center;
      line-height: 1.9;
      font-size: 14px;
    }

    .dkActionCol{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .stateBtn{
      font-weight: 900;
      letter-spacing: .02em;
    }
    .stateBtn.buff{
      color: rgba(243,211,154,.95);
      border-color: rgba(202,166,106,.40);
      background: rgba(202,166,106,.12);
    }
    .stateBtn.debuff{
      color: var(--toneRed2);
      border-color: rgba(255,75,75,.50);
      background: rgba(255,75,75,.10);
    }

    .btnDanger{
      border-color: rgba(255,75,75,.35);
      background: rgba(255,75,75,.10);
    }
    .btnDanger:hover{
      border-color: rgba(255,75,75,.55);
      background: rgba(255,75,75,.14);
    }

    .dkListBox{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px;
      min-height: 460px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .dkItem{
      display:grid;
      grid-template-columns: 92px 1fr 120px;
      gap: 12px;
      align-items: start;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .dkItem:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
    }
    .dkItem.active{
      box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
    }

    .dkItem.buff{
      border-color: rgba(202,166,106,.60);
      background: rgba(202,166,106,.08);
    }
    .dkItem.debuff{
      border-color: rgba(255,75,75,.60);
      background: rgba(255,75,75,.06);
    }

    .dkLeft{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      width: 100%;
      padding-top: 2px;
    }
    .dkLeftTitle{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.25;
      color: rgba(243,211,154,.95);
      text-align:center;
      white-space: normal;
      word-break: break-word;
      width: 100%;
    }

    .dkMiniIcon{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .dkItem.buff .dkMiniIcon{ border-color: rgba(202,166,106,.45); }
    .dkItem.debuff .dkMiniIcon{ border-color: rgba(255,75,75,.45); }
    .dkMiniIcon img{ width:100%; height:100%; object-fit: contain; display:none; }
    .dkMiniIcon .ph{ font-size: 11px; color: rgba(238,241,255,.45); }

    .dkMeta{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 6px;
      padding-top: 6px;
      min-width: 0;
    }
    .dkMeta .d{
      font-size: 13px;
      color: rgba(238,241,255,.75);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      width: 100%;
    }

    .dkTag{
      font-weight: 900;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      text-align:center;
      align-self: start;
      margin-top: 4px;
    }
    .dkTag.buff{ color: rgba(243,211,154,.95); border-color: rgba(202,166,106,.55); }
    .dkTag.debuff{ color: var(--toneRed2); border-color: rgba(255,75,75,.60); }

    .dkFooterBar{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 6px;
    }

    /* ===== PASSIVE (ê°œí¸) ===== */
    /* âœ… íŒ¨ì‹œë¸ŒëŠ” ê°€ë¡œë¥¼ ì œí•œí•˜ì§€ ì•Šê³ , ì‚¬ì´ë“œë°” ì˜† ë‚¨ëŠ” í­ì„ ì „ë¶€ ì‚¬ìš© */
    .passivePage{
      width: 100%;
      max-width: none;
      margin: 0;
    }

    .passTop{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: stretch;
    }

    .passEditor textarea{
      height: 360px;
      resize: vertical;
      line-height: 1.85;
      font-size: 14px;
      text-align: left;
    }

    .passLabel{
      color: rgba(243,211,154,.95);
      font-weight: 900;
      margin-bottom: 6px;
    }

    .passHeaderPick{ display:flex; gap:10px; flex-wrap:wrap; }
    .pvStyleBtn.active{
      border-color: rgba(202,166,106,.70);
      background: rgba(202,166,106,.14);
    }

    .pvBoardBox{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px;
    }

    .pvBoardHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .pvBoardHint{
      color:var(--muted);
      font-size:13px;
    }

    .pvBoardScroll{
      max-height: 560px;
      overflow:auto;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      border-radius: 14px;
    }

    .pvCard{
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
      border-radius: 14px;
      overflow:hidden;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .pvCard:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.18);
    }
    .pvCard.active{
      box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
    }

    .pvHdr{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      font-weight: 900;
      color: rgba(255,255,255,.95);
      position: relative;
      overflow:hidden;
    }
    .pvHdr .slashes{
      margin-left:auto;
      display:flex;
      gap: 6px;
      opacity: .95;
    }
    .pvHdr .slashes i{
      width: 10px;
      height: 18px;
      transform: skewX(-20deg);
      display:block;
      background: rgba(0,0,0,.30);
    }

    .pvHdr.orange{ background: linear-gradient(90deg, #ff7a2f, #8b3b12); }
    .pvHdr.red{    background: linear-gradient(90deg, #ff3d3d, #7a1a1a); }
    .pvHdr.brown{  background: linear-gradient(90deg, #b9833c, #5a3a16); }

    .pvBody{
      padding: 12px 12px 14px;
      color: rgba(255,255,255,.92);
      line-height: 1.75;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .pvHL{
      padding: 0 2px;
      border: 2px solid rgba(255,122,47,.95);
      border-radius: 0;
      background: rgba(255,122,47,.12);
      color: rgba(255,140,70,.98);
      font-weight: 900;

      text-decoration-line: underline;
      text-decoration-color: rgba(255,255,255,.92);
      text-decoration-thickness: 2px;
      text-underline-offset: 3px;
    }

    /* âœ… ì „ìš©í‚¤ì›Œë“œ í‘œì‹œ(ë²„í”„/ë””ë²„í”„ ìƒ‰) */
    .pvKW{
      font-weight: 900;
      padding: 0 2px;
      border-bottom: 2px solid rgba(255,255,255,.92);
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.92);
      text-underline-offset: 3px;
    }
    .pvKW.buff{ color: rgba(243,211,154,.95); }
    .pvKW.debuff{ color: rgba(255,120,120,.98); }

    /* ê°•ì¡° ì•ˆì—ì„œë„ í‚¤ì›Œë“œ ìƒ‰ ìœ ì§€ */
    .pvHL .pvKW.buff{ color: rgba(243,211,154,.95); }
    .pvHL .pvKW.debuff{ color: rgba(255,120,120,.98); }

/* ===== SKILL Color Effects ===== */
.fxGreen{
  color: #6CFF9E;     /* ë°ì€ ì´ˆë¡ */
  font-weight: 900;
}

.fxBlue{
  color: #7EC8FF;     /* ë°ì€ íŒŒë‘ */
  font-weight: 900;
}

.fxRed{
  color: #FF2B2B;     /* ğŸ”¥ ë” ê°•í•œ ë¹¨ê°• */
  font-weight: 900;
}

    /* ===== responsive ===== */
    @media (max-width: 1120px){
      .core-grid{ grid-template-columns: 1fr; }
      .dkTop{ grid-template-columns: 1fr; }
      .kwRow{ grid-template-columns: 1fr; }
      .kwFooter button{ width:100%; }
      .passTop{ grid-template-columns: 1fr; }
      .pvBoardScroll{ max-height: 460px; }
    }
    @media (max-width: 980px){
      .editor{ grid-template-columns: 1fr; }
      .sidebar{ border-right:none; border-bottom:1px solid var(--line); }
      .physGrid{ grid-template-columns: 1fr; }
      .sinsRow.top{ grid-template-columns: repeat(2, 1fr); }
      .sinsRow.bottom{ grid-template-columns: repeat(2, 1fr); }
      .tick{ font-size: 14px; }
      .dkItem{ grid-template-columns: 92px 1fr; }
      .dkTag{ justify-self:start; }
    }

/* ===== SKILL (FIXED LAYOUT) ===== */
.skillPage{ width: 100%; max-width: none; }

/* ===== SKILL text line align ===== */
/* âœ… ìŠ¤í‚¬ í˜ì´ì§€ë¥¼ "ìœ„(3ì—´) + ì•„ë˜(ì €ì¥ëœ ìŠ¤í‚¬)" 2ë‹¨ìœ¼ë¡œ */
.skillEditorGrid{
  width: min(1600px, 100%);
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr;     /* 1ì—´ ì»¨í…Œì´ë„ˆ */
  gap: 18px;
  align-items: start;
}

/* âœ… ìœ„ìª½: 3ì—´(ë¯¸ë¦¬ë³´ê¸° / í¸ì§‘ / ìŠ¤í‚¬ìˆ˜ì¹˜) */
.skillTopGrid{
  display: grid;
  grid-template-columns: 520px 1fr 340px; /* ì›í•˜ëŠ” ë¹„ìœ¨ë¡œ ì¡°ì ˆ ê°€ëŠ¥ */
  gap: 18px;
  align-items: start;
}

/* âœ… grid ìì‹ overflow/ì¹¨ë²” ë°©ì§€ í•µì‹¬ */
.skillTopGrid > *{ min-width: 0; }
.skillEditorGrid > *{ min-width: 0; }

/* ë°•ìŠ¤ê°€ ë°–ìœ¼ë¡œ íŠ€ëŠ” ê±¸ ì˜ë¼ì¤Œ */
.skillTopGrid .box{ overflow: hidden; }
.skillSavedBox{ overflow: hidden; }

.coinEffectWrapper{
  position: relative;
  width: 28px;
  height: 28px;
  flex: 0 0 auto;
}

.coinEffectFrame{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display:block;
}

.coinEffectRoman{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  font-weight: 1000;
  color: rgba(255,255,255,.95);
  pointer-events: none;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
}

/* ===== SKILL text line align (ADD BACK) ===== */
.skLines{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.skLine{
  display:grid;
  grid-template-columns: 28px 1fr; /* ì™¼ìª½ ì½”ì¸ ì¹¸ */
  gap:10px;
  align-items:start;
}

.skLead{
  display:flex;
  align-items:flex-start;
  justify-content:center;
  font-weight:1000;
  text-align:center;
  opacity:.95;
  min-width:0;
}

.skBody{
  min-width:0;
}

/* ===== Skill Preview v3 (3ë²ˆì§¸ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼) ===== */
.skillPreviewCard.v2{
  background: rgba(0,0,0,.34);
  border: 1px solid rgba(255,255,255,.14);
}

/* ===== Skill Preview v2: ì½”ì¸ -> íƒ€ì´í‹€ ìœ„, ì½”ì¸ì€ ì™¼ìª½ ì •ë ¬ ===== */
#skPreviewCard.skillPreviewCard.v2{
  width: min(420px, 100%);
  margin: 0 auto;
}

/* ì½”ì¸ ì¤„: ì™¼ìª½ ì •ë ¬ + íƒ€ì´í‹€ê³¼ ê°™ì€ í­ */
#skPreviewCard.skillPreviewCard.v2 #skCoinRow{
  display:flex;
  justify-content:flex-start;   /* âœ… ì™¼ìª½ ì •ë ¬ */
  align-items:center;
  gap:6px;
  margin: 0 auto;               /* ì¹´ë“œ ê¸°ì¤€ ì¤‘ì•™ì— â€œí­â€ë§Œ ë§ì¶¤ */
  width: 100%;
  max-width: 360px;             /* âœ… 2ë²ˆ ì´ë¯¸ì§€ ëŠë‚Œ */
}

/* ì½”ì¸ ì•„ì´ì½˜ í¬ê¸°(ì‘ê²Œ) */
#skPreviewCard.skillPreviewCard.v2 #skCoinRow .skCoinIcon{
  width:16px;
  height:16px;
}

/* íƒ€ì´í‹€ë°”ë„ ê°™ì€ í­ */
#skPreviewCard.skillPreviewCard.v2 #skTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
}

/* í”„ë ˆì„ ìœ„ìª½ ë” compact */
.skillPreviewCard.v2 .skTop{
  gap: 10px;
}
.skillPreviewCard.v2 .skFrame{
  width: 100px;
  height: 100px;
}

/* âœ… ì½”ì¸ + íƒ€ì´í‹€ í•œ ì¤„ë¡œ */
.skHeaderRow{
  display:flex;
  align-items:center;
  gap: 10px;
}

/* ===== Skill Preview v2 (2ë²ˆ ì‚¬ì§„ ìŠ¤íƒ€ì¼) ===== */
.skillPreviewCard.v2{
  width: min(420px, 100%);      /* âœ… 2ë²ˆì²˜ëŸ¼ 'ì¹´ë“œ í­'ì„ ì¡ì•„ì¤Œ */
  margin: 0 auto;

  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  background: rgba(0,0,0,.22);
  padding: 14px;

  display: flex;               /* âœ… 1ì—´ ì„¸ë¡œ ìŠ¤íƒ */
  flex-direction: column;
  gap: 12px;

  overflow: hidden;
}

.skillPreviewCard.v2 .skTop{
  display:flex;
  flex-direction: column;
  align-items:center;
  gap: 8px;
}

.skillPreviewCard.v2 .skFrame{
  width: 230px;                /* âœ… 2ë²ˆì²˜ëŸ¼ ìœ„ì— í¼ì§í•˜ê²Œ */
  height: 230px;
}

.skillPreviewCard.v2 .skTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
}

/* âœ… 2ë²ˆ ì´ë¯¸ì§€: ì„±ì¥ê³„ìˆ˜ ë¼ì¸ */
.skillPreviewCard.v2 .skGrowthRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  margin-top: 2px;
  padding: 6px 8px;
}

.skillPreviewCard.v2 .skGrowthIcon{
  width: 18px;
  height: 18px;
  object-fit: contain;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
  opacity: .95;
}

.skillPreviewCard.v2 .skGrowthText{
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  text-shadow: 0 2px 10px rgba(0,0,0,.45);
  letter-spacing: -.01em;
  display:flex;
  align-items:baseline;
  gap: 6px;
}

.skillPreviewCard.v2 .skGrowthLabel{
  opacity: .92;
}

.skillPreviewCard.v2 .skGrowthPlus{
  opacity: .95;
}

/* ìŠ¤íƒ¯í‘œ v2: 2ë²ˆ ì‚¬ì§„ì²˜ëŸ¼ 'ê°ˆìƒ‰ ë°”íƒ• + ê¸ˆ ë¼ì¸' ëŠë‚Œ */
.skStatTable.skStat2col.v2{
  width: 100%;
  border: 1px solid rgba(202,166,106,.60);
  border-radius: 14px;
  overflow: hidden;
  background: rgba(25,14,8,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.skStatTable.skStat2col.v2 .skStatTr{
  grid-template-columns: 1fr 120px;  /* âœ… ì˜¤ë¥¸ìª½ ê°’ ì¹¸ ê³ ì • ëŠë‚Œ */
  border-bottom: 1px solid rgba(202,166,106,.22);
}

.skStatTable.skStat2col.v2 .skStatTh{
  padding: 12px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(45,26,14,.60);
  border-right: 1px solid rgba(202,166,106,.22);
  text-align: left;
}

.skStatTable.skStat2col.v2 .skStatTd{
  padding: 12px 12px;
  justify-content: center;      /* âœ… 2ë²ˆì²˜ëŸ¼ ê°€ìš´ë° ì •ë ¬ */
  gap: 8px;
  background: rgba(15,10,8,.35);
}

/* íš¨ê³¼ ë°•ìŠ¤: 2ë²ˆì²˜ëŸ¼ 'ë³¸ë¬¸ì´ ì•„ë˜ë¡œ ê¸¸ê²Œ' */
.skillPreviewCard.v2 .skEffectBox{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  min-height: 160px;
}

/* í”„ë ˆì„/íƒ€ì´í‹€ë°” */
.skFrame{
  width: 260px;
  height: 260px;
  position: relative;
  display:grid;
  place-items:center;
}
.skFrame > img{ width: 100%; height: 100%; object-fit: contain; display:block; }
#skFrameImg{ position:absolute; inset:0; z-index:2; pointer-events:none; }

.skInner{
  position:absolute;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%);

  width: 64%;
  height: 64%;
  border-radius: 999px;
  overflow:hidden;
  display:grid;
  place-items:center;
  z-index:1;
}
.skInner img{ width:100%; height:100%; object-fit:contain; display:none; }

.skTitleBar{
  width: 260px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 12px 14px;
  position: relative;
  overflow:hidden; /* âœ… stripesê°€ íŠ€ë©´ ì—¬ê¸°ì„œ ì˜ë¦¼ */
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.skTitle{ font-weight: 1000; letter-spacing: -.02em; color: rgba(255,255,255,.92); text-align:left; padding-left: 6px; }

.skTitleStripes{
  position:absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%) skewX(-18deg);
  width: 54px;
  height: 22px;
  border-radius: 6px;
  background:
    linear-gradient(90deg,
      rgba(0,0,0,.0) 0%,
      rgba(0,0,0,.0) 20%,
      rgba(255,255,255,.18) 20%,
      rgba(255,255,255,.18) 32%,
      rgba(0,0,0,.0) 32%,
      rgba(0,0,0,.0) 44%,
      rgba(255,255,255,.18) 44%,
      rgba(255,255,255,.18) 56%,
      rgba(0,0,0,.0) 56%,
      rgba(0,0,0,.0) 68%,
      rgba(255,255,255,.18) 68%,
      rgba(255,255,255,.18) 80%,
      rgba(0,0,0,.0) 80%,
      rgba(0,0,0,.0) 100%);
}

/* ì½”ì¸ ì•„ì´ì½˜ */
.skCoinRow{
  display:flex;
  justify-content:center;
  gap:6px;
  margin: 8px 0 6px 0;
}
.skCoinIcon{ width: 22px; height: 22px; object-fit:contain; }

/* ===== ìŠ¤íƒ¯í‘œ (ì‚ì ¸ë‚˜ì˜´ ë°©ì§€) ===== */
.skStatTable.skStat2col{
  width: 100%;
  border: 1px solid rgba(202,166,106,.55);
  border-radius: 14px;
  overflow: hidden; /* âœ… í‘œ í…Œë‘ë¦¬ ì‚ì ¸ë‚˜ì˜´ ë°©ì§€ */
  background: rgba(0,0,0,.28);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
  min-width: 0;     /* âœ… */
}

.skStatTr{
  display: grid;
  grid-template-columns: 140px 1fr;
  border-bottom: 1px solid rgba(202,166,106,.22);
  min-width: 0;
}
.skStatTr:last-child{ border-bottom: none; }

.skStatTh{
  padding: 14px 16px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: linear-gradient(180deg, rgba(60,40,18,.65), rgba(20,12,8,.45));
  border-right: 1px solid rgba(202,166,106,.22);
  letter-spacing: .01em;
  min-width: 0;
}

.skStatTd{
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 10px;
  font-weight: 1000;
  color: rgba(238,241,255,.95);
  background: linear-gradient(180deg, rgba(40,26,14,.55), rgba(12,10,10,.35));
  min-width: 0;              /* âœ… */
  overflow: hidden;          /* âœ… */
  text-overflow: ellipsis;   /* âœ… */
  white-space: nowrap;       /* âœ… */
}

.skMiniIcon, .skStatIcon{
  width: 22px;
  height: 22px;
  object-fit: contain;
  flex: 0 0 auto;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
}

/* ===== Coin Effect inline icon (in description text) ===== */
.coinEff{
  display:inline-flex;
  align-items:center;
  gap:6px;
  vertical-align: middle;
  margin: 0 2px;
  line-height: 0;           /* ê¸€ì line-height ì˜í–¥ ì œê±° */
}

.coinEffIcon{
  position: relative;
  width: 22px;              /* âœ… 22 -> 16 */
  height: 22px;             /* âœ… 22 -> 16 */
  flex: 0 0 22px;            /* âœ… ê³ ì • */
  display: block;
  vertical-align: middle;
  line-height: 0;
}

.coinEffIcon img{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

.coinEffRoman{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size: 9px;           /* âœ… 11 -> 9 */
  font-weight: 1000;
  color: rgba(255,255,255,.95);
  text-shadow: 0 2px 6px rgba(0,0,0,.70);
  pointer-events:none;
  line-height: 1;
}

/* âœ… í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ ë°•ìŠ¤ì— 'ë”±' ë¶™ì—¬ì„œ ê·¸ë¦¬ê¸° */
.coinEffIcon img{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

.coinEffRoman{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size: 11px;
  font-weight: 1000;
  color: rgba(255,255,255,.95);
  text-shadow: 0 2px 6px rgba(0,0,0,.70);
  pointer-events:none;
}

/* íš¨ê³¼ ë°•ìŠ¤ */
.skEffectBox{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  min-height: 220px;
  white-space: pre-normal;
  line-height: 1.75;
  font-size: 13px;
  color: rgba(238,241,255,.92);
  min-width: 0;
  overflow-wrap: anywhere; /* âœ… ê¸´ í…ìŠ¤íŠ¸ë„ íŠ€ì§€ ì•Šê²Œ */
}

/* ===== í¸ì§‘ ì˜ì—­(ê°€ìš´ë°) ===== */
#skText{
  height: 320px;
  resize: vertical;
  line-height: 1.85;
  font-size: 14px;
  text-align: left;
}

/* ===== ì €ì¥ëœ ìŠ¤í‚¬(ë§¨ ì•„ë˜ ì „ì²´í­) ===== */
.skillSavedBox{
  grid-column: 1 / -1;
}

.skillSlots{
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
  align-items: flex-end;
}

.skSlot{
  width: 96px;
  height: 96px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  display:grid;
  place-items:center;
  overflow:hidden;
  cursor:pointer;
  position: relative;
  flex: 0 0 auto;
}

.skSlot.active{
  border-color: rgba(202,166,106,.65);
  box-shadow: 0 0 0 2px rgba(202,166,106,.18) inset;
}

.skSlot .slotFrame{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: contain;
}

.skSlot .slotInner{
  position:absolute;
  inset:18%;           /* ë‚´ë¶€ ì›í˜• ì˜ì—­ í¬ê¸° */
  border-radius:999px;
  overflow:hidden;
  display:grid;
  place-items:center;
}

.skSlot .slotInner img{
  width:100%;
  height:100%;
  object-fit: contain;
  display:block;
}

.skSlot > img{
  width:100%;
  height:100%;
  object-fit: contain;
  display:block;
}

/* ===== ë°˜ì‘í˜• ===== */
@media (max-width: 1280px){
  .skillTopGrid{ grid-template-columns: 1fr; }
  .skillPreviewCard{ grid-template-columns: 1fr; }
  .skTitleBar, .skFrame{ width: 100%; max-width: 360px; }
}

/* ===== Coin Sign Layout (Skill) ===== */
.coinWrap{
  display:flex;
  align-items:center;
  gap:10px;
}

.coinSignBtn{
  width:44px;
  height:44px;
  display:grid;
  place-items:center;
  padding:0;
  font-weight:1000;
}

/* ===== Skill List (Saved Skills -> List Cards) ===== */
.skList{
  display:flex;
  flex-direction:column;
  gap: 12px;
  margin-top: 10px;
}

.skListCard{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: 16px;
  overflow:hidden;
  cursor:pointer;
  transition: background .15s ease, border-color .15s ease, transform .08s ease;
}
.skListCard:hover{
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.18);
}
.skListCard:active{ transform: translateY(1px); }
.skListCard.active{
  box-shadow: 0 0 0 1px rgba(202,166,106,.25) inset;
  border-color: rgba(202,166,106,.35);
}

.skListTop{
  display:grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  padding: 12px;
  align-items: start;
}

.skListArt{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 8px;
  min-width:0;
}
.skListFrame{
  width: 110px;
  height: 110px;
  position: relative;
  display:grid;
  place-items:center;
}
.skListFrame > img{ width:100%; height:100%; object-fit:contain; display:block; }
.skListFrame .inner{
  position:absolute;
  inset: 18%;
  border-radius: 999px;
  overflow:hidden;
  display:grid;
  place-items:center;
}
.skListFrame .inner img{ width:100%; height:100%; object-fit:contain; display:block; }

/* âœ… ìŠ¤í‚¬ ëª©ë¡ í”„ë ˆì„/ë‚´ë¶€ ì´ë¯¸ì§€ ë ˆì´ì–´ ê³ ì • (í”„ë ˆì„ì´ í•­ìƒ ìœ„) */
.skListFrame{
  position: relative;
  overflow: hidden; /* í˜¹ì‹œ ëª¨ë¥¼ ì‚ì ¸ë‚˜ì˜´ ë°©ì§€ */
}

/* í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ 'ìœ„'ë¡œ */
.skListFrame > img{
  position: absolute;
  inset: 0;
  z-index: 2;
  pointer-events: none;
}

/* ìœ ì € ì´ë¯¸ì§€(ë‚´ë¶€)ë¥¼ 'ì•„ë˜'ë¡œ + ì›í˜• í´ë¦½ ìœ ì§€ */
.skListFrame .inner{
  position: absolute;
  inset: 18%;
  z-index: 1;
  border-radius: 999px;
  overflow: hidden;
}

/* ë‚´ë¶€ ì´ë¯¸ì§€ëŠ” í´ë¦½ ì•ˆì—ì„œë§Œ */
.skListFrame .inner img{
  width: 100%;
  height: 100%;
  object-fit: contain; /* ë¯¸ë¦¬ë³´ê¸°ë‘ ë™ì¼ ëŠë‚Œì´ë©´ contain */
  display: block;
}

.skListCoins{
  display:flex;
  justify-content:center;
  gap: 4px;
}
.skListCoins img{ width: 16px; height: 16px; object-fit:contain; }

.skListMain{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap: 10px;
}

.skListTitleBar{
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 10px 12px;
  position: relative;
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
.skListTitle{
  font-weight: 1000;
  letter-spacing: -.02em;
  color: rgba(255,255,255,.92);
  padding-left: 4px;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

.skListStat{
  width: 100%;
  border: 1px solid rgba(202,166,106,.35);
  border-radius: 14px;
  overflow:hidden;
  background: rgba(0,0,0,.22);
}
.skListStatRow{
  display:grid;
  grid-template-columns: 120px 1fr;
  border-bottom: 1px solid rgba(202,166,106,.18);
}
.skListStatRow:last-child{ border-bottom:none; }
.skListStatTh{
  padding: 10px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(60,40,18,.45);
  border-right: 1px solid rgba(202,166,106,.18);
}
.skListStatTd{
  padding: 10px 12px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap: 8px;
  font-weight: 1000;
  color: rgba(238,241,255,.92);
  background: rgba(20,12,8,.25);
}

.skListActions{
  padding: 0 12px 12px;
  display:flex;
  justify-content:center;
}

.skListToggle{
  width: 100%;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);
  padding: 10px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  cursor:pointer;
}
.skListToggle:hover{
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.18);
}

.skListBody{
  padding: 0 12px 12px;
  display:none;
}
.skListBody.open{ display:block; }

.skListEffect{
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  background: rgba(0,0,0,.25);
  padding: 12px;
  white-space: pre-wrap;
  line-height: 1.75;
  font-size: 13px;
  color: rgba(238,241,255,.92);
}

/* ë°˜ì‘í˜• */
@media (max-width: 980px){
  .skListTop{ grid-template-columns: 1fr; }
  .skListArt{ flex-direction:row; justify-content:center; }
}

/* ===== Keyword Tooltip ===== */
.kwTip.hidden{ display:none; }

.kwTip{
  position: fixed;
  z-index: 99999;
  pointer-events: none; /* íˆ´íŒ ìœ„ì— ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°€ë„ ê¹œë¹¡ì„ ë°©ì§€ */
}

/* ===== Keyword Modal Buff/Debuff Toggle ===== */
.kwStateToggle{
  font-weight: 900;
  font-size: 13px;
  padding: 8px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.18);
  border: 2px solid rgba(243,211,154,.95); /* ê¸°ë³¸: ë²„í”„(ë…¸ë€ í…Œë‘ë¦¬) */
  color: rgba(243,211,154,.98);
}

.kwStateToggle.debuff{
  border-color: rgba(255,75,75,.90);       /* ë””ë²„í”„: ë¹¨ê°„ í…Œë‘ë¦¬ */
  color: rgba(255,120,120,.98);            /* ë””ë²„í”„: ë¹¨ê°„ ê¸€ì”¨ */
}

/* ===== Keyword Modal Tabs ===== */
.kwTabs{
  display:flex;
  gap:8px;
  padding:6px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius: 999px;
}

.kwTab{
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.10);
  background: transparent;
  color: rgba(238,241,255,.70);
}

.kwTab.active{
  color: rgba(243,211,154,.98);
  border-color: rgba(202,166,106,.55);
  background: rgba(202,166,106,.14);
}

.kwTipBox{
  width: min(380px, 90vw);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px;
  background: rgba(10,10,12,.96);
  box-shadow: 0 18px 60px rgba(0,0,0,.60);
  padding: 12px;
  display: grid;
  grid-template-columns: 68px 1fr;
  gap: 12px;
}

.kwTipIcon{
  width: 68px; height: 68px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25);
  overflow: hidden;
  display: grid;
  place-items: center;
}
.kwTipIcon img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display:block;
}

.kwTipTitle{
  font-weight: 900;
  margin-bottom: 6px;
}

/* ë²„í”„ */
.kwTipTitle.buff{
  color: rgba(243,211,154,.95);
}

/* ë””ë²„í”„ */
.kwTipTitle.debuff{
  color: rgba(255,120,120,.98);
}
.kwTipText{
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 13px;
  color: rgba(238,241,255,.85);
}

.kwTipTitle.debuff{
  color: rgba(255,120,120,.98);
}
.kwTipTitle.buff{
  color: rgba(243,211,154,.95);
}

/* ===== Skill List (Grid) ===== */
#skList{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); /* 260ì€ ì¹´ë“œ ìµœì†Œí­ */
  gap: 14px;
  align-items: start;
}

/* í™”ë©´ ë„“ì„ ë•Œ ì¡°ê¸ˆ ë” ì´˜ì´˜í•˜ê²Œ */
@media (min-width: 1400px){
  #skList{
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  }
}

/* === Saved Skill Card -> v2(ì„¸ë¡œ 1ì—´) === */
.skListCard{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: 18px;
  overflow:hidden;
}

.skListTop{
  display:flex;
  flex-direction: column;
  align-items:center;
  gap: 12px;
  padding: 14px;
}

.skListArt{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 8px;
}

.skListFrame{
  width: 230px;
  height: 230px;
}

.skListCoins{
  display:flex;
  justify-content:center;
  gap:6px;
}

.skListTitleBar{
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  padding: 12px 14px;
  position: relative;
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}

.skListTitle{
  font-weight: 1000;
  letter-spacing: -.02em;
  color: rgba(255,255,255,.92);
  padding-left: 6px;
  text-align:left;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

/* ê³µê²©ë ˆë²¨/ì„±ì¥ê³„ìˆ˜ ì¤„ */
.skListGrowthRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  margin-top: 2px;
  padding: 6px 8px;
}

.skListGrowthIcon{
  width: 18px;
  height: 18px;
  object-fit: contain;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
  opacity: .95;
}

.skListGrowthText{
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  text-shadow: 0 2px 10px rgba(0,0,0,.45);
  letter-spacing: -.01em;
  display:flex;
  align-items:baseline;
  gap: 6px;
}

/* ìŠ¤íƒ¯í‘œë¥¼ ë¯¸ë¦¬ë³´ê¸°(v2) ìŠ¤íƒ€ì¼ë¡œ */
.skListStat{
  width: 100%;
  max-width: 360px;
  border: 1px solid rgba(202,166,106,.60);
  border-radius: 14px;
  overflow: hidden;
  background: rgba(25,14,8,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.skListStatRow{
  display:grid;
  grid-template-columns: 1fr 120px;
  border-bottom: 1px solid rgba(202,166,106,.22);
}
.skListStatRow:last-child{ border-bottom:none; }

.skListStatTh{
  padding: 12px 12px;
  font-weight: 1000;
  color: rgba(243,211,154,.95);
  background: rgba(45,26,14,.60);
  border-right: 1px solid rgba(202,166,106,.22);
  text-align:left;
}

.skListStatTd{
  padding: 12px 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  font-weight: 1000;
  color: rgba(238,241,255,.92);
  background: rgba(15,10,8,.35);
}

/* ===== View Mode (Read Only) ===== */
.readonly input,
.readonly textarea,
.readonly select{
  pointer-events:none;
  opacity:.92;
}
.readonly .file input[type="file"]{ pointer-events:none; }
.readonly .row-actions,
.readonly .dkFooterBar,
.readonly #pvAddBtn,
.readonly #pvSaveBtn,
.readonly #pvDeleteBtn,
.readonly #dkAddBtn,
.readonly #dkSaveBtn,
.readonly #dkDeleteBtn,
.readonly #btnSaveCore,
.readonly #btnResetCore,
.readonly #skSaveBtn,
.readonly #skNewBtn,
.readonly #skDeleteBtn,
.readonly #btnClearImg,
.readonly #dkIconClear,
.readonly #skImgClear{
  display:none !important;
}

/* ===== View Mode: CORE ì „ìš© UI ì •ë¦¬ ===== */
.readonly .upload-row{ display:none !important; }      /* âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ/ì œê±° ì¤„ í†µì§¸ë¡œ ì œê±° */
.readonly .staggerActions{ display:none !important; }  /* âœ… ííŠ¸ ì¶”ê°€/ì‚­ì œ ë²„íŠ¼ ì œê±° */

/* ===== View Mode: trait keyword chips ===== */
.traitChips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.traitChip{
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(202,166,106,.35);
  background: rgba(0,0,0,.18);
  color: rgba(243,211,154,.95);
  font-weight: 900;
  font-size: 13px;
  line-height: 1.2;
}

.traitChip.deleted{
  border-color: rgba(255,75,75,.55);
  color: rgba(255,120,120,.98);
  text-decoration: line-through;
  text-decoration-thickness: 2px;
  text-decoration-color: rgba(255,180,180,.95);
}

/* ===== View Mode: trait keyword line ===== */
.traitLine{
  border: 1px solid rgba(202,166,106,.40);
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.18));
  padding: 12px 14px;
  color: rgba(243,211,154,.95);
  font-weight: 900;
  letter-spacing: -.01em;
  line-height: 1.45;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
}

.readonly #traitKwList{ display:none !important; }  /* âœ… ê¸°ì¡´ í¸ì§‘ ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¹€ */
.readonly .kwFooter{ display:none !important; }     /* âœ… 'í‚¤ì›Œë“œ ì¶”ê°€' ë²„íŠ¼ ì˜ì—­ ìˆ¨ê¹€ */

/* ===== View Mode: Name title vibe ===== */
.readonly #charName{
  background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.22));
  border-color: rgba(202,166,106,.45);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.35);
  padding: 14px 16px;
}

/* âœ… í¸ì§‘ëª¨ë“œì—ì„œëŠ” ë³´ê¸°ì „ìš© ìš”ì•½(ì¹©) ìˆ¨ê¹€ */
.traitLine{ display:none; }
.readonly .traitLine{ display:block; }

/* ===== View Mode: PASSIVE ì „ìš© UI ì •ë¦¬ ===== */
.readonly #panel-passive .passTop{ 
  display:none !important;            /* âœ… ìœ„ í¸ì§‘ë€ í†µì§¸ë¡œ ì œê±° */
}

.readonly #panel-passive .pvBoardHead{
  display:none !important;            /* âœ… "ì•„ë˜ ëª©ë¡ì—ì„œ..." + ì¶”ê°€ë²„íŠ¼ ì¤„ ì œê±° */
}

.readonly #panel-passive .pvBoardBox{
  margin-top: 0 !important;           /* âœ… ìœ„ê°€ ì‚¬ë¼ì ¸ì„œ ëœ¨ëŠ” ì—¬ë°± ì œê±° */
}

/* ===== View Mode: SKILL ì „ìš© (ëª©ë¡ë§Œ ë‚¨ê¸°ê¸°) ===== */
.readonly #panel-skill .skillTopGrid{
  display:none !important;   /* âœ… ë¯¸ë¦¬ë³´ê¸°/í¸ì§‘/ìˆ˜ì¹˜ 3ì—´ í†µì§¸ë¡œ ìˆ¨ê¹€ */
}
.readonly #panel-skill .skillSavedBox{
  display:block !important;  /* âœ… ìŠ¤í‚¬ ëª©ë¡ì€ ìœ ì§€ */
}

/* ===== View Mode: PASSIVE only list ===== */
.readonly #panel-passive .passTop{ display:none !important; }      /* ìœ„ í¸ì§‘ë€ ì œê±° */
.readonly #panel-passive .pvBoardHint{ display:none !important; }  /* ì•ˆë‚´ë¬¸ ì œê±° */

/* ===== View Mode: SKILL only list ===== */
.readonly #panel-skill .skillTopGrid{ display:none !important; }   /* ë¯¸ë¦¬ë³´ê¸°/í¸ì§‘/ìˆ˜ì¹˜ ì œê±° */
.readonly #panel-skill .skillSavedBox{ margin-top: 0 !important; } /* ìœ„ê°€ ì‚¬ë¼ì ¸ë„ ë¶™ê²Œ */

/* ===== View Mode: DK only list ===== */
.readonly #panel-dk .dkTop{ display:none !important; }             /* ìœ„ í¸ì§‘ 3ì¹¸ ì œê±° */
.readonly #panel-dk .dkListBox > div:first-child{ display:none !important; } /* ì•ˆë‚´ë¬¸ ì œê±° */

  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <h1>ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ ì• ë“œì˜¨</h1>
        <p class="sub">ìºë¦­í„° í¸ì§‘ + ì „ìš© í‚¤ì›Œë“œ(í”„ë¡œí† íƒ€ì…)</p>
      </div>
      <div class="pill">core v1.0</div>
    </header>

    <!-- HOME -->
    <section class="screen card" id="view-home">
      <div class="home">
        <h2>ë¦¼ë²„ìŠ¤ ì»´í¼ë‹ˆ ìµœê°•ìì „</h2>
        <p>í”Œë ˆì´í•˜ê±°ë‚˜ ìºë¦­í„°ë¥¼ ë§Œë“¤ì–´ì„œ, ìµœê°•ì„ ê°€ë ¤ë³´ì.</p>
        <div class="actions">
          <button class="primary" id="btn-play" type="button">í”Œë ˆì´</button>
          <button id="btn-go-editor" type="button">ìºë¦­í„° ë§Œë“¤ê¸°</button>
          <button id="btn-go-library" type="button">ìºë¦­í„° ë³´ê¸° ë° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="toast" id="home-toast"></div>
      </div>
    </section>

<!-- CHARACTER LIBRARY -->
<section class="screen card hidden" id="view-library">
  <div class="home">
    <h2>ìºë¦­í„° ë³´ê¸° ë° ë¶ˆëŸ¬ì˜¤ê¸°</h2>
    <p>ì €ì¥ëœ ìºë¦­í„°ë¥¼ ì„ íƒí•´ì„œ ë³´ê¸° ì „ìš©ìœ¼ë¡œ ì—´ê±°ë‚˜, í¸ì§‘ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´.</p>

    <div class="actions" style="margin-bottom:12px;">
      <button type="button" id="btn-import-character">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
      <button type="button" class="primary" id="btn-save-as-character">í˜„ì¬ ì‘ì—…ì„ ìºë¦­í„°ë¡œ ì €ì¥</button>
      <button type="button" class="ghost" id="btn-lib-back">ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="charList" style="display:flex; flex-direction:column; gap:12px;"></div>
    <div class="toast" id="libToast"></div>
  </div>
</section>

    <!-- EDITOR -->
    <section class="screen card hidden" id="view-editor">
      <div class="editor">
        <aside class="sidebar">
          <h3>ìºë¦­í„° í¸ì§‘</h3>
          <div class="nav">
            <button type="button" id="tab-core" class="active">í•µì‹¬ ì •ë³´</button>
            <button type="button" id="tab-passive">íŒ¨ì‹œë¸Œ í¸ì§‘</button>
            <button type="button" id="tab-skill">ìŠ¤í‚¬ í¸ì§‘</button>
            <button type="button" id="tab-dk">ì „ìš© í‚¤ì›Œë“œ í¸ì§‘</button>
          </div>
          <div class="bottom">
            <button type="button" class="ghost" id="btn-back">ëŒì•„ê°€ê¸°</button>
          </div>
        </aside>

        <main class="content">
          <!-- CORE -->
          <section id="panel-core">
            <div class="centerBoard">
              <div class="core-grid">
                <!-- LEFT -->
                <div>
                  <div class="frame">
                    <div class="hdr">ì´ë¦„ <span class="slash"></span></div>
                    <div class="body">
                      <div class="name-row">
                        <input id="charName" type="text" />
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ì´ë¯¸ì§€ <span class="slash"></span></div>
                    <div class="body">
                      <div class="portrait">
                        <img id="portraitImg" alt="ìºë¦­í„° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" />
                        <div class="ph" id="portraitPh">
                          ì•„ì§ ì´ë¯¸ì§€ê°€ ì—†ì–´.<br/>
                          ì•„ë˜ì—ì„œ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë¼.
                        </div>
                      </div>

                      <div class="upload-row">
                        <button class="primary file" type="button">
                          ì´ë¯¸ì§€ ì—…ë¡œë“œ
                          <input id="fileInput" type="file" accept="image/*" />
                        </button>
                        <button type="button" id="btnClearImg">ì´ë¯¸ì§€ ì œê±°</button>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ííŠ¸ëŸ¬ì§ êµ¬ê°„ <span class="slash"></span></div>
                    <div class="body">
                      <div class="staggerBoard">
                        <div class="staggerBarOuter">
                          <div class="staggerBar" aria-label="ííŠ¸ëŸ¬ì§ êµ¬ê°„ ë°”">
                            <div class="fill"></div>
                            <div class="markerLayer" id="markerLayer"></div>
                          </div>
                        </div>
                        <div class="tickLayer" id="tickLayer"></div>
                      </div>

                      <div class="staggerActions">
                        <button type="button" id="btnAddStagger" class="primary">ííŠ¸ ì¶”ê°€</button>
                        <button type="button" id="btnDelStagger">ííŠ¸ ì‚­ì œ</button>
                      </div>
                    </div>
                  </div>

                  <div class="row-actions">
                    <button class="primary" id="btnSaveCore" type="button">ì €ì¥</button>
                    <button id="btnResetCore" type="button">ì´ˆê¸°í™”</button>
                  </div>

                  <div class="toast" id="coreToast"></div>
                </div>

                <!-- RIGHT -->
                <div>
                  <div class="frame">
                    <div class="hdr">ìŠ¤í…Œì´í„°ìŠ¤ <span class="slash"></span></div>
                    <div class="body">
                      <div class="statList">
                        <div class="rowItem">
                          <div class="iconBox" title="ì²´ë ¥ ì•„ì´ì½˜"><img src="assets/icon_hp.png" alt="ì²´ë ¥" /></div>
                          <div class="label">ì²´ë ¥</div>
                          <div class="grow"><input id="statHp" class="numInput" type="number" min="0" step="1" /></div>
                        </div>

                        <div class="rowItem">
                          <div class="iconBox" title="ì†ë„ ì•„ì´ì½˜"><img src="assets/icon_speed.png" alt="ì†ë„" /></div>
                          <div class="label">ì†ë„</div>
                          <div class="grow inline">
                            <input id="statSpdMin" class="numInput" type="number" min="0" step="1" />
                            <span class="sep">~</span>
                            <input id="statSpdMax" class="numInput" type="number" min="0" step="1" />
                          </div>
                        </div>

                        <div class="rowItem">
                          <div class="iconBox" title="ë°©ì–´ë ˆë²¨ ì•„ì´ì½˜"><img src="assets/icon_deflv.png" alt="ë°©ì–´ë ˆë²¨" /></div>
                          <div class="label">ë°©ì–´ë ˆë²¨</div>
                          <div class="grow"><input id="statDefLv" class="numInput" type="number" min="0" step="1" /></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ë¬¼ë¦¬ ë‚´ì„± ì •ë³´ <span class="slash"></span></div>
                    <div class="body">
                      <div class="physGrid">
                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_slash.png" alt="ì°¸ê²©" /></div>
                          <div class="grow">
                            <select id="physSlash" class="select"></select>
                            <div class="coef" id="coef_physSlash">[x1.0]</div>
                          </div>
                        </div>

                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_pierce.png" alt="ê´€í†µ" /></div>
                          <div class="grow">
                            <select id="physPierce" class="select"></select>
                            <div class="coef" id="coef_physPierce">[x1.0]</div>
                          </div>
                        </div>

                        <div class="physBox rowItem tone-normal">
                          <div class="iconBox"><img src="assets/icon_blunt.png" alt="íƒ€ê²©" /></div>
                          <div class="grow">
                            <select id="physBlunt" class="select"></select>
                            <div class="coef" id="coef_physBlunt">[x1.0]</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">ì£„ì•… ë‚´ì„± ì •ë³´ <span class="slash"></span></div>
                    <div class="body">
                      <div class="sinsWrap">
                        <div class="sinsRow top">
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ë¶„ë…¸</div>
                            <div class="sinIcon"><img src="assets/icon_wrath.png" alt="ë¶„ë…¸" /></div>
                            <select class="select" id="sinWrath"></select>
                            <div class="coef" id="coef_sinWrath">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ìƒ‰ìš•</div>
                            <div class="sinIcon"><img src="assets/icon_lust.png" alt="ìƒ‰ìš•" /></div>
                            <select class="select" id="sinLust"></select>
                            <div class="coef" id="coef_sinLust">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ë‚˜íƒœ</div>
                            <div class="sinIcon"><img src="assets/icon_sloth.png" alt="ë‚˜íƒœ" /></div>
                            <select class="select" id="sinSloth"></select>
                            <div class="coef" id="coef_sinSloth">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">íƒì‹</div>
                            <div class="sinIcon"><img src="assets/icon_gluttony.png" alt="íƒì‹" /></div>
                            <select class="select" id="sinGluttony"></select>
                            <div class="coef" id="coef_sinGluttony">[x1.0]</div>
                          </div>
                        </div>

                        <div class="sinsRow bottom">
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ìš°ìš¸</div>
                            <div class="sinIcon"><img src="assets/icon_gloom.png" alt="ìš°ìš¸" /></div>
                            <select class="select" id="sinGloom"></select>
                            <div class="coef" id="coef_sinGloom">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ì˜¤ë§Œ</div>
                            <div class="sinIcon"><img src="assets/icon_pride.png" alt="ì˜¤ë§Œ" /></div>
                            <select class="select" id="sinPride"></select>
                            <div class="coef" id="coef_sinPride">[x1.0]</div>
                          </div>
                          <div class="sinCell sinBox tone-normal">
                            <div class="sinName">ì§ˆíˆ¬</div>
                            <div class="sinIcon"><img src="assets/icon_envy.png" alt="ì§ˆíˆ¬" /></div>
                            <select class="select" id="sinEnvy"></select>
                            <div class="coef" id="coef_sinEnvy">[x1.0]</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="frame" style="margin-top:14px;">
                    <div class="hdr">íŠ¹ì„± í‚¤ì›Œë“œ <span class="slash"></span></div>
                    <div class="body">
                      <div class="kwWrap" id="traitKwList"></div>
                      <div class="kwFooter">
                        <button class="primary" type="button" id="btnTraitKwAdd">í‚¤ì›Œë“œ ì¶”ê°€</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

          <!-- PASSIVE (ê°œí¸) -->
          <section id="panel-passive" class="hidden">
            <div class="passivePage">
              <div class="frame">
                <div class="hdr">íŒ¨ì‹œë¸Œ í¸ì§‘ <span class="slash"></span></div>
                <div class="body">
                  <!-- ìœ„: í¸ì§‘ -->
                  <div class="passTop">
                    <div class="box passEditor">
                      <div class="passRow">
                        <div class="passLabel">íŒ¨ì‹œë¸Œ ì´ë¦„</div>
                        <input id="pvName" class="textInput" type="text" placeholder="ì˜ˆ: ì˜ˆì§€ì•ˆ" />
                      </div>

                      <div class="passRow" style="margin-top:10px;">
                        <div class="passLabel">ì¤‘ìš”ë„</div>
                        <div class="passHeaderPick">
                          <button type="button" class="pvStyleBtn active" data-style="brown">ë³´í†µ</button>
                          <button type="button" class="pvStyleBtn" data-style="orange">ì¤‘ìš”</button>
                          <button type="button" class="pvStyleBtn" data-style="red">ë§¤ìš°ì¤‘ìš”</button>
                        </div>
                      </div>

                      <div class="passRow" style="margin-top:10px;">
                        <div class="passLabel">ë‚´ìš©</div>
                        <textarea id="pvText" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜. (ê°•ì¡°ëŠ” ì•„ë˜ ë²„íŠ¼)"></textarea>
                      </div>

                      <div class="row-actions" style="margin-top:12px;">
                        <!-- âœ… í‚¤ì›Œë“œ ë²„íŠ¼ ì¶”ê°€ -->
                        <button type="button" id="pvKeywordBtn">í‚¤ì›Œë“œ</button>
                        <button type="button" id="pvHighlightBtn">ê°•ì¡°</button>
                        <button type="button" class="primary" id="pvSaveBtn">ì €ì¥</button>
                        <button type="button" class="btnDanger" id="pvDeleteBtn">ì‚­ì œ</button>
                      </div>

                      <div class="toast" id="pvToast"></div>
                    </div>
                  </div>

                  <!-- ì•„ë˜: ì™„ì„±ëœ íŒ¨ì‹œë¸Œ(ë„“ê²Œ) -->
                  <div class="pvBoardBox">
                    <div class="pvBoardHead">
                      <div class="pvBoardHint">ì•„ë˜ ëª©ë¡ì—ì„œ ì„ íƒí•˜ë©´ ìœ„ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´.</div>
                      <button class="primary" type="button" id="pvAddBtn">íŒ¨ì‹œë¸Œ ì¶”ê°€</button>
                    </div>
                    <div class="pvBoardScroll" id="pvBoard"></div>
                  </div>

                </div>
              </div>
            </div>
          </section>

<section id="panel-skill" class="hidden">
  <div class="skillPage">
    <div class="frame">
      <div class="hdr">ìŠ¤í‚¬ í¸ì§‘ <span class="slash"></span></div>
      <div class="body">

<div class="skillEditorGrid">

  <!-- âœ… ìœ„ 3ì—´ ì˜ì—­ -->
  <div class="skillTopGrid">

    <!-- (1) LEFT: ë¯¸ë¦¬ë³´ê¸° -->
    <div class="box">
      <div class="passLabel">ë¯¸ë¦¬ë³´ê¸°</div>

<div class="skillPreviewCard v2" id="skPreviewCard">

<!-- ìœ„: í”„ë ˆì„ -->
<div class="skTop">
  <div class="skFrame">
    <img id="skFrameImg" alt="frame" />
    <div class="skInner">
      <img id="skInnerImg" alt="inner" />
    </div>
  </div>
</div>

<!-- âœ… ì½”ì¸(ì™¼ìª½ ì •ë ¬) -->
<div class="skCoinRow skCoinRowV2" id="skCoinRow"></div>

<!-- âœ… íƒ€ì´í‹€(ì½”ì¸ ì•„ë˜) -->
<div class="skTitleBar skTitleBarV2" id="skTitleBar">
  <div class="skTitle" id="skTitleTxt">ë§ˆíƒ„ì‚¬ê²©</div>
  <div class="skTitleStripes" aria-hidden="true"></div>
</div>

<!-- âœ… ê³µê²©ë ˆë²¨/ì„±ì¥ê³„ìˆ˜ ë¼ì¸ (íƒ€ì´í‹€ ì•„ë˜) -->
<div class="skGrowthRow skGrowthRowV3" id="skGrowthRow">
  <img class="skGrowthIcon" src="assets/icon_growth.png" alt="ì„±ì¥ê³„ìˆ˜">
  <div class="skGrowthText">
    <span id="skPrevGrowthBase">0</span>
    <span class="skGrowthLabel">ì„±ì¥ê³„ìˆ˜</span>
    <span class="skGrowthPlus">(
      <span id="skPrevGrowthSign">+</span>
      <span id="skPrevGrowthPlus">0</span>
    )</span>
  </div>
</div>

  <!-- ìŠ¤íƒ¯í‘œ: (ì›ë˜ ì˜¤ë¥¸ìª½ì— ìˆë˜ ê²ƒ) ì•„ë˜ë¡œ ì´ë™ -->
  <div class="skStatTable skStat2col v2">
    <div class="skStatTr">
      <div class="skStatTh">ê³µê²© ìœ í˜•</div>
      <div class="skStatTd" id="skPrevAtkCell">
        <img class="skMiniIcon" id="skPrevAtkIcon" alt="">
        <span id="skPrevAtk">ê´€í†µ</span>
      </div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">ì£„ì•… ì†ì„±</div>
      <div class="skStatTd" id="skPrevSinCell">
        <img class="skMiniIcon" id="skPrevSinIcon" alt="">
        <span id="skPrevSin">ì˜¤ë§Œ</span>
      </div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">ìŠ¤í‚¬ ìœ„ë ¥</div>
      <div class="skStatTd"><span id="skPrevPow">0</span></div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">ì½”ì¸ ìœ„ë ¥</div>
      <div class="skStatTd"><span id="skPrevCoin">+0</span></div>
    </div>

    <div class="skStatTr">
      <div class="skStatTh">ê³µê²© ê°€ì¤‘ì¹˜</div>
      <div class="skStatTd"><span id="skPrevW">1</span></div>
    </div>
  </div>

  <!-- íš¨ê³¼ -->
  <div class="skEffectBox" id="skEffectBox"></div>

</div>

      <div style="margin-top:12px;">
        <div class="passLabel">ìŠ¤í‚¬ ì´ë¯¸ì§€(ìœ ì € ì—…ë¡œë“œ)</div>

        <div class="skImgPick">
          <div class="skImgPreview" id="skImgPreview">
            <img id="skImgEl" alt="ìŠ¤í‚¬ ì´ë¯¸ì§€" />
            <div class="ph" id="skImgPh">ì´ë¯¸ì§€</div>
          </div>

          <div class="dkButtons" style="margin:0;">
            <button class="primary file" type="button">
              ì´ë¯¸ì§€ ì—…ë¡œë“œ
              <input id="skImgFile" type="file" accept="image/*" />
            </button>
            <button type="button" id="skImgClear">ì´ë¯¸ì§€ ì œê±°</button>
          </div>
        </div>
      </div>
    </div>

    <!-- (2) MIDDLE: í¸ì§‘ -->
    <div class="box">
      <div class="passLabel">ìŠ¤í‚¬ ì´ë¦„</div>
      <input id="skName" class="textInput" type="text" placeholder="ì˜ˆ: ë§ˆíƒ„ì‚¬ê²©" />

      <div style="margin-top:12px;" class="skillRow2">
        <div>
          <div class="passLabel">ê³µê²© ìœ í˜•</div>
          <select id="skAtkType" class="select">
            <option value="slash">ì°¸ê²©</option>
            <option value="pierce">ê´€í†µ</option>
            <option value="blunt">íƒ€ê²©</option>
          </select>
        </div>

        <div>
          <div class="passLabel">ì£„ì•… ì†ì„±</div>
          <select id="skSin" class="select">
            <option value="wrath">ë¶„ë…¸</option>
            <option value="lust">ìƒ‰ìš•</option>
            <option value="sloth">ë‚˜íƒœ</option>
            <option value="gluttony">íƒì‹</option>
            <option value="melancholy">ìš°ìš¸</option>
            <option value="pride">ì˜¤ë§Œ</option>
            <option value="envy">ì§ˆíˆ¬</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;" class="skillRow2">
        <div>
          <div class="passLabel">ìŠ¤í‚¬ ë“±ê¸‰(í”„ë ˆì„ 1~3)</div>
          <select id="skTier" class="select">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="passLabel">ìŠ¤í‚¬ íš¨ê³¼</div>
        <textarea id="skText" placeholder="íš¨ê³¼ë¥¼ ì…ë ¥í•´ì¤˜. í‚¤ì›Œë“œ ë²„íŠ¼ìœ¼ë¡œ [[kw:...]] í† í°ì„ ë„£ì„ ìˆ˜ ìˆì–´."></textarea>
      </div>

      <div class="row-actions" style="margin-top:12px;">
        <button type="button" id="skKeywordBtn">í‚¤ì›Œë“œ</button>
        <button type="button" id="skCoinEffectBtn">ì½”ì¸ íš¨ê³¼</button>
        <button type="button" id="skHighlightBtn">ê°•ì¡°</button>
  <button type="button" id="skGreenBtn">ë…¹ìƒ‰ íš¨ê³¼</button>
  <button type="button" id="skBlueBtn">íŒŒë€ìƒ‰ íš¨ê³¼</button>
  <button type="button" id="skRedBtn">ë¹¨ê°„ìƒ‰ íš¨ê³¼</button>
      </div>
    </div>

    <!-- (3) RIGHT: ìŠ¤í‚¬ ìˆ˜ì¹˜ + ì €ì¥/ì‚­ì œ -->
    <div class="box">
<div class="passLabel">ìŠ¤í‚¬ ìˆ˜ì¹˜</div>

<div style="margin-top:10px;">
  <div class="passLabel">ê³µê²© ë ˆë²¨</div>
  <input id="skAtkLevel" class="numInput" type="number" step="1" value="0" />
</div>

<div style="margin-top:10px;">
  <div class="passLabel">ì„±ì¥ê³„ìˆ˜</div>
  <input id="skGrowth" class="numInput" type="number" step="1" value="0" />
</div>

<div style="margin-top:10px;">
  <div class="passLabel">ìŠ¤í‚¬ ìœ„ë ¥</div>
  <input id="skPower" class="numInput" type="number" step="1" value="15" />
</div>

      <div style="margin-top:10px;">
        <div class="passLabel">ì½”ì¸ ìœ„ë ¥</div>
        <div class="coinWrap">
          <button type="button" id="skCoinSignBtn" class="coinSignBtn" data-sign="+">+</button>
          <input id="skCoinPower" class="numInput" type="number" step="1" value="4" />
        </div>
      </div>

      <!-- âœ… ì½”ì¸ ì¢…ë¥˜/ê°œìˆ˜ëŠ” ì—¬ê¸°(ì˜¤ë¥¸ìª½)ì— ë‘”ë‹¤ -->
      <div style="margin-top:10px;">
        <div class="passLabel">ì½”ì¸ ì¢…ë¥˜</div>
        <select id="skCoinType" class="select">
          <option value="normal">ì¼ë°˜ ì½”ì¸</option>
          <option value="fixed">íŒŒê´´ ë¶ˆê°€ ì½”ì¸</option>
          <option value="extract">ì ì¶œ ì½”ì¸</option>
          <option value="annihilate">ì†Œë©¸ ì½”ì¸</option>
        </select>
      </div>

      <div style="margin-top:10px;">
        <div class="passLabel">ì½”ì¸ ê°¯ìˆ˜</div>
        <input id="skCoinCount" class="numInput" type="number" min="1" step="1" value="1" />
      </div>

      <div style="margin-top:10px;">
        <div class="passLabel">ê³µê²© ê°€ì¤‘ì¹˜</div>
        <input id="skWeight" class="numInput" type="number" step="1" value="1" />
      </div>

      <div class="row-actions" style="margin-top:12px;">
        <button type="button" class="primary" id="skSaveBtn">ì €ì¥</button>
        <button type="button" id="skNewBtn">ìƒˆ ìŠ¤í‚¬</button>
        <button type="button" class="btnDanger" id="skDeleteBtn">ì‚­ì œ</button>
      </div>

      <div class="toast" id="skToast"></div>
    </div>

  </div><!-- /.skillTopGrid -->

  <!-- âœ… ì•„ë˜: ì €ì¥ëœ ìŠ¤í‚¬ì„ â€œë§¨ ì•„ë˜ ì „ì²´í­â€ìœ¼ë¡œ ë¶„ë¦¬ -->
  <div class="box skillSavedBox">
    <div class="passLabel">ìŠ¤í‚¬ ëª©ë¡</div>
    <div class="skList" id="skList"></div>
  </div>

</div><!-- /.skillEditorGrid -->
</section>

          <!-- ì „ìš© í‚¤ì›Œë“œ -->
            <section id="panel-dk" class="hidden">
            <div class="dkPage">
              <div class="frame">
                <div class="hdr">ì „ìš© í‚¤ì›Œë“œ í¸ì§‘ <span class="slash"></span></div>
                <div class="body">
                  <div class="dkTop">
                    <div class="box">
                      <div class="dkIconPreview">
                        <img id="dkIconImg" alt="ì „ìš© í‚¤ì›Œë“œ ì•„ì´ì½˜" />
                        <div class="ph" id="dkIconPh">ì´ë¯¸ì§€</div>
                      </div>
                      <div class="dkButtons">
                        <button class="primary file" type="button">
                          ì´ë¯¸ì§€ ì—…ë¡œë“œ
                          <input id="dkIconFile" type="file" accept="image/*" />
                        </button>
                        <button type="button" id="dkIconClear">ì´ë¯¸ì§€ ì œê±°</button>
                      </div>
                    </div>

                    <div class="box dkContentArea">
                      <div style="display:flex; flex-direction:column; gap:10px;">
                        <div style="color: rgba(243,211,154,.95); font-weight:900;">í‚¤ì›Œë“œ ì´ë¦„</div>
                        <input id="dkName" class="textInput" type="text" placeholder="í‚¤ì›Œë“œ ì´ë¦„" />

                        <div style="color: rgba(243,211,154,.95); font-weight:900; margin-top:6px;">ë‚´ìš©</div>
                        <textarea id="dkText" placeholder="ë‚´ìš©"></textarea>
                      </div>
                    </div>

                    <div class="box dkActionCol">
                      <button type="button" id="dkStateBtn" class="stateBtn buff">ë²„í”„</button>
                      <button type="button" id="dkSaveBtn" class="primary">ì €ì¥</button>
                      <button type="button" id="dkDeleteBtn" class="btnDanger">í‚¤ì›Œë“œ ì‚­ì œ</button>
                      <div class="toast" id="dkToast"></div>
                    </div>
                  </div>

                  <div class="dkListBox" style="margin-top:14px;">
                    <div style="color:var(--muted); font-size:13px;">
                      ì•„ë˜ ëª©ë¡ì—ì„œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ ìœ„ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´.
                    </div>
                    <div id="dkList"></div>
                    <div class="dkFooterBar">
                      <button class="primary" type="button" id="dkAddBtn">í‚¤ì›Œë“œ ì¶”ê°€</button>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </section>
  </div>

  <!-- âœ… í‚¤ì›Œë“œ í”¼ì»¤ ëª¨ë‹¬ (script ë°–!) -->
  <div id="kwModal" class="hidden" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    align-items:center; justify-content:center;
    padding:18px; z-index:9999;">
    <div style="
      width:min(720px, 100%); max-height:80vh; overflow:auto;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(10,10,12,.96);
      box-shadow:0 18px 60px rgba(0,0,0,.60);
      padding:12px;">
<div style="display:flex; align-items:center; gap:10px; padding:6px 6px 10px;">
  <div style="font-weight:900; color:rgba(243,211,154,.95);" id="kwModalTitle">í‚¤ì›Œë“œ</div>

  <!-- âœ… íƒ­ -->
  <div class="kwTabs" role="tablist" aria-label="í‚¤ì›Œë“œ íƒ­">
    <button type="button" class="kwTab active" data-tab="base" aria-selected="true">ê¸°ë³¸</button>
    <button type="button" class="kwTab" data-tab="rep" aria-selected="false">ëŒ€í‘œ</button>
    <button type="button" class="kwTab" data-tab="ded" aria-selected="false">ì „ìš©</button>
  </div>

  <div style="margin-left:auto;">
    <button type="button" id="kwStateToggle" class="kwStateToggle buff">ë²„í”„</button>
    <button type="button" id="kwCloseBtn">ë‹«ê¸°</button>
  </div>
</div>

<div id="kwModalList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>

  <!-- âœ… í‚¤ì›Œë“œ íˆ´íŒ (ì—¬ê¸°ë¡œ ì´ë™!) -->
  <div id="kwTip" class="kwTip hidden" role="tooltip" aria-hidden="true">
    <div class="kwTipBox">
      <div class="kwTipIcon"><img id="kwTipImg" alt=""></div>
      <div class="kwTipBody">
        <div id="kwTipTitle" class="kwTipTitle"></div>
        <div id="kwTipText" class="kwTipText"></div>
      </div>
    </div>
  </div>

  <script>
/***********************
 * âœ… IndexedDB (ì´ë¯¸ì§€ ì˜êµ¬ ì €ì¥) ìœ í‹¸
 ***********************/
const MEDIA_DB_NAME = "limbus_addon_media_v1";
const MEDIA_DB_VER  = 1;
const MEDIA_STORE   = "images"; // key -> Blob

function openMediaDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(MEDIA_DB_NAME, MEDIA_DB_VER);

    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(MEDIA_STORE)){
        db.createObjectStore(MEDIA_STORE); // key: string, value: Blob
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPutBlob(key, blob){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readwrite");
    tx.objectStore(MEDIA_STORE).put(blob, key);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

async function idbGetBlob(key){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readonly");
    const req = tx.objectStore(MEDIA_STORE).get(key);
    req.onsuccess = () => { db.close(); resolve(req.result || null); };
    req.onerror = () => { db.close(); reject(req.error); };
  });
}

async function idbDel(key){
  const db = await openMediaDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(MEDIA_STORE, "readwrite");
    tx.objectStore(MEDIA_STORE).delete(key);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

function dataURLToBlob(dataURL){
  const [head, body] = String(dataURL).split(",", 2);
  const mime = (head.match(/data:(.*?);base64/)||[])[1] || "application/octet-stream";
  const bin = atob(body || "");
  const len = bin.length;
  const arr = new Uint8Array(len);
  for(let i=0;i<len;i++) arr[i] = bin.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function blobToDataURL(blob){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

async function exportCharacterToFile(charId){
  const data = loadCharData(charId);
  if(!data){
    alert("ìºë¦­í„° ë°ì´í„°ê°€ ì—†ì–´.");
    return;
  }

  // 1) ì–´ë–¤ ì´ë¯¸ì§€ í‚¤ë¥¼ í¬í•¨í• ì§€ ìˆ˜ì§‘
  const mediaKeys = new Set();

  // core portrait
  const corePortraitKey = data?.core?.portraitKey || "";
  if(corePortraitKey) mediaKeys.add(corePortraitKey);

  // dedicated keyword icons
  const dks = Array.isArray(data?.dedicatedKeywords) ? data.dedicatedKeywords : [];
  for(const k of dks){
    if(k?.iconKey) mediaKeys.add(k.iconKey);
  }

  // skill images
  const skills = Array.isArray(data?.skills) ? data.skills : [];
  for(const s of skills){
    if(s?.imgKey) mediaKeys.add(s.imgKey);
  }

  // 2) IndexedDBì—ì„œ Blob ì½ì–´ì„œ dataURLë¡œ íŒ¨í‚¹
  const media = {}; // key -> dataURL
  for(const key of mediaKeys){
    try{
      const blob = await idbGetBlob(key);
      if(blob){
        media[key] = await blobToDataURL(blob);
      }
    }catch(e){
      console.warn("media export fail:", key, e);
    }
  }

  // 3) ìµœì¢… ë‚´ë³´ë‚´ê¸° payload
  const payload = {
    kind: "limbus_char_export",
    version: 1,
    exportedAt: nowISO(),
    char: data,     // core/passives/skills/dedicatedKeywords ê·¸ëŒ€ë¡œ
    media: media    // ì´ë¯¸ì§€ë“¤(Blob -> dataURL)
  };

  const json = JSON.stringify(payload);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;

  const safeName = String(data?.name || "character").trim().replace(/[\\/:*?"<>|]/g, "_");
  a.download = `${safeName}.limbuschar.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => URL.revokeObjectURL(url), 500);
}

async function importCharacterFromFile(file){
  const text = await file.text();
  let pack = null;

  try{
    pack = JSON.parse(text);
  }catch(e){
    alert("íŒŒì¼ì´ JSONì´ ì•„ë‹ˆì•¼.");
    return;
  }

  if(!pack || pack.kind !== "limbus_char_export"){
    alert("ì´ íŒŒì¼ì€ ë‚´ë³´ë‚¸ ìºë¦­í„° íŒŒì¼ì´ ì•„ë‹Œ ê²ƒ ê°™ì•„.");
    return;
  }

  const data = pack.char;
  const media = pack.media || {};

  if(!data || !data.core){
    alert("ìºë¦­í„° ë°ì´í„°ê°€ ë¹„ì •ìƒ(ê¹¨ì§).");
    return;
  }

  // âœ… ìƒˆ ìºë¦­í„°ë¡œ ì €ì¥í•  ê±°ë¼ë©´ id ìƒˆë¡œ ë°œê¸‰
  // (ê¸°ì¡´ id ê·¸ëŒ€ë¡œ ë®ì–´ì“°ë©´ ì¶©ëŒ ê°€ëŠ¥)
  const newId = charUid();

  // 1) media ë³µì›: dataURL -> Blob -> IndexedDBì— key ê·¸ëŒ€ë¡œ ì €ì¥
  // (key ì´ë¦„ì´ core_portrait_v1 ê°™ì€ ê³ ì •í‚¤ë©´ ë‹¤ë¥¸ ìºë¦­í„°ì™€ ì¶©ëŒë‚  ìˆ˜ ìˆìŒ)
  // ê·¸ë˜ì„œ "í‚¤ ì¬ë§¤í•‘"ì´ ì•ˆì „í•¨. ì•„ë˜ëŠ” ì¬ë§¤í•‘ ë°©ì‹.

  const remap = {}; // oldKey -> newKey

  function remapKey(oldKey){
    if(!oldKey) return "";
    if(remap[oldKey]) return remap[oldKey];

    // ìºë¦­í„°ë³„ë¡œ ë¶„ë¦¬ë˜ê²Œ í‚¤ë¥¼ ìƒˆë¡œ ë§Œë“¦
    // ì˜ˆ: core_portrait_v1 -> core_portrait_<newId>
    const nk = `${oldKey}__${newId}`;
    remap[oldKey] = nk;
    return nk;
  }

  // core portraitKey remap
  if(data.core.portraitKey){
    data.core.portraitKey = remapKey(data.core.portraitKey);
  }

  // dk iconKey remap
  if(Array.isArray(data.dedicatedKeywords)){
    for(const k of data.dedicatedKeywords){
      if(k.iconKey) k.iconKey = remapKey(k.iconKey);
    }
  }

  // skill imgKey remap
  if(Array.isArray(data.skills)){
    for(const s of data.skills){
      if(s.imgKey) s.imgKey = remapKey(s.imgKey);
    }
  }

  // media ì €ì¥(ì¬ë§¤í•‘ëœ í‚¤ë¡œ)
  for(const [oldKey, dataURL] of Object.entries(media)){
    const newKey = remapKey(oldKey);
    try{
      const blob = dataURLToBlob(dataURL);
      await idbPutBlob(newKey, blob);
    }catch(e){
      console.warn("media import fail:", oldKey, e);
    }
  }

  // 2) char data ì €ì¥
  const name = (data?.name || data?.core?.name || "ê°€ì ¸ì˜¨ ìºë¦­í„°").trim();

  // char ì €ì¥ í¬ë§·(ë„¤ snapshotCurrentWorkspace êµ¬ì¡°ë‘ ë§ì¶¤)
  const saved = {
    version: 1,
    savedAt: nowISO(),
    name,
    core: data.core || null,
    passives: data.passives || [],
    skills: data.skills || [],
    dedicatedKeywords: data.dedicatedKeywords || [],
  };

  // charList ê°±ì‹ 
  const list = loadCharList();
  list.unshift({
    id: newId,
    name,
    createdAt: nowISO(),
    updatedAt: nowISO(),
  });
  saveCharList(list);
  saveCharData(newId, saved);

  alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${name}`);
  renderCharacterLibrary();
}

function makeObjectURLFromBlob(blob){
  return URL.createObjectURL(blob);
}

/***********************
 * âœ… ObjectURL ëˆ„ìˆ˜ ë°©ì§€(ë¦¬í”„ë ˆì‹œ/ì¬ë Œë” ì‹œ URL í•´ì œ)
 ***********************/
let _portraitObjectURL = "";
function setPortraitFromObjectURL(url){
  if(_portraitObjectURL){
    try{ URL.revokeObjectURL(_portraitObjectURL); }catch(e){}
    _portraitObjectURL = "";
  }
  if(!url){
    setPortrait("");
    return;
  }
  _portraitObjectURL = url;
  setPortrait(url);
}

// dk / modal ì•„ì´ì½˜ url í•´ì œìš©
const _iconObjectURLMap = new Map(); // key -> objectURL
function revokeIconURL(key){
  const u = _iconObjectURLMap.get(key);
  if(u){
    try{ URL.revokeObjectURL(u); }catch(e){}
    _iconObjectURLMap.delete(key);
  }
}

async function applyIconKeyToImg(imgEl, iconKey){
  const prevKey = imgEl?.dataset?.iconKey || "";
  if(prevKey && prevKey !== iconKey){
    revokeIconURL(prevKey);
  }
  if(imgEl?.dataset) imgEl.dataset.iconKey = iconKey || "";

  if(!iconKey){
    imgEl.src = "";
    imgEl.style.display = "none";
    return;
  }
  const blob = await idbGetBlob(iconKey);
  if(!blob){
    imgEl.src = "";
    imgEl.style.display = "none";
    return;
  }
  if(!_iconObjectURLMap.has(iconKey)){
    _iconObjectURLMap.set(iconKey, makeObjectURLFromBlob(blob));
  }
  imgEl.src = _iconObjectURLMap.get(iconKey);
  imgEl.style.display = "block";
}

/***********************
 * âœ… Character Save/Load (v1)
 ***********************/
const KEY_CHAR_LIST = "limbus_char_list_v1";       // [{id,name,updatedAt,createdAt}]
const KEY_CHAR_DATA_PREFIX = "limbus_char_";       // limbus_char_<id>_v1
const KEY_CHAR_DATA_SUFFIX = "_v1";

function nowISO(){ return new Date().toISOString(); }
function charUid(){ return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

let APP_MODE = "edit"; // "edit" | "view"
function setAppMode(mode){
  APP_MODE = (mode === "view") ? "view" : "edit";
  document.body.classList.toggle("readonly", APP_MODE === "view");

  // âœ… íƒ­ ë¼ë²¨ì€ ë³´ê¸° ëª¨ë“œì—ì„œë§Œ ë³€ê²½
  applyViewTabLabels();

  if(APP_MODE === "view"){
    applyViewCoreUI();
  }else{
    // âœ… í¸ì§‘ ëª¨ë“œë¡œ ëŒì•„ì˜¬ ë•Œ view ì „ìš© ì”ìƒ ì œê±°
    cleanupViewArtifacts();
  }
}

function applyViewTabLabels(){
  const coreBtn  = document.getElementById("tab-core");
  const pvBtn    = document.getElementById("tab-passive");
  const skBtn    = document.getElementById("tab-skill");   // âœ… ì¶”ê°€
  const dkBtn    = document.getElementById("tab-dk");      // (ë‚˜ì¤‘ìš©)

  // ì—†ìœ¼ë©´ ì¢…ë£Œ
  if(!coreBtn || !pvBtn || !skBtn) return;

  // ì›ë˜ í…ìŠ¤íŠ¸ ë°±ì—…(1íšŒ)
  if(!coreBtn.dataset.origText) coreBtn.dataset.origText = coreBtn.textContent;
  if(!pvBtn.dataset.origText)   pvBtn.dataset.origText   = pvBtn.textContent;
  if(!skBtn.dataset.origText)   skBtn.dataset.origText   = skBtn.textContent; // âœ… ì¶”ê°€
  if(dkBtn && !dkBtn.dataset.origText) dkBtn.dataset.origText = dkBtn.textContent;

  if(APP_MODE === "view"){
    coreBtn.textContent = coreBtn.dataset.origText; // í•µì‹¬ ì •ë³´ ê·¸ëŒ€ë¡œ
    pvBtn.textContent   = "íŒ¨ì‹œë¸Œ";
    skBtn.textContent   = "ìŠ¤í‚¬";                   // âœ… ì—¬ê¸°!
    dkBtn.textContent = "ì „ìš© í‚¤ì›Œë“œ";           // ë‚˜ì¤‘ì— ì¼œë©´ ë¨
  }else{
    coreBtn.textContent = coreBtn.dataset.origText;
    pvBtn.textContent   = pvBtn.dataset.origText;
    skBtn.textContent   = skBtn.dataset.origText;   // âœ… ë³µêµ¬
    if(dkBtn) dkBtn.textContent = dkBtn.dataset.origText;
  }
}

function cleanupViewArtifacts(){
  // âœ… ë³´ê¸° ëª¨ë“œì—ì„œ ë§Œë“¤ì–´ë‘” traitLine(ì¹© ìš”ì•½)ì´ í¸ì§‘ ëª¨ë“œì— ë‚¨ì•„ ë³´ì´ëŠ” ë¬¸ì œ ë°©ì§€
  const traitSection = [...document.querySelectorAll("#panel-core .frame")].find(f => {
    const h = f.querySelector(".hdr");
    return h && h.textContent.includes("íŠ¹ì„± í‚¤ì›Œë“œ");
  });
  const body = traitSection?.querySelector(".body");
  const old = body?.querySelector(".traitLine");
  if(old) old.remove();
}

function applyViewCoreUI(){
  if(APP_MODE !== "view") return;

  // 1) ì´ë¦„: ì…ë ¥ì¹¸ì„ "íƒ€ì´í‹€"ì²˜ëŸ¼ ë³´ì´ê²Œ
  const nameInput = document.getElementById("charName");
  if(nameInput){
    nameInput.style.fontSize = "26px";
    nameInput.style.fontWeight = "1000";
    nameInput.style.letterSpacing = "-0.02em";
    nameInput.style.color = "rgba(243,211,154,.98)";
    nameInput.style.textShadow = "0 2px 18px rgba(0,0,0,.55)";
    nameInput.style.textAlign = "left";
  }

  // 2) íŠ¹ì„± í‚¤ì›Œë“œ: 1ì¤„ ìš”ì•½ ìƒì„±
  const traitFrameBody = document.querySelector("#panel-core .frame .hdr:nth-child(1)"); // ì•ˆì „í•˜ì§€ ì•Šì•„ì„œ ì•„ë˜ ë°©ì‹ ì‚¬ìš©
  const traitSection = [...document.querySelectorAll("#panel-core .frame")].find(f => {
    const h = f.querySelector(".hdr");
    return h && h.textContent.includes("íŠ¹ì„± í‚¤ì›Œë“œ");
  });

  if(traitSection){
    const body = traitSection.querySelector(".body");
    if(body){
      // ê¸°ì¡´ ìš”ì•½ë°” ìˆìœ¼ë©´ ì œê±° í›„ ì¬ìƒì„±
      const old = body.querySelector(".traitLine");
      if(old) old.remove();

// âœ… í˜„ì¬ UIì— ë¡œë“œëœ í‚¤ì›Œë“œ ì½ê¸°(ì‚­ì œí‘œì‹œ í¬í•¨)
const rows = [...document.querySelectorAll("#traitKwList .kwRow")];

const items = rows
  .map(r => ({
    text: (r.querySelector(".kwInput")?.value || "").trim(),
    deleted: r.classList.contains("deleted")
  }))
  .filter(x => x.text);

const line = document.createElement("div");
line.className = "traitLine";

if(items.length === 0){
  line.textContent = "íŠ¹ì„± í‚¤ì›Œë“œ ì—†ìŒ";
} else {
  const wrap = document.createElement("div");
  wrap.className = "traitChips";

  for(const it of items){
    const chip = document.createElement("span");
    chip.className = "traitChip" + (it.deleted ? " deleted" : "");
    chip.textContent = it.text;
    wrap.appendChild(chip);
  }

  line.appendChild(wrap);
}

body.appendChild(line);
    }
  }
}

function loadCharList(){
  try{
    const raw = JSON.parse(localStorage.getItem(KEY_CHAR_LIST) || "[]");
    return Array.isArray(raw) ? raw : [];
  }catch(e){ return []; }
}
function saveCharList(list){
  localStorage.setItem(KEY_CHAR_LIST, JSON.stringify(list || []));
}
function charDataKey(id){
  return `${KEY_CHAR_DATA_PREFIX}${id}${KEY_CHAR_DATA_SUFFIX}`;
}
function loadCharData(id){
  try{
    return JSON.parse(localStorage.getItem(charDataKey(id)) || "null");
  }catch(e){ return null; }
}
function saveCharData(id, data){
  localStorage.setItem(charDataKey(id), JSON.stringify(data));
}

const viewLibrary = document.getElementById("view-library");
const libToast = document.getElementById("libToast");
const charListEl = document.getElementById("charList");

document.getElementById("btn-go-library").addEventListener("click", () => {
  hide(viewHome); hide(viewEditor);
  show(viewLibrary);
  setAppMode("edit"); // ë¼ì´ë¸ŒëŸ¬ë¦¬ ìì²´ëŠ” ì¡°ì‘ ê°€ëŠ¥
  renderCharacterLibrary();
});

document.getElementById("btn-lib-back").addEventListener("click", () => {
  setAppMode("edit");               // âœ… ì¶”ê°€
  hide(viewLibrary);
  show(viewHome);
});

document.getElementById("btn-save-as-character").addEventListener("click", () => {
  const snap = snapshotCurrentWorkspace();
  const id = charUid();

  // ëª©ë¡ ì €ì¥
  const list = loadCharList();
  list.unshift({
    id,
    name: snap.name,
    createdAt: nowISO(),
    updatedAt: nowISO(),
  });
  saveCharList(list);

  // ë³¸ë¬¸ ì €ì¥
  saveCharData(id, snap);

  toast(libToast, `ìºë¦­í„° ì €ì¥ ì™„ë£Œ: ${snap.name}`);
  renderCharacterLibrary();
});

function renderCharacterLibrary(){
  if(!charListEl) return;
  charListEl.innerHTML = "";

  const list = loadCharList();
  if(list.length === 0){
    const d = document.createElement("div");
    d.style.color = "rgba(238,241,255,.55)";
    d.style.fontSize = "13px";
    d.textContent = "ì•„ì§ ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ì–´. 'í˜„ì¬ ì‘ì—…ì„ ìºë¦­í„°ë¡œ ì €ì¥'ì„ ëˆŒëŸ¬ë´.";
    charListEl.appendChild(d);
    return;
  }

  for(const it of list){
    const row = document.createElement("div");
    row.style.border = "1px solid rgba(255,255,255,.10)";
    row.style.background = "rgba(0,0,0,.18)";
    row.style.borderRadius = "16px";
    row.style.padding = "12px";
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";

    const title = document.createElement("div");
    title.style.fontWeight = "900";
    title.textContent = it.name || "(ì´ë¦„ ì—†ìŒ)";

    const meta = document.createElement("div");
    meta.style.marginLeft = "auto";
    meta.style.display = "flex";
    meta.style.gap = "8px";

    const btnView = document.createElement("button");
    btnView.type = "button";
    btnView.textContent = "ë³´ê¸°";
btnView.addEventListener("click", () => {
  localStorage.setItem("limbus_app_mode_once", "view");
  localStorage.setItem("limbus_load_char_once", it.id);
  location.reload();
});

    const btnEdit = document.createElement("button");
    btnEdit.type = "button";
    btnEdit.className = "primary";
    btnEdit.textContent = "í¸ì§‘";
    btnEdit.addEventListener("click", async () => {
      const data = loadCharData(it.id);
      if(!data){ toast(libToast, "ìºë¦­í„° ë°ì´í„°ê°€ ì—†ì–´(ê¹¨ì¡Œì„ ìˆ˜ ìˆì–´)."); return; }

      // í¸ì§‘ ëª¨ë“œë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
      localStorage.setItem("limbus_app_mode_once", "edit");
      localStorage.setItem("limbus_load_char_once", it.id);
      location.reload();
    });

    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.className = "btnDanger";
    btnDel.textContent = "ì‚­ì œ";
    btnDel.addEventListener("click", () => {
      if(!confirm(`"${it.name}" ìºë¦­í„°ë¥¼ ì‚­ì œí• ê¹Œ? (ì´ë¯¸ì§€ëŠ” DBì— ë‚¨ì„ ìˆ˜ ìˆì–´)`)) return;

      const list2 = loadCharList().filter(x => x.id !== it.id);
      saveCharList(list2);
      localStorage.removeItem(charDataKey(it.id));
      toast(libToast, "ì‚­ì œ ì™„ë£Œ!");
      renderCharacterLibrary();
    });

const btnExport = document.createElement("button");
btnExport.type = "button";
btnExport.textContent = "ë‚´ë³´ë‚´ê¸°";
btnExport.addEventListener("click", async () => {
  try{
    await exportCharacterToFile(it.id);
  }catch(e){
    console.error(e);
    alert("ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨(ì´ë¯¸ì§€/ì €ì¥ê³µê°„ ë¬¸ì œì¼ ìˆ˜ ìˆì–´).");
  }
});

    meta.appendChild(btnView);
    meta.appendChild(btnEdit);
    meta.appendChild(btnExport);
    meta.appendChild(btnDel);

    row.appendChild(title);
    row.appendChild(meta);
    charListEl.appendChild(row);
  }
}

    // ===== view switch =====
    const viewHome = document.getElementById("view-home");
    const viewEditor = document.getElementById("view-editor");
    const homeToast = document.getElementById("home-toast");

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function toast(el, msg){
      if(!el) return;
      el.textContent = msg;
      el.style.display = "block";
    }
    function clearToast(el){
      if(!el) return;
      el.textContent = "";
      el.style.display = "none";
    }

document.getElementById("btn-go-editor").addEventListener("click", () => {
  setAppMode("edit");               // âœ… ì¶”ê°€
  hide(viewHome); show(viewEditor);
  clearToast(homeToast);
  selectTab("core");
  document.getElementById("charName").focus();
});

    document.getElementById("btn-back").addEventListener("click", () => {
      hide(viewEditor); show(viewHome);
      clearToast(homeToast);
    });

    document.getElementById("btn-play").addEventListener("click", () => {
      toast(homeToast, "í”Œë ˆì´ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¡œë¹„/ë§¤ì¹˜ë¡œ ì—°ê²°í• ê²Œ.");
    });

    // ===== tabs =====
    const tabs = {
      core: document.getElementById("tab-core"),
      passive: document.getElementById("tab-passive"),
      skill: document.getElementById("tab-skill"),
      dk: document.getElementById("tab-dk"),
    };
    const panels = {
      core: document.getElementById("panel-core"),
      passive: document.getElementById("panel-passive"),
      skill: document.getElementById("panel-skill"),
      dk: document.getElementById("panel-dk"),
    };
    function selectTab(key){
      Object.entries(tabs).forEach(([k,btn]) => btn.classList.toggle("active", k === key));
      Object.entries(panels).forEach(([k,p]) => p.classList.toggle("hidden", k !== key));
    }
    tabs.core.addEventListener("click", () => selectTab("core"));
    tabs.passive.addEventListener("click", () => selectTab("passive"));
    tabs.skill.addEventListener("click", () => selectTab("skill"));
    tabs.dk.addEventListener("click", () => selectTab("dk"));

    // ===== portrait upload preview =====
    const fileInput = document.getElementById("fileInput");
    const portraitImg = document.getElementById("portraitImg");
    const portraitPh = document.getElementById("portraitPh");
    const btnClearImg = document.getElementById("btnClearImg");

    function setPortrait(src){
      if(!src){
        portraitImg.style.display = "none";
        portraitImg.src = "";
        portraitPh.style.display = "block";
        return;
      }
      portraitImg.src = src;
      portraitImg.style.display = "block";
      portraitPh.style.display = "none";
    }

    // âœ… CORE portrait: IndexedDB í‚¤
    let corePortraitKey = "";

    // âœ… ì´ˆìƒí™” ì—…ë¡œë“œ: IndexedDBì— Blobìœ¼ë¡œ ì˜êµ¬ ì €ì¥
    fileInput.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      try{
        const dataURL = await compressImageToDataURL(f, {
          maxSize: 1024,
          mime: "image/webp",
          quality: 0.90
        });
        const blob = dataURLToBlob(dataURL);

        corePortraitKey = "core_portrait_v1";
        await idbPutBlob(corePortraitKey, blob);

        setPortraitFromObjectURL(makeObjectURLFromBlob(blob));
        toast(coreToast, "ì´ˆìƒí™” ì €ì¥ë¨(ì˜êµ¬).");
      }catch(err){
        console.error(err);
        toast(coreToast, "ì´ˆìƒí™” ì €ì¥ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì œí•œ/íŒŒì¼ ë¬¸ì œì¼ ìˆ˜ ìˆì–´).");
      }
    });

    btnClearImg.addEventListener("click", async () => {
      fileInput.value = "";
      setPortrait("");
      if(corePortraitKey){
        try{ await idbDel(corePortraitKey); }catch(e){}
      }
      corePortraitKey = "";
      toast(coreToast, "ì´ˆìƒí™” ì œê±° ì™„ë£Œ!");
    });

    // ===== resistance options / coeff / tones =====
    const OPTIONS = ["ë‚´ì„±", "ê²¬ë”¤", "ë³´í†µ", "ì•½ì ", "ì·¨ì•½"];
    const MULT = { "ë‚´ì„±":0.5, "ê²¬ë”¤":0.75, "ë³´í†µ":1.0, "ì•½ì ":1.5, "ì·¨ì•½":2.0 };

    function toneOf(v){
      if(v === "ì•½ì " || v === "ì·¨ì•½") return "tone-red";
      if(v === "ë‚´ì„±" || v === "ê²¬ë”¤") return "tone-gray";
      return "tone-normal";
    }
    function setTone(el, tone){
      el.classList.remove("tone-red","tone-gray","tone-normal");
      el.classList.add(tone);
    }
    function fmtCoef(v){
      const n = MULT[v] ?? 1.0;
      return `[x${n.toFixed(n % 1 === 0 ? 1 : 2)}]`;
    }
    function fillSelect(selectEl, defaultValue, onChange){
      selectEl.innerHTML = "";
      for(const opt of OPTIONS){
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        selectEl.appendChild(o);
      }
      selectEl.value = defaultValue || "ë³´í†µ";
      selectEl.addEventListener("change", onChange);
      onChange();
    }

    // physical
    const physSlash = document.getElementById("physSlash");
    const physPierce = document.getElementById("physPierce");
    const physBlunt = document.getElementById("physBlunt");
    const coef_physSlash = document.getElementById("coef_physSlash");
    const coef_physPierce = document.getElementById("coef_physPierce");
    const coef_physBlunt = document.getElementById("coef_physBlunt");

    function physUpdate(selectEl, coefEl){
      const box = selectEl.closest(".physBox");
      setTone(box, toneOf(selectEl.value));
      coefEl.textContent = fmtCoef(selectEl.value);
    }
    fillSelect(physSlash, "ë³´í†µ", () => physUpdate(physSlash, coef_physSlash));
    fillSelect(physPierce, "ë³´í†µ", () => physUpdate(physPierce, coef_physPierce));
    fillSelect(physBlunt, "ë³´í†µ", () => physUpdate(physBlunt, coef_physBlunt));

    // sins
    const sinIds = [
      ["sinWrath","coef_sinWrath"],
      ["sinLust","coef_sinLust"],
      ["sinSloth","coef_sinSloth"],
      ["sinGluttony","coef_sinGluttony"],
      ["sinGloom","coef_sinGloom"],
      ["sinPride","coef_sinPride"],
      ["sinEnvy","coef_sinEnvy"],
    ];
    for(const [selId, coefId] of sinIds){
      const sel = document.getElementById(selId);
      const coef = document.getElementById(coefId);
      fillSelect(sel, "ë³´í†µ", () => {
        setTone(sel.closest(".sinBox"), toneOf(sel.value));
        coef.textContent = fmtCoef(sel.value);
      });
    }

    // ===== stagger =====
    const markerLayer = document.getElementById("markerLayer");
    const tickLayer = document.getElementById("tickLayer");
    const btnAddStagger = document.getElementById("btnAddStagger");
    const btnDelStagger = document.getElementById("btnDelStagger");
    let staggers = [];

    function normalizePercent(input){
      const n = Number(String(input).trim());
      if(!Number.isFinite(n)) return null;
      if(n <= 0 || n >= 100) return null;
      return Math.round(n);
    }
    function renderStaggers(){
      markerLayer.innerHTML = "";
      tickLayer.innerHTML = "";
      const sorted = [...staggers].sort((a,b)=>a-b);
      for(const p of sorted){
        const m = document.createElement("div");
        m.className = "marker";
        m.style.left = `${p}%`;
        markerLayer.appendChild(m);

        const t = document.createElement("div");
        t.className = "tick";
        t.style.left = `${p}%`;
        t.textContent = `${p}%`;
        tickLayer.appendChild(t);
      }
    }
    btnDelStagger.addEventListener("click", () => { staggers = []; renderStaggers(); });
    btnAddStagger.addEventListener("click", () => {
      const ans = prompt("ëª‡ %ì— ííŠ¸ëŸ¬ì§ êµ¬ê°„ì„ ì¶”ê°€í• ê¹Œ? (1~99)");
      if(ans === null) return;
      const p = normalizePercent(ans);
      if(p === null){ alert("1~99 ì‚¬ì´ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜."); return; }
      if(staggers.includes(p)){ alert("ì´ë¯¸ ìˆëŠ” êµ¬ê°„ì´ì•¼."); return; }
      staggers.push(p);
      renderStaggers();
    });
    renderStaggers();

    // ===== íŠ¹ì„± í‚¤ì›Œë“œ =====
    const traitKwList = document.getElementById("traitKwList");
    const btnTraitKwAdd = document.getElementById("btnTraitKwAdd");

    function makeTraitRow(data = { text:"", deleted:false }){
      const row = document.createElement("div");
      row.className = "kwRow" + (data.deleted ? " deleted" : "");

      const input = document.createElement("input");
      input.className = "kwInput";
      input.type = "text";
      input.value = data.text || "";

      const btnToggle = document.createElement("button");
      btnToggle.type = "button";
      btnToggle.className = "btnSmall";
      btnToggle.textContent = data.deleted ? "í‚¤ì›Œë“œ ë³µêµ¬" : "í‚¤ì›Œë“œ ì§€ìš°ê¸°";

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btnSmall";
      btnDel.textContent = "ì‚­ì œ";

      btnToggle.addEventListener("click", () => {
        const isDeleted = row.classList.toggle("deleted");
        btnToggle.textContent = isDeleted ? "í‚¤ì›Œë“œ ë³µêµ¬" : "í‚¤ì›Œë“œ ì§€ìš°ê¸°";
      });

      btnDel.addEventListener("click", () => row.remove());

      row.appendChild(input);
      row.appendChild(btnToggle);
      row.appendChild(btnDel);
      return row;
    }

    btnTraitKwAdd.addEventListener("click", () => {
      traitKwList.appendChild(makeTraitRow());
    });
    traitKwList.appendChild(makeTraitRow());

    // ===== core save/reset =====
    const coreToast = document.getElementById("coreToast");
    const KEY_CORE = "limbus_addon_core_v10";

    function readTraitKeywords(){
      const rows = [...traitKwList.querySelectorAll(".kwRow")];
      return rows.map(r => ({
        text: r.querySelector(".kwInput")?.value ?? "",
        deleted: r.classList.contains("deleted")
      }));
    }
    function loadTraitKeywords(list){
      traitKwList.innerHTML = "";
      if(!Array.isArray(list) || list.length === 0){
        traitKwList.appendChild(makeTraitRow());
        return;
      }
      for(const it of list) traitKwList.appendChild(makeTraitRow(it));
    }

    document.getElementById("btnSaveCore").addEventListener("click", () => {
      const payload = {
        name: document.getElementById("charName").value,
        portraitKey: corePortraitKey || "", // âœ… ì´ë¯¸ì§€ ë¬¸ìì—´ ëŒ€ì‹  í‚¤ë§Œ ì €ì¥
        staggers: [...staggers],
        status: {
          hp: document.getElementById("statHp").value,
          spdMin: document.getElementById("statSpdMin").value,
          spdMax: document.getElementById("statSpdMax").value,
          defLv: document.getElementById("statDefLv").value,
        },
        phys: { slash: physSlash.value, pierce: physPierce.value, blunt: physBlunt.value },
        sins: Object.fromEntries(sinIds.map(([sid]) => [sid, document.getElementById(sid).value])),
        trait_keywords: readTraitKeywords(),
      };
      try{
        localStorage.setItem(KEY_CORE, JSON.stringify(payload));
        toast(coreToast, "ì €ì¥ ì™„ë£Œ!");
      }catch(e){
        toast(coreToast, "ì €ì¥ ì‹¤íŒ¨: ì €ì¥ê³µê°„ ì œí•œì¼ ìˆ˜ ìˆì–´.");
      }
    });

    document.getElementById("btnResetCore").addEventListener("click", async () => {
      document.getElementById("charName").value = "";
      fileInput.value = "";
      setPortrait("");

      if(corePortraitKey){
        try{ await idbDel(corePortraitKey); }catch(e){}
      }
      corePortraitKey = "";

      staggers = [];
      renderStaggers();

      document.getElementById("statHp").value = "";
      document.getElementById("statSpdMin").value = "";
      document.getElementById("statSpdMax").value = "";
      document.getElementById("statDefLv").value = "";

      physSlash.value = "ë³´í†µ"; physUpdate(physSlash, coef_physSlash);
      physPierce.value = "ë³´í†µ"; physUpdate(physPierce, coef_physPierce);
      physBlunt.value = "ë³´í†µ"; physUpdate(physBlunt, coef_physBlunt);

      for(const [sid, cid] of sinIds){
        const sel = document.getElementById(sid);
        const coef = document.getElementById(cid);
        sel.value = "ë³´í†µ";
        setTone(sel.closest(".sinBox"), "tone-normal");
        coef.textContent = fmtCoef("ë³´í†µ");
      }

      loadTraitKeywords([]);
      localStorage.removeItem(KEY_CORE);
      toast(coreToast, "ì´ˆê¸°í™” ì™„ë£Œ!");
    });

    // load core (async + êµ¬ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜)
    (async () => {
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_CORE) || "null");
        if(!saved) return;

        document.getElementById("charName").value = saved.name || "";

        corePortraitKey = saved.portraitKey || "";

        // âœ… êµ¬ë²„ì „: saved.portrait(dataURL) -> IndexedDBë¡œ ì´ê´€
        if(!corePortraitKey && saved.portrait && String(saved.portrait).startsWith("data:image/")){
          try{
            const blob = dataURLToBlob(saved.portrait);
            corePortraitKey = "core_portrait_v1";
            await idbPutBlob(corePortraitKey, blob);

            saved.portraitKey = corePortraitKey;
            delete saved.portrait;
            localStorage.setItem(KEY_CORE, JSON.stringify(saved));
          }catch(e){
            console.error("portrait migrate fail:", e);
          }
        }

        if(corePortraitKey){
          const blob = await idbGetBlob(corePortraitKey);
          if(blob){
            setPortraitFromObjectURL(makeObjectURLFromBlob(blob));
          }else{
            setPortrait("");
          }
        }else{
          setPortrait("");
        }

        if(Array.isArray(saved.staggers)){
          staggers = saved.staggers.map(normalizePercent).filter((x)=>typeof x === "number");
          staggers = [...new Set(staggers)];
        }
        renderStaggers();

        if(saved.status){
          document.getElementById("statHp").value = saved.status.hp ?? "";
          document.getElementById("statSpdMin").value = saved.status.spdMin ?? "";
          document.getElementById("statSpdMax").value = saved.status.spdMax ?? "";
          document.getElementById("statDefLv").value = saved.status.defLv ?? "";
        }
        if(saved.phys){
          physSlash.value = saved.phys.slash || "ë³´í†µ"; physUpdate(physSlash, coef_physSlash);
          physPierce.value = saved.phys.pierce || "ë³´í†µ"; physUpdate(physPierce, coef_physPierce);
          physBlunt.value = saved.phys.blunt || "ë³´í†µ"; physUpdate(physBlunt, coef_physBlunt);
        }
        if(saved.sins){
          for(const [sid, cid] of sinIds){
            const sel = document.getElementById(sid);
            const coef = document.getElementById(cid);
            sel.value = saved.sins[sid] || "ë³´í†µ";
            setTone(sel.closest(".sinBox"), toneOf(sel.value));
            coef.textContent = fmtCoef(sel.value);
          }
        }
        loadTraitKeywords(saved.trait_keywords || []);
        if(APP_MODE === "view") applyViewCoreUI();
      }catch(e){
        console.error("core load fail:", e);
      }
    })();


// ===== ì „ìš© í‚¤ì›Œë“œ =====
const KEY_DK = "limbus_addon_dedicated_keywords_v3";

/* âœ… ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ+ì••ì¶• -> dataURL ë°˜í™˜ */
async function compressImageToDataURL(file, {
  maxSize = 256,       // ì•„ì´ì½˜ì€ 128~256 ì¶”ì²œ, ì´ˆìƒí™”ëŠ” 768~1400
  mime = "image/webp", // webp ë¯¸ì§€ì›ì´ë©´ ìë™ìœ¼ë¡œ jpegë¡œ ë‚´ë ¤ê°
  quality = 0.82
} = {}){
  const dataURL = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(String(r.result || ""));
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  const img = await new Promise((res, rej) => {
    const im = new Image();
    im.onload = () => res(im);
    im.onerror = rej;
    im.src = dataURL;
  });

  const ow = img.naturalWidth || img.width;
  const oh = img.naturalHeight || img.height;

  const scale = Math.min(1, maxSize / Math.max(ow, oh));
  const w = Math.max(1, Math.round(ow * scale));
  const h = Math.max(1, Math.round(oh * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.drawImage(img, 0, 0, w, h);

  let out = canvas.toDataURL(mime, quality);
  if(mime === "image/webp" && !out.startsWith("data:image/webp")){
    out = canvas.toDataURL("image/jpeg", quality);
  }
  return out;
}

    const dkToast = document.getElementById("dkToast");

    const dkIconFile = document.getElementById("dkIconFile");
    const dkIconImg = document.getElementById("dkIconImg");
    const dkIconPh = document.getElementById("dkIconPh");
    const dkIconClear = document.getElementById("dkIconClear");

    const dkName = document.getElementById("dkName");
    const dkText = document.getElementById("dkText");
    const dkStateBtn = document.getElementById("dkStateBtn");
    const dkSaveBtn = document.getElementById("dkSaveBtn");
    const dkDeleteBtn = document.getElementById("dkDeleteBtn");
    const dkAddBtn = document.getElementById("dkAddBtn");
    const dkList = document.getElementById("dkList");

    /** @type {{id:string, name:string, text:string, state:'buff'|'debuff', iconKey:string}[]} */
    let dks = [];
    let activeDkId = null;
    let dkPendingIcon = "";

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function setDkIcon(src){
      if(!src){
        dkIconImg.style.display = "none";
        dkIconImg.src = "";
        dkIconPh.style.display = "block";
        return;
      }
      dkIconImg.src = src;
      dkIconImg.style.display = "block";
      dkIconPh.style.display = "none";
    }

    // ì—…ë¡œë“œ: ì¼ë‹¨ pending(dataURL)ë¡œë§Œ ì¡ì•„ë‘ê³ , "ì €ì¥" ëˆŒë €ì„ ë•Œ DBì— ì €ì¥
    dkIconFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      try{
        dkPendingIcon = await compressImageToDataURL(f, {
          maxSize: 256,
          mime: "image/webp",
          quality: 0.82
        });

        setDkIcon(dkPendingIcon);
        toast(dkToast, "ì•„ì´ì½˜ ì„ íƒë¨(ì••ì¶•ë¨). 'ì €ì¥'ì„ ëˆ„ë¥´ë©´ ì˜êµ¬ ë°˜ì˜ë¼.");
      }catch(err){
        console.error(err);
        toast(dkToast, "ì•„ì´ì½˜ ì²˜ë¦¬ ì‹¤íŒ¨(íŒŒì¼ì´ ì†ìƒëê±°ë‚˜ ë¸Œë¼ìš°ì € ì œí•œì¼ ìˆ˜ ìˆì–´).");
      }
    });

    dkIconClear.addEventListener("click", async () => {
      dkIconFile.value = "";
      setDkIcon("");
      dkPendingIcon = "";

      // âœ… ì„ íƒëœ í•­ëª©ì´ ìˆìœ¼ë©´: DBì—ì„œë„ ì‚­ì œ + iconKey ë¹„ìš°ê¸°
      if(activeDkId){
        const idx = dks.findIndex(x => x.id === activeDkId);
        if(idx >= 0){
          const oldKey = dks[idx].iconKey || "";
          if(oldKey){
            try{ await idbDel(oldKey); }catch(e){}
            revokeIconURL(oldKey);
          }
          dks[idx] = { ...dks[idx], iconKey: "" };
          saveDks();
          renderDkList();
          toast(dkToast, "ì•„ì´ì½˜ ì œê±° ì™„ë£Œ!");
          return;
        }
      }
    });

    function setDkState(state){
      if(state === "debuff"){
        dkStateBtn.textContent = "ë””ë²„í”„";
        dkStateBtn.classList.remove("buff");
        dkStateBtn.classList.add("debuff");
        dkStateBtn.dataset.state = "debuff";
      }else{
        dkStateBtn.textContent = "ë²„í”„";
        dkStateBtn.classList.remove("debuff");
        dkStateBtn.classList.add("buff");
        dkStateBtn.dataset.state = "buff";
      }
    }

    function dkAutosave(){
      if(!activeDkId) return;
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      dks[idx] = {
        ...dks[idx],
        name: dkName.value,
        text: dkText.value,
        state: (dkStateBtn.dataset.state === "debuff") ? "debuff" : "buff",
        // âœ… iconKeyëŠ” ìë™ì €ì¥ì—ì„œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      };
      saveDks();
    }

    dkName.addEventListener("input", dkAutosave);
    dkText.addEventListener("input", dkAutosave);

    dkStateBtn.addEventListener("click", () => {
      const cur = dkStateBtn.dataset.state || "buff";
      setDkState(cur === "buff" ? "debuff" : "buff");
      dkAutosave();
    });

    function saveDks(){
      try{
        localStorage.setItem(KEY_DK, JSON.stringify(dks));
      }catch(e){
        console.error("DK ì €ì¥ ì‹¤íŒ¨:", e);
        toast(dkToast, "ì „ìš© í‚¤ì›Œë“œ ì €ì¥ ì‹¤íŒ¨! (ê¶Œí•œ/ìš©ëŸ‰ ë¬¸ì œì¼ ìˆ˜ ìˆì–´)");
      }
    }

    function clearDkEditor(){
      activeDkId = null;
      dkName.value = "";
      dkText.value = "";
      dkIconFile.value = "";
      setDkIcon("");
      setDkState("buff");
      renderDkList();
    }

    async function loadDkToEditor(item){
      dkPendingIcon = "";
      activeDkId = item.id;
      dkName.value = item.name || "";
      dkText.value = item.text || "";
      setDkState(item.state || "buff");

      // ë¯¸ë¦¬ë³´ê¸°: IndexedDBì—ì„œ ì½ì–´ì˜¤ê¸°
      setDkIcon("");
      if(item.iconKey){
        try{
          const blob = await idbGetBlob(item.iconKey);
          if(blob){
            setDkIcon(makeObjectURLFromBlob(blob));
          }else{
            setDkIcon("");
          }
        }catch(e){
          console.error(e);
          setDkIcon("");
        }
      }

      renderDkList();
    }

    function displayTitle(k){
      const nm = String(k.name || "").trim();
      if(nm) return nm;
      const txt = String(k.text || "").trim();
      if(!txt) return "(ë‚´ìš© ì—†ìŒ)";
      const firstLine = txt.split("\n")[0].trim();
      return firstLine || "(ë‚´ìš© ì—†ìŒ)";
    }

    function renderDkList(){
      dkList.innerHTML = "";

      if(dks.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(238,241,255,.55)";
        empty.style.fontSize = "13px";
        empty.style.padding = "10px 6px";
        empty.textContent = "ì•„ì§ ì „ìš© í‚¤ì›Œë“œê°€ ì—†ì–´. ì•„ë˜ 'í‚¤ì›Œë“œ ì¶”ê°€'ë¡œ ë§Œë“¤ì.";
        dkList.appendChild(empty);
        return;
      }

      for(const k of dks){
        const item = document.createElement("div");
        const toneClass = (k.state === "debuff") ? " debuff" : " buff";
        item.className = "dkItem" + toneClass + (k.id === activeDkId ? " active" : "");

        const left = document.createElement("div");
        left.className = "dkLeft";

        const icon = document.createElement("div");
        icon.className = "dkMiniIcon";

        // âœ… iconKey -> IndexedDBë¡œ ë¡œë“œ
        const img = document.createElement("img");
        img.alt = "ì•„ì´ì½˜";
        img.style.display = "none";
        icon.appendChild(img);

        const ph = document.createElement("div");
        ph.className = "ph";
        ph.textContent = "ì•„ì´ì½˜";
        icon.appendChild(ph);

        if(k.iconKey){
          applyIconKeyToImg(img, k.iconKey).then(() => {
            if(img.style.display === "block") ph.style.display = "none";
          });
        }

        const titleEl = document.createElement("div");
        titleEl.className = "dkLeftTitle";
        titleEl.textContent = displayTitle(k);

        left.appendChild(icon);
        left.appendChild(titleEl);

        const meta = document.createElement("div");
        meta.className = "dkMeta";

        const d = document.createElement("div");
        d.className = "d";
        d.textContent = String(k.text || "").trim() || "(ë‚´ìš© ì—†ìŒ)";
        meta.appendChild(d);

        const tag = document.createElement("div");
        tag.className = "dkTag " + (k.state === "debuff" ? "debuff" : "buff");
        tag.textContent = (k.state === "debuff") ? "ë””ë²„í”„" : "ë²„í”„";

        item.appendChild(left);
        item.appendChild(meta);
        item.appendChild(tag);

        item.addEventListener("click", () => loadDkToEditor(k));
        dkList.appendChild(item);
      }
    }

    dkAddBtn.addEventListener("click", () => {
      const it = { id: uid(), name: "", text: "", state: "buff", iconKey: "" };
      dks.unshift(it);
      saveDks();
      loadDkToEditor(it);
      toast(dkToast, "ìƒˆ ì „ìš© í‚¤ì›Œë“œë¥¼ ë§Œë“¤ì—ˆì–´. ì´ë¦„/ë‚´ìš© ì‘ì„± í›„ ì €ì¥í•´ì¤˜.");
      selectTab("dk");
    });

    dkSaveBtn.addEventListener("click", async () => {
      if(!activeDkId){
        toast(dkToast, "ë¨¼ì € ì•„ë˜ì—ì„œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê±°ë‚˜, 'í‚¤ì›Œë“œ ì¶”ê°€'ë¡œ ë§Œë“¤ì–´ì¤˜.");
        return;
      }
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      // âœ… ê¸°ì¡´ iconKey ìœ ì§€
      let iconKey = dks[idx].iconKey || "";

      // âœ… pending ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ IndexedDBì— ì €ì¥(í‚¤ëŠ” í•­ëª© id ê¸°ë°˜ ê³ ì •)
      if(dkPendingIcon && String(dkPendingIcon).startsWith("data:image/")){
        try{
          const blob = dataURLToBlob(dkPendingIcon);
          iconKey = `dk_icon_${activeDkId}`;
          await idbPutBlob(iconKey, blob);
          revokeIconURL(iconKey); // ìºì‹œ URL ê°±ì‹ 
        }catch(e){
          console.error(e);
          toast(dkToast, "ì•„ì´ì½˜ ì €ì¥ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì œí•œ/í˜•ì‹ ë¬¸ì œ).");
          return;
        }
      }

      dks[idx] = {
        ...dks[idx],
        name: dkName.value,
        text: dkText.value,
        state: (dkStateBtn.dataset.state === "debuff") ? "debuff" : "buff",
        iconKey: iconKey || ""
      };

      saveDks();
      dkPendingIcon = "";
      toast(dkToast, "ì €ì¥ ì™„ë£Œ!");
      renderDkList();

      if(iconKey){
        try{
          const blob = await idbGetBlob(iconKey);
          if(blob) setDkIcon(makeObjectURLFromBlob(blob));
        }catch(e){}
      }
    });

    dkDeleteBtn.addEventListener("click", async () => {
      if(!activeDkId){
        toast(dkToast, "ì‚­ì œí•  í‚¤ì›Œë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
        return;
      }
      const idx = dks.findIndex(x => x.id === activeDkId);
      if(idx < 0) return;

      // âœ… ì•„ì´ì½˜ë„ ê°™ì´ ì‚­ì œ
      const oldKey = dks[idx].iconKey || "";
      if(oldKey){
        try{ await idbDel(oldKey); }catch(e){}
        revokeIconURL(oldKey);
      }

      dks.splice(idx, 1);
      saveDks();
      toast(dkToast, "í‚¤ì›Œë“œ ì‚­ì œ ì™„ë£Œ!");
      clearDkEditor();
    });

    // âœ… DK ì´ˆê¸° ë¡œë“œ + êµ¬ë²„ì „ icon(dataURL) ë§ˆì´ê·¸ë ˆì´ì…˜
    (async () => {
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_DK) || "[]");
        if(Array.isArray(saved)) dks = saved;

        let changed = false;
        for(const k of dks){
          // êµ¬ë²„ì „: icon(dataURL) -> iconKey(DB)
          if(k.icon && String(k.icon).startsWith("data:image/") && !k.iconKey){
            try{
              const blob = dataURLToBlob(k.icon);
              const key = `dk_icon_${k.id}`;
              await idbPutBlob(key, blob);
              k.iconKey = key;
              delete k.icon;
              changed = true;
            }catch(e){
              console.error("dk icon migrate fail:", e);
            }
          }
          if(k.icon && k.iconKey){
            delete k.icon;
            changed = true;
          }
        }
        if(changed) localStorage.setItem(KEY_DK, JSON.stringify(dks));
      }catch(e){
        console.error(e);
      }
      clearDkEditor();
    })();

    // ===== PASSIVE (ê°œí¸) =====
    const KEY_PV = "limbus_addon_passives_v1";

    const pvToast = document.getElementById("pvToast");
    const pvName = document.getElementById("pvName");
    const pvText = document.getElementById("pvText");
    const pvSaveBtn = document.getElementById("pvSaveBtn");
    const pvDeleteBtn = document.getElementById("pvDeleteBtn");
    const pvAddBtn = document.getElementById("pvAddBtn");
    const pvBoard = document.getElementById("pvBoard");
    const skList = document.getElementById("skList");
    const pvHighlightBtn = document.getElementById("pvHighlightBtn");
    const pvKeywordBtn = document.getElementById("pvKeywordBtn");
    const pvStyleBtns = [...document.querySelectorAll(".pvStyleBtn")];

    let passives = [];
    let activePvId = null;
    let activePvStyle = "brown"; // ë³´í†µ=brown | ì¤‘ìš”=orange | ë§¤ìš°ì¤‘ìš”=red

    function pvUid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function pvSaveStore(){
      try{ localStorage.setItem(KEY_PV, JSON.stringify(passives)); }catch(e){}
    }
    function pvLoadStore(){
      try{
        const saved = JSON.parse(localStorage.getItem(KEY_PV) || "[]");
        if(Array.isArray(saved)) passives = saved;
      }catch(e){}
    }
    function pvToastMsg(msg){
      toast(pvToast, msg);
    }
    function pvSetStyle(style){
      activePvStyle = style;
      pvStyleBtns.forEach(b => b.classList.toggle("active", b.dataset.style === style));
    }
    pvStyleBtns.forEach(btn => {
      btn.addEventListener("click", () => pvSetStyle(btn.dataset.style || "brown"));
    });

    function pvHasHighlightTokens(text){
      return String(text || "").includes("[[hl]]") || String(text || "").includes("[[/hl]]");
    }
    function pvWrapSelectionWithHighlight(){
      const el = pvText;
      const start = el.selectionStart ?? 0;
      const end = el.selectionEnd ?? 0;
      if(start === end) return false;

      const txt = el.value;
      const before = txt.slice(0, start);
      const sel = txt.slice(start, end);
      const after = txt.slice(end);

      el.value = before + "[[hl]]" + sel + "[[/hl]]" + after;
      const newPos = end + "[[hl]]".length + "[[/hl]]".length;
      el.focus();
      el.setSelectionRange(newPos, newPos);
      return true;
    }
    function pvStripAllHighlights(text){
      return String(text || "").replaceAll("[[hl]]","").replaceAll("[[/hl]]","");
    }

    pvHighlightBtn.addEventListener("click", () => {
      const ok = pvWrapSelectionWithHighlight();
      if(!ok){
        pvToastMsg("ê°•ì¡°í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì¤˜.");
        return;
      }
      pvToastMsg("ì„ íƒí•œ ë¶€ë¶„ì— ê°•ì¡°ë¥¼ ì ìš©í–ˆì–´.");
      pvRenderBoard();
    });

    /* âœ… ì „ìš©í‚¤ì›Œë“œ í† í° -> ì¹´ë“œì—ì„œ ìƒ‰ í‘œì‹œ */
/* âœ… ì „ìš©í‚¤ì›Œë“œ í† í° -> ì¹´ë“œì—ì„œ ìƒ‰ í‘œì‹œ */
function pvToHtml(text){
  const esc = String(text || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");

  return esc
    .replaceAll("[[hl]]", '<span class="pvHL">')
    .replaceAll("[[/hl]]", "</span>")
    .replaceAll(/\[\[kw:(buff|debuff):([^\]]+)\]\]/g, (m, st, name) => {
      const cls = (st === "debuff") ? "debuff" : "buff";
      const safeName = String(name).replaceAll('"', "&quot;");
      return `<span class="pvKW ${cls}" data-kw="${safeName}" data-state="${st}">${name}</span>`;
    });
}

    function pvDisplayTitle(p){
      const n = String(p.name || "").trim();
      if(n) return n;
      const t = pvStripAllHighlights(String(p.text || "")).trim();
      if(!t) return "(ë‚´ìš© ì—†ìŒ)";
      return (t.split("\n")[0] || "(ë‚´ìš© ì—†ìŒ)").trim();
    }

    function pvRenderBoard(){
      if(!pvBoard) return;
      pvBoard.innerHTML = "";

      if(passives.length === 0){
        const d = document.createElement("div");
        d.style.color = "rgba(238,241,255,.55)";
        d.style.fontSize = "13px";
        d.style.padding = "8px";
        d.textContent = "ì•„ì§ íŒ¨ì‹œë¸Œê°€ ì—†ì–´. ì˜¤ë¥¸ìª½ì˜ 'íŒ¨ì‹œë¸Œ ì¶”ê°€'ë¡œ ë§Œë“¤ì.";
        pvBoard.appendChild(d);
        return;
      }

      for(const p of passives){
        const card = document.createElement("div");
        card.className = "pvCard" + (p.id === activePvId ? " active" : "");

        const hdr = document.createElement("div");
        hdr.className = "pvHdr " + (p.style || "brown");
        hdr.textContent = pvDisplayTitle(p);

        const sl = document.createElement("div");
        sl.className = "slashes";
        sl.innerHTML = "<i></i><i></i><i></i>";
        hdr.appendChild(sl);

        const body = document.createElement("div");
        body.className = "pvBody";
        body.innerHTML = pvToHtml(p.text || "");

        card.appendChild(hdr);
        card.appendChild(body);

        card.addEventListener("click", () => {
          activePvId = p.id;
          pvName.value = p.name || "";
          pvText.value = p.text || "";
          pvSetStyle(p.style || "brown");
          pvRenderBoard();
        });

        pvBoard.appendChild(card);
      }
    }

    function pvClearEditor(){
      activePvId = null;
      pvName.value = "";
      pvText.value = "";
      pvSetStyle("brown");
      pvRenderBoard();
    }

    pvAddBtn.addEventListener("click", () => {
      const it = { id: pvUid(), name: "", text: "", style: "brown" };
      passives.push(it);
      pvSaveStore();

      activePvId = it.id;
      pvName.value = "";
      pvText.value = "";
      pvSetStyle("brown");

      pvRenderBoard();
      pvToastMsg("ìƒˆ íŒ¨ì‹œë¸Œë¥¼ ì¶”ê°€í–ˆì–´. ì´ë¦„/ë‚´ìš© ì‘ì„± í›„ ì €ì¥í•´ì¤˜.");
      selectTab("passive");
    });

    pvSaveBtn.addEventListener("click", () => {
      if(!activePvId){
        pvToastMsg("ë¨¼ì € ì•„ë˜ì—ì„œ íŒ¨ì‹œë¸Œë¥¼ ì„ íƒí•˜ê±°ë‚˜, 'íŒ¨ì‹œë¸Œ ì¶”ê°€'ë¡œ ë§Œë“¤ì–´ì¤˜.");
        return;
      }
      const idx = passives.findIndex(x => x.id === activePvId);
      if(idx < 0) return;

      passives[idx] = {
        ...passives[idx],
        name: pvName.value,
        text: pvText.value,
        style: activePvStyle
      };
      pvSaveStore();
      pvToastMsg("ì €ì¥ ì™„ë£Œ!");
      pvRenderBoard();
    });

    pvDeleteBtn.addEventListener("click", () => {
      if(!activePvId){
        pvToastMsg("ì‚­ì œí•  íŒ¨ì‹œë¸Œë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
        return;
      }
      const idx = passives.findIndex(x => x.id === activePvId);
      if(idx < 0) return;

      passives.splice(idx, 1);
      pvSaveStore();
      pvToastMsg("ì‚­ì œ ì™„ë£Œ!");
      pvClearEditor();
    });

/* ========= í‚¤ì›Œë“œ(ê¸°ë³¸/ëŒ€í‘œ/ì „ìš©) í”¼ì»¤ ========= */
const kwModal = document.getElementById("kwModal");
const kwCloseBtn = document.getElementById("kwCloseBtn");
const kwModalList = document.getElementById("kwModalList");
const kwModalTitle = document.getElementById("kwModalTitle");
const kwTabBtns = [...document.querySelectorAll(".kwTab")];
const kwStateToggle = document.getElementById("kwStateToggle");
let kwStateFilter = "buff"; // âœ… ê¸°ë³¸ì€ ë²„í”„ë§Œ

function setKwStateFilter(next){
  kwStateFilter = (next === "debuff") ? "debuff" : "buff";

  if(kwStateToggle){
    kwStateToggle.classList.remove("buff","debuff");
    kwStateToggle.classList.add(kwStateFilter);
    kwStateToggle.textContent = (kwStateFilter === "debuff") ? "ë””ë²„í”„" : "ë²„í”„";
  }

  renderKwModal(); // âœ… ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
}

kwStateToggle?.addEventListener("click", () => {
  setKwStateFilter(kwStateFilter === "buff" ? "debuff" : "buff");
});

/** âœ… ê¸°ë³¸/ëŒ€í‘œ í‚¤ì›Œë“œ(ìˆ˜ì • ë¶ˆê°€, assets ì•„ì´ì½˜) */
const REP_KEYWORDS = [
  // debuff
  { name:"í™”ìƒ", state:"debuff", icon:"assets/icon_rep_burn.png", text:"í„´ ì¢…ë£Œ ì‹œ, íš¨ê³¼ ìœ„ë ¥ë§Œí¼ ê³ ì • í”¼í•´ë¥¼ ë°›ê³  íšŸìˆ˜ 1 ê°ì†Œ" },
  { name:"ì¶œí˜ˆ", state:"debuff", icon:"assets/icon_rep_bleed.png", text:"ê³µê²© ìŠ¤í‚¬ì˜ ì½”ì¸ íŒì • ì‹œ, íš¨ê³¼ ìœ„ë ¥ë§Œí¼ ê³ ì • ì²´ë ¥ í”¼í•´ë¥¼ ë°›ìŒ. ê³µê²© ìŠ¤í‚¬ì˜ ì½”ì¸ íŒì • í›„ íšŸìˆ˜ 1 ê°ì†Œ" },
  { name:"ì§„ë™", state:"debuff", icon:"assets/icon_rep_tremor.png", text:"ì§„ë™ í­ë°œ ìŠ¤í‚¬ë¡œ í”¼ê²© ì‹œ, íš¨ê³¼ ìœ„ë ¥ë§Œí¼ ííŠ¸ëŸ¬ì§ ì†ìƒ. í„´ ì¢…ë£Œ í›„ íšŸìˆ˜ 1 ê°ì†Œ" },
  { name:"íŒŒì—´", state:"debuff", icon:"assets/icon_rep_rupture.png", text:"ê³µê²© ìŠ¤í‚¬ë¡œ í”¼ê²© ì‹œ, íš¨ê³¼ ìœ„ë ¥ë§Œí¼ ê³ ì • ì²´ë ¥ í”¼í•´ë¥¼ ë°›ìŒ. í”¼ê²© í›„ íšŸìˆ˜ 1 ê°ì†Œ" },
  { name:"ì¹¨ì ", state:"debuff", icon:"assets/icon_rep_sinking.png", text:"ê³µê²© ìŠ¤í‚¬ë¡œ í”¼ê²© ì‹œ, íš¨ê³¼ ìœ„ë ¥ë§Œí¼ ê³ ì • ì •ì‹ ë ¥ í”¼í•´ë¥¼ ë°›ìŒ (ì •ì‹ ë ¥ì´ ì—†ëŠ” ëŒ€ìƒì—ê²ŒëŠ” ìš°ìš¸ ì†ì„± í”¼í•´ë¡œ ì ìš©ë¨) í”¼ê²© í›„ íšŸìˆ˜ 1 ê°ì†Œ" },
  // buff
  { name:"ì¶©ì „", state:"buff", icon:"assets/icon_rep_charge.png", text:"ì†Œëª¨ ì‹œ íŠ¹ì • ìŠ¤í‚¬ì˜ ìœ„ë ¥ì´ ìƒìŠ¹í•¨. íšŸìˆ˜ë¥¼ ìµœëŒ€ 20ê¹Œì§€ ì–»ì„ ìˆ˜ ìˆìŒ. í„´ ì¢…ë£Œ ì‹œ íšŸìˆ˜ 1 ê°ì†Œ" },
  { name:"í˜¸í¡", state:"buff", icon:"assets/icon_rep_breath.png", text:"ì ì¤‘ ì‹œ íš¨ê³¼ ìœ„ë ¥ 1ë‹¹ 5%ì˜ í™•ë¥ ë¡œ 120%ì˜ ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…í˜. í„´ ì¢…ë£Œ ì‹œ, ì¹˜ëª…íƒ€ ë°œë™ í›„ íšŸìˆ˜ 1 ê°ì†Œ" },
];

const BASE_KEYWORDS = [
  // debuff
  { name:"ì·¨ì•½", state:"debuff", icon:"assets/icon_base_fragile.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ë¡œ ë°›ëŠ” í”¼í•´ê°€ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ì¦ê°€ (ìˆ˜ì¹˜ 1ë‹¹ 10%)" },
  { name:"ì†ë°•", state:"debuff", icon:"assets/icon_base_bind.png", text:"í•œ í„´ ë™ì•ˆ ì†ë„ê°€ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€/ê°ì†Œ" },
  { name:"ìœ„ë ¥ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_power_down.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"ê³µê²© ìœ„ë ¥ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_atk_power_down.png", text:"í•œ í„´ ë™ì•ˆ ê³µê²© ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"ìˆ˜ë¹„ ìœ„ë ¥ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_def_power_down.png", text:"í•œ í„´ ë™ì•ˆ ìˆ˜ë¹„ ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"í•© ìœ„ë ¥ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_clash_power_down.png", text:"í•© ì§„í–‰ ì‹œ, í•© ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"ë”í•˜ê¸° ì½”ì¸ ì•½í™”", state:"debuff", icon:"assets/icon_base_plus_coin_down.png", text:"í•œ í„´ ë™ì•ˆ ë”í•˜ê¸° ì½”ì¸ ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"ë¹¼ê¸° ì½”ì¸ ì•½í™”", state:"debuff", icon:"assets/icon_base_minus_coin_down.png", text:"í•œ í„´ ë™ì•ˆ ë¹¼ê¸° ì½”ì¸ ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ê°ì†Œ" },
  { name:"í”¼í•´ëŸ‰ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_damage_down.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ë¡œ ê°€í•˜ëŠ” í”¼í•´ê°€ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ 10%ì”© ê°ì†Œ (ìµœëŒ€ 10)" },
  { name:"ê³µê²© ë ˆë²¨ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_atk_level_down.png", text:"í•œ í„´ ë™ì•ˆ ê³µê²© ë ˆë²¨ì´ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ê°ì†Œ" },
  { name:"ë°©ì–´ ë ˆë²¨ ê°ì†Œ", state:"debuff", icon:"assets/icon_base_def_level_down.png", text:"í•œ í„´ ë™ì•ˆ ë°©ì–´ ë ˆë²¨ì´ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ê°ì†Œ" },
  { name:"ë§ˆë¹„", state:"debuff", icon:"assets/icon_base_paralysis.png", text:"í•œ í„´ ë™ì•ˆ ìˆ˜ì¹˜ë§Œí¼ ì½”ì¸ ìœ„ë ¥ì´ 0ìœ¼ë¡œ ê³ ì •" },

  // buff
  { name:"ë³´í˜¸", state:"buff", icon:"assets/icon_base_protection.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ë¡œ ë°›ëŠ” í”¼í•´ê°€ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ê°ì†Œ (ìˆ˜ì¹˜ 1ë‹¹ 10%)" },
  { name:"ì‹ ì†", state:"buff", icon:"assets/icon_base_haste.png", text:"í•œ í„´ ë™ì•ˆ ì†ë„ê°€ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"ìœ„ë ¥ ì¦ê°€", state:"buff", icon:"assets/icon_base_power_up.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"ê³µê²© ìœ„ë ¥ ì¦ê°€", state:"buff", icon:"assets/icon_base_atk_power_up.png", text:"í•œ í„´ ë™ì•ˆ ê³µê²© ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"ìˆ˜ë¹„ ìœ„ë ¥ ì¦ê°€", state:"buff", icon:"assets/icon_base_def_power_up.png", text:"í•œ í„´ ë™ì•ˆ ìˆ˜ë¹„ ìŠ¤í‚¬ì˜ ìµœì¢… ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"í•© ìœ„ë ¥ ì¦ê°€", state:"buff", icon:"assets/icon_base_clash_power_up.png", text:"í•© ì§„í–‰ ì‹œ, í•© ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"ë”í•˜ê¸° ì½”ì¸ ì¦ê°€", state:"buff", icon:"assets/icon_base_plus_coin_up.png", text:"í•œ í„´ ë™ì•ˆ ë”í•˜ê¸° ì½”ì¸ ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"ë¹¼ê¸° ì½”ì¸ ì¦ê°€", state:"buff", icon:"assets/icon_base_minus_coin_up.png", text:"í•œ í„´ ë™ì•ˆ ë¹¼ê¸° ì½”ì¸ ìœ„ë ¥ì´ ìˆ˜ì¹˜ë§Œí¼ ì¦ê°€" },
  { name:"í”¼í•´ëŸ‰ ì¦ê°€", state:"buff", icon:"assets/icon_base_damage_up.png", text:"í•œ í„´ ë™ì•ˆ ìŠ¤í‚¬ë¡œ ê°€í•˜ëŠ” í”¼í•´ê°€ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ 10%ì”© ì¦ê°€ (ìµœëŒ€ 10)" },
  { name:"ê³µê²© ë ˆë²¨ ì¦ê°€", state:"buff", icon:"assets/icon_base_atk_level_up.png", text:"í•œ í„´ ë™ì•ˆ ê³µê²© ë ˆë²¨ì´ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ì¦ê°€" },
  { name:"ë°©ì–´ ë ˆë²¨ ì¦ê°€", state:"buff", icon:"assets/icon_base_def_level_up.png", text:"í•œ í„´ ë™ì•ˆ ë°©ì–´ ë ˆë²¨ì´ ìˆ˜ì¹˜ì— ë¹„ë¡€í•˜ì—¬ ì¦ê°€" },
];

/** ì „ìš© í‚¤ì›Œë“œ ë¡œë“œ(localStorage) */
function loadDedicatedKeywords(){
  try{
    const raw = JSON.parse(localStorage.getItem(KEY_DK) || "[]");
    if(Array.isArray(raw)) return raw;
  }catch(e){}
  return [];
}

/** íƒ­ ìƒíƒœ */
let kwActiveTab = "base"; // base | rep | ded

function setKwTab(tab){
  kwActiveTab = tab;
  kwTabBtns.forEach(b => {
    const on = (b.dataset.tab === tab);
    b.classList.toggle("active", on);
    b.setAttribute("aria-selected", on ? "true" : "false");
  });

  if(kwModalTitle){
    kwModalTitle.textContent =
      (tab === "base") ? "ê¸°ë³¸ í‚¤ì›Œë“œ" :
      (tab === "rep")  ? "ëŒ€í‘œ í‚¤ì›Œë“œ" : "ì „ìš© í‚¤ì›Œë“œ";
  }
  renderKwModal();
}

function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end = textarea.selectionEnd ?? textarea.value.length;
  const v = textarea.value;
  textarea.value = v.slice(0, start) + text + v.slice(end);
  const pos = start + text.length;
  textarea.focus();
  textarea.setSelectionRange(pos, pos);
}

let kwTargetTextarea = null;

function openKwModalFor(textarea){
  kwTargetTextarea = textarea || pvText;
  kwModal.classList.remove("hidden");
  setKwTab(kwActiveTab);
}
function openKwModal(){
  openKwModalFor(pvText);
}
function closeKwModal(){
  kwModal.classList.add("hidden");
}

/** ê³µí†µ ë Œë” row */
function makeKwRow({name, state, iconSrc, iconKey, isDedicated}){
  const row = document.createElement("button");
  row.type = "button";
  row.style.display = "grid";
  row.style.gridTemplateColumns = "52px 1fr 90px";
  row.style.gap = "10px";
  row.style.alignItems = "center";
  row.style.textAlign = "left";
  row.style.padding = "12px";
  row.style.borderRadius = "14px";

  const icon = document.createElement("div");
  icon.style.width = "48px";
  icon.style.height = "48px";
  icon.style.borderRadius = "14px";
  icon.style.border = "1px solid rgba(255,255,255,.12)";
  icon.style.background = "rgba(0,0,0,.22)";
  icon.style.display = "grid";
  icon.style.placeItems = "center";
  icon.style.overflow = "hidden";

  // ì•„ì´ì½˜: (1) assets ê²½ë¡œ (2) ì „ìš©í‚¤ì›Œë“œ iconKey(IndexedDB)
  const img = document.createElement("img");
  img.alt = "ì•„ì´ì½˜";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.display = "none";
  icon.appendChild(img);

  const ph = document.createElement("div");
  ph.textContent = "ì•„ì´ì½˜";
  ph.style.fontSize = "11px";
  ph.style.color = "rgba(238,241,255,.45)";
  icon.appendChild(ph);

  if(iconSrc){
    img.src = iconSrc;
    img.style.display = "block";
    ph.style.display = "none";
  }else if(isDedicated && iconKey){
    applyIconKeyToImg(img, iconKey).then(() => {
      if(img.style.display === "block") ph.style.display = "none";
    });
  }

  const title = document.createElement("div");
  title.style.fontWeight = "900";
  title.style.color = "rgba(243,211,154,.95)";
  title.textContent = name;

  const isDebuff = (state === "debuff");
  const tag = document.createElement("div");
  tag.textContent = isDebuff ? "ë””ë²„í”„" : "ë²„í”„";
  tag.style.fontWeight = "900";
  tag.style.fontSize = "12px";
  tag.style.padding = "8px 10px";
  tag.style.borderRadius = "999px";
  tag.style.border = "1px solid rgba(255,255,255,.12)";
  tag.style.background = "rgba(0,0,0,.18)";
  tag.style.textAlign = "center";
  tag.style.color = isDebuff ? "rgba(255,120,120,.98)" : "rgba(243,211,154,.95)";

  row.appendChild(icon);
  row.appendChild(title);
  row.appendChild(tag);

    // âœ… í† í°ì€ í†µì¼: ì–´ë””ì„œ ì˜¤ë“  ë™ì¼í•˜ê²Œ [[kw:state:name]]
row.addEventListener("click", async () => {
  const nm = String(name || "").trim() || "í‚¤ì›Œë“œ";
  const st = (state === "debuff") ? "debuff" : "buff";

  const target = kwTargetTextarea || pvText;
  insertAtCursor(target, `[[kw:${st}:${nm}]]`);
  closeKwModal();

  // âœ… íƒ€ê²Ÿì— ë”°ë¼ ê°±ì‹ 
  if(target === skText){
    await renderSkillPreview();
  }else{
    pvRenderBoard();
  }
});

  return row;
}

function renderKwModal(){
  kwModalList.innerHTML = "";

  // íƒ­ë³„ ë°ì´í„°
  if(kwActiveTab === "base"){
    for(const k of BASE_KEYWORDS){
      if(k.state !== kwStateFilter) continue;
      kwModalList.appendChild(makeKwRow({
        name: k.name,
        state: k.state,
        iconSrc: k.icon,
        isDedicated: false
      }));
    }
    return;
  }

  if(kwActiveTab === "rep"){
    for(const k of REP_KEYWORDS){
      if(k.state !== kwStateFilter) continue;
      kwModalList.appendChild(makeKwRow({
        name: k.name,
        state: k.state,
        iconSrc: k.icon,
        isDedicated: false
      }));
    }
    return;
  }

  // ì „ìš©
  const list = loadDedicatedKeywords();

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "rgba(238,241,255,.55)";
    empty.style.fontSize = "13px";
    empty.style.padding = "8px";
    empty.textContent = "ì „ìš© í‚¤ì›Œë“œê°€ ì—†ì–´. ì „ìš© í‚¤ì›Œë“œ íƒ­ì—ì„œ ë¨¼ì € ë§Œë“¤ì–´ì¤˜.";
    kwModalList.appendChild(empty);
    return;
  }

  const filtered = list.filter(k => {
    const st = (k.state === "debuff") ? "debuff" : "buff";
    return st === kwStateFilter;
  });

  if(filtered.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "rgba(238,241,255,.55)";
    empty.style.fontSize = "13px";
    empty.style.padding = "8px";
    empty.textContent = (kwStateFilter === "debuff")
      ? "ë””ë²„í”„ ì „ìš© í‚¤ì›Œë“œê°€ ì—†ì–´."
      : "ë²„í”„ ì „ìš© í‚¤ì›Œë“œê°€ ì—†ì–´.";
    kwModalList.appendChild(empty);
    return;
  }

  for(const k of filtered){
    const nm = (k.name && String(k.name).trim()) ? k.name : "(ì´ë¦„ ì—†ìŒ)";
    kwModalList.appendChild(makeKwRow({
      name: nm,
      state: (k.state === "debuff") ? "debuff" : "buff",
      iconKey: k.iconKey || "",
      isDedicated: true
    }));
  }
} // âœ… ì´ ë‹«ëŠ” ì¤‘ê´„í˜¸ê°€ ì—†ì–´ì„œ ë¨¹í†µë‚¬ë˜ ê±°ì•¼

// âœ… íƒ­ í´ë¦­(í•¨ìˆ˜ ë°–!)
kwTabBtns.forEach(btn => {
  btn.addEventListener("click", () => setKwTab(btn.dataset.tab || "base"));
});

// âœ… ì—´ê¸°/ë‹«ê¸°(í•¨ìˆ˜ ë°–!)
pvKeywordBtn?.addEventListener("click", () => openKwModalFor(pvText));
kwCloseBtn?.addEventListener("click", closeKwModal);
kwModal?.addEventListener("click", (e) => { if(e.target === kwModal) closeKwModal(); });

/* ========= í‚¤ì›Œë“œ Hover Tooltip ========= */
const kwTip = document.getElementById("kwTip");
const kwTipImg = document.getElementById("kwTipImg");
const kwTipTitle = document.getElementById("kwTipTitle");
const kwTipText = document.getElementById("kwTipText");

function findKeywordAny(name){
  const key = String(name || "").trim();
  if(!key) return null;

  // 1) ê¸°ë³¸
  let hit = BASE_KEYWORDS.find(x => String(x.name || "").trim() === key);
  if(hit){
    return { name: hit.name, state: hit.state, text: hit.text, iconSrc: hit.icon, isDedicated:false, iconKey:"" };
  }

  // 2) ëŒ€í‘œ
  hit = REP_KEYWORDS.find(x => String(x.name || "").trim() === key);
  if(hit){
    return { name: hit.name, state: hit.state, text: hit.text, iconSrc: hit.icon, isDedicated:false, iconKey:"" };
  }

  // 3) ì „ìš©(IndexedDB)
  const list = loadDedicatedKeywords();
  // ì™„ì „ì¼ì¹˜
  hit = list.find(x => String(x.name || "").trim() === key);
  if(!hit){
    // ëŠìŠ¨ ë§¤ì¹­
    hit = list.find(x => {
      const n = String(x.name || "").trim();
      return n && (n.includes(key) || key.includes(n));
    });
  }
  if(hit){
    return {
      name: String(hit.name || "").trim() || key,
      state: (hit.state === "debuff") ? "debuff" : "buff",
      text: String(hit.text || "").trim(),
      iconSrc: "",
      isDedicated: true,
      iconKey: hit.iconKey || ""
    };
  }

  return null;
}

async function showKwTipFor(name, stateHint, clientX, clientY){
  const info = findKeywordAny(name);

  const titleText = String(name || "").trim() || "í‚¤ì›Œë“œ";
  kwTipTitle.textContent = titleText;

  // âœ… ìƒ‰: ì°¾ì€ state ìš°ì„ , ì—†ìœ¼ë©´ í† í°ì˜ data-state íŒíŠ¸ ì‚¬ìš©
  const st = info?.state || (stateHint === "debuff" ? "debuff" : "buff");
  kwTipTitle.classList.remove("buff","debuff");
  kwTipTitle.classList.add(st === "debuff" ? "debuff" : "buff");

  // âœ… í…ìŠ¤íŠ¸
  if(info && info.text){
    kwTipText.textContent = info.text;
  }else{
    kwTipText.textContent = "ìƒì„¸ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì–´.";
  }

  // âœ… ì•„ì´ì½˜: (ê¸°ë³¸/ëŒ€í‘œ)=assets src, (ì „ìš©)=IndexedDB iconKey
  if(info?.iconSrc){
    kwTipImg.src = info.iconSrc;
    kwTipImg.style.display = "block";
  }else if(info?.isDedicated && info.iconKey){
    await applyIconKeyToImg(kwTipImg, info.iconKey);
    kwTipImg.style.display = (kwTipImg.src ? "block" : "none");
  }else{
    kwTipImg.src = "";
    kwTipImg.style.display = "none";
  }

  kwTip.classList.remove("hidden");
  kwTip.setAttribute("aria-hidden", "false");

  const pad = 14;
  const offset = 16;

  // ì„ì‹œ ìœ„ì¹˜
  kwTip.style.left = (clientX + offset) + "px";
  kwTip.style.top  = (clientY + offset) + "px";

  // í™”ë©´ ë°”ê¹¥ ë³´ì •
  const rect = kwTip.getBoundingClientRect();
  let x = clientX + offset;
  let y = clientY + offset;

  if(x + rect.width + pad > window.innerWidth) x = clientX - rect.width - offset;
  if(y + rect.height + pad > window.innerHeight) y = clientY - rect.height - offset;

  x = Math.max(pad, Math.min(x, window.innerWidth - rect.width - pad));
  y = Math.max(pad, Math.min(y, window.innerHeight - rect.height - pad));

  kwTip.style.left = x + "px";
  kwTip.style.top  = y + "px";
}

function hideKwTip(){
  kwTip.classList.add("hidden");
  kwTip.setAttribute("aria-hidden", "true");
}

/* âœ… pvBoard ì•ˆì˜ .pvKWì— hoverë¡œë§Œ í‘œì‹œ (ë–¼ë©´ ì¦‰ì‹œ ì‚¬ë¼ì§) */
pvBoard.addEventListener("mousemove", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  const kwEl = t.closest(".pvKW");
  if(!kwEl) { hideKwTip(); return; }

  const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
  const stateHint = kwEl.getAttribute("data-state") || ""; // âœ… base/repë„ ì—¬ê¸° ë“¤ì–´ìˆìŒ
  showKwTipFor(name, stateHint, e.clientX, e.clientY);
});

/* âœ… í‚¤ì›Œë“œ(span.pvKW)ì—ì„œ ë²—ì–´ë‚˜ë©´ ì¦‰ì‹œ ìˆ¨ê¹€ */
pvBoard.addEventListener("mouseout", (e) => {
  const from = e.target;
  if(!(from instanceof HTMLElement)) return;

  const fromKw = from.closest(".pvKW");
  if(!fromKw) return;

  const to = e.relatedTarget;
  if(to instanceof HTMLElement && to.closest(".pvKW")) return;

  hideKwTip();
});

/* âœ… ë³´ë“œ ìì²´ë¥¼ ë– ë‚˜ë„ ìˆ¨ê¹€ */
pvBoard.addEventListener("mouseleave", hideKwTip);

// âœ… ìŠ¤í‚¬ ëª©ë¡ì—ì„œë„ í‚¤ì›Œë“œ íˆ´íŒ ì‘ë™
skList?.addEventListener("mousemove", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  const kwEl = t.closest(".pvKW");
  if(!kwEl) { hideKwTip(); return; }

  const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
  const stateHint = kwEl.getAttribute("data-state") || "";
  showKwTipFor(name, stateHint, e.clientX, e.clientY);
});

skList?.addEventListener("mouseout", (e) => {
  const from = e.target;
  if(!(from instanceof HTMLElement)) return;

  const fromKw = from.closest(".pvKW");
  if(!fromKw) return;

  const to = e.relatedTarget;
  if(to instanceof HTMLElement && to.closest(".pvKW")) return;

  hideKwTip();
});

skList?.addEventListener("mouseleave", hideKwTip);
    pvLoadStore();
    pvClearEditor();
    pvRenderBoard();



function toRoman(num){
  const romanMap = [
    { value: 1000, numeral: "M" },
    { value: 900, numeral: "CM" },
    { value: 500, numeral: "D" },
    { value: 400, numeral: "CD" },
    { value: 100, numeral: "C" },
    { value: 90, numeral: "XC" },
    { value: 50, numeral: "L" },
    { value: 40, numeral: "XL" },
    { value: 10, numeral: "X" },
    { value: 9, numeral: "IX" },
    { value: 5, numeral: "V" },
    { value: 4, numeral: "IV" },
    { value: 1, numeral: "I" }
  ];

  let result = "";
  let n = Math.floor(Number(num) || 0);
  if(n <= 0) return "";

  for(const item of romanMap){
    while(n >= item.value){
      result += item.numeral;
      n -= item.value;
    }
  }
  return result;
}

// ===== SKILL =====
const KEY_SK = "limbus_addon_skills_v1";

const skToast = document.getElementById("skToast");
const skName = document.getElementById("skName");
const skAtkType = document.getElementById("skAtkType");
const skSin = document.getElementById("skSin");
const skTier = document.getElementById("skTier");
const skAtkLevel = document.getElementById("skAtkLevel");
const skGrowth   = document.getElementById("skGrowth");
const skPrevGrowthBase = document.getElementById("skPrevGrowthBase"); // ê³µê²©ë ˆë²¨ í‘œì‹œ
const skPrevGrowthPlus = document.getElementById("skPrevGrowthPlus"); // ì„±ì¥ê³„ìˆ˜ í‘œì‹œ
const skPrevGrowthSign = document.getElementById("skPrevGrowthSign");
const skPower = document.getElementById("skPower");
const skCoinPower = document.getElementById("skCoinPower");
const skCoinSignBtn = document.getElementById("skCoinSignBtn");
const skWeight = document.getElementById("skWeight");
const skText = document.getElementById("skText");

const skKeywordBtn = document.getElementById("skKeywordBtn");
skKeywordBtn?.addEventListener("click", () => openKwModalFor(skText));
const skHighlightBtn = document.getElementById("skHighlightBtn");
const skSaveBtn = document.getElementById("skSaveBtn");
const skDeleteBtn = document.getElementById("skDeleteBtn");
const skNewBtn = document.getElementById("skNewBtn");

const skImgFile = document.getElementById("skImgFile");
const skImgClear = document.getElementById("skImgClear");
const skImgEl = document.getElementById("skImgEl");
const skImgPh = document.getElementById("skImgPh");
const skAtkIcon = document.getElementById("skAtkIcon");
const skSinIcon = document.getElementById("skSinIcon");
const skFrameImg = document.getElementById("skFrameImg");
const skInnerImg = document.getElementById("skInnerImg");
const skTitleTxt = document.getElementById("skTitleTxt");
const skTitleBar = document.getElementById("skTitleBar");

const skPrevAtkIcon = document.getElementById("skPrevAtkIcon");
const skPrevSinIcon = document.getElementById("skPrevSinIcon");
const skPrevAtk = document.getElementById("skPrevAtk");
const skPrevSin = document.getElementById("skPrevSin");

const skPrevPow = document.getElementById("skPrevPow");
const skPrevCoin = document.getElementById("skPrevCoin");
const skPrevW = document.getElementById("skPrevW");
const skCoinType = document.getElementById("skCoinType");
const skCoinCount = document.getElementById("skCoinCount");
const skCoinRow = document.getElementById("skCoinRow");
const skEffectBox = document.getElementById("skEffectBox");

const skGreenBtn = document.getElementById("skGreenBtn");
const skBlueBtn  = document.getElementById("skBlueBtn");
const skRedBtn   = document.getElementById("skRedBtn");

const skCoinEffectBtn = document.getElementById("skCoinEffectBtn");

/** @type {{id:string,name:string,atkType:'slash'|'pierce'|'blunt',sin:string,tier:number,atkLevel:number,growth:number,qty:number,power:number,coinSign:'+'|'-',coinPower:number,weight:number,text:string,imgKey:string,coinType?:string,coinCount?:number}[]} */
let skills = [];
let activeSkId = null;
let skPendingImgDataURL = "";

function skUid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function skSaveStore(){
  try{
    // âœ… localStorageì—ëŠ” "ê°€ë²¼ìš´ ë°ì´í„°ë§Œ" ì €ì¥í•œë‹¤ (ì´ë¯¸ì§€ëŠ” imgKeyë§Œ)
    const compact = skills.map(s => ({
      id: s.id,
      name: s.name || "",
      atkType: s.atkType || "pierce",
      sin: s.sin || "pride",
      tier: Number(s.tier || 1),
      power: Number(s.power || 0),
      coinSign: (s.coinSign === "-") ? "-" : "+",
      coinPower: Number(s.coinPower || 0),
      atkLevel: Number(s.atkLevel || 0),
      growth: Number(s.growth || 0),
      weight: Number(s.weight || 0),
      coinType: s.coinType || "normal",
      coinCount: Number(s.coinCount || 1),
      text: s.text || "",
      imgKey: s.imgKey || "" // âœ… í‚¤ë§Œ!
    }));

    const raw = JSON.stringify(compact);
    localStorage.setItem(KEY_SK, raw);

    const ok = localStorage.getItem(KEY_SK);
    if(ok !== raw) throw new Error("localStorage write verify failed");

    return true;
  }catch(e){
    console.error("SK ì €ì¥ ì‹¤íŒ¨:", e);
    const isQuota =
      String(e?.name || "").includes("Quota") ||
      String(e || "").includes("Quota") ||
      String(e || "").includes("QUOTA");

    const msg = isQuota
      ? "ìŠ¤í‚¬ ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ì €ì¥ê³µê°„(localStorage)ì´ ê½‰ ì°¼ì–´. (í° ë¬¸ìì—´ì´ ì„ì˜€ì„ ê°€ëŠ¥ì„± ë†’ìŒ)"
      : "ìŠ¤í‚¬ ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì €ê°€ ì €ì¥ì„ ë§‰ì•˜ê±°ë‚˜(ì‹œí¬ë¦¿/ê¶Œí•œ), ì½”ë“œ ì—ëŸ¬ê°€ ìˆì–´.";

    try{ toast(skToast, msg); }catch(_){}
    return false;
  }
}

function skLoadStore(){
  try{
    const raw = localStorage.getItem(KEY_SK);
    if(!raw){
      skills = [];
      return;
    }
    const saved = JSON.parse(raw);
    skills = Array.isArray(saved) ? saved : [];
  }catch(e){
    console.error("SK ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
    skills = [];
    try{ toast(skToast, "ìŠ¤í‚¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì €ì¥ ë°ì´í„°ê°€ ê¹¨ì¡Œê±°ë‚˜ JSON íŒŒì‹± ì˜¤ë¥˜ì•¼."); }catch(_){}
  }
}

function setSkImgPreview(src){
  if(!src){
    skImgEl.style.display = "none";
    skImgEl.src = "";
    skImgPh.style.display = "block";
    return;
  }
  skImgEl.src = src;
  skImgEl.style.display = "block";
  skImgPh.style.display = "none";
}

function atkLabel(v){
  if(v === "slash") return "ì°¸ê²©";
  if(v === "pierce") return "ê´€í†µ";
  return "íƒ€ê²©";
}
function sinLabel(v){
  const map = {
    wrath:"ë¶„ë…¸", lust:"ìƒ‰ìš•", sloth:"ë‚˜íƒœ", gluttony:"íƒì‹",
    melancholy:"ìš°ìš¸", pride:"ì˜¤ë§Œ", envy:"ì§ˆíˆ¬"
  };
  return map[v] || v;
}

/** âœ… í”„ë ˆì„ ì´ë¯¸ì§€ ê²½ë¡œ */
function framePath(sin, tier){
  const t = Math.min(3, Math.max(1, Number(tier)||1));
  const s = String(sin || "wrath").trim();
  return `assets/frame_${s}_${t}.png`;
}

function coinIconPath(type){
  const map = {
    normal: "assets/icon_coin_normal.png",
    fixed: "assets/icon_coin_fixed.png",
    extract: "assets/icon_coin_extract.png",
    annihilate: "assets/icon_coin_annihilate.png"
  };
  return map[type] || "";
}

function atkIconPath(atk){
  if(atk === "slash") return "assets/icon_slash.png";
  if(atk === "pierce") return "assets/icon_pierce.png";
  return "assets/icon_blunt.png";
}

function coinIconPath(type){
  const map = {
    normal: "assets/icon_coin_normal.png",
    fixed: "assets/icon_coin_fixed.png",
    extract: "assets/icon_coin_extract.png",
    annihilate: "assets/icon_coin_annihilate.png"
  };
  return map[type] || "";
}

function sinIconPath(sin){
  const map = {
    wrath:"assets/icon_wrath.png",
    lust:"assets/icon_lust.png",
    sloth:"assets/icon_sloth.png",
    gluttony:"assets/icon_gluttony.png",
    melancholy:"assets/icon_gloom.png",
    pride:"assets/icon_pride.png",
    envy:"assets/icon_envy.png",
  };
  return map[String(sin)] || "";
}

function atkIconPath(atk){
  if(atk === "slash")  return "assets/icon_slash.png";
  if(atk === "pierce") return "assets/icon_pierce.png";
  return "assets/icon_blunt.png";
}
function sinIconPath(sin){
  const map = {
    wrath:"assets/icon_wrath.png",
    lust:"assets/icon_lust.png",
    sloth:"assets/icon_sloth.png",
    gluttony:"assets/icon_gluttony.png",
    melancholy:"assets/icon_gloom.png",
    pride:"assets/icon_pride.png",
    envy:"assets/icon_envy.png",
  };
  return map[String(sin)] || "";
}

/** âœ… íƒ€ì´í‹€ë°”(6ë²ˆ)ë„ ì£„ì•…ì— ë§ì¶° í†¤ë§Œ ì‚´ì§ ë³€ê²½ (ì›í•˜ë©´ ë‚˜ì¤‘ì— ë” ë””í…Œì¼í•˜ê²Œ ê°€ëŠ¥) */
function applyTitleToneBySin(sin){
  const tone = {
    wrath:      { a:"rgba(255,60,60,.42)",  b:"rgba(90,10,10,.18)" },   // ë¹¨ê°•
    lust:       { a:"rgba(255,140,40,.42)", b:"rgba(90,40,10,.18)" },   // ì£¼í™©
    sloth:      { a:"rgba(255,220,60,.40)", b:"rgba(90,70,10,.16)" },   // ë…¸ë‘
    gluttony:   { a:"rgba(60,220,120,.34)", b:"rgba(10,70,30,.16)" },   // ì´ˆë¡
    melancholy: { a:"rgba(120,210,255,.34)", b:"rgba(10,40,70,.16)" },  // ì—°íŒŒë‘
    pride:      { a:"rgba(60,120,255,.34)", b:"rgba(10,20,70,.16)" },   // ë‚¨ìƒ‰
    envy:       { a:"rgba(170,90,255,.34)", b:"rgba(50,10,70,.16)" },   // ë³´ë¼
  }[String(sin)] || { a:"rgba(202,166,106,.22)", b:"rgba(0,0,0,.12)" };

  skTitleBar.style.background = `linear-gradient(180deg, ${tone.a}, ${tone.b})`;
  skTitleBar.style.borderColor = "rgba(255,255,255,.12)";
}

function escHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* âœ… (A) ì¸ë¼ì¸ í† í° ì ìš©: "ì´ë¯¸ escapeëœ ë¬¸ìì—´"ì„ ëŒ€ìƒìœ¼ë¡œë§Œ ì²˜ë¦¬ */
function applyInlineTokensEscaped(escText){
  return String(escText || "")
    .replaceAll("[[g]]",  '<span class="fxGreen">').replaceAll("[[/g]]","</span>")
    .replaceAll("[[b]]",  '<span class="fxBlue">').replaceAll("[[/b]]","</span>")
    .replaceAll("[[r]]",  '<span class="fxRed">').replaceAll("[[/r]]","</span>")
    .replaceAll("[[hl]]", '<span class="pvHL">').replaceAll("[[/hl]]","</span>")
    .replaceAll(/\[\[kw:(buff|debuff):([^\]]+)\]\]/g, (m, st, name) => {
      const cls = (st === "debuff") ? "debuff" : "buff";
      const safeName = String(name).replaceAll('"', "&quot;");
      return `<span class="pvKW ${cls}" data-kw="${safeName}" data-state="${st}">${name}</span>`;
    });
}

/* âœ… ì¤„ ë‹¨ìœ„ ë Œë”: [[coin:n]]ì´ ì¤„ ë§¨ ì•ì´ë©´ ì™¼ìª½ ì¹¸ì— ì½”ì¸ ë±ƒì§€ë¡œ ë¶„ë¦¬ */
function skToHtml(text){
  const lines = String(text || "").split("\n");

  const out = lines.map((rawLine) => {
    let line = String(rawLine || "").replace(/^\s+/, ""); // ì•ê³µë°± ì œê±°

    // 1) ë§¨ ì• coin í† í°ë§Œ leadë¡œ ë¶„ë¦¬
    let leadHtml = "";
    const m = line.match(/^\[\[coin:(\d+)\]\]\s*/);
    if(m){
      const n = Number(m[1] || 0);
      const rn = toRoman(n);
      leadHtml = `
        <span class="coinEffIcon" style="width:22px;height:22px;flex:0 0 22px;position:relative;display:block;">
          <img src="assets/icon_coin_effect_frame.png" alt="coin" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;">
          <span class="coinEffRoman" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:1000;color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.70);line-height:1;">
            ${escHtml(rn)}
          </span>
        </span>
      `.trim();
      line = line.slice(m[0].length);
    }

    // 2) ë³¸ë¬¸: ë¨¼ì € escape â†’ í† í°ì²˜ë¦¬ â†’ (ë‚¨ì€) [[coin:n]] ì¸ë¼ì¸ ì•„ì´ì½˜ ë³€í™˜
    let body = escHtml(line);
    body = applyInlineTokensEscaped(body);

    body = body.replace(/\[\[coin:(\d+)\]\]/g, (mm, nn) => {
      const rn = toRoman(Number(nn));
      return `<span class="coinEff" style="display:inline-flex;align-items:center;gap:4px;vertical-align:middle;margin:0 2px;">
        <span class="coinEffIcon" style="position:relative;width:22px;height:22px;flex:0 0 22px;display:block;">
          <img src="assets/icon_coin_effect_frame.png" alt="coin" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;">
          <span class="coinEffRoman" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:1000;color:rgba(255,255,255,.95);text-shadow:0 2px 6px rgba(0,0,0,.70);line-height:1;">
            ${escHtml(rn)}
          </span>
        </span>
      </span>`;
    });

    if(!body.trim()) body = "&nbsp;";

    return `
      <div class="skLine">
        <div class="skLead">${leadHtml}</div>
        <div class="skBody">${body}</div>
      </div>
    `.trim();
  }).join("");

  return `<div class="skLines">${out}</div>`;
}

function snapshotCurrentWorkspace(){
  // core
  let core = null;
  try{ core = JSON.parse(localStorage.getItem(KEY_CORE) || "null"); }catch(e){ core = null; }

  // passives
  let pass = [];
  try{ pass = JSON.parse(localStorage.getItem(KEY_PV) || "[]"); }catch(e){ pass = []; }

  // skills
  let sk = [];
  try{ sk = JSON.parse(localStorage.getItem(KEY_SK) || "[]"); }catch(e){ sk = []; }

  // dedicated keywords
  let dk = [];
  try{ dk = JSON.parse(localStorage.getItem(KEY_DK) || "[]"); }catch(e){ dk = []; }

  return {
    version: 1,
    savedAt: nowISO(),
    name: (core?.name || "").trim() || "ì´ë¦„ì—†ëŠ” ìºë¦­í„°",
    core: core,
    passives: pass,
    skills: sk,
    dedicatedKeywords: dk,
  };
}

async function restoreWorkspaceFromChar(charData){
  if(!charData) return;

  // localStorageì— ê·¸ëŒ€ë¡œ ê½‚ì•„ì£¼ê³ ,
  localStorage.setItem(KEY_CORE, JSON.stringify(charData.core || null));
  localStorage.setItem(KEY_PV, JSON.stringify(charData.passives || []));
  localStorage.setItem(KEY_SK, JSON.stringify(charData.skills || []));
  localStorage.setItem(KEY_DK, JSON.stringify(charData.dedicatedKeywords || []));

  // í™”ë©´ ê°±ì‹ : ê° íŒŒíŠ¸ê°€ ì´ë¯¸ "load" IIFEë¥¼ ê°€ì§€ê³  ìˆìœ¼ë‹ˆ
  // ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ ê·¸ëƒ¥ ìƒˆë¡œê³ ì¹¨ì´ì§€ë§Œ,
  // ì§€ê¸ˆ êµ¬ì¡°ì—ì„œë„ ìµœì†Œ ë™ì‘í•˜ê²Œ í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ ì£¼ìš” ë Œë” ì¬í˜¸ì¶œ:
  try{
    // coreëŠ” IIFEê°€ ìˆìœ¼ë‹ˆ ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ìƒˆë¡œê³ ì¹¨ ì¶”ì²œ.
    // ê·¸ë˜ë„ ì¦‰ì‹œ ë°˜ì˜ì´ í•„ìš”í•˜ë©´ location.reload()ê°€ ì œì¼ ì•ˆì „.
    location.reload();
  }catch(e){}
}

/** âœ… ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  */
async function renderSkillPreview(){
  const nm = String(skName.value || "").trim() || "ìŠ¤í‚¬";
  const atk = skAtkType.value;
  const sin = skSin.value;
  const tier = Number(skTier.value || 1);
  const pow = Number(skPower.value || 0);
  const coinP = Number(skCoinPower.value || 0);
  const sign = (skCoinSignBtn.dataset.sign === "-") ? "-" : "+";
  const atkLv = Number(skAtkLevel?.value || 0);
  const growth = Number(skGrowth?.value || 0);
  const w = Number(skWeight.value || 0);
  const txt = skText.value || "";
if(skAtkIcon) skAtkIcon.src = atkIconPath(atk);
if(skSinIcon) skSinIcon.src = sinIconPath(sin);
  skTitleTxt.textContent = nm;
  skPrevAtk.textContent = atkLabel(atk);
  skPrevSin.textContent = sinLabel(sin);

if(skPrevAtkIcon){
  skPrevAtkIcon.src = atkIconPath(atk);
  skPrevAtkIcon.alt = atkLabel(atk);
}
if(skPrevSinIcon){
  skPrevSinIcon.src = sinIconPath(sin);
  skPrevSinIcon.alt = sinLabel(sin);
}
  skPrevPow.textContent = String(Number.isFinite(pow) ? pow : 0);
  skPrevCoin.textContent = `${sign}${Number.isFinite(coinP) ? Math.abs(coinP) : 0}`;
  skPrevW.textContent = String(Number.isFinite(w) ? w : 0);

// âœ… ê³µê²©ë ˆë²¨ / ì„±ì¥ê³„ìˆ˜ í‘œì‹œ
if(skPrevGrowthBase) skPrevGrowthBase.textContent = String(Number.isFinite(atkLv) ? atkLv : 0);
if(skPrevGrowthPlus) skPrevGrowthPlus.textContent = String(Number.isFinite(growth) ? Math.abs(growth) : 0);
if(skPrevGrowthSign) skPrevGrowthSign.textContent = (growth < 0) ? "-" : "+";

  // âœ… ë¯¸ë¦¬ë³´ê¸°: 0 = ê³µê²©ë ˆë²¨, (+0) = ì„±ì¥ê³„ìˆ˜
  if(skPrevGrowthBase) skPrevGrowthBase.textContent = String(Number.isFinite(atkLv) ? atkLv : 0);
  if(skPrevGrowthPlus) skPrevGrowthPlus.textContent = String(Number.isFinite(growth) ? Math.abs(growth) : 0);

// ì½”ì¸ ì•„ì´ì½˜ ë Œë”
if(skCoinRow){
  skCoinRow.innerHTML = "";

  const count = skCoinCount ? Number(skCoinCount.value || 1) : 1;
  const type  = skCoinType  ? skCoinType.value : "normal";

  for(let i=0;i<count;i++){
    const img = document.createElement("img");
    img.src = coinIconPath(type);
    img.className = "skCoinIcon";
    skCoinRow.appendChild(img);
  }
}

// íš¨ê³¼ ë Œë”(í‚¤ì›Œë“œ span í¬í•¨)
if(skEffectBox){
  skEffectBox.innerHTML = skToHtml(txt);
}

  // í”„ë ˆì„
  skFrameImg.src = framePath(sin, tier);
  applyTitleToneBySin(sin);

  // ë‚´ë¶€ ì´ë¯¸ì§€: (1) pending (2) ì €ì¥ëœ active skill imgKey
  if(skPendingImgDataURL && skPendingImgDataURL.startsWith("data:image/")){
    skInnerImg.src = skPendingImgDataURL;
    skInnerImg.style.display = "block";
  }else{
    skInnerImg.src = "";
    skInnerImg.style.display = "none";

    // activeSkIdê°€ ìˆê³  imgKeyê°€ ìˆìœ¼ë©´ IndexedDBì—ì„œ ë¡œë“œ
    const it = skills.find(x => x.id === activeSkId);
    const key = it?.imgKey || "";
    if(key){
      try{
        const blob = await idbGetBlob(key);
        if(blob){
          skInnerImg.src = makeObjectURLFromBlob(blob);
          skInnerImg.style.display = "block";
        }
      }catch(e){}
    }
  }
}

// í¼ì¹¨ ìƒíƒœ ê¸°ì–µìš©
const _skOpenMap = new Map(); // skillId -> boolean

function setOpen(id, v){ _skOpenMap.set(id, !!v); }
function isOpen(id){ return !!_skOpenMap.get(id); }

/** âœ… ë¦¬ìŠ¤íŠ¸ ë Œë” (ìŠ¤í‚¬ ëª©ë¡ ì¹´ë“œ) */
async function renderSkillList(){
  if(!skList) return;
  skList.innerHTML = "";

  if(skills.length === 0){
    const d = document.createElement("div");
    d.style.color = "rgba(238,241,255,.55)";
    d.style.fontSize = "13px";
    d.style.padding = "8px";
    d.textContent = "ì•„ì§ ì €ì¥ëœ ìŠ¤í‚¬ì´ ì—†ì–´. ìœ„ì—ì„œ ë§Œë“¤ê³  ì €ì¥í•´ì¤˜.";
    skList.appendChild(d);
    return;
  }

  for(const s of skills){
    const card = document.createElement("div");
    card.className = "skListCard" + (s.id === activeSkId ? " active" : "");

    // === TOP (í´ë¦­í•˜ë©´ í¸ì§‘ê¸°ì— ë¡œë“œ) ===
    const top = document.createElement("div");
    top.className = "skListTop";

    // ART (í”„ë ˆì„+ë‚´ë¶€)
    const art = document.createElement("div");
    art.className = "skListArt";

    const frameBox = document.createElement("div");
    frameBox.className = "skListFrame";

    const frame = document.createElement("img");
    frame.alt = "frame";
    frame.src = framePath(s.sin, s.tier);
    frameBox.appendChild(frame);

    const inner = document.createElement("div");
    inner.className = "inner";

    const innerImg = document.createElement("img");
    innerImg.alt = "skill image";
    inner.appendChild(innerImg);
    frameBox.appendChild(inner);

    if(s.imgKey){
      try{
        const blob = await idbGetBlob(s.imgKey);
        innerImg.src = blob ? makeObjectURLFromBlob(blob) : "";
      }catch(e){
        innerImg.src = "";
      }
    }else{
      innerImg.src = "";
    }

    art.appendChild(frameBox);

    // coin icons
    const coinRow = document.createElement("div");
    coinRow.className = "skListCoins";
    const count = Math.max(1, Number(s.coinCount || s.qty || 1));
    const type  = String(s.coinType || "normal");
    for(let i=0;i<count;i++){
      const c = document.createElement("img");
      c.src = coinIconPath(type);
      c.alt = "coin";
      coinRow.appendChild(c);
    }
    art.appendChild(coinRow);

    // MAIN
    const main = document.createElement("div");
    main.className = "skListMain";

    // titlebar tone: ë¯¸ë¦¬ë³´ê¸°ì™€ ê°™ì€ í•¨ìˆ˜ ì¬ì‚¬ìš©
    const titleBar = document.createElement("div");
    titleBar.className = "skListTitleBar";
    // ì£„ì•… í†¤ ì ìš©(ê¸°ì¡´ applyTitleToneBySinì€ skTitleBarë¥¼ ì§ì ‘ ë§Œì§€ë‹ˆê¹Œ, ì—¬ê¸°ì„  ë™ì¼ í†¤ ê³„ì‚°ë§Œ)
    const tone = {
      wrath:      { a:"rgba(255,60,60,.42)",  b:"rgba(90,10,10,.18)" },
      lust:       { a:"rgba(255,140,40,.42)", b:"rgba(90,40,10,.18)" },
      sloth:      { a:"rgba(255,220,60,.40)", b:"rgba(90,70,10,.16)" },
      gluttony:   { a:"rgba(60,220,120,.34)", b:"rgba(10,70,30,.16)" },
      melancholy: { a:"rgba(120,210,255,.34)", b:"rgba(10,40,70,.16)" },
      pride:      { a:"rgba(60,120,255,.34)", b:"rgba(10,20,70,.16)" },
      envy:       { a:"rgba(170,90,255,.34)", b:"rgba(50,10,70,.16)" },
    }[String(s.sin)] || { a:"rgba(202,166,106,.22)", b:"rgba(0,0,0,.12)" };
    titleBar.style.background = `linear-gradient(180deg, ${tone.a}, ${tone.b})`;

    const title = document.createElement("div");
    title.className = "skListTitle";
    title.textContent = String(s.name || "").trim() || "ìŠ¤í‚¬";
    titleBar.appendChild(title);

    // stats
    const stat = document.createElement("div");
    stat.className = "skListStat";

    const rows = [
      ["ê³µê²© ìœ í˜•", atkLabel(s.atkType)],
      ["ì£„ì•… ì†ì„±", sinLabel(s.sin)],
      ["ìŠ¤í‚¬ ìœ„ë ¥", String(Number(s.power ?? 0) || 0)],
      ["ì½”ì¸ ìœ„ë ¥", `${(s.coinSign === "-") ? "-" : "+"}${Math.abs(Number(s.coinPower ?? 0) || 0)}`],
      ["ê³µê²© ê°€ì¤‘ì¹˜", String(Number(s.weight ?? 0) || 0)],
    ];

    for(const [th, td] of rows){
      const r = document.createElement("div");
      r.className = "skListStatRow";

      const thEl = document.createElement("div");
      thEl.className = "skListStatTh";
      thEl.textContent = th;

      const tdEl = document.createElement("div");
      tdEl.className = "skListStatTd";

      // ì•„ì´ì½˜ì´ í•„ìš”í•œ 2ì¤„ë§Œ ë„£ì
      if(th === "ê³µê²© ìœ í˜•"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = atkIconPath(s.atkType);
        img.alt = td;
        tdEl.appendChild(img);
      }
      if(th === "ì£„ì•… ì†ì„±"){
        const img = document.createElement("img");
        img.className = "skMiniIcon";
        img.src = sinIconPath(s.sin);
        img.alt = td;
        tdEl.appendChild(img);
      }

      const sp = document.createElement("span");
      sp.textContent = td;
      tdEl.appendChild(sp);

      r.appendChild(thEl);
      r.appendChild(tdEl);
      stat.appendChild(r);
    }

main.appendChild(titleBar);

// âœ… ê³µê²©ë ˆë²¨/ì„±ì¥ê³„ìˆ˜ ì¤„ (ë‘ë²ˆì§¸ ì´ë¯¸ì§€ì²˜ëŸ¼)
const growthRow = document.createElement("div");
growthRow.className = "skListGrowthRow";

const gIcon = document.createElement("img");
gIcon.className = "skListGrowthIcon";
gIcon.src = "assets/icon_growth.png";
gIcon.alt = "ì„±ì¥ê³„ìˆ˜";

const atkLv = Number(s.atkLevel ?? 0);
const gr = Number(s.growth ?? 0);
const sign = (gr < 0) ? "-" : "+";
const absGr = Math.abs(gr);

const gText = document.createElement("div");
gText.className = "skListGrowthText";
gText.innerHTML = `
  <span>${atkLv}</span>
  <span class="skGrowthLabel">ì„±ì¥ê³„ìˆ˜</span>
  <span class="skGrowthPlus">(${sign} ${absGr})</span>
`;

growthRow.appendChild(gIcon);
growthRow.appendChild(gText);

main.appendChild(growthRow);

main.appendChild(stat);

    top.appendChild(art);
    top.appendChild(main);

    // top í´ë¦­ => í¸ì§‘ê¸°ì— ë¡œë“œ
    top.addEventListener("click", async () => {
      await loadSkillToEditor(s.id);
    });

    card.appendChild(top);

    // === ACTION: [ì½”ì¸ë³„ íš¨ê³¼] í† ê¸€ ===
    const act = document.createElement("div");
    act.className = "skListActions";

    const toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "skListToggle";
    toggle.textContent = "[ ì½”ì¸ë³„ íš¨ê³¼ ]";

    // í† ê¸€ í´ë¦­ì€ ì¹´ë“œ ë¡œë“œ í´ë¦­ê³¼ ë¶„ë¦¬
    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const now = !isOpen(s.id);
      setOpen(s.id, now);
      body.classList.toggle("open", now);
    });

    act.appendChild(toggle);
    card.appendChild(act);

    const body = document.createElement("div");
    body.className = "skListBody" + (isOpen(s.id) ? " open" : "");

    const eff = document.createElement("div");
    eff.className = "skListEffect";
    eff.innerHTML = skToHtml(s.text || "");
    body.appendChild(eff);

    // í¼ì¹œ ë‚´ìš© ì˜ì—­ í´ë¦­í•´ë„ í¸ì§‘ ë¡œë“œ ì•ˆ í•˜ê²Œ(ì›í•˜ë©´ ì£¼ì„ì²˜ë¦¬ ê°€ëŠ¥)
    body.addEventListener("click", (e) => e.stopPropagation());

    card.appendChild(body);

    skList.appendChild(card);
  }
}

/** âœ… í¸ì§‘ê¸° ë¡œë“œ */
async function loadSkillToEditor(id){
  const it = skills.find(x => x.id === id);
  if(!it) return;

  activeSkId = it.id;
  skPendingImgDataURL = "";

  skName.value = it.name || "";
  skAtkType.value = it.atkType || "pierce";
  skSin.value = it.sin || "pride";
  skTier.value = String(it.tier || 1);
  if(skAtkLevel) skAtkLevel.value = String(it.atkLevel ?? 0);
  if(skGrowth)   skGrowth.value   = String(it.growth ?? 0);
  skPower.value = String(it.power ?? 0);
  skCoinPower.value = String(Math.abs(it.coinPower ?? 0));
  setCoinSign(it.coinSign === "-" ? "-" : "+");
  skWeight.value = String(it.weight ?? 0);
  skText.value = it.text || "";

  if(skCoinType)  skCoinType.value  = it.coinType || "normal";
  if(skCoinCount) skCoinCount.value = String(it.coinCount ?? 1);

  // ì´ë¯¸ì§€ í”„ë¦¬ë·°(ì™¼ìª½ ì—…ë¡œë“œ ë°•ìŠ¤)
  setSkImgPreview("");
  if(it.imgKey){
    try{
      const blob = await idbGetBlob(it.imgKey);
      if(blob) setSkImgPreview(makeObjectURLFromBlob(blob));
    }catch(e){}
  }

await renderSkillList();
await renderSkillPreview();
  toast(skToast, "ìŠ¤í‚¬ ë¶ˆëŸ¬ì˜´.");
}

/** ìƒˆ ìŠ¤í‚¬(ì—ë””í„° ì´ˆê¸°í™”) */
async function newSkill(){
  activeSkId = null;
  skPendingImgDataURL = "";
  skName.value = "";
  skAtkType.value = "pierce";
  skSin.value = "pride";
  skTier.value = "1";
  if(skAtkLevel) skAtkLevel.value = "0";
  if(skGrowth)   skGrowth.value   = "0";
  skPower.value = "15";
  skCoinPower.value = "4";
  setCoinSign("+");
  skWeight.value = "1";
  skText.value = "";
  skImgFile.value = "";
  setSkImgPreview("");
await renderSkillList();
await renderSkillPreview();
  toast(skToast, "ìƒˆ ìŠ¤í‚¬ ì‘ì„± ì¤‘.");
  if(skCoinType)  skCoinType.value  = "normal";
  if(skCoinCount) skCoinCount.value = "1";
}

/** ì½”ì¸ ë¶€í˜¸ ë²„íŠ¼ */
function setCoinSign(sign){
  const s = (sign === "-") ? "-" : "+";
  skCoinSignBtn.dataset.sign = s;
  skCoinSignBtn.textContent = s;
  skCoinSignBtn.classList.toggle("neg", s === "-");
  skCoinSignBtn.classList.toggle("pos", s === "+");
}

skCoinSignBtn.addEventListener("click", () => {
  const cur = skCoinSignBtn.dataset.sign || "+";
  setCoinSign(cur === "+" ? "-" : "+");
  renderSkillPreview();
});

/** ìŠ¤í‚¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ -> pending + í”„ë¦¬ë·°. ì €ì¥ ëˆ„ë¥´ë©´ IndexedDB ë°˜ì˜ */
skImgFile.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    skPendingImgDataURL = await compressImageToDataURL(f, {
      maxSize: 512,
      mime: "image/webp",
      quality: 0.88
    });
    setSkImgPreview(skPendingImgDataURL);
    await renderSkillPreview();
    toast(skToast, "ì´ë¯¸ì§€ ì„ íƒë¨. 'ì €ì¥'ì„ ëˆ„ë¥´ë©´ ì˜êµ¬ ë°˜ì˜ë¼.");
  }catch(err){
    console.error(err);
    toast(skToast, "ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨(íŒŒì¼/ë¸Œë¼ìš°ì € ì œí•œ).");
  }
});

skImgClear.addEventListener("click", async () => {
  skImgFile.value = "";
  skPendingImgDataURL = "";
  setSkImgPreview("");

  // ì„ íƒëœ í•­ëª©ì´ ìˆìœ¼ë©´ DBì—ì„œë„ ì‚­ì œ
  if(activeSkId){
    const idx = skills.findIndex(x => x.id === activeSkId);
    if(idx >= 0){
      const oldKey = skills[idx].imgKey || "";
      if(oldKey){
        try{ await idbDel(oldKey); }catch(e){}
      }
      skills[idx] = { ...skills[idx], imgKey: "" };
      skSaveStore();
      toast(skToast, "ì´ë¯¸ì§€ ì œê±° ì™„ë£Œ!");
    }
  }
  await renderSkillPreview();
});

/** ì…ë ¥ ë³€í™” -> ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ */
[skName, skAtkType, skSin, skTier, skPower, skCoinPower, skWeight, skText, skCoinType, skCoinCount, skAtkLevel, skGrowth].forEach(el => {
  el?.addEventListener("input", renderSkillPreview);
  el?.addEventListener("change", renderSkillPreview);
});

/** í‚¤ì›Œë“œ ë²„íŠ¼: ìŠ¤í‚¬ textareaë¥¼ íƒ€ê²Ÿìœ¼ë¡œ ì—´ê¸° */
skCoinEffectBtn?.addEventListener("click", () => {
  const input = prompt("ëª‡ ë²ˆì§¸ ì½”ì¸ íš¨ê³¼ë¥¼ ë„£ì„ê¹Œ? (ì˜ˆ: 1, 2, 3...)");
  if(input === null) return;

  const num = Number(String(input).trim());
  if(!Number.isFinite(num) || num < 1){
    alert("1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì¤˜.");
    return;
  }

  insertAtCursor(skText, `[[coin:${Math.floor(num)}]]`);
  renderSkillPreview();
});

function wrapSelection(textarea, openTag, closeTag){
  const el = textarea;
  const start = el.selectionStart ?? 0;
  const end = el.selectionEnd ?? 0;
  if(start === end) return false;

  const txt = el.value;
  const before = txt.slice(0, start);
  const sel = txt.slice(start, end);
  const after = txt.slice(end);

  el.value = before + openTag + sel + closeTag + after;

  // ì»¤ì„œëŠ” ê°ì‹¼ ë’¤ ëìœ¼ë¡œ
  const pos = end + openTag.length + closeTag.length;
  el.focus();
  el.setSelectionRange(pos, pos);
  return true;
}

/** ê°•ì¡° ë²„íŠ¼: pv ë°©ì‹ ì¬ì‚¬ìš©(í† í° [[hl]]) */
skHighlightBtn.addEventListener("click", () => {
  const el = skText;
  const start = el.selectionStart ?? 0;
  const end = el.selectionEnd ?? 0;
  if(start === end){
    toast(skToast, "ê°•ì¡°í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì¤˜.");
    return;
  }
  const txt = el.value;
  el.value = txt.slice(0,start) + "[[hl]]" + txt.slice(start,end) + "[[/hl]]" + txt.slice(end);
  el.focus();
  el.setSelectionRange(end + 10 + 6, end + 10 + 6);
  toast(skToast, "ì„ íƒí•œ ë¶€ë¶„ì— ê°•ì¡°ë¥¼ ì ìš©í–ˆì–´.");
  renderSkillPreview();
});

skGreenBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[g]]", "[[/g]]");
  if(!ok){ toast(skToast, "íš¨ê³¼ë¥¼ ì ìš©í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì¤˜."); return; }
  toast(skToast, "ì„ íƒí•œ ë¶€ë¶„ì— ë…¹ìƒ‰ íš¨ê³¼ë¥¼ ì ìš©í–ˆì–´.");
  renderSkillPreview();
});

skBlueBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[b]]", "[[/b]]");
  if(!ok){ toast(skToast, "íš¨ê³¼ë¥¼ ì ìš©í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì¤˜."); return; }
  toast(skToast, "ì„ íƒí•œ ë¶€ë¶„ì— íŒŒë€ìƒ‰ íš¨ê³¼ë¥¼ ì ìš©í–ˆì–´.");
  renderSkillPreview();
});

skRedBtn?.addEventListener("click", () => {
  const ok = wrapSelection(skText, "[[r]]", "[[/r]]");
  if(!ok){ toast(skToast, "íš¨ê³¼ë¥¼ ì ìš©í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì¤˜."); return; }
  toast(skToast, "ì„ íƒí•œ ë¶€ë¶„ì— ë¹¨ê°„ìƒ‰ íš¨ê³¼ë¥¼ ì ìš©í–ˆì–´.");
  renderSkillPreview();
});

/** ì €ì¥ */
skSaveBtn.addEventListener("click", async () => {
  const before = skills.slice(); // âœ… ë¡¤ë°±ìš©(ì €ì¥ ì‹¤íŒ¨í•˜ë©´ ë˜ëŒë¦¬ê¸°)

  const payload = {
    id: activeSkId || skUid(),
    name: skName.value,
    atkType: skAtkType.value,
    sin: skSin.value,
    tier: Number(skTier.value || 1),
    power: Number(skPower.value || 0),
    coinSign: (skCoinSignBtn.dataset.sign === "-") ? "-" : "+",
    coinPower: Number(skCoinPower.value || 0),
    atkLevel: Number(skAtkLevel?.value || 0),
    growth:   Number(skGrowth?.value || 0),
    weight: Number(skWeight.value || 0),
    coinType: (skCoinType ? skCoinType.value : "normal"),
    coinCount: (skCoinCount ? Number(skCoinCount.value || 1) : 1),
    text: skText.value || "",
    imgKey: ""
  };

  // ê¸°ì¡´ í•­ëª©ì´ë©´ imgKey ìœ ì§€
  const prev = activeSkId ? skills.find(x => x.id === activeSkId) : null;
  payload.imgKey = prev?.imgKey || "";

  // pending ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ IndexedDBì— ì €ì¥(í‚¤ëŠ” id ê¸°ë°˜ ê³ ì •)
  if(skPendingImgDataURL && skPendingImgDataURL.startsWith("data:image/")){
    try{
      const blob = dataURLToBlob(skPendingImgDataURL);
      payload.imgKey = `skill_img_${payload.id}`;
      await idbPutBlob(payload.imgKey, blob);
    }catch(e){
      console.error(e);
      toast(skToast, "ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì œí•œ/í˜•ì‹ ë¬¸ì œ).");
      return;
    }
  }

  // skills ë°°ì—´ì— ë°˜ì˜
  if(activeSkId){
    const idx = skills.findIndex(x => x.id === activeSkId);
    if(idx >= 0) skills[idx] = payload;
    else skills.unshift(payload);
  }else{
    skills.unshift(payload);
  }

  activeSkId = payload.id;
  skPendingImgDataURL = "";

  // âœ… ì €ì¥ ì‹¤íŒ¨ ë¡¤ë°±
  if(!skSaveStore()){
    skills = before;
    await renderSkillList();
    await renderSkillPreview();
    return;
  }

  await renderSkillList();
  await renderSkillPreview();
  toast(skToast, "ìŠ¤í‚¬ ì €ì¥ ì™„ë£Œ!");
});

/** ì‚­ì œ */
skDeleteBtn.addEventListener("click", async () => {
  if(!activeSkId){
    toast(skToast, "ì‚­ì œí•  ìŠ¤í‚¬ì„ ë¨¼ì € ì„ íƒí•´ì¤˜.");
    return;
  }
  const idx = skills.findIndex(x => x.id === activeSkId);
  if(idx < 0) return;

  const oldKey = skills[idx].imgKey || "";
  if(oldKey){
    try{ await idbDel(oldKey); }catch(e){}
  }

  skills.splice(idx, 1);
  skSaveStore();
  toast(skToast, "ìŠ¤í‚¬ ì‚­ì œ ì™„ë£Œ!");
  await newSkill();
});

/** ìƒˆ ìŠ¤í‚¬ */
skNewBtn.addEventListener("click", newSkill);

/** ì´ˆê¸° ë¡œë“œ */
(async () => {
  try{ skLoadStore(); }catch(e){ console.error(e); }
  await renderSkillList();
  await newSkill();
})();

/** âœ… ìŠ¤í‚¬ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì—ì„œë„ í‚¤ì›Œë“œ hover íˆ´íŒ ì‘ë™í•˜ê²Œ ì—°ê²° */
document.getElementById("skPreviewCard").addEventListener("mousemove", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  const kwEl = t.closest(".pvKW");
  if(!kwEl) { hideKwTip(); return; }

  const name = kwEl.getAttribute("data-kw") || kwEl.textContent || "";
  const stateHint = kwEl.getAttribute("data-state") || "";
  showKwTipFor(name, stateHint, e.clientX, e.clientY);
});
document.getElementById("skPreviewCard").addEventListener("mouseout", (e) => {
  const from = e.target;
  if(!(from instanceof HTMLElement)) return;

  const fromKw = from.closest(".pvKW");
  if(!fromKw) return;

  const to = e.relatedTarget;
  if(to instanceof HTMLElement && to.closest(".pvKW")) return;

  hideKwTip();
});
document.getElementById("skPreviewCard").addEventListener("mouseleave", hideKwTip);

    // (ì„ íƒ) í˜ì´ì§€ ë– ë‚  ë•Œ objectURL ì •ë¦¬
    window.addEventListener("beforeunload", () => {
      if(_portraitObjectURL){
        try{ URL.revokeObjectURL(_portraitObjectURL); }catch(e){}
      }
      for(const [k, u] of _iconObjectURLMap.entries()){
        try{ URL.revokeObjectURL(u); }catch(e){}
      }
      _iconObjectURLMap.clear();
    });

(function bootOnceLoadCharacter(){
  const loadId = localStorage.getItem("limbus_load_char_once");
  if(!loadId) return;

  const mode = localStorage.getItem("limbus_app_mode_once") || "edit";
  localStorage.removeItem("limbus_load_char_once");
  localStorage.removeItem("limbus_app_mode_once");

  const data = loadCharData(loadId);
  if(!data) return;

  // ì‘ì—…ê³µê°„ ë®ì–´ì“°ê¸°
  localStorage.setItem(KEY_CORE, JSON.stringify(data.core || null));
  localStorage.setItem(KEY_PV, JSON.stringify(data.passives || []));
  localStorage.setItem(KEY_SK, JSON.stringify(data.skills || []));
  localStorage.setItem(KEY_DK, JSON.stringify(data.dedicatedKeywords || []));

  // ëª¨ë“œ ì ìš©
  setAppMode(mode);

  // í™ˆ ëŒ€ì‹  ì—ë””í„°ë¡œ ë°”ë¡œ ì§„ì…í•˜ê³ , core íƒ­ë¶€í„° ë³´ì—¬ì£¼ê¸°
  hide(viewHome); show(viewEditor);
  selectTab("core");
})();

const btnImport = document.getElementById("btn-import-character");
const importFile = document.getElementById("importFile");

btnImport?.addEventListener("click", () => importFile.click());
importFile?.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    await importCharacterFromFile(f);
  }catch(err){
    console.error(err);
    alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨(íŒŒì¼ ì†ìƒ/ê¶Œí•œ/ìš©ëŸ‰ ë¬¸ì œì¼ ìˆ˜ ìˆì–´).");
  }finally{
    importFile.value = "";
  }
});

  </script>
</body>
</html>